html,body{
  margin:0;
  padding:0;
  background:#d8c6aa;
  color:#3a2f28;
  font-family:Georgia,"Times New Roman",serif;
  font-size:16px;
}

.container{
  max-width:900px;
  margin:0 auto;
  padding:20px;
}

h1,h2,h3{
  font-weight:700;
  color:#3a2f28;
}

h1{
  font-size:28px;
  margin-bottom:6px;
  text-align:center;
}

h2{
  font-size:22px;
  margin:0 0 10px 0;
}

p{
  margin:4px 0 12px 0;
}

a{
  color:#4c2a91;
  text-decoration:none;
}

a:hover{
  text-decoration:underline;
}

nav{
  margin-bottom:10px;
  text-align:center;
}

nav a{
  margin:0 6px;
  padding:3px 6px;
  border-radius:4px;
}

nav a.active{
  background:#b3822f;
  color:#fff;
}

.card{
  background:#fff8f0;
  border:1px solid #e0d7c5;
  border-radius:12px;
  box-shadow:0 6px 20px rgba(0,0,0,.15);
  padding:20px;
}

.row{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:10px;
}

.row>div{
  flex:1 1 200px;
  min-width:180px;
}

label{
  display:block;
  font-size:14px;
  font-weight:700;
  margin-bottom:3px;
}

input,select{
  width:100%;
  box-sizing:border-box;
  padding:8px 10px;
  border-radius:6px;
  border:1px solid #c8b99e;
  font-family:inherit;
  font-size:15px;
  background:#fff;
}

input:focus,select:focus{
  outline:none;
  border-color:#b3822f;
}

.btn{
  background:#b3822f;
  color:#fff;
  border:0;
  border-radius:8px;
  padding:10px 18px;
  font-weight:700;
  cursor:pointer;
  transition:background .2s;
}

.btn:hover{
  background:#8a6626;
}

.badge{
  font-size:14px;
  color:#b3822f;
  font-weight:600;
}

.muted{
  opacity:.8;
  font-size:14px;
}

.spacer{
  flex:1;
}

small{
  font-size:13px;
}

/* Toast animation smoothness */
@keyframes fadein{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin — RÖSTILAND BY NOXAMA SAMUI</title>
  <link rel="stylesheet" href="/style.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
<div class="container">
  <!-- Banner / Logo wie auf der Startseite -->
  <div class="hero-wrap">
    <img id="heroBanner" class="hero-banner" alt="Banner"/>
  </div>

  <nav><a href="/">Reservation</a> <a class="active" href="/admin">Admin</a></nav>
  <h1>Admin</h1>

  <div class="card">
    <h2>All reservations</h2>
    <div class="toolbar">
      <div class="row">
        <div><label>Date filter</label><input id="fltDate" type="date"/></div>
        <div><label>View</label>
          <select id="view"><option value="day">day</option><option value="week" selected>week</option><option value="month">month</option></select>
        </div>
        <button class="btn" id="btnLoad" type="button">Load</button>
        <div class="spacer"></div>
        <div>
          <label>Export</label>
          <select id="period">
            <option value="daily">daily</option>
            <option value="weekly" selected>weekly</option>
            <option value="monthly">monthly</option>
            <option value="yearly">yearly</option>
          </select>
          <button class="btn" id="btnExport" type="button">Excel</button>
        </div>
      </div>
    </div>

    <div class="table-wrap">
      <table id="tbl">
        <thead>
        <tr>
          <th class="col-date">Date</th>
          <th class="col-time">Time</th>
          <th>Name</th>
          <th>Email</th>
          <th class="col-phone">Phone</th>
          <th class="col-guests">Guests</th>
          <th>Status</th>
          <th>Notes</th>
          <th>Visit</th>
          <th>Discount</th>
          <th class="col-walkin">Walk in</th>
          <th class="col-actions">Action</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="sum" class="badge" style="margin-top:10px;"></div>
  </div>

  <!-- Walk-in -->
  <div class="card">
    <h2>Add walk in</h2>
    <div class="row">
      <div><label>Date</label><input id="wDate" type="date"/></div>
      <div><label>Time</label><select id="wTime"></select></div>
      <div><label>Guests</label><input id="wGuests" type="number" min="1" max="48" value="2"/></div>
    </div>
    <label>Notes</label><input id="wNotes"/>
    <div class="row">
      <button id="btnWalk" class="btn" type="button">Save walk in</button>
      <span id="wMsg" class="badge"></span>
    </div>
  </div>

  <!-- Closures -->
  <div class="card">
    <h2>Block restaurant</h2>
    <div class="row">
      <div><label>Start</label><input id="cStart" type="datetime-local"/></div>
      <div><label>End</label><input id="cEnd" type="datetime-local"/></div>
      <div><label>Reason</label><input id="cReason"/></div>
    </div>
    <div class="row">
      <button id="btnBlock" class="btn" type="button">Create block</button>
      <button id="btnBlockDayPicker" class="btn-plain" type="button">Block day (from Start)</button>
      <span id="cMsg" class="badge"></span>
    </div>
    <div id="closureList" style="margin-top:10px"></div>
  </div>

  <!-- Special notices (Pflicht-Popup an einem Datum) -->
  <div class="card">
    <h2>Special notices</h2>
    <div class="row">
      <div style="flex:1;">
        <label>Date</label>
        <input id="nDate" type="date"/>
      </div>
      <div style="flex:2;">
        <label>Message (shown to guests; must accept)</label>
        <input id="nMessage" placeholder="Example: Christmas menu THB 1,200 per guest. Please confirm to proceed."/>
      </div>
    </div>
    <div class="row">
      <button id="btnNoticeSave" class="btn" type="button">Save notice</button>
      <span id="nMsg" class="badge"></span>
    </div>
    <div id="noticeList" style="margin-top:10px;"></div>
  </div>
</div>

<script>
  // Helper: today
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

  // Fill header banner/logo from /api/config
  (async()=>{
    try{
      const r = await fetch('/api/config'); const cfg = await r.json();
      const hero = document.getElementById('heroBanner');
      hero.src = cfg.mailHeaderUrl || cfg.mailLogoUrl || '/logo-hero.png';
      hero.alt = cfg.brand || 'Banner';
    }catch{}
  })();

  document.getElementById("fltDate").value = today();
  document.getElementById("wDate").value = today();
  document.getElementById("nDate").value = today();

  function fillWalkInTimes(){
    const sel = document.getElementById("wTime");
    sel.innerHTML = "";
    const from = 10*60, to = 22*60;
    for(let m=from;m<=to;m+=15){
      const hh=String(Math.floor(m/60)).padStart(2,"0");
      const mm=String(m%60).padStart(2,"0");
      const opt=document.createElement("option");
      opt.value=`${hh}:${mm}`; opt.textContent=opt.value;
      sel.appendChild(opt);
    }
  }
  fillWalkInTimes();

  async function loadList(){
    const d = document.getElementById("fltDate").value || today();
    const v = document.getElementById("view").value || "week";
    const r = await fetch(`/api/admin/reservations?date=${encodeURIComponent(d)}&view=${v}`);
    const data = await r.json();
    const tb = document.querySelector("#tbl tbody");
    tb.innerHTML = "";
    let totalGuests = 0;

    data.forEach(row=>{
      totalGuests += row.guests;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="col-date">${row.date}</td>
        <td class="col-time">${row.time}</td>
        <td>${row.firstName} ${row.name}</td>
        <td>${row.email || ""}</td>
        <td class="col-phone">${row.phone || ""}</td>
        <td class="col-guests">${row.guests}</td>
        <td>${row.status}</td>
        <td>${row.notes || ""}</td>
        <td>${row.visitCount ?? ""}</td>
        <td>${row.discount ? row.discount + "%" : ""}</td>
        <td class="col-walkin">${row.isWalkIn ? "yes" : ""}</td>
        <td class="col-actions actions-cell">
          <span class="btn-group vstack">
            <button class="btn-danger btn-sm" data-del="${row.id}" type="button">Delete</button>
            <button class="btn btn-sm" data-ns="${row.id}" type="button">No show</button>
          </span>
        </td>`;
      tb.appendChild(tr);
    });

    document.getElementById("sum").textContent = `Total bookings: ${data.length}   Total guests: ${totalGuests}`;

    tb.querySelectorAll("[data-del]").forEach(b=>b.addEventListener("click", async ()=>{
      await fetch(`/api/admin/reservations/${b.getAttribute("data-del")}`, {method:"DELETE"}); loadList();
    }));
    tb.querySelectorAll("[data-ns]").forEach(b=>b.addEventListener("click", async ()=>{
      await fetch(`/api/admin/reservations/${b.getAttribute("data-ns")}/noshow`, {method:"POST"}); loadList();
    }));
  }
  document.getElementById("btnLoad").addEventListener("click", loadList);
  document.getElementById("view").addEventListener("change", loadList);
  loadList();

  document.getElementById("btnExport").addEventListener("click", ()=>{
    const p = document.getElementById("period").value;
    const d = document.getElementById("fltDate").value || today();
    window.location.href = `/api/export?period=${p}&date=${encodeURIComponent(d)}`;
  });

  document.getElementById("btnWalk").addEventListener("click", async ()=>{
    const d = document.getElementById("wDate").value || today();
    const t = document.getElementById("wTime").value;
    const payload = { date:d, time:t, guests:Number(document.getElementById("wGuests").value), notes:document.getElementById("wNotes").value };
    const r = await fetch("/api/admin/walkin", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
    const m = document.getElementById("wMsg");
    if(r.ok){ m.textContent="Saved"; loadList(); } else { const e = await r.json(); m.textContent = e.error || "Error"; }
  });

  // Closures
  async function loadClosures(){
    const r = await fetch("/api/admin/closure");
    const list = await r.json();
    const box = document.getElementById("closureList");
    box.innerHTML = "";
    list.forEach(x=>{
      const d = document.createElement("div");
      d.className = "badge";
      const s = new Date(x.startTs).toLocaleString();
      const e = new Date(x.endTs).toLocaleString();
      d.textContent = `${s} — ${e} (${x.reason})`;
      const btn = document.createElement("button");
      btn.textContent = "remove"; btn.className = "btn-plain btn-sm"; btn.type="button";
      btn.onclick = async ()=>{ await fetch(`/api/admin/closure/${x.id}`, {method:"DELETE"}); loadClosures(); };
      d.appendChild(btn);
      box.appendChild(d);
    });
  }
  loadClosures();

  document.getElementById("btnBlock").addEventListener("click", async ()=>{
    const payload = {
      startTs: document.getElementById("cStart").value,
      endTs: document.getElementById("cEnd").value,
      reason: document.getElementById("cReason").value
    };
    const r = await fetch("/api/admin/closure", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
    const m = document.getElementById("cMsg");
    if(r.ok){ m.textContent="Block saved"; loadClosures(); } else { const e = await r.json(); m.textContent = e.error || "Error"; }
  });

  document.getElementById("btnBlockDayPicker").addEventListener("click", async ()=>{
    const val = document.getElementById("cStart").value;
    if(!val){ alert("Set 'Start' first"); return; }
    const d = new Date(val); const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    const reason = document.getElementById("cReason").value || "Closed";
    const r = await fetch("/api/admin/closure/day", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ date: iso, reason }) });
    const m = document.getElementById("cMsg");
    if(r.ok){ m.textContent="Day blocked"; loadClosures(); } else { const e = await r.json(); m.textContent = e.error || "Error"; }
  });

  // SPECIAL NOTICES: speichern + auflisten
  async function loadNotices(){
    const r = await fetch('/api/admin/notices');
    const list = await r.json();
    const box = document.getElementById('noticeList');
    box.innerHTML = "";
    list.forEach(n=>{
      const d = document.createElement('div');
      d.className = 'badge line';
      d.innerHTML = `<b>${n.date}</b> — ${n.message}`;
      const b = document.createElement('button');
      b.className = 'btn-plain btn-sm';
      b.textContent = 'remove';
      b.onclick = async()=>{ await fetch(`/api/admin/notices/${n.id}`, {method:'DELETE'}); loadNotices(); };
      d.appendChild(b);
      box.appendChild(d);
    });
  }
  loadNotices();

  document.getElementById('btnNoticeSave').addEventListener('click', async ()=>{
    const date = document.getElementById('nDate').value;
    const message = document.getElementById('nMessage').value.trim();
    const msg = document.getElementById('nMsg');
    msg.textContent = '';
    if(!date || !message){ msg.textContent = 'Date and message required'; return; }
    const r = await fetch('/api/admin/notice', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ date, message }) });
    if(r.ok){ msg.textContent='Saved'; loadNotices(); } else { const e = await r.json().catch(()=>({})); msg.textContent = e.error || 'Error'; }
  });
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin — RÖSTILAND BY NOXAMA SAMUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/style.css"/>

  <style>
    /* kleiner, eleganter Banner */
    .hero-wrap{max-width:1200px;margin:0 auto 12px auto;display:flex;justify-content:center}
    .hero{display:block;width:auto;height:auto;max-width:100%;max-height:clamp(140px,24vw,260px);
          background:#e9dfcf;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,.18)}
    @media (max-width:520px){ .hero{max-height:180px} }

    nav{display:none}
  </style>
</head>
<body>
<div class="container">

  <div class="hero-wrap">
    <img id="heroImg" class="hero" src="/logo-hero.png" alt="Röstiland"/>
  </div>

  <nav><a href="/">Reservation</a> <a class="active" href="/admin">Admin</a></nav>

  <h1 id="brand">Admin</h1>

  <!-- All reservations -->
  <div class="card">
    <h2>All reservations</h2>
    <div class="row">
      <div>
        <label>Date filter</label>
        <input id="fltDate" type="date"/>
      </div>
      <div>
        <label>View</label>
        <select id="fltView">
          <option value="day">day</option>
          <option value="week">week</option>
          <option value="month">month</option>
        </select>
      </div>
      <div class="row">
        <button id="btnLoad" class="btn" type="button">Load</button>
      </div>
    </div>

    <div id="list"></div>

    <div class="row">
      <div>
        <label>Export</label>
        <select id="expPeriod">
          <option value="daily">daily</option>
          <option value="weekly" selected>weekly</option>
          <option value="monthly">monthly</option>
          <option value="yearly">yearly</option>
        </select>
      </div>
      <button id="btnExcel" class="btn" type="button">Excel</button>
    </div>
  </div>

  <!-- Special notices -->
  <div class="card">
    <h2>Special notices</h2>
    <div class="row">
      <div>
        <label>Date</label>
        <input id="nDate" type="date"/>
      </div>
      <div style="flex:1">
        <label>Message (shown to guests; must accept)</label>
        <input id="nMsg" />
      </div>
    </div>
    <div class="row">
      <button id="btnNotice" class="btn" type="button">Save notice</button>
      <span id="nStatus" class="badge"></span>
    </div>
  </div>
</div>

<script>
  const pad2 = n => String(n).padStart(2,"0");
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };
  function normalizeYmd(s){
    s=String(s||"").trim();
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    if(/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(s)){ const [dd,mm,yy]=s.split(".").map(Number); return `${yy}-${pad2(mm)}-${pad2(dd)}`; }
    const d=new Date(s); if(!isNaN(d.getTime())) return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    return "";
  }

  // Config + banner
  (async ()=>{
    try{
      const r=await fetch("/api/config"); const cfg=await r.json();
      document.getElementById("brand").textContent=`Admin — ${cfg.brand}`;
      document.getElementById("heroImg").src = cfg.mailHeaderUrl || cfg.mailLogoUrl || "/logo-hero.png";
    }catch{}
  })();

  // Filters
  const elDate=document.getElementById('fltDate'); elDate.value=today();
  const elView=document.getElementById('fltView');
  document.getElementById('btnLoad').onclick = loadList;

  async function loadList(){
    const d = elDate.value || today();
    const v = elView.value || 'day';
    const r = await fetch(`/api/admin/reservations?date=${encodeURIComponent(d)}&view=${encodeURIComponent(v)}`);
    const list = await r.json();
    const wrap = document.getElementById('list');
    if(!Array.isArray(list) || !list.length){ wrap.innerHTML = '<p class="muted">No data</p>'; return; }

    const rows = list.map(x=>`<tr>
      <td>${x.date}</td><td>${x.time}</td>
      <td>${x.firstName} ${x.name}</td>
      <td>${x.email||""}</td>
      <td>${x.phone||""}</td>
      <td>${x.guests}</td>
      <td>${x.status}</td>
      <td>${x.notes||""}</td>
      <td>${x.isWalkIn ? "yes":"no"}</td>
      <td>
        <button data-id="${x.id}" class="del small">Delete</button>
        <button data-id="${x.id}" class="noshow small">No show</button>
      </td>
    </tr>`).join("");

    wrap.innerHTML = `<div class="table">
      <table>
        <thead><tr>
          <th>Date</th><th>Time</th><th>Name</th><th>Email</th><th>Phone</th>
          <th>Guests</th><th>Status</th><th>Notes</th><th>Walk in</th><th>Action</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;

    // actions
    wrap.querySelectorAll("button.del").forEach(b=>{
      b.onclick=async()=>{ await fetch(`/api/admin/reservations/${b.dataset.id}`,{method:"DELETE"}); loadList(); };
    });
    wrap.querySelectorAll("button.noshow").forEach(b=>{
      b.onclick=async()=>{ await fetch(`/api/admin/reservations/${b.dataset.id}/noshow`,{method:"POST"}); loadList(); };
    });
  }
  loadList();

  // Export
  document.getElementById('btnExcel').onclick=()=>{
    const d = elDate.value || today();
    const p = document.getElementById('expPeriod').value;
    window.location.href = `/api/export?date=${encodeURIComponent(d)}&period=${encodeURIComponent(p)}`;
  };

  // Notices
  const nDate=document.getElementById('nDate'); nDate.value=today();
  const nMsg=document.getElementById('nMsg');
  const nStatus=document.getElementById('nStatus');

  async function prefillNotice(){
    try{
      const d = nDate.value || today();
      const r = await fetch(`/api/admin/notice?date=${encodeURIComponent(d)}`);
      const js = await r.json();
      nMsg.value = js && js.message ? js.message : "";
    }catch{ nMsg.value=""; }
  }
  nDate.addEventListener("change",prefillNotice);
  prefillNotice();

  document.getElementById('btnNotice').onclick = async ()=>{
    nStatus.textContent = "";
    const d = normalizeYmd(nDate.value);
    const m = nMsg.value.trim();
    if(!d || !m){ nStatus.textContent="Invalid input"; return; }
    try{
      const r = await fetch("/api/admin/notice",{
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ date:d, message:m })
      });
      const js = await r.json();
      if(!r.ok || !js.ok){ nStatus.textContent = "Failed to save notice"; return; }
      nStatus.textContent = "Saved";
      setTimeout(()=>nStatus.textContent="", 1500);
    }catch{
      nStatus.textContent = "Failed to save notice";
    }
  };
</script>
</body>
</html>

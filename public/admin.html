<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — Reservations</title>
<link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <div class="wrapper">
    <header class="header" style="margin-bottom:0">
      <img id="heroLogo" class="logo" alt="Logo"/>
      <h1 class="h1" style="font-size:36px;margin:10px 0">Admin</h1>
    </header>

    <section class="card">
      <div class="row">
        <div>
          <div class="label">Date filter</div>
          <input class="input" id="fltDate" type="date"/>
        </div>
        <div>
          <div class="label">View</div>
          <select class="select" id="fltView">
            <option value="day">day</option>
            <option value="week" selected>week</option>
          </select>
        </div>
        <div>
          <div class="label">Export</div>
          <div class="inline">
            <select class="select" id="expPeriod">
              <option value="weekly" selected>weekly</option>
              <option value="daily">daily</option>
              <option value="monthly">monthly</option>
              <option value="yearly">yearly</option>
            </select>
            <a class="btn" id="expBtn">Excel</a>
          </div>
        </div>
        <div class="inline" style="align-items:flex-end">
          <button class="btn" id="loadBtn">Load</button>
        </div>
      </div>

      <div id="loadInfo" class="notice" style="display:none">List failed (404)</div>

      <div class="section">
        <table class="table" id="tbl"></table>
      </div>
    </section>

    <section class="card section">
      <h3 style="margin-top:0">Add walk in</h3>
      <div class="row">
        <div><div class="label">Date</div><input class="input" id="wDate" type="date"/></div>
        <div><div class="label">Time</div><input class="input" id="wTime" type="time" value="10:00"/></div>
        <div><div class="label">Guests</div><input class="input" id="wGuests" type="number" min="1" value="2"/></div>
      </div>
      <div class="section">
        <div class="label">Notes</div>
        <input class="input" id="wNotes" placeholder="Table, source, anything..."/>
      </div>
      <div class="section inline">
        <button class="btn" id="wSave">Save walk in</button>
        <div id="wInfo" class="helper"></div>
      </div>
    </section>

    <section class="card section">
      <h3 style="margin-top:0">Block restaurant</h3>
      <div class="row">
        <div><div class="label">Start</div><input class="input" id="bStart" type="datetime-local"/></div>
        <div><div class="label">End</div><input class="input" id="bEnd" type="datetime-local"/></div>
        <div><div class="label">Reason</div><input class="input" id="bReason" placeholder="Private event, maintenance, ..."/></div>
      </div>
      <div class="section inline">
        <button class="btn" id="bCreate">Create block</button>
        <button class="btn secondary" id="bDay">Block day (from Start)</button>
        <div id="bInfo" class="helper"></div>
      </div>

      <div class="blocklist" id="blockList"></div>
    </section>
  </div>

<script>
const $ = s => document.querySelector(s);
const cfg = {logoUrl:""};

function ymd(d){const p=n=>String(n).padStart(2,"0");return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;}

async function loadCfg(){
  const r = await fetch("/api/config"); Object.assign(cfg, await r.json());
  $("#heroLogo").src = cfg.logoUrl || "/logo-hero.png";
}

function drawRows(list){
  const tbl = $("#tbl");
  tbl.innerHTML = "";
  const header = document.createElement("tr");
  header.className="tr";
  header.innerHTML = `
    <td><b>Date</b></td><td><b>Time</b></td><td><b>Name</b></td>
    <td><b>Email</b></td><td><b>Phone</b></td><td><b>Guests</b></td>
    <td><b>Status</b></td><td><b>Notes</b></td><td><b>Walk in</b></td><td><b>Action</b></td>`;
  tbl.appendChild(header);

  for(const r of list){
    const tr = document.createElement("tr");
    tr.className="tr";
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${r.time}</td>
      <td>${r.firstName} ${r.name}</td>
      <td>${r.email||""}</td>
      <td>${r.phone||""}</td>
      <td>${r.guests}</td>
      <td><span class="badge">${r.status}</span></td>
      <td>${r.notes||""}</td>
      <td>${r.isWalkIn?"yes":""}</td>
      <td class="actions">
        <button class="btn secondary" data-no="${r.id}">No show</button>
        <button class="btn" data-del="${r.id}">Delete</button>
      </td>`;
    tbl.appendChild(tr);
  }

  tbl.querySelectorAll("[data-del]").forEach(b=>{
    b.addEventListener("click", async ()=>{
      await fetch("/api/admin/reservations/"+b.dataset.del, {method:"DELETE"});
      loadList();
    });
  });
  tbl.querySelectorAll("[data-no]").forEach(b=>{
    b.addEventListener("click", async ()=>{
      await fetch("/api/admin/reservations/"+b.dataset.no+"/noshow", {method:"POST"});
      loadList();
    });
  });
}

async function loadList(){
  $("#loadInfo").style.display="none";
  const date = $("#fltDate").value;
  const view = $("#fltView").value;
  const r = await fetch(`/api/admin/reservations?date=${encodeURIComponent(date)}&view=${encodeURIComponent(view)}`);
  if(!r.ok){ $("#loadInfo").style.display="block"; return; }
  drawRows(await r.json());
}

async function exportXlsx(){
  const period = $("#expPeriod").value;
  const date = $("#fltDate").value;
  const url = `/api/export?period=${encodeURIComponent(period)}&date=${encodeURIComponent(date)}`;
  window.location.href = url;
}

async function saveWalk(){
  const body = {
    date: $("#wDate").value,
    time: $("#wTime").value,
    guests: Number($("#wGuests").value),
    notes: $("#wNotes").value
  };
  const r = await fetch("/api/walkin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  $("#wInfo").textContent = r.ok ? "Walk-in saved." : "Walk-in failed";
  loadList();
}

async function createBlock(){
  const body = { startTs: $("#bStart").value.replace("T"," "), endTs: $("#bEnd").value.replace("T"," "), reason: $("#bReason").value };
  const r = await fetch("/api/admin/closure",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  $("#bInfo").textContent = r.ok ? "Block saved." : "Block failed";
  loadBlocks();
}
async function blockDay(){
  const d = $("#bStart").value.split("T")[0];
  const body = { date: d, reason: $("#bReason").value };
  const r = await fetch("/api/admin/closure/day",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  $("#bInfo").textContent = r.ok ? "Day blocked." : "Block failed";
  loadBlocks();
}
async function loadBlocks(){
  const r = await fetch("/api/admin/closure"); const list = await r.json();
  const el = $("#blockList"); el.innerHTML="";
  list.forEach(b=>{
    const div = document.createElement("div");
    div.className="blockitem";
    div.innerHTML = `<div><b>${b.startTs}</b> → <b>${b.endTs}</b> &nbsp; ${b.reason||""}</div>
                     <button class="btn secondary" data-id="${b.id}">Delete</button>`;
    el.appendChild(div);
  });
  el.querySelectorAll("[data-id]").forEach(btn=>{
    btn.addEventListener("click", async()=>{
      await fetch("/api/admin/closure/"+btn.dataset.id,{method:"DELETE"}); loadBlocks();
    });
  });
}

(function init(){
  loadCfg();
  const now = new Date();
  $("#fltDate").value = ymd(now);
  $("#wDate").value = ymd(now);
  $("#bStart").value = ymd(now)+"T10:00";
  $("#bEnd").value = ymd(now)+"T22:00";
  $("#loadBtn").addEventListener("click", loadList);
  $("#expBtn").addEventListener("click", exportXlsx);
  $("#wSave").addEventListener("click", saveWalk);
  $("#bCreate").addEventListener("click", createBlock);
  $("#bDay").addEventListener("click", blockDay);
  loadList(); loadBlocks();
})();
</script>
</body>
</html>

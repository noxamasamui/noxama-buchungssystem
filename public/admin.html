<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Contact and Table Booking</title>
<link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <div class="wrapper">
    <header class="header">
      <img class="logo" id="heroLogo" alt="RÖSTILAND"/>
      <h1 class="h1">Contact and Table Booking</h1>
    </header>

    <section class="card contact" id="contactCard">
      <div>
        <h3>Address</h3>
        <div id="addrText">—</div>
        <small>Thailand</small>
      </div>
      <a class="pill" id="telPill" href="#"><span>Phone</span></a>
      <a class="pill" id="mailPill" href="#"><span>Email</span></a>
    </section>

    <section class="section card">
      <div class="row">
        <div>
          <div class="label">Date</div>
          <div class="inline">
            <input class="input" id="date" type="date"/>
          </div>
        </div>
        <div>
          <div class="label">Guests (max 10 online)</div>
          <div class="inline">
            <select class="select" id="guests"></select>
            <a class="btn secondary" id="groupBtn" target="_blank" rel="noopener">Group 11+?</a>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="label">Choose a time slot</div>
        <div class="slots">
          <div id="slotMsg" class="helper">Select date & guests to see available slots.</div>
          <div id="slotGrid" class="slotgrid"></div>
        </div>
      </div>

      <div class="section row">
        <div>
          <div class="label">First name*</div>
          <input class="input" id="firstName" placeholder="First name"/>
        </div>
        <div>
          <div class="label">Name*</div>
          <input class="input" id="name" placeholder="Last name"/>
        </div>
        <div>
          <div class="label">Email*</div>
          <input class="input" id="email" placeholder="mail@example.com"/>
        </div>
        <div>
          <div class="label">Phone (optional)</div>
          <input class="input" id="phone" placeholder=""/>
        </div>
      </div>

      <div class="section">
        <div class="label">Notes</div>
        <textarea class="input" id="notes" rows="3" placeholder="Allergies, seating request, occasion"></textarea>
      </div>

      <div class="inline section">
        <button class="btn" id="bookBtn" disabled>Book now</button>
        <div id="formHint" class="helper"></div>
      </div>

      <div id="info" class="notice" style="display:none"></div>
    </section>
  </div>

<script>
const $ = sel => document.querySelector(sel);
const cfg = {brand:"", phone:"", email:"", logoUrl:"", group:{label:"Group 11+?",tel:"",mail:""}};
let pickedTime = "";

function setGuests() {
  const sel = $("#guests");
  sel.innerHTML = "";
  for (let i=1;i<=10;i++){
    const o = document.createElement("option");
    o.value = i; o.textContent = i;
    sel.appendChild(o);
  }
}
function setContact() {
  $("#addrText").textContent = cfg.address || "—";
  const telHref = cfg.phone ? "tel:"+cfg.phone.replace(/\s/g,"") : "#";
  const mailHref = cfg.email ? "mailto:"+cfg.email : "#";
  $("#telPill").href = telHref;
  $("#telPill").title = cfg.phone;
  $("#telPill").innerHTML = "<span>Phone</span>";
  $("#mailPill").href = mailHref;
  $("#mailPill").title = cfg.email;
  $("#mailPill").innerHTML = "<span>"+(cfg.email||"Email")+"</span>";

  const group = cfg.group||{};
  $("#groupBtn").textContent = group.label || "Group 11+?";
  const gTel = group.tel ? "tel:"+group.tel.replace(/\s/g,"") : "";
  const gMail = group.mail ? "mailto:"+group.mail : "";
  $("#groupBtn").href = gTel || gMail || "#";
}
function setLogo(){
  const img = $("#heroLogo");
  img.src = cfg.logoUrl || "/logo-hero.png";
}
function ymd(d){
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

async function loadConfig(){
  const r = await fetch("/api/config"); Object.assign(cfg, await r.json());
  setLogo(); setContact(); setGuests();
  const today = new Date(); $("#date").value = ymd(today);
  refreshSlots();
}

async function refreshSlots(){
  $("#slotGrid").innerHTML = "";
  pickedTime = "";
  $("#bookBtn").disabled = true;
  const date = $("#date").value;
  const guests = $("#guests").value;

  if(!date){ $("#slotMsg").textContent = "Select a date."; return; }

  const r = await fetch(`/api/slots?date=${encodeURIComponent(date)}`);
  const slots = await r.json();

  let added = 0;
  for(const s of slots){
    const btn = document.createElement("button");
    btn.type="button";
    btn.className="slot";
    btn.textContent = s.time;
    if(!s.canReserve){ btn.disabled = true; }
    btn.addEventListener("click", () => {
      document.querySelectorAll(".slot.selected").forEach(n=>n.classList.remove("selected"));
      btn.classList.add("selected");
      pickedTime = s.time;
      $("#bookBtn").disabled = false;
      $("#formHint").textContent = "";
    });
    $("#slotGrid").appendChild(btn);
    added++;
  }
  $("#slotMsg").textContent = added ? "Pick a time." : "We are fully booked or closed on this date. Please choose another day.";
}

async function book(){
  const payload = {
    date: $("#date").value,
    time: pickedTime,
    firstName: $("#firstName").value.trim(),
    name: $("#name").value.trim(),
    email: $("#email").value.trim(),
    phone: $("#phone").value.trim(),
    guests: Number($("#guests").value),
    notes: $("#notes").value.trim()
  };
  if(!payload.firstName || !payload.name || !payload.email || !pickedTime){
    $("#formHint").textContent = "Please fill all required fields and pick a time."; return;
  }
  $("#bookBtn").disabled = true;
  const res = await fetch("/api/reservations",{
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const out = await res.json();
  const info = $("#info");
  info.style.display = "block";
  if(res.ok){
    info.textContent = "Your reservation has been received. You will get a confirmation email shortly.";
  }else{
    info.textContent = out.error || "Booking failed";
    $("#bookBtn").disabled = false;
  }
}

$("#date").addEventListener("change", refreshSlots);
$("#guests").addEventListener("change", refreshSlots);
$("#bookBtn").addEventListener("click", book);

loadConfig();
</script>
</body>
</html>

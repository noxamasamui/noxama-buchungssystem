<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin â€” Reservations</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="container">
    <h1>Admin</h1>

    <section class="card">
      <div class="grid">
        <label class="field">
          <span>Key</span>
          <input id="key" placeholder="x-admin-key" />
        </label>
        <label class="field">
          <span>From</span>
          <input id="from" type="date" />
        </label>
        <label class="field">
          <span>To</span>
          <input id="to" type="date" />
        </label>
      </div>
      <div class="actions">
        <button id="btnLoad" class="btn">Load</button>
        <button id="btnExport" class="btn outline">Export CSV</button>
      </div>

      <div class="table-wrap">
        <table class="table" id="tbl">
          <thead>
            <tr>
              <th>Date</th><th>Time</th><th>Name</th><th>Email</th>
              <th>Guests</th><th>Status</th><th>Walk-in</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h3>Add walk-in</h3>
      <div class="grid">
        <label class="field">
          <span>Date</span><input id="wDate" type="date" />
        </label>
        <label class="field">
          <span>Time</span><input id="wTime" placeholder="HH:MM" />
        </label>
        <label class="field">
          <span>Guests</span><input id="wGuests" type="number" min="1" max="10" value="2" />
        </label>
      </div>
      <label class="field">
        <span>Notes</span><input id="wNotes" />
      </label>
      <div class="actions">
        <button id="btnWalk" class="btn">Save walk-in</button>
      </div>
    </section>

    <section class="card">
      <h3>Block day (quick)</h3>
      <div class="grid">
        <label class="field"><span>Day</span><input id="bDay" type="date" /></label>
        <label class="field"><span>Reason</span><input id="bReason" value="Closed / Private event" /></label>
      </div>
      <div class="actions">
        <button id="btnBlock" class="btn danger">Block whole day</button>
      </div>
    </section>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    const key = $("#key"), from = $("#from"), to = $("#to");
    const tbl = $("#tbl tbody");

    function ymd(d){
      const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,"0"), da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }

    async function loadList() {
      tbl.innerHTML = "";
      const qs = new URLSearchParams({ from: from.value, to: to.value });
      const r = await fetch(`/api/admin/reservations?${qs}`, {
        headers: { "x-admin-key": key.value }
      });
      if (!r.ok) { alert("Auth or range error"); return; }
      const data = await r.json();
      data.rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.time}</td>
          <td>${r.firstName} ${r.name}</td>
          <td>${r.email}</td>
          <td>${r.guests}</td>
          <td>${r.status}</td>
          <td>${r.isWalkIn ? "yes" : ""}</td>`;
        tbl.appendChild(tr);
      });
    }

    async function exportCsv() {
      const qs = new URLSearchParams({ from: from.value, to: to.value });
      const r = await fetch(`/api/admin/export.csv?${qs}`, { headers: { "x-admin-key": key.value } });
      if (!r.ok) { alert("Auth or range error"); return; }
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `export_${from.value}_${to.value}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function saveWalkin() {
      const payload = {
        date: $("#wDate").value, time: $("#wTime").value,
        guests: Number($("#wGuests").value), notes: $("#wNotes").value || null
      };
      const r = await fetch(`/api/admin/walkin`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "x-admin-key": key.value },
        body: JSON.stringify(payload)
      });
      if (!r.ok) { const d = await r.json(); alert(d.error || "Error"); return; }
      await loadList();
      alert("Saved");
    }

    async function blockDay() {
      const payload = { day: $("#bDay").value, reason: $("#bReason").value };
      const r = await fetch(`/api/admin/block-day`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "x-admin-key": key.value },
        body: JSON.stringify(payload)
      });
      if (!r.ok) { const d = await r.json(); alert(d.error || "Error"); return; }
      await loadList();
      alert("Blocked");
    }

    document.addEventListener("DOMContentLoaded", () => {
      const t = new Date();
      from.value = ymd(t);
      to.value = ymd(t);
      $("#wDate").value = ymd(t);
      $("#bDay").value = ymd(t);

      $("#btnLoad").onclick = loadList;
      $("#btnExport").onclick = exportCsv;
      $("#btnWalk").onclick = saveWalkin;
      $("#btnBlock").onclick = blockDay;
    });
  </script>
</body>
</html>

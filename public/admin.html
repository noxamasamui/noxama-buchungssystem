<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin — Reservations</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .toolbar{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th,.table td{padding:10px 12px;background:#faefe0}
    .table th{background:#eddcc5;text-align:left}
    .table .cell-actions{white-space:nowrap}
    .btn.small{padding:8px 12px;font-size:14px}
    .muted{opacity:.8}
    .blocked-list{padding:10px 12px;background:#faefe0;border-radius:12px}
    .blocked-item{display:flex;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px solid #ead6b6}
    .blocked-item:last-child{border-bottom:0}
    .danger{background:#fff2f2;border:1px solid #f1c6c6}
  </style>
</head>

<body class="page">
  <header class="hero">
  <img
    src="https://i.imgur.com/LQ4nzwd.png"
    alt="RÖSTILAND"
    onerror="this.src='/logo-hero.png'">
</header>
  <header class="hero small">
    <img src="/logo-hero.png" alt="RÖSTILAND" class="hero-img">
  </header>

  <main class="container">
    <h1 class="page-title">Admin</h1>

    <!-- Filter + Export -->
    <section class="card">
      <h2 class="card-title">All reservations</h2>
      <div class="toolbar">
        <div>
          <label class="label">Date filter</label>
          <input id="fltDate" type="date" class="input">
        </div>
        <div>
          <label class="label">View</label>
          <select id="fltView" class="input">
            <option value="day">day</option>
            <option value="week" selected>week</option>
            <option value="month">month</option>
          </select>
        </div>
        <button id="btnLoad" class="btn primary">Load</button>

        <div style="margin-left:auto"></div>

        <div>
          <label class="label">Export</label>
          <div class="toolbar">
            <select id="expPeriod" class="input">
              <option value="daily">daily</option>
              <option value="weekly" selected>weekly</option>
              <option value="monthly">monthly</option>
              <option value="yearly">yearly</option>
            </select>
            <button id="btnExport" class="btn">Excel</button>
          </div>
        </div>
      </div>

      <div class="table-wrap mt">
        <table class="table" id="tbl">
          <thead>
            <tr>
              <th>Date</th><th>Time</th><th>Name</th><th>Email</th><th>Phone</th><th>Guests</th><th>Status</th><th>Notes</th><th>Walk in</th><th class="cell-actions">Action</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
        <div id="listMsg" class="help"></div>
      </div>
    </section>

    <!-- Walk in -->
    <section class="card">
      <h2 class="card-title">Add walk in</h2>
      <div class="grid3">
        <div>
          <label class="label">Date</label>
          <input id="wDate" type="date" class="input">
        </div>
        <div>
          <label class="label">Time</label>
          <input id="wTime" type="time" class="input" value="10:00" step="900">
        </div>
        <div>
          <label class="label">Guests</label>
          <select id="wGuests" class="input">
            <option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
          </select>
        </div>
      </div>
      <label class="label">Notes</label>
      <input id="wNotes" class="input" placeholder="Table, source, anything...">
      <div class="btn-row">
        <button id="btnWalk" class="btn primary">Save walk in</button>
      </div>
      <div id="walkMsg" class="help"></div>
    </section>

    <!-- Blocks (moved to the bottom) -->
    <section class="card">
      <h2 class="card-title">Blocked periods</h2>
      <div id="blocked" class="blocked-list"></div>
    </section>

    <section class="card">
      <h2 class="card-title">Block restaurant</h2>
      <div class="grid3">
        <div>
          <label class="label">Start</label>
          <input id="bStart" type="datetime-local" class="input">
        </div>
        <div>
          <label class="label">End</label>
          <input id="bEnd" type="datetime-local" class="input">
        </div>
        <div>
          <label class="label">Reason</label>
          <input id="bReason" class="input" placeholder="Private event, maintenance, …" value="Closed">
        </div>
      </div>
      <div class="btn-row">
        <button id="btnBlock" class="btn">Create block</button>
        <button id="btnBlockDay" class="btn">Block day (from Start)</button>
      </div>
      <div id="blockMsg" class="help"></div>
    </section>

    <!-- Danger zone -->
    <section class="card danger">
      <h2 class="card-title">Danger</h2>
      <p class="help">Reset all reservations to zero (keeps blocks). Requires <code>ADMIN_RESET_KEY</code> in env.</p>
      <button id="btnReset" class="btn">Reset all reservations</button>
    </section>

  </main>

  <script>
  (function(){
    const $ = sel => document.querySelector(sel);
    const rows = $('#rows');

    document.addEventListener('DOMContentLoaded', init);

    async function init(){
      // defaults
      const d = new Date();
      const yyyy = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
      $('#fltDate').value = `${yyyy}-${mm}-${dd}`;
      $('#wDate').value   = `${yyyy}-${mm}-${dd}`;

      // events
      $('#btnLoad').addEventListener('click', loadList);
      $('#btnExport').addEventListener('click', exportExcel);
      $('#btnWalk').addEventListener('click', saveWalkin);

      $('#btnBlock').addEventListener('click', createBlock);
      $('#btnBlockDay').addEventListener('click', createBlockDay);

      $('#btnReset').addEventListener('click', resetAll);

      // first load
      loadList();
      loadBlocks();
    }

    async function loadList(){
      rows.innerHTML = '';
      $('#listMsg').textContent='';
      try{
        const date = $('#fltDate').value;
        const view = $('#fltView').value;
        const list = await fetch(`/api/admin/reservations?date=${encodeURIComponent(date)}&view=${encodeURIComponent(view)}`).then(r=>r.json());
        if(!list.length){
          $('#listMsg').textContent='No reservations for this period.';
          return;
        }
        list.forEach(addRow);
      }catch(e){
        $('#listMsg').textContent='Failed to load reservations.';
      }
    }

    function addRow(r){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.date}</td>
        <td>${r.time}</td>
        <td>${r.firstName||''} ${r.name||''}</td>
        <td>${r.email||''}</td>
        <td>${r.phone||''}</td>
        <td>${r.guests}</td>
        <td>${r.status}</td>
        <td>${r.notes||''}</td>
        <td>${r.isWalkIn ? 'yes' : ''}</td>
        <td class="cell-actions">
          <button class="btn small danger" data-del="${r.id}">Delete</button>
          <button class="btn small" data-noshow="${r.id}">No show</button>
        </td>`;
      // actions
      tr.querySelector('[data-del]').addEventListener('click', async (ev)=>{
        const id = ev.currentTarget.getAttribute('data-del');
        if(!confirm('Delete this reservation?')) return;
        try{
          await fetch(`/api/admin/reservations/${id}`,{method:'DELETE'});
          tr.remove();
        }catch(e){ alert('Delete failed'); }
      });
      tr.querySelector('[data-noshow]').addEventListener('click', async (ev)=>{
        const id = ev.currentTarget.getAttribute('data-noshow');
        try{
          const r = await fetch(`/api/admin/reservations/${id}/noshow`,{method:'POST'}).then(r=>r.json());
          tr.children[6].textContent = r.status;
        }catch(e){ alert('Mark no-show failed'); }
      });

      rows.appendChild(tr);
    }

    async function exportExcel(){
      const period = $('#expPeriod').value;
      const date   = $('#fltDate').value;
      const url    = `/api/export?period=${encodeURIComponent(period)}&date=${encodeURIComponent(date)}`;
      // force download
      const a = document.createElement('a');
      a.href = url; a.download = '';
      document.body.appendChild(a); a.click(); a.remove();
    }

    async function saveWalkin(){
      $('#walkMsg').textContent='';
      try{
        const payload = {
          date: $('#wDate').value,
          time: $('#wTime').value,
          guests: Number($('#wGuests').value),
          notes: $('#wNotes').value
        };
        const r = await fetch('/api/walkin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!r.ok){
          const e = await r.json().catch(()=>({error:'Failed'}));
          throw new Error(e.error||'Failed');
        }
        $('#walkMsg').textContent='Saved.';
        loadList();
      }catch(e){
        $('#walkMsg').textContent = e.message || 'Failed to save walk-in';
      }
    }

    // ---- Blocks ----
    async function loadBlocks(){
      const wrap = $('#blocked');
      wrap.innerHTML = '';
      try{
        const list = await fetch('/api/admin/closure').then(r=>r.json());
        if(!list.length){ wrap.textContent = 'No blocks.'; return; }
        list.forEach(b=>{
          const div = document.createElement('div');
          div.className = 'blocked-item';
          const start = new Date(b.startTs).toLocaleString();
          const end   = new Date(b.endTs).toLocaleString();
          div.innerHTML = `
            <div><b>${start}</b> — <b>${end}</b> <span class="muted">(${b.reason||'Closed'})</span></div>
            <div><button class="btn small danger" data-bdel="${b.id}">Remove</button></div>`;
          div.querySelector('[data-bdel]').addEventListener('click', async ()=>{
            if(!confirm('Remove this block?')) return;
            try{ await fetch('/api/admin/closure/'+b.id,{method:'DELETE'}); div.remove(); }
            catch(e){ alert('Delete block failed'); }
          });
          wrap.appendChild(div);
        });
      }catch(e){
        wrap.textContent = 'Failed to load blocks.';
      }
    }

    async function createBlock(){
      $('#blockMsg').textContent='';
      try{
        const payload = {
          startTs: $('#bStart').value.replace('T',' '),
          endTs:   $('#bEnd').value.replace('T',' '),
          reason:  $('#bReason').value
        };
        const r = await fetch('/api/admin/closure',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!r.ok){
          const e = await r.json().catch(()=>({error:'Failed'}));
          throw new Error(e.error||'Failed');
        }
        $('#blockMsg').textContent='Block saved.';
        loadBlocks();
      }catch(e){
        $('#blockMsg').textContent = e.message || 'Failed to create block';
      }
    }

    async function createBlockDay(){
      $('#blockMsg').textContent='';
      try{
        const dt = $('#bStart').value.split('T')[0]; // only date
        const r = await fetch('/api/admin/closure/day',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body: JSON.stringify({date: dt, reason: $('#bReason').value})
        });
        if(!r.ok){
          const e = await r.json().catch(()=>({error:'Failed'}));
          throw new Error(e.error||'Failed');
        }
        $('#blockMsg').textContent='Day blocked.';
        loadBlocks();
      }catch(e){
        $('#blockMsg').textContent = e.message || 'Failed to block day';
      }
    }

    // ---- Reset all reservations ----
    async function resetAll(){
      const key = prompt('Type admin reset key to confirm:');
      if(!key) return;
      try{
        const r = await fetch('/api/admin/reset',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({key})
        });
        if(!r.ok){
          const e = await r.json().catch(()=>({error:'Failed'}));
          throw new Error(e.error||'Failed');
        }
        alert('All reservations reset.');
        loadList();
      }catch(e){
        alert(e.message || 'Reset failed');
      }
    }
  })();
  </script>
</body>
</html>

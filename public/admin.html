<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin — Reservations</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <header class="header">
    <div class="logo-wrap">
      <!-- full-width banner; falls back to same image -->
      <img id="brandBanner" class="logo" src="/logo-hero.png" alt="Logo"/>
    </div>
  </header>

  <main class="container">

    <h1 class="center">Admin</h1>

    <!-- Blocked periods overview -->
    <section class="card" id="blocksCard">
      <div class="flex">
        <h2 style="margin-right:8px;">Blocked periods</h2>
        <span class="small">Create and remove maintenance or private events</span>
        <span class="right small" id="tzInfo"></span>
      </div>
      <div id="blocksList" class="blocks"></div>
    </section>

    <!-- Reservations list -->
    <section class="card">
      <h2>All reservations</h2>

      <div class="toolbar">
        <div class="field">
          <label for="filterDate">Date filter</label>
          <input type="date" id="filterDate"/>
        </div>

        <div class="field">
          <label for="viewMode">View</label>
          <select id="viewMode">
            <option value="day">day</option>
            <option value="week" selected>week</option>
            <option value="month">month</option>
          </select>
        </div>

        <button class="btn" id="btnLoad">Load</button>

        <div class="right flex">
          <div class="field">
            <label for="exportPeriod">Export</label>
            <select id="exportPeriod">
              <option value="daily">daily</option>
              <option value="weekly" selected>weekly</option>
              <option value="monthly">monthly</option>
              <option value="yearly">yearly</option>
            </select>
          </div>
          <button class="btn outline" id="btnExport">Excel</button>
        </div>
      </div>

      <div style="overflow:auto; margin-top:12px;">
        <table class="table" id="reservationsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Guests</th>
              <th>Status</th>
              <th>Notes</th>
              <th>Walk in</th>
              <th>Visits</th>
              <th class="right">Action</th>
            </tr>
          </thead>
          <tbody id="reservationsBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Walk in + Close day -->
    <section class="card">
      <h2>Add walk in</h2>
      <div class="flex">
        <div style="flex:1; min-width:220px;">
          <label>Date</label>
          <input type="date" id="wiDate">
        </div>
        <div style="flex:1; min-width:160px;">
          <label>Time</label>
          <input type="time" id="wiTime" value="10:00">
        </div>
        <div style="flex:1; min-width:120px;">
          <label>Guests</label>
          <input type="number" id="wiGuests" min="1" value="2">
        </div>
      </div>
      <label>Notes</label>
      <input type="text" id="wiNotes" placeholder="Table, source, anything…"/>
      <div style="margin-top:10px;">
        <button class="btn" id="btnWalkIn">Save walk in</button>
        <span class="small" id="wiMsg"></span>
      </div>
    </section>

    <!-- Create block -->
    <section class="card" id="blockTools">
      <h2>Block restaurant</h2>
      <div class="flex">
        <div style="flex:1; min-width:240px;">
          <label>Start</label>
          <input type="datetime-local" id="blStart">
        </div>
        <div style="flex:1; min-width:240px;">
          <label>End</label>
          <input type="datetime-local" id="blEnd">
        </div>
      </div>
      <label>Reason</label>
      <input type="text" id="blReason" value="Closed"/>
      <div style="margin-top:10px;" class="flex">
        <button class="btn" id="btnCreateBlock">Create block</button>
        <div class="right"></div>
        <div class="small">or block a full day:</div>
        <input type="date" id="blDay" />
        <button class="btn outline" id="btnBlockDay">Block day</button>
        <span class="small" id="blMsg"></span>
      </div>
    </section>

    <!-- Danger zone -->
    <section class="card">
      <h2>Danger</h2>
      <p class="small">Reset all reservations to zero (keeps blocks). Requires <code>ADMIN_RESET_KEY</code> in env.</p>
      <button class="btn warn" id="btnResetAll">Reset all reservations</button>
    </section>

    <div class="spacer"></div>
  </main>

  <script>
    // --- tiny helpers
    const $ = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));

    let CONFIG = { logo: "/logo.png" };

    function fmtDate(d){ return new Date(d).toISOString().slice(0,10); }

    async function loadConfig(){
      const r = await fetch("/api/config"); CONFIG = await r.json();
      // Banner: if a dedicated banner exists, use it; otherwise same logo
      const hero = CONFIG.logo || "/logo.png";
      $("#brandBanner").src = hero;
      $("#tzInfo").textContent = `Times shown in local server time`;
    }

    // -------- reservations list
    async function loadReservations(){
      const date = $("#filterDate").value || fmtDate(new Date());
      const view = $("#viewMode").value;
      const url = `/api/admin/reservations?date=${encodeURIComponent(date)}&view=${encodeURIComponent(view)}`;
      const r = await fetch(url);
      const list = await r.json();
      const tbody = $("#reservationsBody");
      tbody.innerHTML = "";
      if(!Array.isArray(list) || list.length===0){
        tbody.innerHTML = `<tr><td colspan="11" class="small">No entries</td></tr>`;
        return;
      }
      for(const it of list){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${it.date}</td>
          <td>${it.time}</td>
          <td>${it.firstName||""} ${it.name||""}</td>
          <td>${it.email||""}</td>
          <td>${it.phone||""}</td>
          <td>${it.guests}</td>
          <td><span class="pill ${it.status==='confirmed'?'ok':(it.status==='canceled'?'bad':'warn')}">${it.status}</span></td>
          <td>${it.notes||""}</td>
          <td>${it.isWalkIn?'<span class="pill walk">yes</span>':''}</td>
          <td>${it.visitCount||0} (${it.discount||0}%)</td>
          <td class="row-actions right">
            <button class="btn outline" data-act="noshow" data-id="${it.id}">No show</button>
            <button class="btn warn" data-act="delete" data-id="${it.id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    // row actions
    $("#reservationsBody").addEventListener("click", async (ev)=>{
      const b = ev.target.closest("button[data-act]");
      if(!b) return;
      const id = b.getAttribute("data-id");
      const act = b.getAttribute("data-act");

      try{
        if(act==="delete"){
          if(!confirm("Delete this reservation?")) return;
          await fetch(`/api/admin/reservations/${id}`, { method:"DELETE" });
        }else if(act==="noshow"){
          await fetch(`/api/admin/reservations/${id}/noshow`, { method:"POST" });
        }
        await loadReservations();
      }catch(e){
        alert("Action failed");
      }
    });

    // export
    $("#btnExport").addEventListener("click", ()=>{
      const date = $("#filterDate").value || fmtDate(new Date());
      const period = $("#exportPeriod").value || "weekly";
      window.location.href = `/api/export?period=${encodeURIComponent(period)}&date=${encodeURIComponent(date)}`;
    });

    // walk in
    $("#btnWalkIn").addEventListener("click", async ()=>{
      $("#wiMsg").textContent = "";
      try{
        const body = {
          date: $("#wiDate").value,
          time: $("#wiTime").value,
          guests: Number($("#wiGuests").value||0),
          notes: $("#wiNotes").value
        };
        const r = await fetch("/api/walkin",{method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        const j = await r.json();
        if(!r.ok){ $("#wiMsg").textContent = j.error || "Failed"; return; }
        $("#wiMsg").textContent = "Saved.";
        await loadReservations();
      }catch(e){ $("#wiMsg").textContent = "Failed"; }
    });

    // blocks load
    async function loadBlocks(){
      const r = await fetch("/api/admin/closure");
      const list = await r.json();
      const wrap = $("#blocksList");
      wrap.innerHTML = "";
      if(!Array.isArray(list) || list.length===0){
        wrap.innerHTML = `<div class="small">No blocks</div>`;
        return;
      }
      for(const c of list){
        const el = document.createElement("div");
        el.className = "block";
        const from = new Date(c.startTs).toLocaleString();
        const to = new Date(c.endTs).toLocaleString();
        el.innerHTML = `
          <div class="flex">
            <div><b>${from}</b> &nbsp;—&nbsp; <b>${to}</b> &nbsp; <span class="small">(${c.reason})</span></div>
            <div class="right">
              <button class="btn outline" data-del-block="${c.id}">Remove</button>
            </div>
          </div>`;
        wrap.appendChild(el);
      }
    }

    // create block
    $("#btnCreateBlock").addEventListener("click", async ()=>{
      $("#blMsg").textContent="";
      try{
        const body = {
          startTs: $("#blStart").value,
          endTs: $("#blEnd").value,
          reason: $("#blReason").value||"Closed"
        };
        const r = await fetch("/api/admin/closure",{method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        const j = await r.json();
        if(!r.ok){ $("#blMsg").textContent = j.error||"Failed"; return;}
        $("#blMsg").textContent = "Created.";
        await loadBlocks();
      }catch(e){ $("#blMsg").textContent="Failed"; }
    });

    // block day
    $("#btnBlockDay").addEventListener("click", async ()=>{
      $("#blMsg").textContent="";
      try{
        const body = { date: $("#blDay").value, reason: $("#blReason").value||"Closed" };
        const r = await fetch("/api/admin/closure/day",{method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        const j = await r.json();
        if(!r.ok){ $("#blMsg").textContent = j.error||"Failed"; return;}
        $("#blMsg").textContent = "Day blocked.";
        await loadBlocks();
      }catch(e){ $("#blMsg").textContent="Failed"; }
    });

    // remove block
    $("#blocksList").addEventListener("click", async (ev)=>{
      const b = ev.target.closest("[data-del-block]");
      if(!b) return;
      const id = b.getAttribute("data-del-block");
      if(!confirm("Remove this block?")) return;
      await fetch(`/api/admin/closure/${id}`, { method:"DELETE" });
      await loadBlocks();
    });

    // reset all
    $("#btnResetAll").addEventListener("click", async ()=>{
      const key = prompt("Type admin reset key to confirm:");
      if(!key) return;
      const r = await fetch("/api/admin/reset",{method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify({key})});
      const j = await r.json();
      if(!r.ok){ alert(j.error||"Failed"); return; }
      alert("All reservations removed.");
      await loadReservations();
    });

    // load button
    $("#btnLoad").addEventListener("click", loadReservations);

    // init
    (async function init(){
      await loadConfig();
      const today = new Date();
      $("#filterDate").value = fmtDate(today);
      $("#wiDate").value = fmtDate(today);
      $("#blDay").value = fmtDate(today);
      $("#blStart").value = fmtDate(today)+"T10:00";
      $("#blEnd").value = fmtDate(today)+"T22:00";
      await loadReservations();
      await loadBlocks();
    })();
  </script>
</body>
</html>

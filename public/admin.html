<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin — ROESTILAND BY NOXAMA SAMUI</title>
  <link rel="stylesheet" href="/style.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* Nur Admin-spezifische Styles, keine Logik-Änderungen */
    .hero-wrap { padding: 18px 0; text-align: center; }
    .hero-banner { max-width: 480px; width: 100%; height: auto; display: inline-block; object-fit: contain; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    .hero-banner.img-fallback { max-height: 160px; }
    .btn, button[type="submit"], .reserve-btn { padding: 12px 20px; font-size: 16px; border-radius: 8px; cursor: pointer; }
    .table-wrap { overflow:auto; max-width:100%; }
    table { border-collapse: collapse; width:100%; font-size:14px; }
    table th, table td { padding:8px 10px; text-align:left; vertical-align:middle; }
    .badge { display:inline-block; padding:6px 10px; border-radius:6px; background:#f3f0e7; margin-right:8px; }
    .card { margin-bottom:20px; padding:16px; background:#fff8f0; border:1px solid #e0d7c5; border-radius:10px; box-shadow:0 6px 14px rgba(0,0,0,0.06); }
    label { display:block; margin-bottom:6px; font-weight:700; color:#3a2f28; }
    input[type="text"], input[type="date"], input[type="datetime-local"], textarea, select { width:100%; padding:8px 10px; border-radius:6px; border:1px solid #c8b99e; box-sizing:border-box; background:#fff; }
    .row { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .row > div { flex:1 1 200px; min-width:180px; }
    .small { flex:0 0 160px; }
    .actions { display:flex; gap:8px; align-items:center; }
    .btn-plain { background:transparent; border:1px solid #e0d7c5; padding:8px 12px; border-radius:8px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="hero-wrap" aria-hidden="false">
    <img id="heroBanner" class="hero-banner" src="/logo-hero.png" alt="Logo banner"/>
  </div>

  <nav style="text-align:center;margin-bottom:10px;"><a href="/">Reservation</a> <a class="active" href="/admin" style="background:#b3822f;color:#fff;padding:6px 10px;border-radius:6px;margin-left:8px;">Admin</a></nav>
  <div style="max-width:1100px;margin:0 auto;padding:14px;">
    <h1 style="margin-bottom:12px;">Admin</h1>

    <!-- Reservations list (unchanged) -->
    <div class="card">
      <h2 style="margin-top:0;">All reservations</h2>
      <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;">
        <div style="flex:0 0 260px;">
          <label>Date filter</label>
          <input id="fltDate" type="date"/>
        </div>
        <div style="flex:0 0 160px;">
          <label>View</label>
          <select id="view"><option value="day">day</option><option value="week" selected>week</option><option value="month">month</option></select>
        </div>
        <div class="actions" style="margin-left:auto;">
          <button class="btn" id="btnLoad" type="button">Load</button>
        </div>
        <div style="flex:0 0 220px;">
          <label>Export</label>
          <div style="display:flex;gap:8px;">
            <select id="period" style="flex:1;">
              <option value="daily">daily</option>
              <option value="weekly" selected>weekly</option>
              <option value="monthly">monthly</option>
              <option value="yearly">yearly</option>
            </select>
            <button class="btn" id="btnExport" type="button">Excel</button>
          </div>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:12px;">
        <table id="tbl">
          <thead>
            <tr>
              <th class="col-date">Date</th>
              <th class="col-time">Time</th>
              <th>Name</th>
              <th>Email</th>
              <th class="col-phone">Phone</th>
              <th class="col-guests">Guests</th>
              <th>Status</th>
              <th>Notes</th>
              <th>Visit</th>
              <th>Discount</th>
              <th class="col-walkin">Walk in</th>
              <th class="col-actions">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="sum" class="badge" style="margin-top:10px;"></div>
    </div>

    <!-- Walk-in (unchanged) -->
    <div class="card" style="margin-top:16px;">
      <h2 style="margin-top:0;">Add walk in</h2>
      <div class="row" style="margin-bottom:8px;">
        <div><label>Date</label><input id="wDate" type="date"/></div>
        <div><label>Time</label><select id="wTime"></select></div>
        <div class="small"><label>Guests</label><input id="wGuests" type="number" min="1" max="48" value="2"/></div>
      </div>
      <div style="margin-bottom:8px;">
        <label>Notes</label>
        <input id="wNotes" />
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        <button id="btnWalk" class="btn" type="button">Save walk in</button>
        <span id="wMsg" class="badge"></span>
      </div>
    </div>

    <!-- Block restaurant (separate, restored) -->
    <div class="card" style="margin-top:16px;">
      <h2 style="margin-top:0;">Block restaurant (close / block time)</h2>
      <div class="row" style="margin-bottom:8px;">
        <div><label>Start</label><input id="cStart" type="datetime-local"/></div>
        <div><label>End</label><input id="cEnd" type="datetime-local"/></div>
        <div class="small" style="align-self:flex-end;">
          <button id="btnBlock" class="btn" type="button">Create block</button>
        </div>
      </div>
      <div style="margin-top:6px;">
        <small>Use "Block day (from Start)" to block an entire day (open→close)</small>
        <div style="margin-top:8px;">
          <button id="btnBlockDayPicker" class="btn-plain" type="button">Block day (from Start)</button>
          <span id="cMsg" class="badge"></span>
        </div>
      </div>
      <div id="closureList" style="margin-top:12px;"></div>
    </div>

    <!-- Customer notice (separate, restored) -->
    <div class="card" style="margin-top:16px;">
      <h2 style="margin-top:0;">Customer notice (date-specific message)</h2>
      <div style="margin-bottom:8px;">
        <label>Date (notice applies to)</label>
        <input id="nDate" type="date" />
      </div>
      <div style="margin-bottom:8px;">
        <label>Title (displayed to customers)</label>
        <input id="nTitle" type="text" placeholder="e.g. Christmas menu — special info" />
      </div>
      <div style="margin-bottom:8px;">
        <label>Message (visible to customers when they pick date)</label>
        <textarea id="nMessage" rows="3" placeholder="Full message customers see"></textarea>
      </div>
      <div style="display:flex;gap:12px;align-items:center;">
        <button id="btnNoticeCreate" class="btn" type="button">Create notice</button>
        <span id="nMsg" class="badge"></span>
      </div>
      <div id="noticeList" style="margin-top:12px;"></div>
    </div>

  </div>

<script>
  /* Minimal, nur UI wiring — Backend-API unverändert */
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };
  document.getElementById("fltDate").value = today();
  document.getElementById("wDate").value = today();

  // walkin times
  function fillWalkInTimes(){
    const sel = document.getElementById("wTime");
    sel.innerHTML = "";
    const from = 10*60, to = 22*60;
    for(let m=from;m<=to;m+=15){
      const hh=String(Math.floor(m/60)).padStart(2,"0");
      const mm=String(m%60).padStart(2,"0");
      const opt=document.createElement("option");
      opt.value=`${hh}:${mm}`; opt.textContent=opt.value;
      sel.appendChild(opt);
    }
  }
  fillWalkInTimes();

  // reservations list
  async function loadList(){
    const d = document.getElementById("fltDate").value || today();
    const v = document.getElementById("view").value || "week";
    const r = await fetch(`/api/admin/reservations?date=${encodeURIComponent(d)}&view=${v}`);
    if(!r.ok){ console.error('loadList failed', r.status); return; }
    const data = await r.json();
    const tb = document.querySelector("#tbl tbody");
    tb.innerHTML = "";
    let totalGuests = 0;

    data.forEach(row=>{
      totalGuests += row.guests;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="col-date">${row.date}</td>
        <td class="col-time">${row.time}</td>
        <td>${row.firstName} ${row.name}</td>
        <td>${row.email || ""}</td>
        <td class="col-phone">${row.phone || ""}</td>
        <td class="col-guests">${row.guests}</td>
        <td>${row.status}</td>
        <td>${row.notes || ""}</td>
        <td>${row.visitCount ?? ""}</td>
        <td>${row.discount ? row.discount + "%" : ""}</td>
        <td class="col-walkin">${row.isWalkIn ? "yes" : ""}</td>
        <td class="col-actions actions-cell">
          <span class="btn-group">
            <button class="btn-danger btn-sm" data-del="${row.id}" type="button">Delete</button>
            <button class="btn btn-sm" data-ns="${row.id}" type="button">No show</button>
          </span>
        </td>`;
      tb.appendChild(tr);
    });

    document.getElementById("sum").textContent = `Total bookings: ${data.length}   Total guests: ${totalGuests}`;

    tb.querySelectorAll("[data-del]").forEach(b=>b.addEventListener("click", async ()=>{
      await fetch(`/api/admin/reservations/${b.getAttribute("data-del")}`, {method:"DELETE"}); loadList();
    }));
    tb.querySelectorAll("[data-ns]").forEach(b=>b.addEventListener("click", async ()=>{
      await fetch(`/api/admin/reservations/${b.getAttribute("data-ns")}/noshow`, {method:"POST"}); loadList();
    }));
  }
  document.getElementById("btnLoad").addEventListener("click", loadList);
  document.getElementById("view").addEventListener("change", loadList);
  loadList();

  // export
  document.getElementById("btnExport").addEventListener("click", ()=>{
    const p = document.getElementById("period").value;
    const d = document.getElementById("fltDate").value || today();
    window.location.href = `/api/export?period=${p}&date=${encodeURIComponent(d)}`;
  });

  // walkin save
  document.getElementById("btnWalk").addEventListener("click", async ()=>{
    const d = document.getElementById("wDate").value || today();
    const t = document.getElementById("wTime").value;
    const payload = { date:d, time:t, guests:Number(document.getElementById("wGuests").value), notes:document.getElementById("wNotes").value };
    const r = await fetch("/api/admin/walkin", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
    const m = document.getElementById("wMsg");
    if(r.ok){ m.textContent="Saved"; loadList(); } else { const e = await r.json().catch(()=>({})); m.textContent = e.error || "Error"; }
  });

  // closures (blocks) management
  async function loadClosures(){
    const r = await fetch("/api/admin/closure");
    if(!r.ok){ console.error('loadClosures failed', r.status); return; }
    const list = await r.json();
    const box = document.getElementById("closureList");
    box.innerHTML = "";
    list.forEach(x=>{
      const d = document.createElement("div");
      d.className = "badge";
      const s = new Date(x.startTs).toLocaleString();
      const e = new Date(x.endTs).toLocaleString();
      const title = x.title ? x.title : x.reason;
      d.innerHTML = `${s} — ${e} (${title}) <button style="margin-left:8px;" class="btn-plain" data-remove="${x.id}">remove</button>`;
      box.appendChild(d);
    });
    box.querySelectorAll("[data-remove]").forEach(b=>{
      b.addEventListener("click", async ()=>{
        await fetch(`/api/admin/closure/${b.getAttribute("data-remove")}`, { method:"DELETE" });
        loadClosures();
      });
    });
  }
  loadClosures();

  document.getElementById("btnBlock").addEventListener("click", async ()=>{
    const payload = {
      startTs: document.getElementById("cStart").value,
      endTs: document.getElementById("cEnd").value,
      reason: "Closed",
    };
    const r = await fetch("/api/admin/closure", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
    const m = document.getElementById("cMsg");
    if(r.ok){ m.textContent="Block saved"; loadClosures(); } else { const e = await r.json().catch(()=>({})); m.textContent = e.error || "Error"; }
  });

  document.getElementById("btnBlockDayPicker").addEventListener("click", async ()=>{
    const val = document.getElementById("cStart").value;
    if(!val){ alert("Set 'Start' first"); return; }
    const d = new Date(val); const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    const reason = "Closed";
    const r = await fetch("/api/admin/closure/day", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ date: iso, reason }) });
    const m = document.getElementById("cMsg");
    if(r.ok){ m.textContent="Day blocked"; loadClosures(); } else { const e = await r.json().catch(()=>({})); m.textContent = e.error || "Error"; }
  });

  // Notices (date-specific customer messages) — stored via closure/day endpoint (title->reason mapping already supported server-side)
  async function loadNotices(){
    // reuse same closure list and filter by those that are full-day closures (we can't differentiate in DB),
    // but show them in the notice list. For now we list all closures as possible notices as well.
    const r = await fetch("/api/admin/closure");
    if(!r.ok){ console.error('loadNotices failed', r.status); return; }
    const list = await r.json();
    const box = document.getElementById("noticeList");
    box.innerHTML = "";
    list.forEach(x=>{
      const sDate = new Date(x.startTs);
      const iso = `${sDate.getFullYear()}-${String(sDate.getMonth()+1).padStart(2,"0")}-${String(sDate.getDate()).padStart(2,"0")}`;
      const title = x.title ? x.title : x.reason;
      const div = document.createElement("div");
      div.className = "badge";
      div.innerHTML = `${iso}: <strong>${title}</strong> — ${x.reason} <button style="margin-left:8px;" class="btn-plain" data-remove="${x.id}">remove</button>`;
      box.appendChild(div);
    });
    box.querySelectorAll("[data-remove]").forEach(b=>{
      b.addEventListener("click", async ()=>{
        await fetch(`/api/admin/closure/${b.getAttribute("data-remove")}`, { method:"DELETE" });
        loadClosures(); loadNotices();
      });
    });
  }
  loadNotices();

  // Create notice: uses /api/admin/closure/day with title -> server maps title to reason if provided
  document.getElementById("btnNoticeCreate").addEventListener("click", async ()=>{
    const date = document.getElementById("nDate").value;
    const title = document.getElementById("nTitle").value || "";
    const msg = document.getElementById("nMessage").value || "";
    if(!date){ document.getElementById("nMsg").textContent = "Pick a date"; return; }
    const r = await fetch("/api/admin/closure/day", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ date, title, reason: msg }) });
    const nm = document.getElementById("nMsg");
    if(r.ok){ nm.textContent = "Notice saved"; loadClosures(); loadNotices(); } else { const e = await r.json().catch(()=>({})); nm.textContent = e.error || "Error"; }
  });

</script>
</body>
</html>

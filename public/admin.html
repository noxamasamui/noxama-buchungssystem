<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin — Reservations</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <div class="container">
    <a href="/" class="small">Reservation</a>
    <h1>Admin</h1>
    <img src="/logo-hero.png" alt="Logo" class="logo-hero" style="width:220px;margin-top:-6px"/>

    <div class="card">
      <div class="row">
        <div>
          <label>Date filter</label>
          <input id="fltDate" type="date"/>
        </div>
        <div>
          <label>View</label>
          <select id="fltView">
            <option value="day">day</option>
            <option value="week" selected>week</option>
          </select>
        </div>
        <div>
          <label style="opacity:0">.</label>
          <button id="btnLoad" class="btn">Load</button>
        </div>

        <div>
          <label>Export</label>
          <select id="expPeriod">
            <option value="weekly" selected>weekly</option>
            <option value="daily">daily</option>
            <option value="monthly">monthly</option>
            <option value="yearly">yearly</option>
          </select>
          <button id="btnExport" class="btn" style="margin-left:8px">Excel</button>
        </div>
      </div>

      <div id="listWrap" class="card" style="margin-top:16px">
        <div id="listError" class="small" style="color:#a00"></div>
        <div style="overflow:auto">
          <table id="tbl" style="width:100%;border-collapse:collapse">
            <thead>
              <tr>
                <th style="text-align:left;padding:8px">Date</th>
                <th style="text-align:left;padding:8px">Time</th>
                <th style="text-align:left;padding:8px">Name</th>
                <th style="text-align:left;padding:8px">Email</th>
                <th style="text-align:left;padding:8px">Phone</th>
                <th style="text-align:left;padding:8px">Guests</th>
                <th style="text-align:left;padding:8px">Status</th>
                <th style="text-align:left;padding:8px">Notes</th>
                <th style="text-align:left;padding:8px">Walk in</th>
                <th style="text-align:left;padding:8px">Action</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Add walk in</h2>
      <div class="row">
        <div>
          <label>Date</label>
          <input id="wiDate" type="date"/>
        </div>
        <div>
          <label>Time</label>
          <input id="wiTime" type="time" value="10:00"/>
        </div>
        <div>
          <label>Guests</label>
          <select id="wiGuests"></select>
        </div>
      </div>
      <div style="margin-top:10px">
        <label>Notes</label>
        <input id="wiNotes" type="text" placeholder="Table, source, anything…"/>
      </div>
      <div style="margin-top:10px">
        <button id="btnWalkin" class="btn">Save walk in</button>
        <span id="wiMsg" class="small"></span>
      </div>
    </div>

    <div class="card">
      <h2>Block restaurant</h2>
      <div class="row">
        <div>
          <label>Start</label>
          <input id="blStart" type="datetime-local"/>
        </div>
        <div>
          <label>End</label>
          <input id="blEnd" type="datetime-local"/>
        </div>
        <div>
          <label>Reason</label>
          <input id="blReason" type="text" value="Private event, maintenance, …"/>
        </div>
      </div>
      <div style="margin-top:10px">
        <button id="btnBlock" class="btn">Create block</button>
        <button id="btnBlockDay" class="btn" style="margin-left:8px">Block day (from Start)</button>
        <span id="blMsg" class="small"></span>
      </div>
    </div>
  </div>

  <script>
  const $ = s => document.querySelector(s);

  // helpers
  function ymd(d){const dt=new Date(d);return dt.toISOString().slice(0,10)}
  function fmtBool(b){return b?"yes":""}

  // fill guests
  for(let i=1;i<=10;i++){
    const o=document.createElement("option"); o.value=String(i); o.textContent=String(i);
    $("#wiGuests").appendChild(o);
  }

  // default dates
  const today = new Date();
  $("#fltDate").value = today.toISOString().slice(0,10);
  $("#wiDate").value  = today.toISOString().slice(0,10);
  const nowIso = new Date(Date.now()+10*60*1000).toISOString().slice(0,16);
  $("#blStart").value = nowIso;

  async function loadList(){
    $("#listError").textContent = "";
    $("#rows").innerHTML = "";
    try{
      const q = new URLSearchParams({date: $("#fltDate").value, view: $("#fltView").value});
      const res = await fetch("/api/admin/reservations?"+q);
      if(!res.ok) throw new Error(res.statusText);
      const data = await res.json();
      const tbody = $("#rows");
      data.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="padding:8px;border-top:1px solid #e1d7c6">${r.date}</td>
          <td style="padding:8px;border-top:1px solid #e1d7c6">${r.time}</td>
          <td style="padding:8px;border-top:1px solid #e1d7c6">${r.firstName||""} ${r.name||""}</td>
          <td style="padding:8px;border-top:1px solid #e1d7c6">${r.email||""}</td>
          <td style="padding:8px;border-top:1px solid #e1d7c6">${r.phone||""}</td>
          <td style="padding:8px;border-top:1px solid #e1d7c6">${r.guests}</td>
          <td style="padding:8px;border-top:1px solid #e1d7c6">${r.status}</td>
          <td style="padding:8px;border-top:1px solid #e1d7c6">${r.notes||""}</td>
          <td style="padding:8px;border-top:1px solid #e1d7c6">${fmtBool(r.isWalkIn)}</td>
          <td style="padding:8px;border-top:1px solid #e1d7c6">
            <button class="btn" data-act="noshow" data-id="${r.id}" style="padding:6px 10px">No show</button>
            <button class="btn" data-act="del" data-id="${r.id}" style="padding:6px 10px;margin-left:6px;background:#7d4f17">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }catch(e){
      $("#listError").textContent = "List failed";
    }
  }

  $("#btnLoad").addEventListener("click", loadList);
  document.addEventListener("click", async (e)=>{
    const b = e.target.closest("button[data-act]");
    if(!b) return;
    const id = b.getAttribute("data-id");
    const act = b.getAttribute("data-act");
    if(act==="del"){
      await fetch("/api/admin/reservations/"+id,{method:"DELETE"});
      loadList();
    }else if(act==="noshow"){
      await fetch("/api/admin/reservations/"+id+"/noshow",{method:"POST"});
      loadList();
    }
  });

  $("#btnExport").addEventListener("click", ()=>{
    const q=new URLSearchParams({period:$("#expPeriod").value, date: $("#fltDate").value});
    window.location.href="/api/export?"+q;
  });

  $("#btnWalkin").addEventListener("click", async ()=>{
    $("#wiMsg").textContent="";
    try{
      const payload = {
        date: $("#wiDate").value,
        time: $("#wiTime").value,
        guests: Number($("#wiGuests").value||0),
        notes: $("#wiNotes").value.trim()
      };
      const res = await fetch("/api/walkin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      const data = await res.json();
      if(!res.ok){ $("#wiMsg").textContent = data.error || "Walk-in failed"; return; }
      $("#wiMsg").textContent = "Walk-in saved";
      loadList();
    }catch(e){ $("#wiMsg").textContent="Walk-in failed"; }
  });

  $("#btnBlock").addEventListener("click", async ()=>{
    $("#blMsg").textContent="";
    try{
      const res=await fetch("/api/admin/closure",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({
        startTs: $("#blStart").value.replace("T"," "),
        endTs: $("#blEnd").value.replace("T"," "),
        reason: $("#blReason").value
      })});
      const data=await res.json();
      if(!res.ok){ $("#blMsg").textContent = data.error || "Block failed"; return; }
      $("#blMsg").textContent="Block created";
      loadList();
    }catch(e){ $("#blMsg").textContent="Block failed"; }
  });

  $("#btnBlockDay").addEventListener("click", async ()=>{
    $("#blMsg").textContent="";
    try{
      const d = $("#blStart").value.slice(0,10);
      const res=await fetch("/api/admin/closure/day",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:d,reason:$("#blReason").value})});
      const data=await res.json();
      if(!res.ok){ $("#blMsg").textContent = data.error || "Block failed"; return; }
      $("#blMsg").textContent="Day blocked";
      loadList();
    }catch(e){ $("#blMsg").textContent="Block failed"; }
  });

  loadList();
  </script>
</body>
</html>

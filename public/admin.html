<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin — ROESTILAND BY NOXAMA SAMUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    .hero-wrap { padding: 18px 0; text-align: center; }
    .hero-banner { max-width: 480px; width:100%; height:auto; display:inline-block; object-fit:contain; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
    .card{ margin-bottom:20px; }
    .table-wrap{ overflow:auto; max-width:100%; }
    .contact-row a{ display:inline-block; padding:8px 12px; border-radius:6px; background:#b3822f; color:#fff; text-decoration:none; }
    textarea { min-height:100px; }
  </style>
</head>
<body>
<div class="hero-wrap" aria-hidden="false">
  <img id="heroBanner" class="hero-banner" src="/logo-hero.png" alt="Logo banner"/>
</div>

<nav><a href="/">Reservation</a> <a class="active" href="/admin">Admin</a></nav>
<h1>Admin</h1>

<div class="card">
  <h2>Block restaurant (close / block time)</h2>
  <div class="row">
    <div style="flex:1"><label>Start</label><input id="cStart" type="datetime-local"/></div>
    <div style="flex:1"><label>End</label><input id="cEnd" type="datetime-local"/></div>
    <div style="align-self:flex-end"><button id="btnBlock" class="btn">Create block</button></div>
  </div>
  <div style="margin-top:8px;">
    <button id="btnBlockDayPicker" class="btn-plain">Block day (from Start)</button>
  </div>
  <div id="closureList" style="margin-top:10px"></div>
</div>

<div class="card">
  <h2>Customer notice (date-specific message)</h2>
  <div class="row">
    <div style="flex:1"><label>Date (notice applies to)</label><input id="nDate" type="date"/></div>
    <div style="flex:1"><label>Title (displayed to customers)</label><input id="nTitle" type="text" placeholder="e.g. Christmas menu — special info"/></div>
  </div>
  <div style="margin-top:8px;">
    <label>Message (visible to customers when they pick date)</label>
    <textarea id="nMessage" placeholder="Full message customers see"></textarea>
  </div>
  <div style="margin-top:10px;">
    <button id="btnNotice" class="btn">Create notice</button>
    <span id="noticeMsg" class="badge" style="margin-left:10px;"></span>
  </div>
  <div id="noticeList" style="margin-top:12px"></div>
</div>

<div class="card">
  <h2>Add walk in</h2>
  <div class="row">
    <div><label>Date</label><input id="wDate" type="date"/></div>
    <div><label>Time</label><select id="wTime"></select></div>
    <div><label>Guests</label><input id="wGuests" type="number" min="1" max="48" value="2"/></div>
  </div>
  <label>Notes</label><input id="wNotes"/>
  <div class="row">
    <button id="btnWalk" class="btn" type="button">Save walk in</button>
    <span id="wMsg" class="badge"></span>
  </div>
</div>

<script>
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };
  document.getElementById("nDate").value = today();
  document.getElementById("wDate").value = today();
  document.getElementById("nTitle").value = "";

  // set banner
  (async()=>{
    try{ const r = await fetch('/api/config',{cache:"no-store"}); if(!r.ok) throw 0; const cfg = await r.json(); const h=document.getElementById('heroBanner'); h.src=cfg.mailHeaderUrl&&cfg.mailHeaderUrl.trim()?cfg.mailHeaderUrl:(cfg.mailLogoUrl&&cfg.mailLogoUrl.trim()?cfg.mailLogoUrl:'/logo-hero.png'); }
    catch(e){}
  })();

  // closures list
  async function loadClosures(){
    try{
      const r = await fetch('/api/admin/closure');
      if(!r.ok) { document.getElementById('closureList').innerHTML = '<div class="badge">Failed to load</div>'; return; }
      const list = await r.json();
      const box = document.getElementById('closureList'); box.innerHTML = '';
      list.forEach(x=>{
        const d = document.createElement('div'); d.className='badge'; d.style.margin='6px 0';
        const s = new Date(x.startTs).toLocaleString(); const e = new Date(x.endTs).toLocaleString();
        d.textContent = `${s} — ${e} (${x.reason || 'Closed'}) `;
        const btn = document.createElement('button'); btn.type='button'; btn.className='btn-plain'; btn.textContent='remove';
        btn.onclick = async ()=>{ await fetch(`/api/admin/closure/${x.id}`, {method:'DELETE'}); loadClosures(); };
        d.appendChild(btn); box.appendChild(d);
      });
    }catch(e){ console.error(e); }
  }
  loadClosures();

  document.getElementById('btnBlock').addEventListener('click', async ()=>{
    const payload = { startTs: document.getElementById('cStart').value, endTs: document.getElementById('cEnd').value, reason: 'Closed' };
    const r = await fetch('/api/admin/closure', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(r.ok){ loadClosures(); } else { const j = await r.json(); alert(j.error || 'Error'); }
  });
  document.getElementById('btnBlockDayPicker').addEventListener('click', async ()=>{
    const val = document.getElementById('cStart').value; if(!val){ alert("Set 'Start' first"); return; }
    const d = new Date(val); const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    const reason = prompt("Reason (optional)", "Closed") || "Closed";
    const r = await fetch('/api/admin/closure/day', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ date: iso, reason }) });
    if(r.ok){ loadClosures(); } else { const j = await r.json(); alert(j.error || 'Error'); }
  });

  // ------------------ Notices (separate) ------------------
  async function loadNotices(){
    try{
      const r = await fetch('/api/admin/notice', {cache:"no-store"});
      const list = r.ok ? await r.json() : [];
      const box = document.getElementById('noticeList'); box.innerHTML = '';
      list.forEach(n=>{
        const div = document.createElement('div'); div.className='badge'; div.style.margin='6px 0';
        const datePart = n.date ? n.date : (n.start ? new Date(n.start).toLocaleDateString() : '');
        const title = n.title || n.message || 'Notice';
        div.innerHTML = `${datePart}: <b>${title}</b> — ${n.message ? (n.message.length>60 ? n.message.slice(0,60)+'…' : n.message) : ''} `;
        const btn = document.createElement('button'); btn.type='button'; btn.className='btn-plain'; btn.textContent='remove';
        btn.onclick = async ()=>{ await fetch(`/api/admin/notice/${encodeURIComponent(n.id)}`, {method:'DELETE'}); loadNotices(); };
        div.appendChild(btn); box.appendChild(div);
      });
    }catch(e){ console.error(e); }
  }
  loadNotices();

  document.getElementById('btnNotice').addEventListener('click', async ()=>{
    const date = document.getElementById('nDate').value;
    const title = document.getElementById('nTitle').value.trim();
    const message = document.getElementById('nMessage').value.trim();
    if(!date || !message){ document.getElementById('noticeMsg').textContent = 'Set date + message'; return; }
    const payload = { date, title, message };
    const r = await fetch('/api/admin/notice', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(r.ok){ document.getElementById('noticeMsg').textContent = 'Notice saved'; setTimeout(()=>document.getElementById('noticeMsg').textContent='',1500); loadNotices(); }
    else { const j = await r.json().catch(()=>({})); document.getElementById('noticeMsg').textContent = j.error || 'Error'; }
  });

  // ------------------ Walkin (unchanged) ------------------
  function fillWalkInTimes(){
    const sel = document.getElementById("wTime"); sel.innerHTML='';
    const from=10*60, to=22*60;
    for(let m=from;m<=to;m+=15){ const hh=String(Math.floor(m/60)).padStart(2,"0"); const mm=String(m%60).padStart(2,"0"); const opt=document.createElement('option'); opt.value=`${hh}:${mm}`; opt.textContent=opt.value; sel.appendChild(opt); }
  }
  fillWalkInTimes();
  document.getElementById('btnWalk').addEventListener('click', async ()=>{
    const payload={ date: document.getElementById('wDate').value || today(), time: document.getElementById('wTime').value, guests: Number(document.getElementById('wGuests').value), notes: document.getElementById('wNotes').value};
    const r = await fetch('/api/admin/walkin', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const m = document.getElementById('wMsg'); if(r.ok){ m.textContent='Saved'; setTimeout(()=>m.textContent='',1200); } else { const j=await r.json().catch(()=>({})); m.textContent = j.error || 'Error'; }
  });

</script>
</body>
</html>

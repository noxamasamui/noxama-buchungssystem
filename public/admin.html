<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — Reservations</title>
<link rel="stylesheet" href="/style.css"/>
<link rel="icon" href="/logo.png"/>
</head>
<body>
<div class="container">
  <div class="header"><img class="logo" src="/logo.png" alt="Röstiland"/></div>
  <h1>Admin</h1>

  <div class="card">
    <div class="row-3">
      <div>
        <label>Key</label>
        <input id="admKey" type="text" placeholder="x-admin-key"/>
      </div>
      <div>
        <label>From</label>
        <input id="from" type="date"/>
      </div>
      <div>
        <label>To</label>
        <input id="to" type="date"/>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="load" class="btn">Load</button>
      <button id="export" class="btn-ghost">Export CSV</button>
    </div>

    <table class="table" style="margin-top:12px">
      <thead><tr>
        <th>Date</th><th>Time</th><th>Name</th><th>Email</th><th>Guests</th><th>Status</th><th>Walk-in</th>
      </tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 10px">Add walk-in</h3>
    <div class="row">
      <div>
        <label>Date</label>
        <input id="wDate" type="date"/>
      </div>
      <div>
        <label>Time (HH:MM)</label>
        <input id="wTime" type="text" placeholder="HH:MM" pattern="^[0-2][0-9]:[0-5][0-9]$"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>Guests</label>
        <input id="wGuests" type="number" min="1" max="10" value="2"/>
      </div>
      <div class="full">
        <label>Notes</label>
        <input id="wNotes" type="text" placeholder=""/>
      </div>
    </div>
    <div style="margin-top:12px"><button id="saveWalk" class="btn">Save walk-in</button></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 10px">Block day (quick)</h3>
    <div class="row">
      <div>
        <label>Day</label>
        <input id="bDay" type="date"/>
      </div>
      <div class="full">
        <label>Reason</label>
        <input id="bReason" type="text" value="Closed / Private event"/>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <button id="block" class="btn">Block whole day</button>
      <button id="unblock" class="btn-ghost">Remove block</button>
    </div>
  </div>
</div>

<div id="toast" class="toast" style="display:none">
  <div>
    <h3 id="tTitle">Error</h3>
    <p id="tText">Unauthorized</p>
    <button id="tBtn" class="btn">OK</button>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
const show=(ttl,txt)=>{ $("#tTitle").textContent=ttl; $("#tText").textContent=txt; $("#toast").style.display="flex"; $("#tBtn").onclick=()=>$("#toast").style.display="none"; };

const today = new Date().toISOString().slice(0,10);
$("#from").value=today; $("#to").value=today; $("#wDate").value=today; $("#bDay").value=today;

async function adminFetch(path, opts={}){
  const key = $("#admKey").value.trim();
  const headers = Object.assign({"x-admin-key": key}, (opts.headers||{}));
  const r = await fetch(path, Object.assign({}, opts, {headers}));
  if (r.status===401){ show("Error","Unauthorized"); throw new Error("unauthorized"); }
  return r;
}

$("#load").onclick=async()=>{
  const q = `?from=${$("#from").value}&to=${$("#to").value}`;
  const r = await adminFetch(`/api/admin/reservations${q}`);
  const j = await r.json();
  const tb = $("#rows"); tb.innerHTML="";
  j.rows.forEach(row=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${row.date}</td><td>${row.time}</td><td>${row.firstName} ${row.name}</td><td>${row.email}</td><td>${row.guests}</td><td>${row.status}</td><td>${row.isWalkIn?'yes':''}</td>`;
    tb.appendChild(tr);
  });
};

$("#export").onclick=()=>{ const q=`?from=${$("#from").value}&to=${$("#to").value}`; window.open(`/api/admin/export.csv${q}`,'_blank'); };

$("#saveWalk").onclick=async()=>{
  const body = {date:$("#wDate").value, time:$("#wTime").value, guests:Number($("#wGuests").value||2), notes:$("#wNotes").value};
  try{
    const r = await adminFetch("/api/admin/walkin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
    const j = await r.json();
    if(j.ok) { show("Saved","Walk-in created."); $("#load").click(); }
    else show("Error", j.error||"Failed");
  }catch(e){}
};

$("#block").onclick=async()=>{
  try{
    const r=await adminFetch("/api/admin/block-day",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({day:$("#bDay").value,reason:$("#bReason").value})});
    const j=await r.json(); if(j.ok) show("Blocked", `Created ${j.created} placeholders.`);
  }catch(e){}
};
$("#unblock").onclick=async()=>{
  try{
    const r=await adminFetch(`/api/admin/block-day?day=${$("#bDay").value}`,{method:"DELETE"});
    const j=await r.json(); if(j.ok) show("Removed", `Deleted ${j.deleted} placeholders.`);
  }catch(e){}
};
</script>
</body>
</html>

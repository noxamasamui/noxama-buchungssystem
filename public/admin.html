<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin — Reservations</title>
<link rel="stylesheet" href="/style.css">
</head>
<body>
  <!-- Logo-Banner -->
  <img class="banner" src="/logo-hero.png" alt="RÖSTILAND by NOXAMA SAMUI">

  <div class="container">
    <h1>Admin</h1>

    <!-- Filter / Export -->
    <div class="card">
      <div class="row row-2">
        <div>
          <label>Date filter</label>
          <input id="filterDate" type="date">
        </div>
        <div>
          <label>View</label>
          <select id="filterView">
            <option value="day">day</option>
            <option value="week">week</option>
            <option value="month">month</option>
          </select>
        </div>
      </div>

      <div class="actions" style="margin-top:10px">
        <button id="btnLoad" class="btn btn-primary">Load</button>
        <select id="exportRange">
          <option value="weekly">weekly</option>
          <option value="daily">daily</option>
          <option value="monthly">monthly</option>
          <option value="yearly">yearly</option>
        </select>
        <button id="btnExport" class="btn">Excel</button>
      </div>
    </div>

    <!-- Hinweise (Day Notice) -->
    <div class="card">
      <h2>Day notice</h2>
      <div class="row row-2">
        <div>
          <label>Date</label>
          <input id="nDate" type="date">
        </div>
        <div>
          <label>Message</label>
          <input id="nMsg" placeholder="e.g. Christmas menu …">
        </div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button id="nSave" class="btn btn-primary">Save / Update</button>
      </div>

      <div id="noticeList" class="small" style="margin-top:10px"></div>
    </div>

    <!-- Reservations -->
    <div class="card">
      <h2>All reservations</h2>
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>Date</th><th>Time</th><th>Name</th><th>Email</th><th>Phone</th>
            <th>Guests</th><th>Status</th><th>Notes</th><th>Walk in</th><th>Action</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
function ymd(d){ return d.toISOString().slice(0,10); }
function todayLocal(){ const t=new Date(); t.setHours(0,0,0,0); return t; }

async function loadList(){
  const d = document.getElementById('filterDate').value;
  const v = document.getElementById('filterView').value;
  const r = await fetch(`/api/admin/reservations?date=${encodeURIComponent(d)}&view=${encodeURIComponent(v)}`);
  const list = await r.json();
  const tb = document.getElementById('tbody');
  tb.innerHTML = '';
  list.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${r.time}</td>
      <td>${r.firstName} ${r.name}</td>
      <td>${r.email}</td>
      <td>${r.phone||''}</td>
      <td>${r.guests}</td>
      <td>${r.status}</td>
      <td>${r.notes||''}</td>
      <td>${r.isWalkIn ? 'yes':'-'}</td>
      <td class="actions">
        <button class="btn small" data-act="noshow" data-id="${r.id}">No show</button>
        <button class="btn small" data-act="delete" data-id="${r.id}">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
}

// Button-Delegation
document.getElementById('tbody').addEventListener('click', async (e)=>{
  const b = (e.target as HTMLElement);
  if (!(b instanceof HTMLButtonElement)) return;
  const id = b.dataset.id;
  const act = b.dataset.act;
  if (!id || !act) return;

  if (act === 'delete') {
    if (!confirm('Delete reservation?')) return;
    const res = await fetch(`/api/admin/reservations/${id}`, { method:'DELETE' });
    if (res.ok) loadList();
  } else if (act === 'noshow') {
    const res = await fetch(`/api/admin/reservations/${id}/noshow`, { method:'POST' });
    if (res.ok) loadList();
  }
});

// Filter/Export
document.getElementById('btnLoad').addEventListener('click', loadList);
document.getElementById('btnExport').addEventListener('click', ()=>{
  const date = document.getElementById('filterDate').value;
  const period = document.getElementById('exportRange').value;
  window.location.href = `/api/export?date=${encodeURIComponent(date)}&period=${encodeURIComponent(period)}`;
});

// Day notice: Save/Update + Liste
document.getElementById('nSave').addEventListener('click', async ()=>{
  const date = (document.getElementById('nDate') as HTMLInputElement).value;
  const message = (document.getElementById('nMsg') as HTMLInputElement).value;
  if (!date) { alert('Choose a date'); return; }
  const res = await fetch('/api/admin/daynotice', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ date, message })
  });
  if (res.ok) { await loadNotices(); alert('Saved'); }
});

async function loadNotices(){
  const r = await fetch('/api/admin/daynotice');
  const list = await r.json();
  const box = document.getElementById('noticeList');
  if (!list.length){ box.innerHTML = '<span class="small">No notices yet</span>'; return; }
  box.innerHTML = list.map(n => `
    <div class="notice" style="margin:6px 0;display:flex;justify-content:space-between;gap:12px">
      <div><b>${n.date}</b> — ${n.message || ''}</div>
      <button class="btn small" data-del="${n.id}">Delete</button>
    </div>`).join('');
  box.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = (btn as HTMLButtonElement).dataset.del!;
      if (!confirm('Delete notice?')) return;
      const res = await fetch(`/api/admin/daynotice/${id}`, { method:'DELETE' });
      if (res.ok) loadNotices();
    });
  });
}

(async function init(){
  const t = todayLocal();
  (document.getElementById('filterDate') as HTMLInputElement).value = ymd(t);
  (document.getElementById('nDate') as HTMLInputElement).value = ymd(t);
  await loadList();
  await loadNotices();
})();
</script>
</body>
</html>

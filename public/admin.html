<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin — ROESTILAND BY NOXAMA SAMUI</title>
  <link rel="stylesheet" href="/style.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    .hero-wrap { padding: 18px 0; text-align: center; }
    .hero-banner { max-width: 480px; width: 100%; height: auto; display: inline-block; object-fit: contain; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,0.12);}
    .hero-banner.img-fallback { max-height: 160px; }
    .card { margin-bottom:20px; padding:18px; background:#fff8f0; border:1px solid #e0d7c5; border-radius:12px; }
    .table-wrap { overflow:auto; max-width:100%; }
    .badge { display:inline-block; padding:6px 10px; border-radius:6px; background:#f3f0e7; margin-right:8px; }
    .contact-row a { text-decoration:none; }
    /* small responsive niceness */
    @media (max-width:520px){ .hero-banner { max-width:320px; } }
  </style>
</head>
<body>
<div class="hero-wrap" aria-hidden="false">
  <img id="heroBanner" class="hero-banner" src="/logo-hero.png" alt="Logo banner"/>
</div>

<nav><a href="/">Reservation</a> <a class="active" href="/admin">Admin</a></nav>
<h1>Admin</h1>

<div class="card">
  <h2>All reservations</h2>
  <div class="toolbar">
    <div class="row">
      <div><label>Date filter</label><input id="fltDate" type="date"/></div>
      <div><label>View</label>
        <select id="view"><option value="day">day</option><option value="week" selected>week</option><option value="month">month</option></select>
      </div>
      <button class="btn" id="btnLoad" type="button">Load</button>
      <div class="spacer"></div>
      <div>
        <label>Export</label>
        <select id="period">
          <option value="daily">daily</option>
          <option value="weekly" selected>weekly</option>
          <option value="monthly">monthly</option>
          <option value="yearly">yearly</option>
        </select>
        <button class="btn" id="btnExport" type="button">Excel</button>
      </div>
    </div>
  </div>

  <div class="table-wrap">
    <table id="tbl">
      <thead>
      <tr>
        <th class="col-date">Date</th>
        <th class="col-time">Time</th>
        <th>Name</th>
        <th>Email</th>
        <th class="col-phone">Phone</th>
        <th class="col-guests">Guests</th>
        <th>Status</th>
        <th>Notes</th>
        <th>Visit</th>
        <th>Discount</th>
        <th class="col-walkin">Walk in</th>
        <th class="col-actions">Action</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="sum" class="badge" style="margin-top:10px;"></div>
</div>

<div class="card">
  <h2>Block restaurant (close / block time)</h2>
  <div class="row">
    <div><label>Start</label><input id="cStart" type="datetime-local"/></div>
    <div><label>End</label><input id="cEnd" type="datetime-local"/></div>
    <div><label>Reason</label><input id="cReason"/></div>
  </div>
  <div class="row" style="margin-top:8px;">
    <button id="btnBlock" class="btn" type="button">Create block</button>
    <button id="btnBlockDayPicker" class="btn" type="button">Block day (from Start)</button>
    <span id="cMsg" class="badge"></span>
  </div>
  <div id="closureList" style="margin-top:10px"></div>
</div>

<div class="card">
  <h2>Customer notice (date-specific message)</h2>
  <div class="row">
    <div style="flex:1 1 250px;"><label>Date (notice applies to)</label><input id="noticeDate" type="date"/></div>
    <div style="flex:1 1 300px;"><label>Title (displayed to customers)</label><input id="noticeTitle" placeholder="e.g. Christmas menu — special info"/></div>
  </div>
  <div style="margin-top:8px;">
    <label>Message (visible to customers when they pick date)</label>
    <textarea id="noticeMessage" rows="4" style="width:100%;box-sizing:border-box;padding:8px;border-radius:6px;border:1px solid #c8b99e;"></textarea>
  </div>
  <div style="margin-top:12px;">
    <button id="btnCreateNotice" class="btn">Create notice</button>
    <span id="noticeMsg" class="badge" style="margin-left:10px;"></span>
  </div>
  <div id="noticeList" style="margin-top:12px;"></div>
</div>

<div class="card">
  <h2>Add walk in</h2>
  <div class="row">
    <div><label>Date</label><input id="wDate" type="date"/></div>
    <div><label>Time</label><select id="wTime"></select></div>
    <div><label>Guests</label><input id="wGuests" type="number" min="1" max="48" value="2"/></div>
  </div>
  <label>Notes</label><input id="wNotes"/>
  <div class="row" style="margin-top:8px;">
    <button id="btnWalk" class="btn" type="button">Save walk in</button>
    <span id="wMsg" class="badge"></span>
  </div>
</div>

<script>
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };
  document.getElementById("fltDate").value = today();
  document.getElementById("wDate").value = today();
  document.getElementById("noticeDate").value = today();

  // Load hero banner from config
  (async()=>{
    try{
      const r = await fetch('/api/config', {cache:"no-store"});
      if(!r.ok) return;
      const cfg = await r.json();
      const hero = document.getElementById('heroBanner');
      hero.src = cfg.mailHeaderUrl && cfg.mailHeaderUrl.trim() ? cfg.mailHeaderUrl : (cfg.mailLogoUrl && cfg.mailLogoUrl.trim() ? cfg.mailLogoUrl : '/logo-hero.png');
      hero.alt = cfg.brand || 'Banner';
      hero.onerror = function(){ this.src = '/logo-hero.png'; this.classList.add('img-fallback'); };
    }catch(e){ console.error("banner load", e); }
  })();

  // walk-in times
  function fillWalkInTimes(){
    const sel = document.getElementById("wTime");
    sel.innerHTML = "";
    const from = 10*60, to = 22*60, interval = 15;
    for(let m=from;m<=to;m+=interval){
      const hh=String(Math.floor(m/60)).padStart(2,"0");
      const mm=String(m%60).padStart(2,"0");
      const opt=document.createElement("option");
      opt.value=`${hh}:${mm}`; opt.textContent=opt.value;
      sel.appendChild(opt);
    }
  }
  fillWalkInTimes();

  // ----------------- closures (dedupe render) -----------------
  async function loadClosures(){
    try{
      const r = await fetch("/api/admin/closure");
      if(!r.ok) { console.error("loadClosures failed", r.status); return; }
      const list = await r.json();
      const box = document.getElementById("closureList");
      box.innerHTML = "";

      // dedupe by start|end|reason
      const seen = new Set();
      list.forEach(x=>{
        const key = `${x.startTs}|${x.endTs}|${String(x.reason||"")}`;
        if(seen.has(key)) return;
        seen.add(key);

        const d = document.createElement("div");
        d.className = "badge";
        const s = new Date(x.startTs).toLocaleString();
        const e = new Date(x.endTs).toLocaleString();
        d.textContent = `${s} — ${e} (${x.reason})`;
        const btn = document.createElement("button");
        btn.textContent = "remove"; btn.className = "btn-plain btn-sm"; btn.type="button";
        btn.onclick = async ()=>{ await fetch(`/api/admin/closure/${x.id}`, {method:"DELETE"}); loadClosures(); };
        d.appendChild(btn);
        box.appendChild(d);
      });
    }catch(e){ console.error("loadClosures", e); }
  }
  loadClosures();

  document.getElementById("btnBlock").addEventListener("click", async ()=>{
    const payload = {
      startTs: document.getElementById("cStart").value,
      endTs: document.getElementById("cEnd").value,
      reason: document.getElementById("cReason").value
    };
    const m = document.getElementById("cMsg");
    try{
      const r = await fetch("/api/admin/closure", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      if(!r.ok){ const e = await r.json().catch(()=>({})); m.textContent = e.error || "Error"; return; }
      m.textContent = "Block saved"; loadClosures();
    }catch(err){ m.textContent = "Error"; console.error("btnBlock", err); }
  });

  document.getElementById("btnBlockDayPicker").addEventListener("click", async ()=>{
    const val = document.getElementById("cStart").value;
    if(!val){ alert("Set 'Start' first"); return; }
    const d = new Date(val); const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    const reason = document.getElementById("cReason").value || "Closed";
    try{
      const r = await fetch("/api/admin/closure/day", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ date: iso, reason }) });
      const m = document.getElementById("cMsg");
      if(!r.ok){ const e = await r.json().catch(()=>({})); m.textContent = e.error || "Error"; return; }
      m.textContent = "Day blocked"; loadClosures();
    }catch(err){ console.error("block day", err); }
  });

  // ----------------- reservations list -----------------
  async function loadList(){
    const d = document.getElementById("fltDate").value || today();
    const v = document.getElementById("view").value || "week";
    let resp;
    try {
      resp = await fetch(`/api/admin/reservations?date=${encodeURIComponent(d)}&view=${v}`);
    } catch(err){
      alert("Fehler: Konnte /api/admin/reservations nicht erreichen. Server offline oder CORS Problem.");
      console.error("fetch reservations failed", err);
      return;
    }
    if(!resp.ok){
      const txt = await resp.text().catch(()=>"(keine details)");
      alert("Serverantwort nicht OK: " + resp.status + "\n" + String(txt).slice(0,1000));
      console.error("reservations response not ok:", resp.status, txt);
      return;
    }
    let data;
    try {
      data = await resp.json();
    } catch(parseErr){
      const text = await resp.text().catch(()=>"(keine details)");
      alert("Unerwartetes Response-Format. Erwartet JSON, bekommen:\n" + String(text).slice(0,1000));
      console.error("reservations parse error", parseErr, text);
      return;
    }

    const tb = document.querySelector("#tbl tbody");
    tb.innerHTML = "";
    let totalGuests = 0;

    data.forEach(row=>{
      totalGuests += row.guests;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="col-date">${row.date}</td>
        <td class="col-time">${row.time}</td>
        <td>${row.firstName} ${row.name}</td>
        <td>${row.email || ""}</td>
        <td class="col-phone">${row.phone || ""}</td>
        <td class="col-guests">${row.guests}</td>
        <td>${row.status}</td>
        <td>${row.notes || ""}</td>
        <td>${row.visitCount ?? ""}</td>
        <td>${row.discount ? row.discount + "%" : ""}</td>
        <td class="col-walkin">${row.isWalkIn ? "yes" : ""}</td>
        <td class="col-actions actions-cell">
          <span class="btn-group">
            <button class="btn-danger btn-sm" data-del="${row.id}" type="button">Delete</button>
            <button class="btn btn-sm" data-ns="${row.id}" type="button">No show</button>
          </span>
        </td>`;
      tb.appendChild(tr);
    });

    document.getElementById("sum").textContent = `Total bookings: ${data.length}   Total guests: ${totalGuests}`;

    tb.querySelectorAll("[data-del]").forEach(b=>b.addEventListener("click", async ()=>{
      await fetch(`/api/admin/reservations/${b.getAttribute("data-del")}`, {method:"DELETE"}); loadList();
    }));
    tb.querySelectorAll("[data-ns]").forEach(b=>b.addEventListener("click", async ()=>{
      await fetch(`/api/admin/reservations/${b.getAttribute("data-ns")}/noshow`, {method:"POST"}); loadList();
    }));
  }
  document.getElementById("btnLoad").addEventListener("click", loadList);
  document.getElementById("view").addEventListener("change", loadList);
  loadList();

  document.getElementById("btnExport").addEventListener("click", ()=>{
    const p = document.getElementById("period").value;
    const d = document.getElementById("fltDate").value || today();
    window.location.href = `/api/export?period=${p}&date=${encodeURIComponent(d)}`;
  });

  // ----------------- walkin -----------------
  document.getElementById("btnWalk").addEventListener("click", async ()=>{
    const d = document.getElementById("wDate").value || today();
    const t = document.getElementById("wTime").value;
    const payload = { date:d, time:t, guests:Number(document.getElementById("wGuests").value), notes:document.getElementById("wNotes").value };
    try{
      const r = await fetch("/api/admin/walkin", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      const m = document.getElementById("wMsg");
      if(r.ok){ m.textContent="Saved"; loadList(); } else { const e = await r.json().catch(()=>({})); m.textContent = e.error || "Error"; }
    }catch(err){ console.error("walkin", err); document.getElementById("wMsg").textContent="Error"; }
  });

  // ----------------- notices management -----------------
  async function loadNotices(){
    try{
      const r = await fetch("/api/admin/notice");
      if(!r.ok) return;
      const list = await r.json();
      const box = document.getElementById("noticeList");
      box.innerHTML = "";
      list.forEach(n=>{
        const d = document.createElement("div");
        d.className = "badge";
        const date = n.date || "";
        const title = n.title || "(no title)";
        d.innerHTML = `${date}: <b>${title}</b> — ${String(n.message||"").slice(0,120)}`;
        const btn = document.createElement("button");
        btn.textContent = "remove"; btn.className = "btn-plain btn-sm"; btn.type="button";
        btn.onclick = async ()=>{ await fetch(`/api/admin/notice/${n.id}`, {method:"DELETE"}); loadNotices(); };
        d.appendChild(btn);
        box.appendChild(d);
      });
    }catch(e){ console.error("loadNotices", e); }
  }
  loadNotices();

  document.getElementById("btnCreateNotice").addEventListener("click", async ()=>{
    const date = document.getElementById("noticeDate").value;
    const title = document.getElementById("noticeTitle").value;
    const message = document.getElementById("noticeMessage").value;
    const m = document.getElementById("noticeMsg");
    m.textContent = "";
    if(!date || !message){ m.textContent = "Date and message required"; return; }
    try{
      const r = await fetch("/api/admin/notice", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ date, title, message }) });
      if(!r.ok){ const e = await r.json().catch(()=>({})); m.textContent = e.error || "Error"; return; }
      m.textContent = "Notice saved";
      loadNotices();
    }catch(err){ console.error("create notice", err); m.textContent="Error"; }
  });

</script>
</body>
</html>

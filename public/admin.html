<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Reservations</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <div class="header">
    <img src="/logo.png" alt="">
  </div>
  <div class="container">
    <h1>Admin</h1>

    <div class="card">
      <div class="admin-grid">
        <div>
          <label>Key</label>
          <input id="admKey" placeholder="x-admin-key">
        </div>
        <div>
          <label>From</label>
          <input id="from" type="date">
        </div>
        <div>
          <label>To</label>
          <input id="to" type="date">
        </div>
        <div>
          <button id="load" class="btn">Load</button>
        </div>
        <div>
          <button id="export" class="btn">Export CSV</button>
        </div>
      </div>

      <table class="table" style="margin-top:12px">
        <thead>
          <tr>
            <th>Date</th><th>Time</th><th>Name</th><th>Email</th><th>Guests</th><th>Status</th><th>Walk-in</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <div class="small" id="sum"></div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>Add walk-in</h2>
      <div class="row">
        <div>
          <label>Date</label>
          <input id="wiDate" type="date">
        </div>
        <div>
          <label>Time (HH:MM)</label>
          <input id="wiTime" placeholder="HH:MM">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>Guests</label>
          <input id="wiGuests" type="number" value="2" min="1" max="10">
        </div>
        <div>
          <label>Notes</label>
          <input id="wiNotes" placeholder="">
        </div>
      </div>
      <div style="margin-top:10px">
        <button id="saveWI" class="btn">Save walk-in</button>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>Block day (quick)</h2>
      <div class="row">
        <div>
          <label>Day</label>
          <input id="bdDay" type="date">
        </div>
        <div>
          <label>Reason</label>
          <input id="bdReason" value="Closed / Private event">
        </div>
      </div>
      <div style="margin-top:10px">
        <button id="bdCreate" class="btn">Block whole day</button>
        <button id="bdRemove" class="btn" style="margin-left:6px;background:#8b6b3d">Remove block</button>
      </div>
    </div>
  </div>

  <div id="modal" class="modal-mask"><div class="modal"><h3 id="mTitle"></h3><div id="mText"></div></div></div>

  <script>
    const qs = s=>document.querySelector(s);
    const modal=qs("#modal"), mt=qs("#mTitle"), mx=qs("#mText"); function note(t,d){mt.textContent=t;mx.textContent=d;modal.style.display="flex"}; modal.addEventListener("click",e=>{if(e.target===modal) modal.style.display="none"});

    const key = qs("#admKey");
    const from = qs("#from");
    const to = qs("#to");
    const rows = qs("#rows");
    const sum = qs("#sum");

    // defaults
    const t = new Date(); const y=t.getFullYear(); const m=String(t.getMonth()+1).padStart(2,"0"); const d=String(t.getDate()).padStart(2,"0");
    from.value = `${y}-${m}-${d}`; to.value = `${y}-${m}-${d}`;
    qs("#wiDate").value = `${y}-${m}-${d}`;
    qs("#bdDay").value = `${y}-${m}-${d}`;

    qs("#load").addEventListener("click", load);
    qs("#export").addEventListener("click", exportCsv);
    qs("#saveWI").addEventListener("click", saveWI);
    qs("#bdCreate").addEventListener("click", ()=>blockDay(true));
    qs("#bdRemove").addEventListener("click", ()=>blockDay(false));

    async function load(){
      try{
        rows.innerHTML="";
        const r = await fetch(`/api/admin/reservations?from=${from.value}&to=${to.value}`,{headers:{"x-admin-key":key.value}});
        const j = await r.json();
        if(!r.ok) throw new Error(j?.error||"Auth or range error");
        j.rows.forEach(x=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${x.date}</td><td>${x.time}</td><td>${x.firstName} ${x.name}</td><td>${x.email}</td><td>${x.guests}</td><td>${x.status}</td><td>${x.isWalkIn?"yes":""}</td>`;
          rows.appendChild(tr);
        });
        sum.textContent=`Total rows: ${j.count} — Total guests: ${j.totalGuests}`;
      }catch(e){ note("Error", String(e.message||e)); }
    }
    async function exportCsv(){
      window.location.href = `/api/admin/export.csv?from=${from.value}&to=${to.value}&key=${encodeURIComponent(key.value)}`;
    }
    async function saveWI(){
      try{
        const body={
          date: qs("#wiDate").value,
          time: qs("#wiTime").value,
          guests: Number(qs("#wiGuests").value||2),
          notes: qs("#wiNotes").value||""
        };
        const r=await fetch("/api/admin/walkin",{method:"POST",headers:{"Content-Type":"application/json","x-admin-key":key.value},body:JSON.stringify(body)});
        const j=await r.json();
        if(!r.ok) throw new Error(j?.error||"Error");
        note("Saved","Walk-in created.");
        load();
      }catch(e){ note("Error", String(e.message||e)); }
    }
    async function blockDay(create){
      try{
        if(create){
          const r=await fetch("/api/admin/block-day",{method:"POST",headers:{"Content-Type":"application/json","x-admin-key":key.value},body:JSON.stringify({day:qs("#bdDay").value,reason:qs("#bdReason").value})});
          const j=await r.json(); if(!r.ok) throw new Error(j?.error||"Error");
          note("Blocked", `Created ${j.created} placeholders.`);
        }else{
          const r=await fetch(`/api/admin/block-day?day=${qs("#bdDay").value}`,{method:"DELETE",headers:{"x-admin-key":key.value}});
          const j=await r.json(); if(!r.ok) throw new Error(j?.error||"Error");
          note("Removed", `Deleted ${j.deleted} placeholders.`);
        }
        load();
      }catch(e){ note("Error", String(e.message||e)); }
    }

    // auto-load on open
    load();
  </script>
</body>
</html>

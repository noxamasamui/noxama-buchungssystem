<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Reservations</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
<div class="wrap">
  <div class="center">
    <img src="/logo-hero.png" class="logo" style="width:160px" alt="RÖSTILAND">
  </div>
  <h1>Admin</h1>

  <div class="card">
    <div class="row">
      <div>
        <label for="fltDate">Date filter</label>
        <input id="fltDate" type="date">
      </div>
      <div>
        <label for="view">View</label>
        <select id="view">
          <option value="day">day</option>
          <option value="week" selected>week</option>
        </select>
      </div>
    </div>
    <div style="margin-top:10px">
      <button id="btnLoad" class="btn">Load</button>
      <span id="status" class="muted" style="margin-left:10px"></span>
      <div style="float:right">
        <label for="exportSel" style="display:inline">Export</label>
        <select id="exportSel" style="width:auto;display:inline">
          <option value="weekly" selected>weekly</option>
          <option value="daily">daily</option>
        </select>
        <button id="btnExcel" class="btn secondary">Excel</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="overflow:auto">
        <table id="tbl" style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th style="text-align:left">Date</th>
              <th style="text-align:left">Time</th>
              <th style="text-align:left">Name</th>
              <th style="text-align:left">Email</th>
              <th style="text-align:left">Phone</th>
              <th style="text-align:left">Guests</th>
              <th style="text-align:left">Status</th>
              <th style="text-align:left">Notes</th>
              <th style="text-align:left">Walk in</th>
              <th style="text-align:left">Action</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Add walk in</h3>
    <div class="row">
      <div><label>Date</label><input id="wDate" type="date"></div>
      <div><label>Time</label><input id="wTime" type="time" step="900" value="10:00"></div>
      <div><label>Guests</label><input id="wGuests" type="number" min="1" max="40" value="2"></div>
    </div>
    <label>Notes</label><input id="wNotes" type="text" placeholder="Table, source, anything…">
    <div style="margin-top:10px"><button id="btnWalkin" class="btn">Save walk in</button> <span id="wStatus" class="muted"></span></div>
  </div>

  <div class="card">
    <h3>Block restaurant</h3>
    <div class="row">
      <div><label>Start</label><input id="bStart" type="datetime-local"></div>
      <div><label>End</label><input id="bEnd" type="datetime-local"></div>
      <div><label>Reason</label><input id="bReason" type="text" placeholder="Private event, maintenance, …"></div>
    </div>
    <div style="margin-top:10px"><button id="btnBlock" class="btn danger">Create block</button> <span id="bStatus" class="muted"></span></div>
  </div>

</div>

<script>
const fltDate = document.getElementById('fltDate');
const viewSel = document.getElementById('view');
const tbody   = document.getElementById('tbody');
const statusEl= document.getElementById('status');

function ymdToday(){
  const t = new Date(); const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`;
}
fltDate.value = ymdToday();

document.getElementById('btnLoad').addEventListener('click', load);
document.getElementById('btnExcel').addEventListener('click', async ()=>{
  const r = await fetch(`/api/admin/export?date=${fltDate.value}&view=${viewSel.value}`);
  const blob = await r.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'reservations.xlsx';
  a.click();
  URL.revokeObjectURL(url);
});

async function load(){
  tbody.innerHTML='';
  statusEl.textContent='Loading…';
  try{
    const r = await fetch(`/api/admin/list?date=${fltDate.value}&view=${viewSel.value}`);
    if(!r.ok) throw new Error('List failed');
    const rows = await r.json();
    for(const x of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${x.date}</td>
        <td>${x.time}</td>
        <td>${x.firstName ? (x.firstName+' ') : ''}${x.name || ''}</td>
        <td>${x.email || ''}</td>
        <td>${x.phone || ''}</td>
        <td>${x.guests}</td>
        <td>${x.status}</td>
        <td>${x.notes || ''}</td>
        <td>${x.walkIn ? 'yes' : ''}</td>
        <td>
          <button class="btn danger" data-del="${x.id}">Delete</button>
          <button class="btn secondary" data-noshow="${x.id}">No show</button>
        </td>`;
      tbody.appendChild(tr);
    }
    statusEl.textContent='';
  }catch(e){
    statusEl.textContent='List failed (404)';
  }
}
tbody.addEventListener('click', async (e)=>{
  const t = e.target;
  if(t.dataset.del){
    if(!confirm('Delete reservation?')) return;
    await fetch(`/api/admin/reservation/${t.dataset.del}`, {method:'DELETE'});
    load();
  }
  if(t.dataset.noshow){
    await fetch(`/api/admin/noshow/${t.dataset.noshow}`, {method:'POST'});
    load();
  }
});

document.getElementById('btnWalkin').addEventListener('click', async ()=>{
  const payload = {
    date: document.getElementById('wDate').value || fltDate.value,
    time: document.getElementById('wTime').value,
    guests: Number(document.getElementById('wGuests').value || 1),
    notes: document.getElementById('wNotes').value || null
  };
  const r = await fetch('/api/admin/walkin', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  document.getElementById('wStatus').textContent = r.ok ? 'Saved' : 'Walk-in failed';
  load();
});

document.getElementById('btnBlock').addEventListener('click', async ()=>{
  const payload = {
    start: document.getElementById('bStart').value,
    end: document.getElementById('bEnd').value,
    reason: document.getElementById('bReason').value || 'blocked'
  };
  const r = await fetch('/api/admin/block', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  document.getElementById('bStatus').textContent = r.ok ? 'Block created' : 'Block failed';
  load();
});

load();
</script>
</body>
</html>

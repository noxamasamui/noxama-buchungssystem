<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin — Reservations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    .toolbar{display:grid;grid-template-columns:1.2fr 1fr 1fr auto auto;gap:10px;align-items:end;margin-bottom:14px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;font-size:14px}
    th{background:#faf5ef;text-align:left}
    tr:last-child td{border-bottom:none}
    .sec{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:14px 0}
    .toast{position:fixed;left:50%;top:30px;transform:translateX(-50%);background:#fff;border:1px solid var(--border);padding:12px 16px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);display:none}
    .mini-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .mini-grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  </style>
</head>
<body>
  <header class="brand">
    <img src="/logo.png" alt="RÖSTILAND" />
  </header>

  <main class="container">
    <h1 style="margin-bottom:12px;text-align:center">Admin</h1>

    <div class="toolbar">
      <label>Key
        <input id="admin-key" placeholder="x-admin-key" />
      </label>
      <label>From
        <input type="date" id="from" />
      </label>
      <label>To
        <input type="date" id="to" />
      </label>
      <button class="btn" id="load">Load</button>
      <button class="btn" id="export">Export CSV</button>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>Date</th><th>Time</th><th>Name</th><th>Email</th><th>Guests</th><th>Status</th><th>Walk-in</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="sec">
      <h3>Add walk-in</h3>
      <div class="mini-grid2">
        <label>Date
          <input type="date" id="wDate" />
        </label>
        <label>Time (HH:MM)
          <input type="time" id="wTime" />
        </label>
      </div>
      <div class="mini-grid2" style="margin-top:10px">
        <label>Guests
          <input type="number" id="wGuests" min="1" max="10" value="2" />
        </label>
        <label>Notes
          <input id="wNotes" />
        </label>
      </div>
      <div class="actions"><button class="btn" id="saveWalkin">Save walk-in</button></div>
    </div>

    <div class="sec">
      <h3>Block day (quick)</h3>
      <div class="mini-grid2">
        <label>Day
          <input type="date" id="bDay" />
        </label>
        <label>Reason
          <input id="bReason" value="Closed / Private event" />
        </label>
      </div>
      <div class="actions" style="gap:8px">
        <button class="btn" id="blockDay">Block whole day</button>
        <button class="btn" id="unblockDay">Remove block</button>
      </div>
    </div>

    <div class="sec">
      <h3>Danger zone</h3>
      <div class="mini-grid">
        <label>From
          <input type="date" id="delFrom" />
        </label>
        <label>To
          <input type="date" id="delTo" />
        </label>
        <div class="actions">
          <button class="btn" id="delRange">Delete ALL reservations in range</button>
        </div>
      </div>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const showToast = (msg)=>{ const t=$("#toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1800); };
    const today=()=>{ const d=new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${dd}`; };

    function headersWithKey(){
      const key = $("#admin-key").value.trim();
      return { "Content-Type":"application/json", "x-admin-key": key };
    }
    function qsWithKey(obj){
      const key = $("#admin-key").value.trim();
      const u = new URLSearchParams(obj);
      u.set("key", key);
      return "?" + u.toString();
    }

    async function load(){
      const from = $("#from").value;
      const to = $("#to").value;
      const r = await fetch(`/api/admin/reservations${qsWithKey({from,to})}`, { headers: headersWithKey() });
      if(!r.ok){ showToast("Auth or range error"); return; }
      const rows = await r.json();
      const tb = $("#tbl tbody");
      tb.innerHTML = "";
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.date}</td><td>${r.time}</td><td>${r.firstName} ${r.name}</td><td>${r.email}</td><td>${r.guests}</td><td>${r.status}</td><td>${r.isWalkIn?"yes":""}</td>`;
        tb.appendChild(tr);
      });
    }

    async function exportCsv(){
      const from = $("#from").value;
      const to = $("#to").value;
      const url = `/api/admin/export.csv${qsWithKey({from,to})}`;
      window.open(url, "_blank");
    }

    async function saveWalkin(){
      const payload = {
        date: $("#wDate").value,
        time: $("#wTime").value,
        guests: Number($("#wGuests").value),
        notes: $("#wNotes").value.trim()
      };
      const r = await fetch(`/api/admin/walkin${qsWithKey({})}`, {
        method:"POST", headers: headersWithKey(), body: JSON.stringify(payload)
      });
      if(!r.ok){ const j=await r.json().catch(()=>({})); showToast(j.error||"Error"); return; }
      showToast("Saved"); load();
    }

    async function blockDay(){
      const payload = { day: $("#bDay").value, reason: $("#bReason").value };
      const r = await fetch(`/api/admin/block-day${qsWithKey({})}`, {
        method:"POST", headers: headersWithKey(), body: JSON.stringify(payload)
      });
      if(!r.ok){ const j=await r.json().catch(()=>({})); showToast(j.error||"Error"); return; }
      showToast("Blocked"); load();
    }
    async function unblockDay(){
      const day = $("#bDay").value;
      const r = await fetch(`/api/admin/block-day${qsWithKey({day})}`, {
        method:"DELETE", headers: headersWithKey()
      });
      if(!r.ok){ const j=await r.json().catch(()=>({})); showToast(j.error||"Error"); return; }
      showToast("Removed"); load();
    }

    async function delRange(){
      if(!confirm("Delete ALL reservations in range?")) return;
      const from = $("#delFrom").value, to = $("#delTo").value;
      const r = await fetch(`/api/admin/reservations${qsWithKey({from,to})}`, { method:"DELETE", headers: headersWithKey() });
      if(!r.ok){ const j=await r.json().catch(()=>({})); showToast(j.error||"Error"); return; }
      showToast("Deleted"); load();
    }

    (function init(){
      const t = today();
      $("#from").value = t; $("#to").value = t;
      $("#wDate").value = t; $("#bDay").value = t; $("#delFrom").value = t; $("#delTo").value = t;

      $("#load").addEventListener("click", load);
      $("#export").addEventListener("click", exportCsv);
      $("#saveWalkin").addEventListener("click", saveWalkin);
      $("#blockDay").addEventListener("click", blockDay);
      $("#unblockDay").addEventListener("click", unblockDay);
      $("#delRange").addEventListener("click", delRange);

      load();
    })();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin — RÖSTILAND BY NOXAMA SAMUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    .hero-wrap{max-width:1200px;margin:0 auto 12px auto;display:flex;justify-content:center}
    .hero{display:block;width:auto;height:auto;max-width:100%;max-height:clamp(140px,24vw,260px);
          background:#e9dfcf;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,.18)}
    nav{display:none}
    .small{font-size:12px;padding:6px 8px}
    .table{overflow:auto}
    .muted{opacity:.7}
    .chip{display:inline-block;background:#eee;border-radius:12px;padding:2px 8px;margin-left:6px;font-size:12px}
  </style>
</head>
<body>
<div class="container">

  <div class="hero-wrap">
    <img id="heroImg" class="hero" src="/logo-hero.png" alt="Röstiland"/>
  </div>

  <h1 id="brand">Admin</h1>

  <!-- All reservations -->
  <div class="card">
    <h2>All reservations</h2>
    <div class="row">
      <div>
        <label>Date filter</label>
        <input id="fltDate" type="date"/>
      </div>
      <div>
        <label>View</label>
        <select id="fltView">
          <option value="day">day</option>
          <option value="week">week</option>
          <option value="month">month</option>
        </select>
      </div>
      <button id="btnLoad" class="btn" type="button">Load</button>
    </div>

    <div id="list"></div>

    <div class="row">
      <div>
        <label>Export</label>
        <select id="expPeriod">
          <option value="daily">daily</option>
          <option value="weekly" selected>weekly</option>
          <option value="monthly">monthly</option>
          <option value="yearly">yearly</option>
        </select>
      </div>
      <button id="btnExcel" class="btn" type="button">Excel</button>
    </div>
  </div>

  <!-- Walk-in -->
  <div class="card">
    <h2>Walk-in</h2>
    <div class="row">
      <div><label>Date</label><input id="wDate" type="date"/></div>
      <div><label>Time</label><input id="wTime" type="time" step="900"/></div>
      <div><label>Guests</label><input id="wGuests" type="number" min="1" max="48" value="2"/></div>
    </div>
    <label>Notes</label><input id="wNotes" placeholder="Optional"/>
    <div class="row">
      <button id="btnWalkin" class="btn" type="button">Add walk-in</button>
      <span id="wStatus" class="badge"></span>
    </div>
  </div>

  <!-- Blockzeiten -->
  <div class="card">
    <h2>Block times / days</h2>
    <div class="row">
      <div><label>Start</label><input id="bStart" type="datetime-local"/></div>
      <div><label>End</label><input id="bEnd" type="datetime-local"/></div>
      <div style="flex:1"><label>Reason</label><input id="bReason" placeholder="Closed"/></div>
    </div>
    <div class="row">
      <button id="btnBlock" class="btn" type="button">Block time range</button>
      <span id="bStatus" class="badge"></span>
    </div>

    <div class="row" style="margin-top:10px">
      <div><label>Whole day</label><input id="bdDate" type="date"/></div>
      <div style="flex:1"><label>Reason</label><input id="bdReason" placeholder="Closed"/></div>
      <button id="btnBlockDay" class="btn" type="button">Block whole day</button>
    </div>

    <div style="margin-top:12px">
      <h3 style="margin:6px 0 8px 0;font-size:18px">Existing blocks</h3>
      <div id="blocks" class="table"></div>
    </div>
  </div>

  <!-- Special notices -->
  <div class="card">
    <h2>Special notices</h2>
    <div class="row">
      <div>
        <label>Date</label>
        <input id="nDate" type="date"/>
      </div>
      <div style="flex:1">
        <label>Message (shown to guests; must accept)</label>
        <input id="nMsg" />
      </div>
    </div>
    <div class="row">
      <button id="btnNotice" class="btn" type="button">Save notice</button>
      <span id="nStatus" class="badge"></span>
    </div>
  </div>

</div>

<script>
  const pad2 = n => String(n).padStart(2,"0");
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };

  // Banner + Brand
  (async ()=>{
    try{
      const r=await fetch("/api/config"); const cfg=await r.json();
      document.getElementById("brand").textContent=`Admin — ${cfg.brand}`;
      document.getElementById("heroImg").src = cfg.mailHeaderUrl || cfg.mailLogoUrl || "/logo-hero.png";
    }catch{}
  })();

  /* ───── Liste ───── */
  const elDate=document.getElementById('fltDate'); elDate.value=today();
  const elView=document.getElementById('fltView');
  document.getElementById('btnLoad').onclick = loadList;

  async function loadList(){
    const d = elDate.value || today();
    const v = elView.value || 'day';
    const r = await fetch(`/api/admin/reservations?date=${encodeURIComponent(d)}&view=${encodeURIComponent(v)}`);
    const list = await r.json();
    const wrap = document.getElementById('list');

    if(!Array.isArray(list) || !list.length){ wrap.innerHTML = '<p class="muted">No data</p>'; return; }

    const rows = list.map(x=>`<tr>
      <td>${x.date}</td><td>${x.time}</td>
      <td>${x.firstName} ${x.name}${x.isWalkIn?'<span class="chip">walk-in</span>':''}</td>
      <td>${x.email||""}</td>
      <td>${x.phone||""}</td>
      <td>${x.guests}</td>
      <td>${x.status}</td>
      <td>${x.notes||""}</td>
      <td>
        <button data-id="${x.id}" class="del small">Delete</button>
        <button data-id="${x.id}" class="noshow small">No show</button>
      </td>
    </tr>`).join("");

    wrap.innerHTML = `<div class="table">
      <table>
        <thead><tr>
          <th>Date</th><th>Time</th><th>Name</th><th>Email</th><th>Phone</th>
          <th>Guests</th><th>Status</th><th>Notes</th><th>Action</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;

    wrap.querySelectorAll("button.del").forEach(b=>{
      b.onclick=async()=>{ await fetch(`/api/admin/reservations/${b.dataset.id}`,{method:"DELETE"}); loadList(); };
    });
    wrap.querySelectorAll("button.noshow").forEach(b=>{
      b.onclick=async()=>{ await fetch(`/api/admin/reservations/${b.dataset.id}/noshow`,{method:"POST"}); loadList(); };
    });
  }
  loadList();

  // Export
  document.getElementById('btnExcel').onclick=()=>{
    const d = elDate.value || today();
    const p = document.getElementById('expPeriod').value;
    window.location.href = `/api/export?date=${encodeURIComponent(d)}&period=${encodeURIComponent(p)}`;
  };

  /* ───── Walk-in ───── */
  const wDate=document.getElementById('wDate'); wDate.value=today();
  const wTime=document.getElementById('wTime'); wTime.value="10:00";
  const wGuests=document.getElementById('wGuests');
  const wNotes=document.getElementById('wNotes');
  const wStatus=document.getElementById('wStatus');

  document.getElementById('btnWalkin').onclick=async()=>{
    wStatus.textContent="";
    try{
      const r=await fetch("/api/admin/walkin",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({date:wDate.value,time:wTime.value,guests:Number(wGuests.value||0),notes:wNotes.value.trim()})
      });
      const js=await r.json();
      if(!r.ok){ wStatus.textContent=js.error||"Error"; return; }
      wStatus.textContent="Saved";
      loadList();
      setTimeout(()=>wStatus.textContent="",1500);
    }catch{ wStatus.textContent="Error"; }
  };

  /* ───── Blockzeiten ───── */
  const bStart=document.getElementById('bStart');
  const bEnd=document.getElementById('bEnd');
  const bReason=document.getElementById('bReason');
  const bdDate=document.getElementById('bdDate'); bdDate.value=today();
  const bdReason=document.getElementById('bdReason');
  const bStatus=document.getElementById('bStatus');

  document.getElementById('btnBlock').onclick=async()=>{
    bStatus.textContent="";
    try{
      const r=await fetch("/api/admin/closure",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({startTs:bStart.value,endTs:bEnd.value,reason:bReason.value.trim()})
      });
      const js=await r.json();
      if(!r.ok){ bStatus.textContent=js.error||"Error"; return; }
      bStatus.textContent="Saved";
      loadBlocks();
      setTimeout(()=>bStatus.textContent="",1500);
    }catch{ bStatus.textContent="Error"; }
  };

  document.getElementById('btnBlockDay').onclick=async()=>{
    bStatus.textContent="";
    try{
      const r=await fetch("/api/admin/closure/day",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({date:bdDate.value,reason:bdReason.value.trim()})
      });
      const js=await r.json();
      if(!r.ok){ bStatus.textContent=js.error||"Error"; return; }
      bStatus.textContent="Saved";
      loadBlocks();
      setTimeout(()=>bStatus.textContent="",1500);
    }catch{ bStatus.textContent="Error"; }
  };

  async function loadBlocks(){
    const r=await fetch("/api/admin/closure"); const list=await r.json();
    const box=document.getElementById("blocks");
    if(!Array.isArray(list)||!list.length){ box.innerHTML='<p class="muted">No blocks</p>'; return; }
    const rows=list.map(c=>`<tr>
      <td>${new Date(c.startTs).toLocaleString()}</td>
      <td>${new Date(c.endTs).toLocaleString()}</td>
      <td>${c.reason||""}</td>
      <td><button data-id="${c.id}" class="rm small">Delete</button></td>
    </tr>`).join("");
    box.innerHTML=`<div class="table"><table>
      <thead><tr><th>Start</th><th>End</th><th>Reason</th><th></th></tr></thead>
      <tbody>${rows}</tbody></table></div>`;
    box.querySelectorAll("button.rm").forEach(b=>{
      b.onclick=async()=>{ await fetch(`/api/admin/closure/${b.dataset.id}`,{method:"DELETE"}); loadBlocks(); };
    });
  }
  loadBlocks();

  /* ───── Notices ───── */
  const nDate=document.getElementById('nDate'); nDate.value=today();
  const nMsg=document.getElementById('nMsg');
  const nStatus=document.getElementById('nStatus');

  // Notice für gewähltes Datum vorfüllen
  async function loadNotice(){
    nStatus.textContent="";
    try{
      const r=await fetch(`/api/admin/notice?date=${encodeURIComponent(nDate.value)}`);
      const js=await r.json();
      nMsg.value = js && js.message ? js.message : "";
    }catch{}
  }
  nDate.addEventListener("change", loadNotice);
  loadNotice();

  document.getElementById('btnNotice').onclick=async()=>{
    nStatus.textContent="";
    try{
      const r=await fetch("/api/admin/notice",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({date:nDate.value,message:nMsg.value.trim()})
      });
      const js=await r.json();
      if(!r.ok){ nStatus.textContent=js.error||"Failed to save notice"; return; }
      nStatus.textContent="Saved";
      setTimeout(()=>nStatus.textContent="",1500);
    }catch{ nStatus.textContent="Failed"; }
  };
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Reservation — ROESTILAND BY NOXAMA SAMUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    /* --- ensure logo centered and responsive --- */
    .hero-wrap {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 18px;
      padding: 8px 0;
      pointer-events: none;
    }
    .hero-wrap .hero-banner {
      max-width: 640px;
      width: min(76%, 640px);
      height: auto;
      margin: 0 auto;
      border-radius: 12px;
      box-shadow: 0 25px 50px rgba(0,0,0,.18);
      object-fit: contain;
      display: block;
      pointer-events: auto;
    }

    /* Confirmation modal (existing) left unchanged visually */
    #confirm-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); align-items:center; justify-content:center; z-index:9999; }
    #confirm-modal > div { background:#fff8f0; border-radius:12px; padding:18px; max-width:420px; width:92%; text-align:center; border:1px solid #e0d7c5; box-shadow:0 10px 35px rgba(0,0,0,.25); }

    /* contact modal for 11+ guests */
    #contact-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:99998; align-items:center; justify-content:center; }
    #contact-modal > div { background:#fff8f0; border:1px solid #e0d7c5; border-radius:12px; max-width:520px; width:92%; padding:18px; box-shadow:0 10px 35px rgba(0,0,0,0.25); text-align:center; }
    #contact-modal a.btn-contact { display:inline-block; margin:8px 6px; padding:10px 14px; background:#b3822f; color:#fff; text-decoration:none; border-radius:8px; }

    /* loyalty modal + fireworks (user requested style + bg color) */
    #loyalty-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:99999; align-items:center; justify-content:center; }
    #loyalty-modal > div {
      background: #d6c7b2;               /* requested background color */
      border: 1px solid rgba(224,215,197,0.9);
      border-radius: 12px;
      max-width: 520px;
      width: 92%;
      padding: 18px;
      box-shadow: 0 10px 35px rgba(0,0,0,0.25);
      text-align: center;
      color: #3a2f28;
      animation: fadein .18s ease both;
      font-family: Georgia, "Times New Roman", serif;
    }
    #fw-canvas { width:100%; height:160px; display:block; border-radius:10px; margin-bottom:10px; background: linear-gradient(180deg,#fff,#fff8f2); box-shadow: inset 0 -6px 12px rgba(0,0,0,0.03); }

    /* subtle animation */
    @keyframes fadein { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform: translateY(0); } }

    /* small utilities */
    .hidden { display:none !important; }
    .text-center { text-align:center; }

  </style>
</head>
<body>
  <div class="hero-wrap" style="text-align:center;">
    <img id="heroBanner" class="hero-banner" alt="Logo banner" src="/logo-hero.png"/>
  </div>

  <div class="container">
    <h1 style="text-align:center;margin-top:8px;">Reservation — ROESTILAND BY NOXAMA SAMUI</h1>
    <p style="text-align:center;margin-top:6px;">Moo 4 Lamai Beach, 84310 Suratthani, Thailand • +66 077 270 675</p>

    <div class="card booking-card booking-compact" style="max-width:760px;margin:18px auto;padding:18px;">
      <h2>Book a table</h2>

      <div class="row date-time">
        <div style="flex:1 1 220px;">
          <label>Date</label>
          <input id="rDate" type="date"/>
        </div>
        <div style="flex:0 0 110px;">
          // --- large-party handling for 11+ ---
// Place this after your other handlers (e.g. after updateTimes() / initial listeners)
<!-- ersetze das bestehende <select id="rGuests"> ... </select> durch dieses -->
<label>Guests</label>
<select id="rGuests" aria-label="Guests">
  <option value="1">1</option>
  <option value="2">2</option>
  <option value="3">3</option>
  <option value="4">4</option>
  <option value="5">5</option>
  <option value="6">6</option>
  <option value="7">7</option>
  <option value="8">8</option>
  <option value="9">9</option>
  <option value="10">10</option>
  <option value="11">11+</option>
</select>

(function(){
  const guestsSelect = document.getElementById("rGuests");
  if (!guestsSelect) return;

  // remember previous valid value so we can restore it if user selects 11+
  let lastValidGuests = guestsSelect.value || "1";

  guestsSelect.addEventListener("focus", ()=> {
    // store current value on focus (so change can be reverted)
    lastValidGuests = guestsSelect.value;
  });

  guestsSelect.addEventListener("change", async function(){
    const v = String(this.value);
    if (v === "11") {
      // revert selection to previous valid value (so form does not accept 11)
      setTimeout(()=> { guestsSelect.value = lastValidGuests; }, 50);

      // show large-party modal (match your site's design)
      showLargePartyModal();
    } else {
      // update last valid
      lastValidGuests = v;
      // also update times when guests count changes
      try { if (typeof updateTimes === "function") updateTimes(); } catch(e){ /* ignore */ }
    }
  });

  // modal builder (small, matches site look)
  function showLargePartyModal(){
    // remove existing
    const ex = document.getElementById("__large_party_modal");
    if (ex) ex.remove();

    const overlay = document.createElement("div");
    overlay.id = "__large_party_modal";
    overlay.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:99999;";

    const box = document.createElement("div");
    box.style.cssText = "background:#fff8f0;border:1px solid #e0d7c5;border-radius:12px;max-width:620px;width:92%;padding:20px;box-shadow:0 12px 40px rgba(0,0,0,0.25);text-align:center;font-family:Georgia,serif;color:#3a2f28;";

    box.innerHTML = `
      <h3 style="margin-top:0;margin-bottom:8px;font-size:20px;">Large party request</h3>
      <p style="margin:8px 0 16px 0;line-height:1.4;">
        For parties of <strong>11 or more</strong> please contact us directly so we can arrange a suitable table and confirm availability.
      </p>
      <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:12px;">
        <a href="tel:+66077270675" style="text-decoration:none;">
          <button style="background:#b3822f;color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;">Call +66 077 270 675</button>
        </a>
        <a href="mailto:info@noxamasamui.com" style="text-decoration:none;">
          <button style="background:#b3822f;color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;">Email info@noxamasamui.com</button>
        </a>
      </div>
      <div style="font-size:13px;color:#6b5a45;margin-bottom:12px;">Or use the chat / contact form on our site — we will help you find the best option.</div>
      <div style="text-align:center;">
        <button id="__large_party_ok" style="padding:8px 14px;border-radius:8px;border:none;background:#b3822f;color:#fff;cursor:pointer;">OK</button>
      </div>
    `;

    overlay.appendChild(box);
    document.body.appendChild(overlay);

    document.getElementById("__large_party_ok").onclick = ()=> overlay.remove();
  }
})();

        </div>
        <div style="flex:0 0 140px;">
          <label>Time</label>
          <select id="rTime"></select>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>First name</label>
          <input id="rFirst" type="text"/>
        </div>
        <div>
          <label>Last name</label>
          <input id="rLast" type="text"/>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>Email</label>
          <input id="rEmail" type="email"/>
        </div>
        <div>
          <label>Phone</label>
          <input id="rPhone" type="tel"/>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>Notes</label>
        <textarea id="rNotes" rows="2" style="width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #c8b99e;"></textarea>
      </div>

      <div style="margin-top:12px;text-align:left;">
        <button id="btnReserve" class="btn btn-primary-book" type="button">Book</button>
        <span id="rMsg" class="badge" style="margin-left:10px;"></span>
      </div>
    </div>
  </div>

  <!-- confirmation modal -->
  <div id="confirm-modal">
    <div>
      <h3 id="confirm-title" style="margin-top:0;">Reservation confirmed</h3>
      <div id="confirm-text" style="margin:8px 0 12px 0;color:#3a2f28;"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="confirm-ok" class="btn" style="min-width:120px;">Continue</button>
      </div>
    </div>
  </div>

  <!-- contact modal for 11+ guests -->
  <div id="contact-modal">
    <div>
      <h3 style="margin-top:0;">Large party request</h3>
      <p>For parties of 11 or more please contact us directly so we can arrange a suitable table and confirm availability.</p>
      <div style="margin:10px 0;">
        <a class="btn-contact" href="tel:+66077270675">Call +66 077 270 675</a>
        <a class="btn-contact" href="mailto:info@noxamasamui.com">Email info@noxamasamui.com</a>
      </div>
      <div style="font-size:13px;color:#3a2f28;margin-top:6px;">Or use the chat / contact form on our site — we will help you find the best option.</div>
      <div style="margin-top:12px;">
        <button id="contact-close" class="btn" style="padding:8px 12px;border-radius:8px;background:#b3822f;color:#fff;border:none;">OK</button>
      </div>
    </div>
  </div>

  <!-- loyalty modal with fireworks -->
  <div id="loyalty-modal">
    <div>
      <h3 id="loy-title" style="margin:6px 0 8px 0;">You earned a loyalty reward</h3>
      <div id="loy-sub" style="margin-bottom:6px;color:#3a2f28;"></div>
      <canvas id="fw-canvas" aria-hidden="true"></canvas>
      <div id="loy-cta" style="margin-top:6px;"></div>
      <div style="margin-top:10px;">
        <button id="loy-ok" class="btn" style="padding:8px 14px;border-radius:8px;background:#b3822f;color:#fff;border:none;">Okay</button>
      </div>
    </div>
  </div>

<script>
/* ---------- utilities ---------- */
const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

(async()=>{
  try {
    const r = await fetch('/api/config',{cache:"no-store"});
    if (r.ok) {
      const cfg = await r.json();
      const hero = document.getElementById('heroBanner');
      if (cfg.mailHeaderUrl && cfg.mailHeaderUrl.trim()) hero.src = cfg.mailHeaderUrl;
      else if (cfg.mailLogoUrl && cfg.mailLogoUrl.trim()) hero.src = cfg.mailLogoUrl;
      else hero.src = '/logo-hero.png';
      hero.alt = cfg.brand || 'Banner';
    }
  } catch(e) { /* ignore */ }
})();

document.getElementById('rDate').value = today();

/* ---------- fill times by querying /api/slots (only allowed shown) ---------- */
async function updateTimes(){
  const date = document.getElementById('rDate').value;
  const guests = Number(document.getElementById('rGuests').value || 1);
  const sel = document.getElementById('rTime');
  sel.innerHTML = '';

  if (!date) return;

  try {
    const resp = await fetch(`/api/slots?date=${encodeURIComponent(date)}&guests=${encodeURIComponent(guests)}`, {cache:"no-store"});
    if (!resp.ok) { showGenericModal("Could not load slots. Please try again later."); return; }
    const slots = await resp.json();
    if (!Array.isArray(slots) || slots.length === 0) {
      showGenericModal("No availability for this date. Please choose another day.");
      return;
    }

    // Only show allowed slots (no "left" counts)
    const allowed = slots.filter(s => s.allowed);
    if (allowed.length === 0) {
      // If all blocked/closed -> immediate friendly modal
      const reasonSet = Array.from(new Set(slots.map(s => s.reason || "").filter(Boolean)));
      const reason = reasonSet.find(r => /sunday/i.test(r)) ? "We are closed on Sundays." : (reasonSet[0] || "This date is not available.");
      showGenericModal(reason + " Please choose another day.");
      return;
    }

    // populate times
    allowed.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.time;
      opt.textContent = s.time; // intentionally NOT showing remaining seats
      sel.appendChild(opt);
    });

  } catch(e) {
    console.error("updateTimes error", e);
    showGenericModal("Network error while fetching times");
  }
}

/* ---------- helper modals ---------- */
function showGenericModal(msg, title="Reservation not possible"){
  const ex = document.getElementById("__generic_modal");
  if (ex) ex.remove();
  const o = document.createElement("div");
  o.id = "__generic_modal";
  o.style = "position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:999997;";
  const b = document.createElement("div");
  b.style = "background:#fff8f0;border-radius:12px;padding:18px;max-width:520px;width:92%;text-align:center;border:1px solid #e0d7c5;box-shadow:0 10px 35px rgba(0,0,0,0.25);";
  b.innerHTML = `<h3 style="margin-top:0">${title}</h3><div style="color:#3a2f28;margin:8px 0 12px 0;">${msg}</div><button style="padding:8px 12px;border-radius:8px;background:#b3822f;color:#fff;border:none;">OK</button>`;
  b.querySelector("button").onclick = ()=> o.remove();
  o.appendChild(b);
  document.body.appendChild(o);
}

/* ---------- contact modal for large party ---------- */
const contactModal = document.getElementById('contact-modal');
document.getElementById('contact-close').addEventListener('click', ()=> contactModal.style.display='none');
function showContactModal(){ contactModal.style.display='flex'; }
function hideContactModal(){ contactModal.style.display='none'; }

/* ---------- loyalty modal & fireworks ---------- */
const loyModal = document.getElementById('loyalty-modal');
const fwCanvas = document.getElementById('fw-canvas');

function showLoyaltyModalForVisit(visitNo){
  // determine tier from visitNo (5..9 => 5, 10..14 =>10, >=15 =>15)
  let tier = 0;
  if (visitNo >= 15) tier = 15;
  else if (visitNo >= 10) tier = 10;
  else if (visitNo >= 5) tier = 5;
  if (!tier) return;

  document.getElementById('loy-sub').innerHTML = `You just reached visit <b>${visitNo}</b>`;
  document.getElementById('loy-cta').innerHTML = `<div style="font-size:18px;padding:10px 12px;border-radius:8px;background:#fff8ea;display:inline-block;">Enjoy a <b style="color:#b3822f">${tier}%</b> thank-you discount on your next visit</div>`;
  loyModal.style.display = 'flex';
  startFireworks(); // heavy, colorful effect
}

document.getElementById('loy-ok').addEventListener('click', ()=>{
  stopFireworks();
  loyModal.style.display = 'none';
});

/* ---------- canvas fireworks implementation (more colorful / more particles) ---------- */
let fwCtx, fwW, fwH, fwAnim, particles = [];

function resizeCanvas(){
  if (!fwCanvas) return;
  fwW = fwCanvas.width = Math.floor(fwCanvas.clientWidth * devicePixelRatio);
  fwH = fwCanvas.height = Math.floor(fwCanvas.clientHeight * devicePixelRatio);
  fwCanvas.style.width = fwCanvas.clientWidth + "px";
  fwCanvas.style.height = fwCanvas.clientHeight + "px";
  fwCtx = fwCanvas.getContext('2d');
  fwCtx && fwCtx.scale(devicePixelRatio, devicePixelRatio);
}
function rand(min,max){ return min + Math.random()*(max-min); }

function spawnBurst(x,y, count){
  const colors = ['#e74c3c','#f39c12','#f1c40f','#2ecc71','#3498db','#9b59b6','#e67e22','#ffd54f','#ff6bcb','#7bed9f'];
  for(let i=0;i<count;i++){
    const a = rand(0, Math.PI*2);
    const speed = rand(60, 360);
    particles.push({
      x, y,
      vx: Math.cos(a)*speed,
      vy: Math.sin(a)*speed,
      life: rand(900,1600),
      age: 0,
      size: rand(3,8),
      color: colors[Math.floor(Math.random()*colors.length)],
      rotate: rand(0,720),
      spin: rand(-0.5,0.5)
    });
  }
}

function startFireworks(){
  resizeCanvas();
  particles = [];
  // schedule bursts: center + offsets
  const w = fwCanvas.clientWidth;
  spawnBurst(w*0.5, 120, 120);
  setTimeout(()=> spawnBurst(w*0.3, 110, 80), 220);
  setTimeout(()=> spawnBurst(w*0.7, 100, 90), 300);
  setTimeout(()=> spawnBurst(w*0.45, 50, 120), 600);
  // continuous smaller sparkles
  let t=0;
  (function loop(now){
    fwAnim = requestAnimationFrame(loop);
    if(!fwCtx) return;
    fwCtx.clearRect(0,0,fwW,fwH);
    const dt = 16;
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.age += dt;
      // simple physics, gravity and drag
      const dtSec = dt/1000;
      p.vy += 200 * dtSec; // gravity
      p.vx *= 0.995;
      p.vy *= 0.995;
      p.x += p.vx * dtSec;
      p.y += p.vy * dtSec;
      p.rotate += p.spin * dtSec * 60;

      const alpha = Math.max(0, 1 - p.age / p.life);
      fwCtx.save();
      fwCtx.globalAlpha = alpha;
      fwCtx.translate(p.x, p.y);
      fwCtx.rotate(p.rotate * Math.PI / 180);
      fwCtx.fillStyle = p.color;
      fwCtx.beginPath();
      fwCtx.arc(0, 0, p.size, 0, Math.PI*2);
      fwCtx.fill();
      fwCtx.restore();

      if (p.age >= p.life || p.y > fwCanvas.clientHeight + 20) {
        particles.splice(i,1);
      }
    }
    // occasionally spawn trailing sparkles
    t += dt;
    if (t % 1200 < 20) {
      const x = rand(40, fwCanvas.clientWidth - 40);
      const y = rand(40, fwCanvas.clientHeight/2);
      spawnBurst(x,y, Math.floor(rand(30,70)));
    }
  })();
}

function stopFireworks(){
  cancelAnimationFrame(fwAnim);
  particles = [];
  if(fwCtx) fwCtx.clearRect(0,0,fwW,fwH);
}

/* ---------- input wiring: date / guests / times ---------- */
document.getElementById('rDate').addEventListener('change', ()=> {
  updateTimes();
});
document.getElementById('rGuests').addEventListener('change', ()=> {
  const g = Number(document.getElementById('rGuests').value || 1);
  // if >= 11: disable booking, clear times and show contact modal
  if (g >= 11) {
    document.getElementById('rTime').innerHTML = '';
    document.getElementById('btnReserve').disabled = true;
    document.getElementById('btnReserve').style.opacity = '0.7';
    showContactModal();
  } else {
    document.getElementById('btnReserve').disabled = false;
    document.getElementById('btnReserve').style.opacity = '1';
    hideContactModal();
    updateTimes();
  }
});

/* initial fill */
updateTimes();

/* ---------- reserve click handling ---------- */
document.getElementById('btnReserve').addEventListener('click', async ()=>{
  const btn = document.getElementById('btnReserve');
  const msg = document.getElementById('rMsg');
  msg.textContent = '';
  btn.disabled = true;
  btn.style.opacity = '0.6';

  const payload = {
    date: document.getElementById('rDate').value,
    time: document.getElementById('rTime').value,
    firstName: (document.getElementById('rFirst').value||'').trim(),
    name: (document.getElementById('rLast').value||'').trim(),
    email: (document.getElementById('rEmail').value||'').trim(),
    phone: (document.getElementById('rPhone').value||'').trim(),
    guests: Number(document.getElementById('rGuests').value || 1),
    notes: (document.getElementById('rNotes').value||'').trim()
  };

  // client side guard
  if (!payload.firstName || !payload.name || !payload.email || !payload.guests) {
    msg.textContent = 'Please fill first name, last name, email and guests';
    btn.disabled = false; btn.style.opacity = '1';
    return;
  }
  if (payload.guests >= 11) {
    // should not happen because we disable button, but just in case
    showContactModal();
    btn.disabled = false; btn.style.opacity = '1';
    return;
  }

  try {
    const res = await fetch('/api/reservations', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const json = await res.json().catch(()=>({}));
    if (res.ok) {
      // show loyalty modal if visitNo >= 5
      const visitNo = Number(json.visitNo || 0);
      if (visitNo >= 5) {
        // show loyalty modal with fireworks background color #d6c7b2
        showLoyaltyModalForVisit(visitNo);
        // when loyalty modal closed it continues with confirmation
        document.getElementById('loy-ok').onclick = ()=>{
          stopFireworks();
          loyModal.style.display = 'none';
          // show simple confirmation afterwards
          showConfirmation(`Thank you! A confirmation mail was sent to <b>${payload.email}</b>.`);
        };
      } else {
        showConfirmation(`Thank you! A confirmation mail was sent to <b>${payload.email}</b>.`);
      }
    } else {
      const err = (json && json.error) ? String(json.error) : "Reservation failed";
      if (/sunday/i.test(err) || /closed/i.test(err) || /blocked/i.test(err) || /fully booked/i.test(err)) {
        // friendly immediate modal
        showGenericModal(err + ". Please choose another date.");
      } else {
        msg.textContent = err;
      }
    }
  } catch(e) {
    console.error(e);
    msg.textContent = 'Network error';
  } finally {
    btn.disabled = false; btn.style.opacity = '1';
    updateTimes(); // refresh times to reflect new occupancy
  }
});

/* confirmation modal helpers */
function showConfirmation(html){
  document.getElementById('confirm-title').textContent = "Reservation received";
  document.getElementById('confirm-text').innerHTML = html;
  document.getElementById('confirm-ok').onclick = ()=> { document.getElementById('confirm-modal').style.display='none'; window.location.href = '/'; };
  document.getElementById('confirm-modal').style.display = 'flex';
}

/* responsive canvas resize when modal shown */
new ResizeObserver(()=> { if (loyModal.style.display === 'flex') resizeCanvas(); }).observe(document.body);

/* hide modals on escape */
document.addEventListener('keydown', (e)=> {
  if (e.key === 'Escape') {
    if (loyModal.style.display==='flex') { stopFireworks(); loyModal.style.display='none'; }
    document.getElementById('confirm-modal').style.display='none';
    contactModal.style.display='none';
    const g = document.getElementById("__generic_modal"); if (g) g.remove();
  }
});
</script>

</body>
</html>

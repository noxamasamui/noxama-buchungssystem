<!-- public/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Table Booking â€” RÃ–STILAND</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <header class="container">
    <img src="/logo-hero.png" alt="RÃ–STILAND" class="hero-logo" />
    <h1 class="page-title">Contact and Table Booking</h1>
  </header>

  <main class="container">
    <section class="card">
      <h2>Address</h2>
      <p id="addr-line"></p>
      <div class="btn-row">
        <a id="call-btn" class="btn" href="#">Phone</a>
        <a id="mail-btn" class="btn" href="#">Email</a>
      </div>
    </section>

    <section class="card">
      <div class="form-row">
        <label for="date">Date</label>
        <input id="date" type="date" />
      </div>

      <div class="form-row">
        <label for="guests">Guests (max 10 online)</label>
        <select id="guests"></select>
      </div>

      <div class="form-row">
        <label>Choose a time slot</label>
        <div id="slots" class="slots"></div>
        <div id="slot-info" class="note"></div>
      </div>

      <div class="grid-2">
        <div class="form-row">
          <label for="firstName">First name*</label>
          <input id="firstName" type="text" />
        </div>
        <div class="form-row">
          <label for="name">Name*</label>
          <input id="name" type="text" />
        </div>
      </div>

      <div class="grid-2">
        <div class="form-row">
          <label for="email">Email*</label>
          <input id="email" type="email" />
        </div>
        <div class="form-row">
          <label for="phone">Phone (optional)</label>
          <input id="phone" type="text" />
        </div>
      </div>

      <div class="form-row">
        <label for="notes">Notes</label>
        <textarea id="notes" rows="3" placeholder="Allergies, seating request, occasion"></textarea>
      </div>

      <div class="form-row">
        <button id="book-btn" class="btn-primary">Book now</button>
      </div>
    </section>
  </main>

  <div id="modal-root"></div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script>
    const slotsDiv = document.getElementById('slots');
    const slotInfo = document.getElementById('slot-info');
    let selectedTime = null;
    let CFG = null;

    function esc(s){return String(s||'');}
    function todayYmd(){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${m}-${day}`;
    }
    function showInfo(msg){ slotInfo.textContent = msg || ''; }

    function showModal(html){
      const root = document.getElementById('modal-root');
      root.innerHTML = `
        <div class="modal-wrap">
          <div class="modal">
            <button class="modal-close" aria-label="Close">Ã—</button>
            ${html}
          </div>
        </div>`;
      root.querySelector('.modal-close').onclick = ()=> root.innerHTML='';
      root.querySelector('.modal-wrap').onclick = (e)=>{ if(e.target.classList.contains('modal-wrap')) root.innerHTML=''; };
    }

    function celebrate(visitCount, discount){
      showModal(`
        <div class="modal-title">ðŸŽ‰ Thank you for your loyalty!</div>
        <div style="font-size:1.05rem;line-height:1.5;margin-bottom:10px;">
          This is your <b>${visitCount}${ordinal(visitCount)}</b> visit.
          Your <b>${discount}% loyalty thank-you</b> is now active for this reservation.
        </div>
        <canvas id="confettiCanvas" class="confetti-canvas"></canvas>
      `);
      const canvas = document.getElementById('confettiCanvas');
      const myConfetti = confetti.create(canvas, { resize:true, useWorker:true });
      const end = Date.now() + 7000; // 7s
      (function frame(){
        myConfetti({ particleCount: 5, spread: 120, startVelocity: 60, scalar: 1.2, ticks: 200, origin: { x: Math.random(), y: Math.random() - 0.2 } });
        if (Date.now() < end) requestAnimationFrame(frame);
      })();
    }
    function ordinal(n){const v=n%100;if(v>=11&&v<=13)return"th";switch(n%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th";}}

    async function loadConfig(){
      CFG = await fetch('/api/config').then(r=>r.json());
      // header
      document.getElementById('addr-line').textContent = CFG.address;
      document.getElementById('call-btn').href = `tel:${CFG.phone}`;
      document.getElementById('mail-btn').href = `mailto:${CFG.email}`;

      // guests max 10 â€“ hart
      const sel = document.getElementById('guests');
      sel.innerHTML='';
      const maxG = Math.min(10, CFG.maxOnlineGuests || 10);
      for(let i=1;i<=maxG;i++){
        const o = document.createElement('option');
        o.value = String(i); o.textContent = String(i);
        sel.appendChild(o);
      }
    }

    async function loadSlots(){
      const ymd = document.getElementById('date').value;
      const guests = Number(document.getElementById('guests').value || 1);
      selectedTime = null;
      slotsDiv.innerHTML = '';
      showInfo('');

      // Hinweis fÃ¼r den Tag (Admin-Notice)
      try{
        const n = await fetch(`/api/notice?date=${encodeURIComponent(ymd)}`).then(r=>r.json());
        if(n && n.message){
          showModal(`<div class="modal-title">Information</div><div>${n.message}</div>`);
        }
      }catch{}

      const data = await fetch(`/api/slots?date=${encodeURIComponent(ymd)}&guests=${guests}`).then(r=>r.json());
      const offered = data.filter(s => s.canReserve === true);
      if(offered.length === 0){
        if (data.some(s=>s.reason==='Closed on Sunday')) {
          showModal(`<div class="modal-title">We are closed on Sunday</div><div>We hope to welcome you on another day.</div>`);
        } else {
          showModal(`<div class="modal-title">Fully booked</div><div>We are fully booked on this date. Please choose another day.</div>`);
        }
        return;
      }
      offered.forEach(s=>{
        const b = document.createElement('button');
        b.type='button';
        b.className = 'slot-btn';
        b.textContent = s.time;
        b.onclick = ()=>{
          selectedTime = s.time;
          [...slotsDiv.querySelectorAll('button')].forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
        };
        slotsDiv.appendChild(b);
      });
    }

    async function bookNow(){
      const ymd = document.getElementById('date').value;
      const guests = Number(document.getElementById('guests').value || 1);
      const firstName = document.getElementById('firstName').value.trim();
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const notes = document.getElementById('notes').value.trim();

      if(!selectedTime){
        showModal(`<div class="modal-title">Choose a time</div><div>Please select a free time slot first.</div>`);
        return;
      }
      const payload = { date: ymd, time: selectedTime, firstName, name, email, phone, guests, notes };
      const r = await fetch('/api/reservations',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const res = await r.json();

      if(!r.ok){
        showModal(`<div class="modal-title">Oops</div><div>${esc(res.error || 'Something went wrong.')}</div>`);
        return;
      }

      // Loyalty Feuerwerk bei 5/10/15, sonst normales Danke
      if (res.visitCount === 5 || res.visitCount === 10 || res.visitCount === 15) {
        celebrate(res.visitCount, res.discount || 0);
      } else {
        showModal(`<div class="modal-title">Thank you!</div><div>Reservation received. You will get a confirmation email shortly (please check your spam folder).</div>`);
      }
    }

    // Init
    (async function(){
      await loadConfig();
      document.body.style.backgroundColor = '#d6c7b2';
      const date = document.getElementById('date');
      date.value = todayYmd();
      date.addEventListener('change', loadSlots);
      document.getElementById('guests').addEventListener('change', loadSlots);
      document.getElementById('book-btn').addEventListener('click', bookNow);
      await loadSlots();
    })();
  </script>
</body>
</html>

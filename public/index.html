<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Reservation — ROESTILAND BY NOXAMA SAMUI</title>
  <link rel="stylesheet" href="/style.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* --- Ergänzende Styles (nur das Nötigste, rest bleibt in style.css) --- */

    /* ensure hero banner centered and not changed */
    .hero-wrap { text-align:center; margin-top:18px; }
    .hero-banner { max-width:640px; width:76%; border-radius:12px; box-shadow:0 25px 50px rgba(0,0,0,.18); display:inline-block; }

    /* Loyalty modal + fireworks styling (requested) */
    #loyalty-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:99999; align-items:center; justify-content:center; }
    #loyalty-modal > .card {
      background:#d6c7b2; /* requested modal bg */
      border:1px solid rgba(0,0,0,0.06);
      border-radius:12px;
      max-width:520px;
      width:92%;
      padding:14px;
      box-shadow:0 10px 35px rgba(0,0,0,0.25);
      text-align:center;
      position:relative;
      overflow:visible;
    }
    #fw-canvas { width:100%; height:200px; display:block; border-radius:10px; margin-bottom:12px; background:linear-gradient(180deg,#fff,#fff8f2); box-shadow: inset 0 -6px 12px rgba(0,0,0,0.03); }

    #loyalty-modal h2 { margin:8px 0 4px; font-size:22px; color:#3a2f28; }
    #loyalty-modal p { margin:6px 0; color:#3a2f28; }

    #loyalty-modal .btn { margin-top:10px; background:#b3822f; color:#fff; border-radius:8px; padding:8px 14px; border:0; cursor:pointer; font-weight:700; }

    /* 11+ large party modal */
    #largeparty-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:99998; align-items:center; justify-content:center; }
    #largeparty-modal > .box {
      background:#fff8f0; border:1px solid #e0d7c5; border-radius:12px; max-width:520px; width:92%; padding:18px; box-shadow:0 10px 35px rgba(0,0,0,0.25); text-align:center;
    }
    #largeparty-modal .contact-row { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:12px; }
    #largeparty-modal .contact-row a { background:#b3822f; color:#fff; padding:10px 14px; border-radius:8px; text-decoration:none; font-weight:700; display:inline-block; min-width:120px; text-align:center; }
    @media (max-width:520px) {
      #largeparty-modal .contact-row a { min-width:120px; flex:1 1 100%; }
      #loyalty-modal > .card { padding:12px; }
      #fw-canvas { height:140px; }
    }

    /* small utility: hidden */
    .hidden { display:none !important; }

    /* special info modal (date-specific notifications) */
    #special-info-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:99997; align-items:center; justify-content:center; }
    #special-info-modal > .box { background:#fff8f0; border:1px solid #e0d7c5; border-radius:12px; max-width:520px; width:92%; padding:18px; box-shadow:0 10px 35px rgba(0,0,0,0.25); text-align:center; }
    #special-info-modal h3 { margin-top:0; color:#3a2f28; }
    #special-info-modal p { color:#3a2f28; }
    #special-info-modal .btn { margin-top:12px; background:#b3822f; color:#fff; padding:8px 14px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
  </style>
</head>
<body>
  <div class="hero-wrap">
    <img id="heroBanner" class="hero-banner" alt="Logo banner" src="/logo-hero.png"/>
  </div>

  <div class="container">
    <h1 style="text-align:center;margin-top:8px;">Reservation — ROESTILAND BY NOXAMA SAMUI</h1>
    <p style="text-align:center;margin-top:6px;">Moo 4 Lamai Beach, 84310 Suratthani, Thailand • +66 077 270 675</p>

    <div class="card booking-card booking-compact" style="max-width:760px;margin:18px auto;padding:18px;">
      <h2>Book a table</h2>

      <div class="row date-time">
        <div style="flex:1 1 220px;">
          <label>Date</label>
          <input id="rDate" type="date"/>
        </div>
        <div style="flex:0 0 110px;">
          <label>Guests</label>
          <select id="rGuests">
            <!-- 1..10 then 11+ -->
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
            <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
            <option value="11plus">11+</option>
          </select>
        </div>
        <div style="flex:0 0 140px;">
          <label>Time</label>
          <select id="rTime"></select>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>First name</label>
          <input id="rFirst" type="text"/>
        </div>
        <div>
          <label>Last name</label>
          <input id="rLast" type="text"/>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>Email</label>
          <input id="rEmail" type="email"/>
        </div>
        <div>
          <label>Phone</label>
          <input id="rPhone" type="tel"/>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>Notes</label>
        <textarea id="rNotes" rows="2" style="width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #c8b99e;"></textarea>
      </div>

      <div style="margin-top:12px;text-align:left;">
        <button id="btnReserve" class="btn btn-primary-book" type="button">Book</button>
        <span id="rMsg" class="badge" style="margin-left:10px;"></span>
      </div>
    </div>
  </div>

  <!-- confirmation modal -->
  <div id="confirm-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#fff8f0;border-radius:12px;padding:18px;max-width:420px;width:92%;text-align:center;border:1px solid #e0d7c5;">
      <h3 id="confirm-title" style="margin-top:0;">Reservation confirmed</h3>
      <div id="confirm-text" style="margin:8px 0 12px 0;color:#3a2f28;"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="confirm-ok" class="btn" style="min-width:120px;">Continue</button>
      </div>
    </div>
  </div>

  <!-- loyalty modal (with fireworks canvas) -->
  <div id="loyalty-modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="loyalty-title">
      <canvas id="fw-canvas"></canvas>
      <h2 id="loyalty-title">You earned a loyalty reward</h2>
      <p id="loyalty-sub">Congratulations — loyalty reward unlocked!</p>
      <p id="loyalty-msg"></p>
      <button id="loyalty-ok" class="btn">Okay</button>
    </div>
  </div>

  <!-- large party modal -->
  <div id="largeparty-modal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" aria-labelledby="lp-title">
      <h2 id="lp-title">Large party request</h2>
      <p>For parties of 11 or more please contact us directly so we can arrange a suitable table and confirm availability.</p>
      <div class="contact-row" style="margin-top:12px;">
        <a href="tel:+66077270675" id="lp-call">Call +66 077 270 675</a>
        <a href="mailto:info@noxamasamui.com" id="lp-email">Email info@noxamasamui.com</a>
      </div>
      <div style="margin-top:12px;">
        <button id="lp-ok" class="btn">OK</button>
      </div>
    </div>
  </div>

  <!-- special-date info modal -->
  <div id="special-info-modal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" aria-labelledby="sd-title">
      <h3 id="sd-title">Information</h3>
      <div id="sd-body" style="margin-top:8px;"></div>
      <button id="sd-ok" class="btn">OK</button>
    </div>
  </div>

<script>
  // ---------- Helpers ----------
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

  // load banner from /api/config
  (async()=>{
    try{
      const r = await fetch('/api/config', {cache:"no-store"});
      const cfg = await r.json();
      const hero = document.getElementById('heroBanner');
      hero.src = cfg.mailHeaderUrl || cfg.mailLogoUrl || '/logo-hero.png';
      hero.alt = cfg.brand || 'Banner';
    }catch(e){ console.error(e); }
  })();

  document.getElementById('rDate').value = today();

  // fill time select (same as admin)
  function fillTimes(){
    const sel = document.getElementById('rTime');
    sel.innerHTML = '';
    const from = 10*60, to = 22*60, interval = 15;
    for(let m=from;m<=to;m+=interval){
      const hh=String(Math.floor(m/60)).padStart(2,"0");
      const mm=String(m%60).padStart(2,"0");
      const opt=document.createElement("option"); opt.value=`${hh}:${mm}`; opt.textContent=opt.value;
      sel.appendChild(opt);
    }
  }
  fillTimes();

  // find reserve button and add handler
  document.getElementById('btnReserve').addEventListener('click', async ()=>{
    const d = document.getElementById('rDate').value || today();
    const t = document.getElementById('rTime').value;
    const payload = {
      date: d,
      time: t,
      firstName: (document.getElementById('rFirst').value || "").trim(),
      name: (document.getElementById('rLast').value || "").trim(),
      email: (document.getElementById('rEmail').value || "").trim(),
      phone: (document.getElementById('rPhone').value || "").trim(),
      guests: Number(document.getElementById('rGuests').value || 1),
      notes: (document.getElementById('rNotes').value || "").trim()
    };
    const msg = document.getElementById('rMsg');
    msg.textContent = '';

    // basic client validation (keep minimal)
    if(!payload.firstName || !payload.name || !payload.email || !payload.guests){
      msg.textContent = 'Please fill first name, last name, email and guests';
      return;
    }

    try{
      const r = await fetch('/api/reservations', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });

      const json = await r.json().catch(()=>({}));
      if(r.ok){
        // success — show confirmation modal and then redirect to /
        const title = document.getElementById('confirm-title');
        const txt = document.getElementById('confirm-text');
        title.textContent = 'Reservation received';
        txt.innerHTML = `Thank you! Your reservation is confirmed. A confirmation mail will be sent to <b>${payload.email}</b>. Please also check your spam folder.`;
        // If loyalty popup unlocked, show loyalty modal first (if available)
        if(json && (json.nowUnlockedTier===5 || json.nowUnlockedTier===10 || json.nowUnlockedTier===15) && typeof showLoyaltyModal === 'function'){
          showLoyaltyModal(json.nowUnlockedTier);
          // when loyalty modal is closed it will stop fireworks; we also show confirm modal afterwards
          document.getElementById('loyalty-ok').onclick = ()=>{ hideLoyaltyModal(); showConfirmModal(); };
        } else {
          showConfirmModal();
        }

        // helper: ok button will redirect to home
        document.getElementById('confirm-ok').onclick = ()=>{ hideConfirmModal(); window.location.href = '/'; };
      } else {
        // handle known server messages: closed/blocked/fully booked => user-friendly popup
        const err = (json && json.error) ? json.error : "Failed to create reservation";
        if(err.toLowerCase().includes("closed") || err.toLowerCase().includes("blocked") || err.toLowerCase().includes("fully booked")){
          // show modal with custom message
          const title = document.getElementById('confirm-title');
          const txt = document.getElementById('confirm-text');
          title.textContent = 'Not available';
          if(err.toLowerCase().includes("sunday")) {
            txt.textContent = "We are closed on Sundays. Please choose another day.";
          } else if(err.toLowerCase().includes("blocked") || err.toLowerCase().includes("closed")) {
            txt.textContent = "This date is blocked or closed. Please choose another day.";
          } else {
            txt.textContent = "This slot is fully booked. Please choose another time or day.";
          }
          document.getElementById('confirm-ok').onclick = ()=>{ hideConfirmModal(); };
          showConfirmModal();
        } else {
          msg.textContent = err || 'Error saving reservation';
        }
      }
    }catch(e){
      console.error('reservation post error', e);
      msg.textContent = 'Network error';
    }
  });

  function showConfirmModal(){
    const m = document.getElementById('confirm-modal');
    m.style.display = 'flex';
  }
  function hideConfirmModal(){
    const m = document.getElementById('confirm-modal');
    m.style.display = 'none';
  }

  // ---------- NEW: special-date check (on date change) ----------
  // When date is chosen, query /api/special-dates to see if there's a message for that y-m-d
  async function checkSpecialDateAndNotify(ymd){
    if(!ymd) return;
    try{
      const r = await fetch(`/api/special-dates?date=${encodeURIComponent(ymd)}`, { cache: "no-store" });
      if(!r.ok) return;
      const list = await r.json();
      if(!Array.isArray(list) || list.length === 0) return;
      // show the first matching message (admin can manage multiple; frontend shows all if desired)
      const m = list[0];
      document.getElementById('sd-title').textContent = m.title || "Note about this date";
      document.getElementById('sd-body').innerHTML = `<div style="color:#3a2f28;">${m.message || ""}</div>`;
      document.getElementById('sd-ok').onclick = ()=>{ document.getElementById('special-info-modal').style.display = 'none'; };
      document.getElementById('special-info-modal').style.display = 'flex';
    }catch(e){
      console.error("special-date check error", e);
    }
  }

  // attach date change: call updateTimes (existing) and then check special date
  document.getElementById('rDate').addEventListener('change', (e)=>{
    const val = e.target.value;
    // maintain existing behavior
    (typeof updateTimes === 'function') && updateTimes();
    // new behavior (special-date popup)
    checkSpecialDateAndNotify(val);
  });

  // also check on page load for default date
  checkSpecialDateAndNotify(document.getElementById('rDate').value);

  // ---------- rest of index functions (retain existing fireworks/loyalty/largeparty logic) ----------
  // For safety reuse other functions defined later (we kept full implementations in earlier file)
  // However to keep this file standalone we implement the minimal functions used above, and retain existing ones
  // The rest of the app's advanced logic (fireworks) is below, unchanged from prior version

  // fill times select (updated to ask slots endpoint if present)
  async function updateTimes(){
    // If API /api/slots is available, prefer to fetch allowed slots (so unavailable times are not shown)
    const date = document.getElementById('rDate').value;
    const guests = Number(document.getElementById('rGuests').value || 1);
    const sel = document.getElementById('rTime');
    sel.innerHTML = '';
    if(!date) return;
    try{
      const resp = await fetch(`/api/slots?date=${encodeURIComponent(date)}&guests=${encodeURIComponent(guests)}`, { cache:"no-store" });
      if(!resp.ok) { fillTimes(); return; }
      const slots = await resp.json();
      if(!Array.isArray(slots) || slots.length === 0) { fillTimes(); return; }
      const allowed = slots.filter(s => s.allowed);
      if(allowed.length === 0){
        // Let other logic show closed/blocked popup
        return;
      }
      allowed.forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s.time;
        opt.textContent = s.time;
        sel.appendChild(opt);
      });
    }catch(e){
      console.error("updateTimes fallback", e);
      fillTimes();
    }
  }

  // (Large party / loyalty code and fireworks engine are unchanged from previous working file)
  // For brevity include a minimal copy of those functions necessary for the page to operate; the detailed
  // fireworks implementation is the same as earlier and remains here so loyalty popups still show.
  // --- Minimal large party modal handlers ---
  document.getElementById('rGuests').addEventListener('change', function(){
    const v = this.value;
    if(v === '11plus'){
      const m = document.getElementById('largeparty-modal');
      m.style.display = 'flex';
      document.getElementById('lp-ok').onclick = ()=>{ m.style.display = 'none'; };
      // reset selection back to 1
      setTimeout(()=>{ this.value = '1'; updateTimes(); }, 10);
    } else {
      updateTimes();
    }
  });

  // --- Loyalty modal and fireworks (the full implementation is added below) ---
  // We'll reuse full fireworks code from previous working file (kept intact).
  // ... for space: full fireworks code continues exactly as in previous file (kept intact) ...
</script>

<!-- FIREWORKS + LOYALTY implementation copied intact from the working version -->
<script>
  // start of loyalty/fireworks code (kept intact)
  function showConfirmModal(){ document.getElementById('confirm-modal').style.display = 'flex'; }
  function hideConfirmModal(){ document.getElementById('confirm-modal').style.display = 'none'; }

  function showLoyaltyModal(tier){
    const m = document.getElementById('loyalty-modal');
    m.style.display = 'flex';
    const msgEl = document.getElementById('loyalty-msg');
    msgEl.innerHTML = `You just reached visit ${tier} <br><strong>Enjoy a ${tier}% thank-you discount on your next visit</strong>`;
    startFireworks(document.getElementById('fw-canvas'));
  }
  function hideLoyaltyModal(){
    stopFireworks();
    document.getElementById('loyalty-modal').style.display = 'none';
  }

  // fireworks implementation (same as before)
  let _fwRunning = false;
  let _fwRAF = null;
  let _fwCtx = null;
  let _fwCanvas = null;
  let _fwParticles = [];

  function startFireworks(canvas){
    if(_fwRunning) return;
    _fwCanvas = canvas;
    canvas.width = canvas.clientWidth * devicePixelRatio;
    canvas.height = canvas.clientHeight * devicePixelRatio;
    _fwCtx = canvas.getContext('2d');
    _fwCtx.scale(devicePixelRatio, devicePixelRatio);
    _fwParticles = [];
    _fwRunning = true;

    spawnBurst(200, canvas.clientWidth/2, canvas.clientHeight/2);
    const burstInterval = setInterval(()=> spawnBurst(120 + Math.random()*120, 50 + Math.random()*(canvas.clientWidth-100), 40 + Math.random()*(canvas.clientHeight-80)), 600);

    function loop(){
      if(!_fwRunning) { clearInterval(burstInterval); _fwRAF = null; return; }
      _fwCtx.clearRect(0,0,canvas.clientWidth, canvas.clientHeight);
      _fwCtx.fillStyle = 'rgba(214,199,178,0.08)';
      _fwCtx.fillRect(0,0,canvas.clientWidth, canvas.clientHeight);

      for(let i=_fwParticles.length-1;i>=0;i--){
        const p = _fwParticles[i];
        p.vy += 0.03 * p.weight;
        p.x += p.vx;
        p.y += p.vy;
        p.vx *= 0.995;
        p.vy *= 0.995;
        p.life -= 1;
        const alpha = Math.max(0, p.life / p.maxLife);
        _fwCtx.globalAlpha = alpha;
        const g = _fwCtx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size*1.8);
        g.addColorStop(0, p.color);
        g.addColorStop(0.6, p.color);
        g.addColorStop(1, 'rgba(255,255,255,0)');
        _fwCtx.fillStyle = g;
        _fwCtx.beginPath();
        _fwCtx.arc(p.x, p.y, p.size, 0, Math.PI*2);
        _fwCtx.fill();

        if(Math.random() < 0.02){
          _fwCtx.fillStyle = 'rgba(255,255,255,0.9)';
          _fwCtx.fillRect(p.x+Math.random()*2-1, p.y+Math.random()*2-1, 1.5, 1.5);
        }

        if(p.life <= 0 || p.y > canvas.clientHeight + 40) {
          _fwParticles.splice(i,1);
        }
      }

      _fwCtx.globalAlpha = 1;
      _fwRAF = requestAnimationFrame(loop);
    }
    loop();

    function spawnBurst(count, cx, cy){
      const colors = ['#e74c3c','#f39c12','#ffd54f','#f06292','#9b59b6','#8e44ad','#3498db','#2ecc71','#ff7043','#ffe082'];
      for(let i=0;i<count;i++){
        const ang = Math.random()*Math.PI*2;
        const speed = 1 + Math.random()*6;
        const vx = Math.cos(ang)*speed;
        const vy = Math.sin(ang)*speed*0.9 - (Math.random()*2);
        const size = 2 + Math.random()*5;
        const life = 40 + Math.floor(Math.random()*90);
        const color = colors[Math.floor(Math.random()*colors.length)];
        _fwParticles.push({
          x: cx + (Math.random()*8-4),
          y: cy + (Math.random()*8-4),
          vx, vy,
          size,
          life,
          maxLife: life,
          color,
          weight: 0.8 + Math.random()*0.8
        });
      }
    }
  }

  function stopFireworks(){
    _fwRunning = false;
    if(_fwRAF) { cancelAnimationFrame(_fwRAF); _fwRAF = null; }
    if(_fwCanvas && _fwCtx){
      _fwCtx.clearRect(0,0,_fwCanvas.clientWidth, _fwCanvas.clientHeight);
    }
    _fwParticles = [];
  }

  document.getElementById('loyalty-ok').addEventListener('click', ()=> hideLoyaltyModal());

  window.addEventListener('resize', ()=>{
    if(_fwCanvas && _fwCanvas.parentElement && _fwCanvas.parentElement.offsetParent && _fwRunning){
      _fwCanvas.width = _fwCanvas.clientWidth * devicePixelRatio;
      _fwCanvas.height = _fwCanvas.clientHeight * devicePixelRatio;
      _fwCtx.scale(devicePixelRatio, devicePixelRatio);
    }
  });
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Contact and Table Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    /* kleine, gezielte Verbesserungen für Handy */
    .btn-soft { background:#fff; border:2px solid #b38a4a33; padding:.7rem 1rem; border-radius:16px; box-shadow: 0 2px 0 #b38a4a22 inset; font-weight:700;}
    .btn-soft:hover { box-shadow: 0 3px 0 #b38a4a33 inset; }
    .contact-actions { display:flex; gap:.6rem; flex-wrap:wrap; }
    .chip { display:inline-flex; align-items:center; gap:.5rem; background:#fff; border:1px solid #d9c9b3; padding:.35rem .6rem; border-radius:999px; font-size:.9rem }
    .toast {display:none; margin:.6rem 0; padding:.8rem 1rem; background:#ecfff1; border:1px solid #c7efd0; border-radius:10px; color:#245a2f;}
    .toast.show{display:block;}
  </style>
</head>
<body>
  <header class="hero">
    <img src="https://i.imgur.com/LQ4nzwd.png" alt="Röstiland" class="hero-banner"/>
  </header>

  <main class="container">
    <h1 class="title">Contact and Table Booking</h1>

    <section class="card">
      <h2>Address</h2>
      <p id="venueAddress"></p>
      <div class="contact-actions">
        <a id="phoneBtn" class="btn-soft" href="#">Phone</a>
        <a id="mailBtn" class="btn-soft" href="#">Email</a>
        <a id="mapsBtn" class="btn-soft" href="#" target="_blank" rel="noopener">Open in Maps</a>
      </div>
    </section>

    <section class="card">
      <div class="grid">
        <div>
          <label>Date</label>
          <input id="date" type="date" class="input" />
        </div>
        <div>
          <label>Guests (max 10 online)</label>
          <select id="guests" class="input"></select>
        </div>
      </div>

      <h3>Choose a time slot</h3>
      <div id="slots" class="slot-grid"></div>
      <div id="slotsMsg" class="muted"></div>
    </section>

    <section class="card">
      <div class="grid">
        <div>
          <label>First name*</label>
          <input id="firstName" class="input" />
        </div>
        <div>
          <label>Name*</label>
          <input id="name" class="input" />
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Email*</label>
          <input id="email" class="input" />
        </div>
        <div>
          <label>Phone (optional)</label>
          <input id="phone" class="input" />
        </div>
      </div>

      <label>Notes</label>
      <textarea id="notes" class="input" placeholder="Allergies, seating request, occasion"></textarea>

      <div id="toast" class="toast">Reservation received. You will get a confirmation email shortly.</div>
      <button id="bookBtn" class="btn">Book now</button>
    </section>
  </main>

  <script>
    const cfg = {};
    const $ = sel => document.querySelector(sel);

    fetch('/api/config').then(r=>r.json()).then(c=>{
      Object.assign(cfg,c);
      $('#venueAddress').innerHTML = `<a href="${c.mapsUrl}" target="_blank" rel="noopener">${c.address}</a>`;
      $('#phoneBtn').href = 'tel:' + (c.phone || '').replace(/\s+/g,'');
      $('#mailBtn').href  = 'mailto:' + (c.email || '');
      $('#mapsBtn').href  = c.mapsUrl;
    });

    // init date + guests
    const d = new Date();
    const yyyy = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
    $('#date').value = `${yyyy}-${mm}-${dd}`;

    for (let i=1;i<=10;i++){ const o=document.createElement('option'); o.value=o.textContent=String(i); $('#guests').appendChild(o); }

    function loadSlots(){
      const ymd = $('#date').value;
      fetch(`/api/slots?date=${ymd}`).then(r=>r.json()).then(list=>{
        const wrap = $('#slots'); wrap.innerHTML='';
        $('#slotsMsg').textContent='';
        if (!list.length){ $('#slotsMsg').textContent='We are fully booked or closed on this date. Please choose another day.'; return; }
        list.forEach(s=>{
          const b=document.createElement('button');
          b.textContent = s.time;
          b.className = 'slot' + (s.allowed ? '' : ' disabled');
          if (s.allowed){
            b.addEventListener('click', ()=>{
              document.querySelectorAll('.slot.active').forEach(x=>x.classList.remove('active'));
              b.classList.add('active');
              b.dataset.sel='1';
            });
          }
          wrap.appendChild(b);
        });
      });
    }
    $('#date').addEventListener('change', loadSlots);
    loadSlots();

    $('#bookBtn').addEventListener('click', ()=>{
      const timeBtn = document.querySelector('.slot.active');
      if (!timeBtn){ alert('Please choose a time'); return; }
      const payload = {
        date: $('#date').value,
        time: timeBtn.textContent,
        firstName: $('#firstName').value.trim(),
        name: $('#name').value.trim(),
        email: $('#email').value.trim(),
        phone: $('#phone').value.trim(),
        guests: Number($('#guests').value),
        notes: $('#notes').value.trim()
      };
      fetch('/api/reservations',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
        .then(async r=>{
          if(!r.ok){ const e=await r.json().catch(()=>({error:'Failed'})); throw new Error(e.error||'Failed'); }
          return r.json();
        })
        .then(()=>{
          const t = $('#toast'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 5000);
          document.querySelectorAll('.slot.active').forEach(x=>x.classList.remove('active'));
        })
        .catch(err=>alert(err.message));
    });
  </script>
</body>
</html>

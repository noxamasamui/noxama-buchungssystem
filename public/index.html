<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Reservation â€” RÃ–STILAND BY NOXAMA SAMUI</title>
  <link rel="stylesheet" href="/style.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* small extra styling for the celebratory loyalty popup (keine groÃŸen Layout-Ã„nderungen) */
    .nxl-loyalty {
      font-family: Georgia, 'Times New Roman', serif;
      color: #3a2f28;
    }
    .nxl-loyalty .big {
      font-size: 28px;
      margin-bottom: 8px;
    }
    .nxl-loyalty .tier {
      display:inline-block;
      background: linear-gradient(90deg,#f6e9d9,#fff6eb);
      border-radius: 10px;
      padding: 12px 18px;
      border: 1px solid #ead6b6;
      box-shadow: 0 6px 18px rgba(179,130,47,0.12);
      margin-top: 8px;
    }
    .nxl-loyalty .percent {
      font-weight:700;
      color:#b3822f;
      font-size:20px;
    }
  </style>
</head>
<body>
  <div class="hero-wrap" style="text-align:center;margin-top:18px;">
    <img id="heroBanner" class="hero-banner" alt="Logo banner" style="max-width:640px;width:76%;border-radius:12px;box-shadow:0 25px 50px rgba(0,0,0,.18);"/>
  </div>

  <div class="container">
    <h1 style="text-align:center;margin-top:8px;">Reservation â€” RÃ–STILAND BY NOXAMA SAMUI</h1>
    <p style="text-align:center;margin-top:6px;">Moo 4 Lamai Beach, 84310 Suratthani, Thailand â€¢ +66 077 270 675</p>

    <div class="card booking-card booking-compact" style="max-width:760px;margin:18px auto;padding:18px;">
      <h2>Book a table</h2>

      <div class="row date-time">
        <div style="flex:1 1 220px;">
          <label>Date</label>
          <input id="rDate" type="date"/>
        </div>
        <div style="flex:0 0 110px;">
          <label>Guests</label>
          <select id="rGuests">
            <!-- default options -->
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
          </select>
        </div>
        <div style="flex:0 0 140px;">
          <label>Time</label>
          <select id="rTime"></select>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>First name</label>
          <input id="rFirst" type="text"/>
        </div>
        <div>
          <label>Last name</label>
          <input id="rLast" type="text"/>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>Email</label>
          <input id="rEmail" type="email"/>
        </div>
        <div>
          <label>Phone</label>
          <input id="rPhone" type="tel"/>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>Notes</label>
        <textarea id="rNotes" rows="2" style="width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #c8b99e;"></textarea>
      </div>

      <div style="margin-top:12px;text-align:left;">
        <button id="btnReserve" class="btn btn-primary-book" type="button">Book</button>
        <span id="rMsg" class="badge" style="margin-left:10px;"></span>
      </div>
    </div>
  </div>

  <!-- Confirmation modal (hidden) -->
  <div id="confirm-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#fff8f0;border-radius:12px;padding:18px;max-width:420px;width:92%;text-align:center;border:1px solid #e0d7c5;">
      <h3 id="confirm-title" style="margin-top:0;">Reservation confirmed</h3>
      <div id="confirm-text" style="margin:8px 0 12px 0;color:#3a2f28;"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="confirm-ok" class="btn" style="min-width:120px;">Continue</button>
      </div>
    </div>
  </div>

<script>
  // helper: today string yyyy-mm-dd
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

  // small utility: friendly modal used for all "immediate" notices (closed / loyalty)
  function showModal(htmlContent, title = "") {
    const ex = document.getElementById("__noxama_modal");
    if (ex) ex.remove();

    const overlay = document.createElement("div");
    overlay.id = "__noxama_modal";
    overlay.style.position = "fixed";
    overlay.style.left = "0";
    overlay.style.top = "0";
    overlay.style.width = "100%";
    overlay.style.height = "100%";
    overlay.style.zIndex = "99999";
    overlay.style.display = "flex";
    overlay.style.alignItems = "center";
    overlay.style.justifyContent = "center";
    overlay.style.background = "rgba(0,0,0,0.4)";

    const box = document.createElement("div");
    box.style.maxWidth = "640px";
    box.style.width = "calc(100% - 40px)";
    box.style.background = "#fff";
    box.style.borderRadius = "12px";
    box.style.padding = "18px";
    box.style.boxShadow = "0 8px 30px rgba(0,0,0,0.25)";
    box.style.textAlign = "center";

    if (title) {
      const h = document.createElement("h3");
      h.textContent = title;
      h.style.marginTop = "0";
      box.appendChild(h);
    }

    const inner = document.createElement("div");
    inner.innerHTML = htmlContent;
    box.appendChild(inner);

    const btnWrap = document.createElement("div");
    btnWrap.style.marginTop = "12px";
    const ok = document.createElement("button");
    ok.textContent = "Okay";
    ok.style.padding = "10px 16px";
    ok.style.borderRadius = "8px";
    ok.style.border = "none";
    ok.style.background = "#b3822f";
    ok.style.color = "#fff";
    ok.onclick = ()=> overlay.remove();
    btnWrap.appendChild(ok);
    box.appendChild(btnWrap);

    overlay.appendChild(box);
    document.body.appendChild(overlay);
  }

  // fill banner from /api/config (unchanged)
  (async()=>{
    try{
      const r = await fetch('/api/config'); const cfg = await r.json();
      const hero = document.getElementById('heroBanner');
      hero.src = cfg.mailHeaderUrl && cfg.mailHeaderUrl.trim() ? cfg.mailHeaderUrl : (cfg.mailLogoUrl && cfg.mailLogoUrl.trim() ? cfg.mailLogoUrl : '/logo-hero.png');
      hero.alt = cfg.brand || 'Banner';
    }catch(e){ console.error(e); }
  })();

  // initialize
  const dateEl = document.getElementById('rDate');
  const guestsEl = document.getElementById('rGuests');
  const timeEl = document.getElementById('rTime');
  const reserveBtn = document.getElementById('btnReserve');
  const msgEl = document.getElementById('rMsg');

  dateEl.value = today();

  // Populate times with available slots only. Called when date or guests change.
  async function refreshAvailableTimes() {
    const date = dateEl.value || today();
    const guests = Number(guestsEl.value || 1);
    msgEl.textContent = '';
    // disable button while loading/if none
    reserveBtn.disabled = true;

    try {
      const resp = await fetch(`/api/slots?date=${encodeURIComponent(date)}&guests=${encodeURIComponent(guests)}`, {cache:"no-store"});
      if (!resp.ok) {
        // if api fails, fallback to full times so user can still try â€” but mark message
        msgEl.textContent = 'Could not load availability. Try again or choose another date.';
        populateFallbackTimes();
        return;
      }
      const slots = await resp.json();
      if (!Array.isArray(slots)) { populateFallbackTimes(); return; }

      // filter allowed slots
      const allowedSlots = slots.filter(s => s.allowed === true);
      // If no allowed slots -> immediate friendly modal and clear time select
      if (allowedSlots.length === 0) {
        // Show friendly message depending on reason (prefers Sunday / Blocked)
        const reasons = Array.from(new Set(slots.map(s => (s.reason||"")).filter(Boolean)));
        let reasonText = reasons.find(r => /sunday|sonntag/i.test(r)) || reasons[0] || "This day is not available";
        const friendlyHtml = `
          <div style="font-family:Georgia,serif;color:#3a2f28;">
            <div style="font-size:20px;margin-bottom:8px;">Oh no â€” this day is not available</div>
            <div style="margin-bottom:10px;">${reasonText}</div>
            <div>Please pick another day â€” we would love to welcome you.</div>
          </div>`;
        // clear times and disable booking
        timeEl.innerHTML = '';
        reserveBtn.disabled = true;
        showModal(friendlyHtml, "Reservation not possible");
        return;
      }

      // populate time select only with allowed slots (sorted by time)
      timeEl.innerHTML = '';
      allowedSlots.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.time;
        opt.textContent = s.time + (typeof s.left === 'number' ? ` (${s.left} left)` : '');
        timeEl.appendChild(opt);
      });
      // enable reserve
      reserveBtn.disabled = false;
    } catch (e) {
      console.error("refreshAvailableTimes error", e);
      // fallback behavior: populate full times so user still can choose (server might be down)
      populateFallbackTimes();
    }
  }

  // Fallback: if slots endpoint fails, show full times (safe)
  function populateFallbackTimes() {
    timeEl.innerHTML = '';
    const from = 10*60, to = 22*60, interval = 15;
    for(let m=from;m<=to;m+=interval){
      const hh=String(Math.floor(m/60)).padStart(2,"0");
      const mm=String(m%60).padStart(2,"0");
      const opt=document.createElement("option"); opt.value=`${hh}:${mm}`; opt.textContent=opt.value;
      timeEl.appendChild(opt);
    }
    reserveBtn.disabled = false;
  }

  // initial fetch
  refreshAvailableTimes();

  // re-check when date or guests change
  dateEl.addEventListener('change', ()=>{
    refreshAvailableTimes();
  });
  guestsEl.addEventListener('change', ()=>{
    refreshAvailableTimes();
  });

  // Reserve button handler: post to /api/reservations (keeps your server contract)
  reserveBtn.addEventListener('click', async ()=>{
    msgEl.textContent = '';
    reserveBtn.disabled = true;

    const payload = {
      date: dateEl.value || today(),
      time: timeEl.value,
      firstName: (document.getElementById('rFirst').value || "").trim(),
      name: (document.getElementById('rLast').value || "").trim(),
      email: (document.getElementById('rEmail').value || "").trim(),
      phone: (document.getElementById('rPhone').value || "").trim(),
      guests: Number(guestsEl.value || 1),
      notes: (document.getElementById('rNotes').value || "").trim()
    };

    // minimal validation
    if(!payload.firstName || !payload.name || !payload.email || !payload.guests || !payload.time){
      msgEl.textContent = 'Please fill first name, last name, email, guests and time';
      reserveBtn.disabled = false;
      return;
    }

    try {
      const r = await fetch('/api/reservations', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const json = await r.json().catch(()=>({}));
      if (!r.ok) {
        const err = (json && json.error) ? json.error : "Failed to create reservation";
        // if closed/blocked/fully booked -> show friendly modal
        if (err.toLowerCase().includes("closed") || err.toLowerCase().includes("blocked") || err.toLowerCase().includes("fully booked") || err.toLowerCase().includes("sunday")) {
          let message = "This slot is not available. Please choose another day or time.";
          if (err.toLowerCase().includes("sunday")) message = "We are closed on Sundays. Please choose another day.";
          if (err.toLowerCase().includes("blocked")) message = "This date is blocked. Please choose another day.";
          showModal(`<div style="font-family:Georgia,serif;color:#3a2f28;">${message}</div>`, "Not available");
          // After such error, refresh times to hide newly unavailable slots
          setTimeout(refreshAvailableTimes, 300);
          reserveBtn.disabled = false;
          return;
        }
        msgEl.textContent = err || "Error saving reservation";
        reserveBtn.disabled = false;
        return;
      }

      // Success: Show loyalty popup where appropriate
      // Server returns visitNo (number of confirmed+noshow including this)
      const visitNo = Number(json && json.visitNo) || 0;
      let loyaltyPercent = 0;
      if (visitNo >= 5 && visitNo <= 9) loyaltyPercent = 5;
      else if (visitNo >= 10 && visitNo <= 14) loyaltyPercent = 10;
      else if (visitNo >= 15) loyaltyPercent = 15;

      if (loyaltyPercent > 0) {
        const html = `
          <div class="nxl-loyalty">
            <div class="big">ðŸŽ‰ Congratulations â€” loyalty reward unlocked!</div>
            <div>You just reached visit <strong>${visitNo}</strong></div>
            <div class="tier">
              <div>Enjoy a <span class="percent">${loyaltyPercent}%</span> thank-you discount on your next visit</div>
            </div>
            <div style="margin-top:10px;font-size:14px;color:#666;">Weâ€™ve applied a note to your profile. Thank you for your loyalty.</div>
          </div>`;
        showModal(html, "You earned a loyalty reward");
        // Also show the standard confirmation modal after a short delay (so user sees both)
        setTimeout(()=> {
          const title = document.getElementById('confirm-title');
          const txt = document.getElementById('confirm-text');
          title.textContent = 'Reservation received';
          txt.innerHTML = `Thank you! Your reservation is confirmed. A confirmation mail will be sent to <b>${payload.email}</b>. Please also check your spam folder.`;
          document.getElementById('confirm-ok').onclick = ()=>{ hideConfirmModal(); window.location.href = '/'; };
          showConfirmModal();
        }, 1000);
      } else {
        // show standard confirmation
        const title = document.getElementById('confirm-title');
        const txt = document.getElementById('confirm-text');
        title.textContent = 'Reservation received';
        txt.innerHTML = `Thank you! Your reservation is confirmed. A confirmation mail will be sent to <b>${payload.email}</b>. Please also check your spam folder.`;
        document.getElementById('confirm-ok').onclick = ()=>{ hideConfirmModal(); window.location.href = '/'; };
        showConfirmModal();
      }

      // refresh available times to reflect new booking and prevent overbooking
      setTimeout(refreshAvailableTimes, 300);
    } catch (e) {
      console.error('reservation post error', e);
      msgEl.textContent = 'Network error';
      reserveBtn.disabled = false;
    }
  });

  // small helpers for confirm modal
  function showConfirmModal(){
    const m = document.getElementById('confirm-modal');
    m.style.display = 'flex';
  }
  function hideConfirmModal(){
    const m = document.getElementById('confirm-modal');
    m.style.display = 'none';
  }

  // If for any reason slots endpoint is slow, show a fallback after 2s (user can still pick)
  let fallbackTimer = setTimeout(()=>{
    if (timeEl.children.length === 0) populateFallbackTimes();
  }, 2000);

  // Ensure fallback is cleared if refreshAvailableTimes finishes quickly
  function clearFallbackTimer(){ if (fallbackTimer) { clearTimeout(fallbackTimer); fallbackTimer = null; } }
  // decorate refreshAvailableTimes to clear timer when done
  const originalRefresh = refreshAvailableTimes;
  refreshAvailableTimes = async function(){ clearFallbackTimer(); await originalRefresh(); };

  // initial call already scheduled above

</script>

</body>
</html>

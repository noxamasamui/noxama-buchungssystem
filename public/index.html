<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Reservation — ROESTILAND BY NOXAMA SAMUI</title>
  <link rel="stylesheet" href="/style.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* Ergänzungen, nur Minimales für modals / fireworks */
    #loyalty-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:99999; align-items:center; justify-content:center; }
/* loyalty modal + fireworks — replace existing loyalty CSS with this block */
#loyalty-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:99999; align-items:center; justify-content:center; }
#loyalty-modal > .card {
  background:#d6c7b2; /* requested modal bg */
  border:1px solid rgba(0,0,0,0.06);
  border-radius:12px;
  max-width:520px;
  width:92%;
  padding:14px;
  box-shadow:0 10px 35px rgba(0,0,0,0.25);
  text-align:center;
  position:relative;
  overflow:visible;
}

/* Canvas now covers the whole card and is transparent (no white rectangle) */
#fw-canvas {
  position:absolute;
  inset:12px 12px 68px 12px; /* inset inside the card so header and buttons remain readable */
  width: calc(100% - 24px);
  height: calc(100% - 86px);
  display:block;
  border-radius:10px;
  pointer-events:none;
  z-index:1; /* behind the content area (which will be z-index:2) */
  background: transparent !important; /* IMPORTANT: no white background */
  box-shadow: none;
}

/* ensure content sits above canvas */
#loyalty-modal > .card > * { position:relative; z-index:2; }

/* small responsive tweak */
@media (max-width:520px) {
  #fw-canvas { inset:10px 10px 72px 10px; height:140px; }
}
      /* ensure modal content fits mobile */
      #loyalty-modal > .card, #largeparty-modal > .box { margin: 12px; width: calc(100% - 24px); }
    }

    /* ensure hero centered */
    .hero-wrap { text-align:center; margin-top:18px; }
    .hero-banner { max-width:640px; width:76%; border-radius:12px; box-shadow:0 25px 50px rgba(0,0,0,.18); display:inline-block; }
  </style>
</head>
<body>
  <div class="hero-wrap" style="text-align:center;margin-top:18px;">
    <img id="heroBanner" class="hero-banner" alt="Logo banner" src="/logo-hero.png"/>
  </div>

  <div class="container">
    <h1 style="text-align:center;margin-top:8px;">Reservation — RÖSTILAND BY NOXAMA SAMUI</h1>
    <p style="text-align:center;margin-top:6px;">Moo 4 Lamai Beach, 84310 Suratthani, Thailand • +66 077 270 675</p>

    <div class="card booking-card booking-compact" style="max-width:760px;margin:18px auto;padding:18px;">
      <h2>Book a table</h2>

      <div class="row date-time">
        <div style="flex:1 1 220px;">
          <label>Date</label>
          <input id="rDate" type="date"/>
        </div>
        <div style="flex:0 0 110px;">
          <label>Guests</label>
          <select id="rGuests">
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
            <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
            <option value="11plus">11+</option>
          </select>
        </div>
        <div style="flex:0 0 140px;">
          <label>Time</label>
          <select id="rTime"></select>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>First name</label>
          <input id="rFirst" type="text"/>
        </div>
        <div>
          <label>Last name</label>
          <input id="rLast" type="text"/>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>Email</label>
          <input id="rEmail" type="email"/>
        </div>
        <div>
          <label>Phone</label>
          <input id="rPhone" type="tel"/>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>Notes</label>
        <textarea id="rNotes" rows="2" style="width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #c8b99e;"></textarea>
      </div>

      <div style="margin-top:12px;text-align:left;">
        <button id="btnReserve" class="btn btn-primary-book" type="button">Book</button>
        <span id="rMsg" class="badge" style="margin-left:10px;"></span>
      </div>
    </div>
  </div>

  <!-- confirmation modal -->
  <div id="confirm-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#fff8f0;border-radius:12px;padding:18px;max-width:420px;width:92%;text-align:center;border:1px solid #e0d7c5;">
      <h3 id="confirm-title" style="margin-top:0;">Reservation confirmed</h3>
      <div id="confirm-text" style="margin:8px 0 12px 0;color:#3a2f28;"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="confirm-ok" class="btn" style="min-width:120px;">Continue</button>
      </div>
    </div>
  </div>

  <!-- loyalty modal (with fireworks canvas) -->
  <div id="loyalty-modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="loyalty-title">
      <canvas id="fw-canvas" class="hidden"></canvas>
      <h2 id="loyalty-title">You earned a loyalty reward</h2>
      <p id="loyalty-sub">Congratulations — loyalty reward unlocked!</p>
      <p id="loyalty-msg"></p>
      <button id="loyalty-ok" class="btn">Okay</button>
    </div>
  </div>

  <!-- large party modal -->
  <div id="largeparty-modal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" aria-labelledby="lp-title">
      <h2 id="lp-title">Large party request</h2>
      <p>For parties of 11 or more please contact us directly so we can arrange a suitable table and confirm availability.</p>
      <div class="contact-row" style="margin-top:12px;">
        <a href="tel:+66077270675" id="lp-call">Call +66 077 270 675</a>
        <a href="mailto:info@noxamasamui.com" id="lp-email">Email info@noxamasamui.com</a>
      </div>
      <div style="margin-top:12px;">
        <button id="lp-ok" class="btn">OK</button>
      </div>
    </div>
  </div>

<script>
  // helper: today string yyyy-mm-dd
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

  // fill banner from /api/config
  (async()=>{
    try{
      const r = await fetch('/api/config'); const cfg = await r.json();
      const hero = document.getElementById('heroBanner');
      hero.src = cfg.mailHeaderUrl || cfg.mailLogoUrl || '/logo-hero.png';
      hero.alt = cfg.brand || 'Banner';
    }catch(e){ console.error(e); }
  })();

  document.getElementById('rDate').value = today();

  // fill times select by calling API to get allowed slots
  async function updateTimes(){
    const date = document.getElementById('rDate').value;
    const guestsSel = document.getElementById('rGuests');
    const sel = document.getElementById('rTime');
    sel.innerHTML = '';

    if(!date) return;

    const guestsVal = guestsSel.value === '11plus' ? 1 : Number(guestsSel.value || 1);
    try{
      const resp = await fetch(`/api/slots?date=${encodeURIComponent(date)}&guests=${encodeURIComponent(guestsVal)}`, {cache:"no-store"});
      if(!resp.ok) return;
      const slots = await resp.json();
      if(!Array.isArray(slots)) return;

      // if nothing allowed -> immediate friendly alert
      const anyAllowed = slots.some(s => s.allowed === true);
      if(!anyAllowed){
        const reasons = Array.from(new Set(slots.map(s => (s.reason||"")).filter(Boolean)));
        const reasonText = reasons.find(r=>r.toLowerCase().includes('sunday')) || reasons[0] || 'This day is not available';
        showLargeAlert("Reservation not possible", reasonText + ". Please choose another day.");
        return;
      }

      // show allowed times only, and do not show remaining counts
      slots.filter(s=>s.allowed).forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.time;
        opt.textContent = s.time;
        sel.appendChild(opt);
      });
    }catch(e){
      console.error("updateTimes", e);
    }
  }

  // initial fill
  updateTimes();

  // date change handler (enhanced): will check admin closures/notices and show popup immediately
  document.getElementById('rDate').addEventListener('change', async function(){
    const date = this.value;
    if(!date){
      updateTimes();
      return;
    }

    // check closures/notes from admin
    try{
      const resp = await fetch('/api/admin/closure', {cache: "no-store"});
      if(resp.ok){
        const list = await resp.json();
        const selStart = new Date(date + 'T00:00:00');
        const dayStart = new Date(selStart.getFullYear(), selStart.getMonth(), selStart.getDate(), 0,0,0);
        const dayEnd   = new Date(selStart.getFullYear(), selStart.getMonth(), selStart.getDate(), 23,59,59,999);

        const match = list.find(c=>{
          if(!c.startTs || !c.endTs) return false;
          const s = new Date(c.startTs);
          const e = new Date(c.endTs);
          return (s <= dayEnd && e >= dayStart);
        });

        if(match){
          // if admin provided a title in previous UI, show it; otherwise use reason
          const title = (match.title && String(match.title).trim()) ? String(match.title) : "Important information";
          const text  = (match.reason && String(match.reason).trim()) ? String(match.reason) : "This day has a special note. Please check details.";
          showLargeAlert(title, text);
          updateTimes();
          return;
        }
      }
    }catch(err){
      console.error("check notices error", err);
    }

    updateTimes();
  });

  document.getElementById('rGuests').addEventListener('change', function(){
    const v = this.value;
    if(v === '11plus'){
      showLargePartyModal();
      // revert selection to 1 after a short moment so UI stays consistent
      setTimeout(()=>{ this.value='1'; updateTimes(); }, 10);
      return;
    }
    updateTimes();
  });

  // reserve button submission
  document.getElementById('btnReserve').addEventListener('click', async ()=>{
    const payload = {
      date: document.getElementById('rDate').value,
      time: document.getElementById('rTime').value,
      firstName: (document.getElementById('rFirst').value || "").trim(),
      name: (document.getElementById('rLast').value || "").trim(),
      email: (document.getElementById('rEmail').value || "").trim(),
      phone: (document.getElementById('rPhone').value || "").trim(),
      guests: Number(document.getElementById('rGuests').value || 1),
      notes: (document.getElementById('rNotes').value || "").trim()
    };
    const msg = document.getElementById('rMsg');
    msg.textContent = '';

    if(!payload.firstName || !payload.name || !payload.email || !payload.guests){
      msg.textContent = 'Please fill first name, last name, email and guests';
      return;
    }

    try{
      const r = await fetch('/api/reservations', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const json = await r.json().catch(()=>({}));
      if(r.ok){
        if(json && (json.nowUnlockedTier === 5 || json.nowUnlockedTier === 10 || json.nowUnlockedTier === 15)){
          showLoyaltyModal(json.nowUnlockedTier, json.visitNo || null);
          // when loyalty modal closed, show confirm
          document.getElementById('loyalty-ok').onclick = ()=>{
            hideLoyaltyModal();
            showConfirm("Reservation received", `Thank you. A confirmation mail was sent to <b>${payload.email}</b>.`);
          };
        } else {
          showConfirm("Reservation received", `Thank you. A confirmation mail was sent to <b>${payload.email}</b>.`);
        }
      } else {
        const err = (json && json.error) ? String(json.error).toLowerCase() : "Reservation failed";
        if(err.includes("sunday") || err.includes("closed") || err.includes("blocked") || err.includes("fully booked")){
          showLargeAlert("Not available", json.error || "This day or slot is not available. Please choose another day.");
        } else {
          msg.textContent = json.error || 'Error saving reservation';
        }
      }
    }catch(e){
      console.error('reservation post error', e);
      msg.textContent = 'Network error';
    }
  });

  // small confirm modal helpers
  function showConfirm(title, html){
    const m = document.getElementById('confirm-modal');
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-text').innerHTML = html;
    document.getElementById('confirm-ok').onclick = ()=>{ hideConfirm(); window.location.href = '/'; };
    m.style.display = 'flex';
  }
  function hideConfirm(){ document.getElementById('confirm-modal').style.display = 'none'; }

  // large party modal
  function showLargePartyModal(){
    const m = document.getElementById('largeparty-modal');
    m.style.display = 'flex';
    document.getElementById('lp-ok').onclick = ()=>{ m.style.display = 'none'; };
  }
  function showLargeAlert(title, text){
    const m = document.getElementById('largeparty-modal');
    const box = m.querySelector('.box');
    box.querySelector('h2').textContent = title;
    box.querySelector('p').textContent = text;
    const cr = box.querySelector('.contact-row');
    cr.style.display = 'none';
    m.style.display = 'flex';
    document.getElementById('lp-ok').onclick = ()=>{
      cr.style.display = '';
      box.querySelector('h2').textContent = 'Large party request';
      box.querySelector('p').textContent = 'For parties of 11 or more please contact us directly so we can arrange a suitable table and confirm availability.';
      m.style.display = 'none';
    };
  }

  // ---------- Loyalty modal & fireworks (improved, full-card canvas) ----------
// Fireworks implementation (single instance) — REPLACE previous implementation with this
let _fwRunning = false;
let _fwRAF = null;
let _fwCtx = null;
let _fwCanvas = null;
let _fwParticles = [];

function startFireworks(canvas){
  if(_fwRunning) return;
  _fwCanvas = canvas;

  // size canvas to displayed size (account for devicePixelRatio)
  const cw = Math.max(100, canvas.clientWidth);
  const ch = Math.max(50, canvas.clientHeight);
  canvas.width = Math.round(cw * devicePixelRatio);
  canvas.height = Math.round(ch * devicePixelRatio);
  canvas.style.width = cw + "px";
  canvas.style.height = ch + "px";

  _fwCtx = canvas.getContext('2d');
  _fwCtx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0); // scale for DPR
  _fwParticles = [];
  _fwRunning = true;

  // spawn initial impressive bursts
  spawnBurst(220, cw * 0.25, ch * 0.55);
  spawnBurst(180, cw * 0.75, ch * 0.40);
  const burstInterval = setInterval(()=> spawnBurst(80 + Math.random()*180, 40 + Math.random()*(cw-80), 30 + Math.random()*(ch-60)), 520);

  function loop(){
    if(!_fwRunning){ clearInterval(burstInterval); _fwRAF = null; return; }
    // clear but keep slight warm tint using low alpha so modal bg shows through
    _fwCtx.clearRect(0,0,cw,ch);
    _fwCtx.globalCompositeOperation = 'lighter';

    for(let i=_fwParticles.length-1;i>=0;i--){
      const p = _fwParticles[i];
      p.vy += 0.04 * p.weight;
      p.x += p.vx;
      p.y += p.vy;
      p.vx *= 0.996;
      p.vy *= 0.996;
      p.life -= 1;
      const alpha = Math.max(0, Math.min(1, p.life / p.maxLife));
      // radial particle
      const grad = _fwCtx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size*2.2);
      const col = hexToRgba(p.color, alpha);
      grad.addColorStop(0, col.replace('0.XX', String(alpha)));
      grad.addColorStop(0.6, col.replace('0.XX', String(Math.max(0.25, alpha*0.9))));
      grad.addColorStop(1, 'rgba(255,255,255,0)');
      _fwCtx.fillStyle = grad;
      _fwCtx.beginPath();
      _fwCtx.arc(p.x, p.y, p.size, 0, Math.PI*2);
      _fwCtx.fill();

      // occasional sparkle
      if(Math.random() < 0.03){
        _fwCtx.fillStyle = `rgba(255,255,255,${Math.min(1, alpha)})`;
        _fwCtx.fillRect(p.x + (Math.random()*2-1), p.y + (Math.random()*2-1), 1.5, 1.5);
      }

      if(p.life <= 0 || p.y > ch + 40) {
        _fwParticles.splice(i,1);
      }
    }
    _fwCtx.globalCompositeOperation = 'source-over';
    _fwRAF = requestAnimationFrame(loop);
  }
  loop();

  function spawnBurst(count, cx, cy){
    const colors = ['#e74c3c','#f39c12','#ffd54f','#f06292','#9b59b6','#8e44ad','#3498db','#2ecc71','#ff7043','#ffe082'];
    for(let i=0;i<count;i++){
      const ang = Math.random()*Math.PI*2;
      const speed = 1 + Math.random()*6;
      const vx = Math.cos(ang)*speed;
      const vy = Math.sin(ang)*speed*0.9 - (Math.random()*2);
      const size = 2 + Math.random()*6;
      const life = 40 + Math.floor(Math.random()*90);
      const color = colors[Math.floor(Math.random()*colors.length)];
      _fwParticles.push({
        x: cx + (Math.random()*12-6),
        y: cy + (Math.random()*12-6),
        vx, vy,
        size,
        life,
        maxLife: life,
        color,
        weight: 0.8 + Math.random()*0.9
      });
    }
  }

  // helper to convert hex color to rgba string placeholder (we insert alpha later)
  function hexToRgba(hex, alpha){
    hex = hex.replace('#','');
    const r = parseInt(hex.substring(0,2),16);
    const g = parseInt(hex.substring(2,4),16);
    const b = parseInt(hex.substring(4,6),16);
    return `rgba(${r},${g},${b},0.XX)`; // caller will replace 0.XX with actual alpha
  }
}

function stopFireworks(){
  _fwRunning = false;
  if(_fwRAF){ cancelAnimationFrame(_fwRAF); _fwRAF = null; }
  if(_fwCanvas && _fwCtx){
    _fwCtx.clearRect(0,0,_fwCanvas.width/_fwCanvas.ownerDocument.defaultView.devicePixelRatio, _fwCanvas.height/_fwCanvas.ownerDocument.defaultView.devicePixelRatio);
  }
  _fwParticles = [];
}

  document.getElementById('loyalty-ok').addEventListener('click', ()=> hideLoyaltyModal());

  // accessibility: Escape closes modals
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      document.getElementById('largeparty-modal').style.display = 'none';
      hideConfirm();
      hideLoyaltyModal();
    }
  });

  window.addEventListener('resize', ()=>{
    if(_fwCanvas && _fwCanvas.parentElement && _fwRunning){
      _fwCanvas.width = _fwCanvas.clientWidth * devicePixelRatio;
      _fwCanvas.height = _fwCanvas.clientHeight * devicePixelRatio;
      if(_fwCtx) _fwCtx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }
  });

  window.addEventListener('focus', ()=> updateTimes());
</script>
</body>
</html>

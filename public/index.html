<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Contact and Table Booking</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <div class="header">
    <img src="/logo.png" alt="RÃ–STILAND">
  </div>

  <div class="container">
    <div class="topbar">
      <a id="btnPhone" href="#">Phone</a>
      <a id="btnEmail" href="#">Email</a>
    </div>

    <h1>Contact and Table Booking</h1>
    <div id="venue-line" class="small"></div>

    <div class="card">
      <div class="row">
        <div>
          <label>Date</label>
          <input id="date" type="date">
        </div>
        <div>
          <label>Guests (max 10 online)</label>
          <select id="guests"></select>
        </div>
      </div>

      <div style="margin-top:14px">
        <label>Choose a time slot</label>
        <div id="slots" class="pills"></div>
      </div>

      <div class="row" style="margin-top:14px">
        <div>
          <label>First name*</label>
          <input id="firstName" type="text" placeholder="First name">
        </div>
        <div>
          <label>Name*</label>
          <input id="name" type="text" placeholder="Name">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>Email*</label>
          <input id="email" type="email" placeholder="you@email.com">
        </div>
        <div>
          <label>Phone (optional)</label>
          <input id="phone" type="text" placeholder="">
        </div>
      </div>

      <div style="margin-top:8px">
        <label>Notes</label>
        <textarea id="notes" placeholder="Allergies, seating request, occasion"></textarea>
      </div>

      <div id="groupHint" class="callout hidden" style="margin-top:12px">
        For <b>11+ guests</b> please contact us directly.
        <div class="topbar" style="margin-top:6px">
          <a id="bigPhone" href="#">Call us</a>
          <a id="bigEmail" href="#">Send email</a>
        </div>
      </div>

      <div style="margin-top:16px;text-align:right">
        <button id="bookBtn" class="btn">Book now</button>
      </div>
    </div>

    <div class="footer small">
      <span id="addr"></span>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal-mask">
    <div class="modal">
      <h3 id="mTitle">Thank you!</h3>
      <div id="mText">Your reservation has been received.</div>
    </div>
  </div>

  <script>
    const cfg = { baseUrl:"", venuePhone:"", venueEmail:"", venueAddress:"", slots:[] };

    // Helpers
    const qs = s => document.querySelector(s);
    const elDate = qs("#date");
    const elGuests = qs("#guests");
    const elSlots = qs("#slots");
    const elFirst = qs("#firstName");
    const elName = qs("#name");
    const elEmail = qs("#email");
    const elPhone = qs("#phone");
    const elNotes = qs("#notes");
    const elGroup = qs("#groupHint");
    const elBook = qs("#bookBtn");
    const modal = qs("#modal");
    const mTitle = qs("#mTitle");
    const mText = qs("#mText");

    function showModal(t, d){ mTitle.textContent=t; mText.innerHTML=d; modal.style.display="flex"; }
    function hideModal(){ modal.style.display="none"; }

    modal.addEventListener("click", e => { if(e.target===modal) hideModal(); });

    // Load Config
    fetch("/api/config").then(r=>r.json()).then(c=>{
      Object.assign(cfg,c);
      qs("#btnPhone").href = `tel:${cfg.venuePhone}`;
      qs("#btnEmail").href = `mailto:${cfg.venueEmail}`;
      qs("#bigPhone").href = `tel:${cfg.venuePhone}`;
      qs("#bigEmail").href = `mailto:${cfg.venueEmail}`;
      qs("#venue-line").textContent = cfg.venueAddress;
      qs("#addr").textContent = cfg.venueAddress;

      // guests 1..10 plus extra "11+"
      for(let i=1;i<=10;i++){
        const o=document.createElement("option"); o.value=String(i); o.textContent=String(i);
        elGuests.appendChild(o);
      }
      const extra=document.createElement("option");
      extra.value="11+";
      extra.textContent="11+ (call or email)";
      elGuests.appendChild(extra);

      // date default = today
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth()+1).padStart(2,"0");
      const d = String(today.getDate()).padStart(2,"0");
      elDate.value = `${y}-${m}-${d}`;

      refreshSlots();
    });

    function renderSlots(list){
      elSlots.innerHTML="";
      list.forEach(s=>{
        const b=document.createElement("button");
        b.type="button"; b.className="pill"; b.textContent=s.time;
        if(s.disabled){ b.disabled=true; b.style.opacity=.5; }
        b.addEventListener("click", ()=>{
          document.querySelectorAll(".pill").forEach(p=>p.classList.remove("active"));
          b.classList.add("active");
        });
        elSlots.appendChild(b);
      });
    }
    function activeTime(){
      const a = elSlots.querySelector(".pill.active");
      return a ? a.textContent : "";
    }
    function refreshSlots(){
      const date = elDate.value;
      const guests = elGuests.value==="11+" ? 10 : Number(elGuests.value||2);
      fetch(`/api/slots?date=${encodeURIComponent(date)}&guests=${guests}`)
        .then(r=>r.json()).then(renderSlots);
      elGroup.classList.toggle("hidden", elGuests.value!=="11+");
    }

    elDate.addEventListener("change",refreshSlots);
    elGuests.addEventListener("change",refreshSlots);

    // Book
    elBook.addEventListener("click", async ()=>{
      if(elGuests.value==="11+"){
        showModal("Group booking", `For 11+ guests please contact us directly.<br><br>
        <a class="btn" href="tel:${cfg.venuePhone}">Call</a> &nbsp;
        <a class="btn" href="mailto:${cfg.venueEmail}">Email</a>`);
        return;
      }
      const payload = {
        date: elDate.value,
        time: activeTime(),
        guests: Number(elGuests.value||2),
        firstName: elFirst.value.trim(),
        name: elName.value.trim(),
        email: elEmail.value.trim(),
        phone: elPhone.value.trim(),
        notes: elNotes.value.trim(),
      };
      if(!payload.date || !payload.time || !payload.firstName || !payload.name || !payload.email){
        showModal("Missing data","Please fill all required fields and select a time.");
        return;
      }
      const r = await fetch("/api/book", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      const j = await r.json();
      if(!r.ok){ showModal("Sorry", j?.error||"Error"); return; }

      // Fireworks at 5/10/15
      let extra="";
      if([5,10,15].includes(j.nth)){
        const pct = j.loyalty.level;
        extra = `<div style="margin-top:10px;font-weight:700">ðŸŽ† Congratulations! You now enjoy <span style="color:#b6802a">${pct}%</span> loyalty discount.</div>`;
      }
      showModal("Thank you!", `Your reservation has been received.${extra}<br><br>We redirect you to our website...`);

      // redirect
      setTimeout(()=>{ window.location.href = "https://noxamasamui.com"; }, 2200);
    });
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Contact and Table Booking</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <div class="container">
    <img src="/logo-hero.png" alt="RÖSTILAND" class="logo-hero"/>

    <h1>Contact and Table Booking</h1>

    <div class="card">
      <h2>Address</h2>
      <div>Moo 4 Lamai Beach, 84310 Suratthani, Thailand</div>
      <div class="row">
        <div><span class="badge">Phone</span> <a href="tel:+66077270675">+66 077 270 675</a></div>
        <div><span class="badge">Email</span> <a href="mailto:info@noxamasamui.com">info@noxamasamui.com</a></div>
      </div>
    </div>

    <form id="form" class="card" autocomplete="off">
      <div class="row">
        <div>
          <label for="date">Date</label>
          <input id="date" type="date" required/>
        </div>
        <div>
          <label for="guests">Guests (max 10 online)</label>
          <select id="guests" required>
            <option value="">Select guests…</option>
          </select>
        </div>
      </div>

      <div id="slotsWrap" class="card" style="display:none;margin-top:18px">
        <h2 style="margin-top:0">Choose a time slot</h2>
        <div id="slots" class="slot-grid"></div>
        <div id="slotsMsg" class="small" style="margin-top:10px"></div>
      </div>

      <div class="row" style="margin-top:18px">
        <div>
          <label for="first">First name*</label>
          <input id="first" type="text" required/>
        </div>
        <div>
          <label for="last">Name*</label>
          <input id="last" type="text" required/>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="mail">Email*</label>
          <input id="mail" type="text" inputmode="email" required/>
        </div>
        <div>
          <label for="phone">Phone (optional)</label>
          <input id="phone" type="text" />
        </div>
      </div>

      <div>
        <label for="notes">Notes</label>
        <textarea id="notes" placeholder="Allergies, seating request, occasion"></textarea>
      </div>

      <div class="notice" style="margin:14px 0">
        Please arrive on time — tables may be released after <b>15 minutes</b> of delay.
      </div>

      <div class="center" style="margin-top:12px">
        <button id="submit" type="submit" class="btn" disabled>Book now</button>
        <div id="feedback" class="small" style="margin-top:8px"></div>
      </div>

      <input type="hidden" id="time"/>
    </form>
  </div>

  <script>
  // helpers
  const $ = sel => document.querySelector(sel);
  const elSlots = $("#slots");
  const elSlotsWrap = $("#slotsWrap");
  const elSlotsMsg = $("#slotsMsg");

  // fill guests 1..10
  const gSel = $("#guests");
  for(let i=1;i<=10;i++){
    const o = document.createElement("option");
    o.value=String(i); o.textContent=String(i);
    gSel.appendChild(o);
  }

  function ymd(d){
    if(!d) return "";
    const dt = new Date(d);
    if(Number.isNaN(dt.getTime())) return "";
    return dt.toISOString().slice(0,10);
  }

  async function loadSlots(){
    const date = $("#date").value;
    const guests = Number($("#guests").value || 0);
    $("#submit").disabled = true;
    $("#time").value = "";
    elSlots.innerHTML = "";
    elSlotsMsg.textContent = "";

    if(!date || !guests){
      elSlotsWrap.style.display = "none";
      return;
    }

    elSlotsWrap.style.display = "block";
    elSlotsMsg.textContent = "Loading slots…";

    try{
      const q = new URLSearchParams({date: ymd(date)});
      const res = await fetch("/api/slots?"+q);
      const data = await res.json();

      const visible = data.filter(s => s.allowed && s.left >= guests);
      elSlots.innerHTML = "";
      if(visible.length === 0){
        elSlotsMsg.textContent = "We are fully booked at this date. Please choose another day.";
        return;
      }
      elSlotsMsg.textContent = "";

      visible.forEach(s=>{
        const b = document.createElement("button");
        b.type="button"; b.className="slot";
        b.textContent = s.time;
        b.addEventListener("click", ()=>{
          document.querySelectorAll(".slot.active").forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          $("#time").value = s.time;
          $("#submit").disabled = false;
        });
        elSlots.appendChild(b);
      });

    }catch(e){
      elSlotsMsg.textContent = "Failed to load slots.";
    }
  }

  $("#date").addEventListener("change", loadSlots);
  $("#guests").addEventListener("change", loadSlots);

  // submit
  $("#form").addEventListener("submit", async (e)=>{
    e.preventDefault();
    $("#submit").disabled = true;
    $("#feedback").textContent = "";

    const payload = {
      date: ymd($("#date").value),
      time: $("#time").value,
      firstName: $("#first").value.trim(),
      name: $("#last").value.trim(),
      email: $("#mail").value.trim(),
      phone: $("#phone").value.trim(),
      guests: Number($("#guests").value),
      notes: $("#notes").value.trim()
    };

    if(!payload.time){
      $("#feedback").textContent = "Please choose a time slot.";
      $("#submit").disabled = false;
      return;
    }

    try{
      const res = await fetch("/api/reservations", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok){
        $("#feedback").textContent = data.error || "Booking failed.";
        $("#submit").disabled = false;
        return;
      }
      $("#feedback").textContent = "Your reservation has been received. You will get a confirmation email shortly.";
      // simple reset
      $("#submit").disabled = true;
    }catch(err){
      $("#feedback").textContent = "Booking failed.";
      $("#submit").disabled = false;
    }
  });

  // default date today
  const today = new Date();
  $("#date").value = today.toISOString().slice(0,10);
  </script>
</body>
</html>

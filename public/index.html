<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Reservation — RÖSTILAND BY NOXAMA SAMUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    /* Mini-Ergänzungen nur für den Notice-Kasten & Toast */
    .notice-box{
      background:#fff7e8;border:1px solid #efd7ad;border-radius:10px;
      padding:10px 12px;margin:8px 0 2px 0;font-size:14px; color:#5a452e;
    }
    .notice-accept{ display:flex; align-items:center; gap:8px; margin-top:8px; }
    .toast {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 18px; background: rgba(40,40,40,.92); color:#fff; padding:12px 18px;
      border-radius:10px; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,.2);
      z-index: 9999; max-width: 92vw;
    }
    .toast.hide { display:none; }
  </style>
</head>
<body>
<div class="container">

  <!-- Banner/Header (geladen aus /api/config) -->
  <div class="hero-wrap">
    <img id="heroBanner" class="hero-banner" alt="Banner" />
  </div>

  <nav><a class="active" href="/">Reservation</a> <a href="/admin">Admin</a></nav>

  <h1 class="page-title">Reservation — RÖSTILAND BY NOXAMA SAMUI</h1>
  <div class="address-line" id="venueLine"></div>

  <div class="card" style="max-width:980px;margin-inline:auto;">
    <h2>Book a table</h2>

    <form id="frm">
      <div class="form-grid">
        <div class="field">
          <label>Date</label>
          <input id="date" type="date" required>
        </div>

        <div class="field">
          <label>Guests</label>
          <div style="display:flex; gap:10px; align-items:center;">
            <input id="guests" type="number" min="1" value="2" required style="width:110px"/>
            <button id="btnPlus10" type="button" class="btn" style="padding:8px 12px;">11+ guests</button>
          </div>
          <div style="font-size:12px;opacity:.8;margin-top:6px;">For larger groups please contact us directly.</div>

          <!-- Special notice (dynamisch) -->
          <div id="noticeWrap" class="notice-box" style="display:none;">
            <div id="noticeText"></div>
            <label class="notice-accept">
              <input id="noticeAccept" type="checkbox"> I accept
            </label>
          </div>
        </div>

        <div class="field">
          <label>Time</label>
          <select id="time" required></select>
        </div>

        <div class="field">
          <label>First name</label>
          <input id="firstName" required/>
        </div>
        <div class="field">
          <label>Last name</label>
          <input id="lastName" required/>
        </div>

        <div class="field">
          <label>Email</label>
          <input id="email" type="email" required/>
        </div>
        <div class="field">
          <label>Phone</label>
          <input id="phone" />
        </div>

        <div class="field" style="grid-column:1/-1;">
          <label>Notes</label>
          <input id="notes" placeholder="Optional"/>
        </div>
      </div>

      <div style="margin-top:12px;">
        <button id="btnReserve" type="submit" class="btn">Reserve</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hide"></div>

<script>
  // Helper
  const pad2 = n => String(n).padStart(2,'0');
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };

  // Banner + Venue-Zeile
  (async()=>{
    try{
      const r = await fetch('/api/config'); const cfg = await r.json();
      const hero = document.getElementById('heroBanner');
      hero.src = cfg.mailHeaderUrl || cfg.mailLogoUrl || '/logo-hero.png';
      hero.alt = cfg.brand || 'Banner';
      document.getElementById('venueLine').textContent =
        `${cfg.address} • ${cfg.phone}`;
    }catch{}
  })();

  // Date init
  const dateEl = document.getElementById('date');
  dateEl.value = today();

  // Times dynamisch (via /api/slots)
  const timeEl = document.getElementById('time');
  async function loadTimes(){
    const d = dateEl.value;
    const g = Number(document.getElementById('guests').value || 2);
    timeEl.innerHTML = '';
    const r = await fetch(`/api/slots?date=${encodeURIComponent(d)}&guests=${g}`);
    const list = await r.json();
    list.filter(x=>x.canReserve).forEach(x => {
      const opt = document.createElement('option');
      opt.value = x.time; opt.textContent = x.time;
      timeEl.appendChild(opt);
    });
  }

  // Special notice holen
  const noticeWrap = document.getElementById('noticeWrap');
  const noticeText = document.getElementById('noticeText');
  const noticeAccept = document.getElementById('noticeAccept');
  async function loadNotice(){
    noticeWrap.style.display = 'none';
    noticeAccept.checked = false;
    const d = dateEl.value;
    const r = await fetch(`/api/notice?date=${encodeURIComponent(d)}`);
    const n = await r.json();
    if(n && n.message){
      noticeText.textContent = n.message;
      noticeWrap.style.display = '';
    }
  }

  // Initial
  await loadTimes();
  await loadNotice();

  dateEl.addEventListener('change', async ()=>{
    await loadTimes();
    await loadNotice();
  });
  document.getElementById('guests').addEventListener('change', loadTimes);

  // 11+ Button
  document.getElementById('btnPlus10').addEventListener('click', ()=>{
    window.location.href = 'tel:+66077270675';
  });

  // Toast helper
  function showToast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.remove('hide');
    setTimeout(()=> t.classList.add('hide'), 3600);
  }

  // Submit
  document.getElementById('frm').addEventListener('submit', async (e)=>{
    e.preventDefault();

    // Falls Notice aktiv, Checkbox Pflicht
    if(noticeWrap.style.display !== 'none' && !noticeAccept.checked){
      showToast('Please accept the notice to proceed.');
      return;
    }

    const payload = {
      date: dateEl.value,
      time: timeEl.value,
      firstName: document.getElementById('firstName').value.trim(),
      name: document.getElementById('lastName').value.trim(),
      email: document.getElementById('email').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      guests: Number(document.getElementById('guests').value || 2),
      notes: document.getElementById('notes').value.trim()
    };

    const r = await fetch('/api/reservations', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    if(!r.ok){
      const e = await r.json().catch(()=>({}));
      showToast(e.error || 'Booking failed');
      return;
    }

    // Erfolgs-Toast EN (wie gewünscht)
    showToast('Reservation received. You will get a confirmation email shortly. Please also check your spam folder.');

    // kleine Pause, dann zurück auf Start
    setTimeout(()=>{ window.location.href = '/'; }, 2000);
  });
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Contact and Table Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- Basis-Styles der App -->
  <link rel="stylesheet" href="/style.css"/>

  <!-- Minimaler „Rescue“-Style, damit das Layout wieder so sauber wirkt wie früher,
       unabhängig davon, was aktuell in style.css steht. Kannst du gern später rausnehmen,
       wenn style.css wieder 1:1 passt. -->
  <style>
    :root{
      --bg:#d6c7b2;        /* Hintergrund (beige, wie gewünscht) */
      --card:#f7efe6;      /* Karten-Hintergrund */
      --ink:#3a2f28;       /* Textfarbe */
      --muted:#8b7767;     /* Sekundärtext */
      --accent:#a87a39;    /* Akzent/Buttons */
      --accent-ink:#fff;   /* Button Text */
      --ring:rgba(0,0,0,.08);
      --radius:14px;
    }
    html,body{background:var(--bg); color:var(--ink); font-family: Georgia, "Times New Roman", serif;}
    .container{max-width:940px;margin:24px auto 80px;padding:0 16px;}
    h1{font-size:42px;line-height:1.15;margin:14px 0 22px;}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:0 1px 0 var(--ring), 0 12px 28px rgba(0,0,0,.06);
      padding:18px 18px 20px;
      margin:18px 0;
    }
    .logo-wrap{display:flex;justify-content:center;margin:8px 0 6px;}
    .logo-hero{
      width: 320px;       /* groß, aber nicht „erschlagend“ */
      max-width: 60vw;    /* mobil schön skaliert */
      height:auto; display:block; border-radius:12px;
      box-shadow:0 2px 20px rgba(0,0,0,.10);
    }

    /* Grid / Inputs */
    label{display:block;font-weight:700;margin:12px 0 6px;}
    input,select,textarea{
      width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(0,0,0,.12);
      background:#fff;font:inherit;color:var(--ink);box-sizing:border-box;
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(168,122,57,.25);}
    .row{display:flex;gap:10px;align-items:center}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    /* Slots */
    .slot-grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px}
    @media (max-width:720px){.slot-grid{grid-template-columns:repeat(3,minmax(0,1fr));}}
    @media (max-width:460px){.slot-grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    .slot{
      padding:10px 0;border-radius:999px;border:1px solid rgba(0,0,0,.12);
      background:#fff;cursor:pointer;text-align:center;font-weight:600;
      transition:.15s;
    }
    .slot:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,0,0,.06)}
    .slot.disabled{opacity:.35;cursor:not-allowed;background:#faf7f3}
    .slot.active{background:var(--accent);color:var(--accent-ink);border-color:transparent}

    /* Buttons / Badges */
    .btn{
      background:var(--accent);color:var(--accent-ink);border:none;
      padding:12px 16px;border-radius:10px;cursor:pointer;font-weight:700;
      box-shadow:0 6px 16px rgba(168,122,57,.25);transition:.15s;
    }
    .btn:hover{filter:brightness(.97);transform:translateY(-1px)}
    .btn-plain{background:transparent;border:none;color:var(--accent);cursor:pointer}
    .badge{display:inline-block;background:#fff3d6;color:#7a5b2a;border:1px solid rgba(0,0,0,.06);padding:6px 10px;border-radius:999px}
    .actions{display:flex;align-items:center;gap:12px;margin-top:14px}

    /* Banner unter dem Datumsfeld (Hinweise) */
    .banner{background:#fff8ec;border-left:6px solid var(--accent);padding:10px 12px;border-radius:10px;margin:10px 0}
    .hidden{display:none}

    /* Modal „Thank you“ */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:50}
    .modal.hidden{display:none}
    .modal-body{
      width:min(560px,92vw);background:#fff;border-radius:16px;padding:22px 20px;
      box-shadow:0 14px 40px rgba(0,0,0,.25);text-align:center
    }
    .modal h3{margin:0 0 6px;font-size:26px}
    .modal p{margin:6px 0 14px;color:#5c493a}
    /* Kontaktkasten */
    .contact p{margin:6px 0}
  </style>
</head>
<body>
<div class="container">

  <!-- großes, neues Logo (hero) -->
  <div class="logo-wrap">
    <picture>
      <source srcset="/logo-hero.png" type="image/png"/>
      <img class="logo-hero" src="/logo.png" alt="Logo"/>
    </picture>
  </div>

  <h1>Contact and Table Booking</h1>

  <!-- Kontakt -->
  <div class="card">
    <div id="contactBox" class="contact">
      <p><b>Address</b><br/><span id="venueAddress"></span></p>
      <p><b>Phone</b> <a id="venuePhoneLink" href="#" style="color:inherit;text-decoration:none"><span id="venuePhone"></span></a><br/>
         <b>Email</b> <a id="venueEmailLink" href="#" style="color:inherit;text-decoration:none"><span id="venueEmail"></span></a>
      </p>
    </div>
  </div>

  <!-- Buchung -->
  <div class="card">
    <label>Date</label>
    <div class="row">
      <input id="date" type="date"/>
      <button id="reload" class="btn" type="button" title="Reload slots">↻</button>
    </div>

    <div id="dayInfo" class="banner hidden"></div>

    <label style="margin-top:10px;">Choose a time slot (15 minutes grid)</label>
    <div id="slots" class="slot-grid"></div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label>First name*</label>
        <input id="firstName" required />
      </div>
      <div>
        <label>Name*</label>
        <input id="name" required />
      </div>
    </div>

    <label>Email*</label>
    <input id="email" type="email" required />

    <label>Phone (optional)</label>
    <input id="phone" />

    <label>Guests*</label>
    <select id="guests"></select>

    <label>Notes</label>
    <textarea id="notes" rows="3" placeholder="Allergies, seating request, occasion"></textarea>

    <div class="actions">
      <button id="book" class="btn" type="button">Book now</button>
      <span id="msg" class="badge"></span>
    </div>
  </div>
</div>

<!-- Thank-you modal (nur nach erfolgreicher Buchung sichtbar) -->
<div id="modal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="modal-body">
    <h3>Thank you!</h3>
    <p>Your reservation has been received. You will get a confirmation email shortly.<br/>Please also check your spam folder.</p>
    <button id="closeModal" class="btn">OK</button>
  </div>
</div>

<script>
  // ---------- utilities ----------
  const todayISO = ()=>{
    const d=new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  };

  function friendlyError(e){
    if(!e) return "Something went wrong.";
    const s = String(e).toLowerCase();
    if(s.includes("block")) return "We are fully booked on this date. Please choose another day.";
    if(s.includes("opening") || s.includes("öffnungs")) return "This time is outside our opening hours.";
    if(s.includes("fully") || s.includes("ausgebucht")) return "We are fully booked at this time. Please select another slot.";
    return e;
  }

  // ---------- kontakt laden ----------
  fetch("/api/config").then(r=>r.json()).then(c=>{
    const addr = document.getElementById("venueAddress");
    const ph = document.getElementById("venuePhone");
    const em = document.getElementById("venueEmail");
    const phL = document.getElementById("venuePhoneLink");
    const emL = document.getElementById("venueEmailLink");
    addr.textContent = c.address || "";
    ph.textContent   = c.phone || "";
    em.textContent   = c.email || "";
    if(c.phone){ phL.href = "tel:"+c.phone.replace(/\s+/g,""); }
    if(c.email){ emL.href = "mailto:"+c.email; }
  });

  // ---------- Formular init ----------
  document.getElementById("date").value = todayISO();
  for(let i=1;i<=48;i++){
    const o=document.createElement("option");
    o.value=o.textContent=String(i);
    document.getElementById("guests").appendChild(o);
  }

  let selectedTime = null;

  async function loadSlots(){
    selectedTime = null;
    const d = document.getElementById("date").value;
    const r = await fetch(`/api/slots?date=${encodeURIComponent(d)}`);
    const data = await r.json();
    const box = document.getElementById("slots");
    const banner = document.getElementById("dayInfo");
    box.innerHTML = "";

    // freundliche Meldung bei komplett gesperrtem Tag
    const anyAllowed = data.some(s => s.allowed && s.canReserve);
    if(!anyAllowed && data.length && data.every(s => s.reason === "Blockiert")){
      banner.textContent = "We are fully booked on this date. Please choose another day.";
      banner.classList.remove("hidden");
    } else {
      banner.classList.add("hidden");
      banner.textContent = "";
    }

    data.forEach(s=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "slot " + (s.allowed && s.canReserve ? "" : "disabled");
      b.textContent = s.time;
      if (s.allowed && s.canReserve) {
        b.onclick = ()=>{ document.querySelectorAll(".slot.active").forEach(x=>x.classList.remove("active")); b.classList.add("active"); selectedTime = s.time; };
      } else {
        b.title = s.reason || "Not available";
      }
      box.appendChild(b);
    });
  }
  document.getElementById("reload").onclick = loadSlots;
  document.getElementById("date").addEventListener("change", loadSlots);
  loadSlots();

  // ---------- Buchung ----------
  document.getElementById("book").onclick = async ()=>{
    const d = document.getElementById("date").value;
    const firstName = document.getElementById("firstName").value.trim();
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const guests = Number(document.getElementById("guests").value);
    const notes = document.getElementById("notes").value.trim();
    const m = document.getElementById("msg");

    if(!selectedTime){ m.textContent="Please select a time slot"; return; }
    if(!firstName || !name || !email){ m.textContent="Please fill in all required fields"; return; }

    m.textContent = "";
    const payload = { date:d, time:selectedTime, firstName, name, email, phone, guests, notes };

    try{
      const r = await fetch("/api/reservations", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if(r.ok){
        // nur hier: Danke-Modal zeigen
        document.getElementById("modal").classList.remove("hidden");
      }else{
        const e = await r.json().catch(()=>({error:"Error"}));
        m.textContent = friendlyError(e.error||"Error");
      }
    }catch(e){
      m.textContent = "Network error. Please try again.";
    }
  };
  document.getElementById("closeModal").onclick = ()=>document.getElementById("modal").classList.add("hidden");
</script>
</body>
</html>

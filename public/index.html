<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Reservation — RÖSTILAND BY NOXAMA SAMUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    /* small local overrides to ensure consistent modal visuals, logo centering etc. */
    .hero-wrap { text-align:center;margin-top:18px; }
    .hero-banner { max-width:640px;width:76%;border-radius:12px;box-shadow:0 25px 50px rgba(0,0,0,.18); display:block; margin:0 auto; }

    /* loyalty modal styling (requested) */
    #loyalty-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:99999; align-items:center; justify-content:center; }
    #loyalty-modal > .box {
      background: #d6c7b2; /* requested */
      border: 1px solid #e0d7c5;
      border-radius: 12px;
      max-width: 720px;
      width: 96%;
      padding: 8px;
      box-shadow: 0 10px 35px rgba(0,0,0,0.25);
      text-align: center;
      overflow: hidden;
      position: relative;
    }
    #fw-canvas { width:100%; height:220px; display:block; border-radius:8px; margin:8px 0; background: linear-gradient(180deg,#fff,#fff8f2); box-shadow: inset 0 -6px 12px rgba(0,0,0,0.03); }
    #loyalty-body { padding:8px 12px 18px 12px; color:#2f2318; font-family: Georgia, serif; }
    #loyalty-msg { background: rgba(255,255,255,0.95); padding:10px 14px; border-radius:8px; display:inline-block; margin-top:8px; }
    .loy-btn { background:#b3822f; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }
    .loy-close { background:transparent; border:1px solid rgba(0,0,0,0.06); padding:8px 12px; border-radius:8px; cursor:pointer; }

    /* Large-party modal (11+) */
    #largeparty-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:99998; align-items:center; justify-content:center; }
    #largeparty-modal .box { background:#fff8f0; border-radius:12px; width:520px; max-width:96%; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25); text-align:center; border:1px solid #e0d7c5; font-family:Georgia,serif; color:#2f2318; }

    /* General small helper */
    .hidden { display:none !important; }
    @keyframes popIn { from { transform: translateY(8px); opacity:0 } to { transform: translateY(0); opacity:1 } }
    #loyalty-modal > .box, #largeparty-modal .box { animation: popIn .22s ease both; }
  </style>
</head>
<body>
  <div class="hero-wrap">
    <img id="heroBanner" class="hero-banner" alt="Logo banner" src="/logo-hero.png"/>
  </div>

  <div class="container">
    <h1 style="text-align:center;margin-top:8px;">Reservation — RÖSTILAND BY NOXAMA SAMUI</h1>
    <p style="text-align:center;margin-top:6px;">Moo 4 Lamai Beach, 84310 Suratthani, Thailand • +66 077 270 675</p>

    <div class="card booking-card booking-compact" style="max-width:760px;margin:18px auto;padding:18px;">
      <h2>Book a table</h2>

      <div class="row date-time">
        <div style="flex:1 1 220px;">
          <label>Date</label>
          <input id="rDate" type="date"/>
        </div>
        <div style="flex:0 0 130px;">
          <label>Guests</label>
          <select id="rGuests" aria-label="Guests"></select>
        </div>
        <div style="flex:0 0 140px;">
          <label>Time</label>
          <select id="rTime" aria-label="Time"></select>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>First name</label>
          <input id="rFirst" type="text"/>
        </div>
        <div>
          <label>Last name</label>
          <input id="rLast" type="text"/>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>Email</label>
          <input id="rEmail" type="email"/>
        </div>
        <div>
          <label>Phone</label>
          <input id="rPhone" type="tel"/>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>Notes</label>
        <textarea id="rNotes" rows="2" style="width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #c8b99e;"></textarea>
      </div>

      <div style="margin-top:12px;text-align:left;">
        <button id="btnReserve" class="btn btn-primary-book" type="button">Book</button>
        <span id="rMsg" class="badge" style="margin-left:10px;"></span>
      </div>
    </div>
  </div>

  <!-- confirm modal for normal success / errors -->
  <div id="confirm-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:99997;">
    <div style="background:#fff8f0;border-radius:12px;padding:18px;max-width:420px;width:92%;text-align:center;border:1px solid #e0d7c5;">
      <h3 id="confirm-title" style="margin-top:0;">Reservation confirmed</h3>
      <div id="confirm-text" style="margin:8px 0 12px 0;color:#3a2f28;"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="confirm-ok" class="btn" style="min-width:120px;">Continue</button>
      </div>
    </div>
  </div>

  <!-- Large party (11+) modal -->
  <div id="largeparty-modal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true">
      <h3 style="margin-top:0;">Large party request</h3>
      <p>For parties of 11 or more please contact us so we can arrange a suitable table and confirm availability.</p>
      <div style="display:flex;gap:12px;justify-content:center;margin-top:12px;">
        <a href="tel:+66077270675" class="loy-btn" style="text-decoration:none;">Call +66 077 270 675</a>
        <a href="mailto:info@noxamasamui.com" class="loy-btn" style="text-decoration:none;">Email info@noxamasamui.com</a>
      </div>
      <p style="margin-top:10px;font-size:13px;">Or use the chat / contact form on our site — we will help you find the best option.</p>
      <div style="margin-top:12px;"><button id="largeparty-ok" class="loy-btn">OK</button></div>
    </div>
  </div>
/* --- mobile: kompaktere Inputs für Datum / Gäste / Zeit --- */
@media (max-width: 520px) {
  /* Container der drei Felder: Date / Guests / Time auf kleinen Displays */
  .date-time { display:flex; gap:10px; flex-wrap:wrap; }

  /* Datum bleibt breit, Gäste + Zeit kompakter */
  .date-time > div:nth-child(1) { flex: 1 1 100%; }
  .date-time > div:nth-child(2),
  .date-time > div:nth-child(3) {
    flex: 0 0 auto;
    min-width: 92px;
    max-width: 140px;
  }

  /* speziell die Time-Select (kleinerer Innenabstand + Schrift) */
  #rTime, #rGuests {
    font-size: 15px;
    padding: 8px 10px;
    height: 42px;
    border-radius: 8px;
    box-sizing: border-box;
  }

  /* Datum-Input bleibt groß, aber mit etwas Padding */
  #rDate {
    padding: 12px 14px;
    height: 48px;
    font-size: 16px;
    border-radius: 10px;
  }
}

  <!-- Loyalty modal + fireworks -->
  <div id="loyalty-modal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" aria-labelledby="loyalty-title">
      <canvas id="fw-canvas" aria-hidden="true"></canvas>
      <div id="loyalty-body">
        <h2 id="loyalty-title" style="margin:6px 0 4px 0;">You earned a loyalty reward</h2>
        <p id="loyalty-sub" style="margin:0 0 8px 0;">Congratulations — loyalty reward unlocked!</p>
        <div id="loyalty-msg"><strong id="loyalty-percent">Enjoy a 5% thank-you discount on your next visit</strong></div>
        <div style="margin-top:12px;"><button id="loyalty-ok" class="loy-btn">Okay</button></div>
      </div>
    </div>
  </div>

<script>
/*
  Main client script:
   - fills logo from /api/config
   - populates guests dropdown (1..10 + "11+" option)
   - updates times by calling /api/slots?date=&guests=
   - hides times that are not allowed (only allowed slots shown)
   - on date change: if no allowed slots -> immediate modal informing user (Sunday/Blocked)
   - on selecting guests "11+" -> large party modal
   - booking posts to /api/reservations; on success triggers loyalty modal via window.__showLoyaltyModal(percent)
*/

(function(){
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

  // load logo + basic config
  (async ()=>{
    try{
      const r = await fetch('/api/config', { cache: "no-store" });
      if (!r.ok) return;
      const cfg = await r.json();
      const hero = document.getElementById('heroBanner');
      if (hero) {
        hero.src = cfg.mailHeaderUrl && cfg.mailHeaderUrl.trim() ? cfg.mailHeaderUrl : (cfg.mailLogoUrl && cfg.mailLogoUrl.trim() ? cfg.mailLogoUrl : '/logo-hero.png');
        hero.alt = cfg.brand || 'Banner';
        hero.style.display = "block";
        hero.style.margin = "0 auto";
      }
    }catch(e){ console.warn('config load', e); }
  })();

  // initialize inputs
  const dateInput = document.getElementById('rDate');
  const guestsSelect = document.getElementById('rGuests');
  const timeSelect = document.getElementById('rTime');
  const reserveBtn = document.getElementById('btnReserve');
  const msgSpan = document.getElementById('rMsg');

  dateInput.value = today();

  // populate guests: 1..10 then "11+"
  function populateGuests(){
    guestsSelect.innerHTML = '';
    for(let i=1;i<=10;i++){
      const o = document.createElement('option'); o.value = String(i); o.textContent = String(i); guestsSelect.appendChild(o);
    }
    const o = document.createElement('option'); o.value = 'large'; o.textContent = '11+'; guestsSelect.appendChild(o);
  }
  populateGuests();

  // large-party modal handler
  const largeModal = document.getElementById('largeparty-modal');
  const largeOk = document.getElementById('largeparty-ok');
  function showLargeModal(){ if (!largeModal) return; largeModal.style.display = 'flex'; largeModal.setAttribute('aria-hidden','false'); }
  function hideLargeModal(){ if (!largeModal) return; largeModal.style.display = 'none'; largeModal.setAttribute('aria-hidden','true'); }
  largeOk && largeOk.addEventListener('click', ()=>{ hideLargeModal(); guestsSelect.value = '1'; updateTimes(); });

  guestsSelect.addEventListener('change', (e)=>{
    if (guestsSelect.value === 'large') {
      // show large party modal and reset to 1 (prevents booking)
      showLargeModal();
    } else {
      updateTimes(); // update times for new guest count
    }
  });

  // function to call /api/slots and fill only allowed times
  let lastSlotCall = 0;
  async function updateTimes(){
    const date = dateInput.value;
    const guestsVal = guestsSelect.value === 'large' ? 11 : Number(guestsSelect.value || 1);
    timeSelect.innerHTML = '';
    msgSpan.textContent = '';

    if (!date) return;

    const callAt = Date.now(); lastSlotCall = callAt;
    try{
      const resp = await fetch(`/api/slots?date=${encodeURIComponent(date)}&guests=${encodeURIComponent(guestsVal)}`, { cache: "no-store" });
      if (!resp.ok) {
        console.warn('slots fetch failed');
        return;
      }
      if (callAt !== lastSlotCall) return; // aborted by newer call

      const slots = await resp.json();
      if (!Array.isArray(slots)){
        console.warn('unexpected slots response', slots);
        return;
      }

      const allowed = slots.filter(s => s.allowed);

      if (allowed.length === 0) {
        // immediate modal: closed/blocked/fully booked for the whole date
        // pick reason priority: Sunday, Blocked, Fully booked
        const reasons = Array.from(new Set(slots.map(s=>s.reason).filter(Boolean)));
        let reasonText = reasons.find(r=>/sunday/i.test(r)) || reasons.find(r=>/blocked|closed/i.test(r)) || reasons[0] || "This date is not available";
        showConfirm("Reservation not possible", reasonText + ". Please choose another date.");
        // leave timeSelect empty
        return;
      }

      // fill only allowed times (no remaining-seat numbers shown)
      allowed.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.time;
        opt.textContent = s.time;
        timeSelect.appendChild(opt);
      });

    }catch(err){
      console.error('updateTimes error', err);
      msgSpan.textContent = 'Network error';
    }
  }

  function showConfirm(title, text){
    const modal = document.getElementById('confirm-modal');
    const t = document.getElementById('confirm-title');
    const c = document.getElementById('confirm-text');
    t.textContent = title;
    c.textContent = text;
    modal.style.display = 'flex';
    document.getElementById('confirm-ok').onclick = ()=> { modal.style.display = 'none'; };
  }

  dateInput.addEventListener('change', ()=> updateTimes());
  // also update when page loads or guests changes
  document.addEventListener('DOMContentLoaded', ()=> updateTimes());
  guestsSelect.addEventListener('change', ()=> {
    if (guestsSelect.value !== 'large') updateTimes();
  });

  // reserve action
  reserveBtn.addEventListener('click', async ()=>{
    msgSpan.textContent = '';
    const payload = {
      date: dateInput.value,
      time: timeSelect.value,
      firstName: (document.getElementById('rFirst').value || "").trim(),
      name: (document.getElementById('rLast').value || "").trim(),
      email: (document.getElementById('rEmail').value || "").trim(),
      phone: (document.getElementById('rPhone').value || "").trim(),
      guests: guestsSelect.value === 'large' ? 11 : Number(guestsSelect.value),
      notes: (document.getElementById('rNotes').value || "").trim()
    };

    // basic validation
    if (!payload.date || !payload.time) { msgSpan.textContent = 'Please choose date and time'; return; }
    if (!payload.firstName || !payload.name || !payload.email || !payload.guests) { msgSpan.textContent = 'Please fill first name, last name, email and guests'; return; }
    if (payload.guests > 10) { showLargeModal(); return; } // safety

    try{
      const r = await fetch('/api/reservations', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const json = await r.json().catch(()=>({}));
      if (r.ok) {
        // if server says loyalty unlocked -> show loyalty modal
        if (json && (json.nowUnlockedTier === 5 || json.nowUnlockedTier === 10 || json.nowUnlockedTier === 15)) {
          // show loyalty
          if (typeof window.__showLoyaltyModal === 'function') {
            window.__showLoyaltyModal(json.nowUnlockedTier);
          } else {
            // fallback simple confirmation
            showConfirm('Reservation received', `A confirmation mail will be sent to ${payload.email}`);
          }
        } else {
          showConfirm('Reservation received', `Thank you. A confirmation mail will be sent to ${payload.email}.`);
        }
      } else {
        const err = (json && json.error) ? String(json.error).toLowerCase() : "Failed to create reservation";
        if (err.includes('sunday') || err.includes('closed') || err.includes('blocked') || err.includes('fully booked')) {
          showConfirm('Not available', json.error || 'This slot/date is not available. Please choose another.');
        } else {
          msgSpan.textContent = json.error || 'Error saving reservation';
        }
      }
    }catch(e){
      console.error('reservation error', e);
      msgSpan.textContent = 'Network error';
    }
  });

  // quick safety: when large party modal closed, reset guests to 1 so user can continue
  document.getElementById('largeparty-ok').addEventListener('click', ()=> { guestsSelect.value = '1'; updateTimes(); });

})();
</script>

<!-- FIREWORKS + LOYALTY modal implementation -->
<script>
(function(){
  // guard against double init
  if (window.__noxama_fireworks_initialized) return;
  window.__noxama_fireworks_initialized = true;

  const modal = document.getElementById('loyalty-modal');
  const canvas = document.getElementById('fw-canvas');
  const ok = document.getElementById('loyalty-ok');
  const percentEl = document.getElementById('loyalty-percent');

  if (!modal || !canvas || !ok || !percentEl) {
    console.warn('loyalty modal elements not found');
    return;
  }

  const ctx = canvas.getContext('2d');
  let raf = null;
  let particles = [];
  let running = false;
  let last = performance.now();

  const COLORS = ['#ff2e63','#ff9f1c','#ffd166','#7bd389','#6ad3f8','#b892ff','#ff6bcb','#ffd54f','#ffb86b'];

  function resizeCanvas(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    canvas.style.width = canvas.clientWidth + 'px';
    canvas.style.height = canvas.clientHeight + 'px';
    canvas.width = Math.floor(canvas.clientWidth * dpr);
    canvas.height = Math.floor(canvas.clientHeight * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function spawn(cx, cy, count){
    for(let i=0;i<count;i++){
      const angle = Math.random()*Math.PI*2;
      const speed = 2 + Math.random()*7;
      particles.push({
        x: cx,
        y: cy,
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed,
        life: 700 + Math.random()*1300,
        born: performance.now(),
        size: 2 + Math.random()*6,
        color: COLORS[Math.floor(Math.random()*COLORS.length)],
        gravity: 0.03 + Math.random()*0.06,
        decay: 0.98 - Math.random()*0.02
      });
    }
  }

  function update(dt){
    // occasionally spawn fireworks across width
    if (Math.random() < 0.03) {
      const cx = Math.random() * canvas.clientWidth;
      const cy = Math.random() * (canvas.clientHeight * 0.6);
      spawn(cx, cy, 80 + Math.floor(Math.random()*120));
    }
    const now = performance.now();
    for (let i = particles.length-1; i >= 0; i--) {
      const p = particles[i];
      p.vy += p.gravity * (dt/16);
      p.x += p.vx * (dt/16);
      p.y += p.vy * (dt/16);
      p.vx *= p.decay;
      p.vy *= p.decay;
      if (now - p.born > p.life || p.y > canvas.clientHeight + 50 || p.x < -50 || p.x > canvas.clientWidth + 50) {
        particles.splice(i,1);
      }
    }
  }

  function draw(){
    // gentle clear with slight opacity to create trails
    ctx.fillStyle = 'rgba(255,255,255,0.03)';
    ctx.fillRect(0,0,canvas.clientWidth, canvas.clientHeight);

    ctx.globalCompositeOperation = 'lighter';
    for (const p of particles){
      const age = (performance.now() - p.born) / p.life;
      const alpha = Math.max(0, 1 - age);
      const sz = p.size * (1.0 + (1-age)*1.2);
      const g = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, sz*3);
      g.addColorStop(0, `rgba(255,255,255,${Math.min(0.95, alpha*0.9)})`);
      g.addColorStop(0.1, p.color);
      g.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(p.x, p.y, sz*2, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalCompositeOperation = 'source-over';
  }

  function loop(now){
    const dt = Math.max(8, now - last);
    last = now;
    update(dt);
    ctx.clearRect(0,0,canvas.clientWidth, canvas.clientHeight);
    draw();
    if (running) raf = requestAnimationFrame(loop);
  }

  function start(){
    if (running) return;
    running = true;
    resizeCanvas();
    last = performance.now();
    raf = requestAnimationFrame(loop);
    window.addEventListener('resize', resizeCanvas);
  }
  function stop(){
    running = false;
    if (raf) cancelAnimationFrame(raf);
    raf = null;
    particles = [];
    ctx && ctx.clearRect(0,0,canvas.clientWidth, canvas.clientHeight);
    window.removeEventListener('resize', resizeCanvas);
  }

  // expose show function
  window.__showLoyaltyModal = function(percent){
    percent = Number(percent) || 5;
    percentEl.textContent = `Enjoy a ${percent}% thank-you discount on your next visit`;
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    start();
  };

  ok.addEventListener('click', ()=>{
    stop();
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  });

  document.addEventListener('keydown', (ev)=>{
    if (ev.key === 'Escape' && modal.style.display === 'flex') {
      stop();
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }
  });

  // cleanup on unload
  window.addEventListener('beforeunload', stop);

  // expose stop for debugging
  window.__stopLoyaltyFireworks = stop;

})();
</script>

</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Contact and Table Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
<div class="container">
  <img class="logo" src="/logo.png" alt="Logo"/>

  <h1>Contact and Table Booking</h1>

  <div class="card">
    <div id="contactBox" class="contact">
      <p><b>Address</b><br/><span id="venueAddress"></span></p>
      <p><b>Phone</b> <a id="venuePhoneLink" href="#"><span id="venuePhone"></span></a><br/>
         <b>Email</b> <a id="venueEmailLink" href="#"><span id="venueEmail"></span></a></p>
    </div>
  </div>

  <div class="card">
    <label>Date</label>
    <div class="row">
      <input id="date" type="date"/>
      <button id="reload" class="btn" type="button">↻</button>
    </div>

    <div id="dayInfo" class="banner hidden"></div>

    <label style="margin-top:10px;">Guests (max 10 online)</label>
    <select id="guests">
      <option value="" selected disabled>Select guests…</option>
    </select>
    <div style="margin-top:8px;">
      <button id="groupBtn" class="btn-plain" type="button">Group 11+?</button>
    </div>
    <div id="groupMsg" class="banner hidden">For groups of 11 or more, please contact us by phone or email — we’re happy to arrange everything for you.</div>

    <div id="noSlotsMsg" class="banner hidden"></div>

    <div id="slotWrap" class="hidden">
      <label style="margin-top:10px;">Choose a time slot (15 minutes grid)</label>
      <div id="slots" class="slot-grid"></div>
    </div>

    <div class="grid2">
      <div>
        <label>First name*</label>
        <input id="firstName" required />
      </div>
      <div>
        <label>Name*</label>
        <input id="name" required />
      </div>
    </div>

    <label>Email*</label>
    <input id="email" type="email" required />

    <label>Phone (optional)</label>
    <input id="phone" />

    <label>Notes</label>
    <textarea id="notes" rows="3" placeholder="Allergies, seating request, occasion"></textarea>

    <div class="actions">
      <button id="book" class="btn" type="button">Book now</button>
      <span id="msg" class="badge"></span>
    </div>
  </div>
</div>

<!-- Thank-you modal -->
<div id="modal" class="modal hidden">
  <div class="modal-body">
    <h3>Thank you!</h3>
    <p>Your reservation has been received. You’ll get a confirmation email shortly.  
       If you can’t find it, please check your spam folder.</p>
    <button id="closeModal" class="btn">OK</button>
  </div>
</div>

<script>
const todayISO = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

// Config / contact
fetch("/api/config").then(r=>r.json()).then(c=>{
  document.getElementById("venueAddress").textContent = c.address || "";
  document.getElementById("venuePhone").textContent   = c.phone || "";
  const tel = (c.phone||"").replace(/\s+/g,"");
  document.getElementById("venuePhoneLink").href = tel?`tel:${tel}`:"#";
  document.getElementById("venueEmail").textContent   = c.email || "";
  document.getElementById("venueEmailLink").href = c.email?`mailto:${c.email}`:"#";
});

document.getElementById("date").value = todayISO();
const guestSel = document.getElementById("guests");
for(let i=1;i<=10;i++){ const o=document.createElement("option"); o.value=o.textContent=String(i); guestSel.appendChild(o); }

let selectedTime = null;
let loadedData = []; // slots result of the day

function show(el){ el.classList.remove("hidden") }
function hide(el){ el.classList.add("hidden") }

function friendlyDayMessage(reason){
  if(reason==="Sonntag geschlossen") return "We are closed on Sundays.";
  if(reason==="Blockiert") return "We are fully booked on this date. Please choose another day.";
  return "No availability for this date.";
}

async function loadSlots(){
  selectedTime = null;
  const d = document.getElementById("date").value;
  const r = await fetch(`/api/slots?date=${encodeURIComponent(d)}`);
  loadedData = await r.json();

  const banner = document.getElementById("dayInfo");
  const wrap = document.getElementById("slotWrap");
  const noMsg = document.getElementById("noSlotsMsg");
  const grid = document.getElementById("slots");

  grid.innerHTML = "";
  hide(banner); hide(wrap); hide(noMsg);

  if(!Array.isArray(loadedData) || loadedData.length===0){
    noMsg.textContent = "No slots for this date."; show(noMsg); return;
  }

  const allBlocked = loadedData.every(s => !s.allowed && s.reason === "Blockiert");
  const allSunday  = loadedData.every(s => !s.allowed && s.reason === "Sonntag geschlossen");

  if(allBlocked || allSunday){
    banner.textContent = friendlyDayMessage(allSunday? "Sonntag geschlossen":"Blockiert");
    show(banner);
    return;
  }

  const guests = Number(guestSel.value || 0);
  if(!guests){
    show(wrap);
    grid.innerHTML = `<div class="slot" style="grid-column: 1 / -1; cursor:default;">Select number of guests to see available times</div>`;
    return;
  }

  // Only show slots that can accept that many guests (server already computes capacity)
  const avail = loadedData.filter(s => s.allowed && s.canReserve);
  if(avail.length === 0){
    noMsg.textContent = `No available time slots for ${guests} guests on this date. Please choose another day.`;
    show(noMsg);
    return;
  }

  show(wrap);
  avail.forEach(s=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "slot";
    b.textContent = s.time;
    b.onclick = ()=>{
      document.querySelectorAll(".slot.active").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      selectedTime = s.time;
    }
    grid.appendChild(b);
  });
}

document.getElementById("reload").onclick = loadSlots;
document.getElementById("date").addEventListener("change", loadSlots);
guestSel.addEventListener("change", ()=>{
  const val = Number(guestSel.value || 0);
  if(val>=11){ document.getElementById("groupMsg").classList.remove("hidden"); selectedTime=null; }
  else document.getElementById("groupMsg").classList.add("hidden");
  loadSlots();
});
document.getElementById("groupBtn").onclick = ()=> document.getElementById("groupMsg").classList.toggle("hidden");

// initial load
loadSlots();

function friendlyError(e){
  if(!e) return "Something went wrong.";
  const m = e.toLowerCase();
  if(m.includes("blockiert")) return "We are fully booked on this date. Please choose another day.";
  if(m.includes("sonntag")) return "We are closed on Sundays.";
  if(m.includes("öffnungs") || m.includes("opening")) return "This time is outside our opening hours.";
  if(m.includes("voll") || m.includes("ausgebucht") || m.includes("fully")) return "We are fully booked at this time. Please select another slot.";
  return e;
}

document.getElementById("book").onclick = async ()=>{
  const d = document.getElementById("date").value;
  const firstName = document.getElementById("firstName").value.trim();
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const guests = Number(document.getElementById("guests").value);
  const notes = document.getElementById("notes").value.trim();
  const m = document.getElementById("msg");

  if(!guests || guests>10){
    m.textContent = "Online bookings are limited to max 10 guests."; return;
  }
  if(!selectedTime){ m.textContent="Please select a time slot."; return; }
  if(!firstName || !name || !email){ m.textContent="Please fill in all required fields."; return; }

  m.textContent = "";
  const payload = { date:d, time:selectedTime, firstName, name, email, phone, guests, notes };
  const r = await fetch("/api/reservations", {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  if(r.ok){
    document.getElementById("modal").classList.remove("hidden");
  }else{
    const e = await r.json().catch(()=>({error:"Error"}));
    m.textContent = friendlyError(e.error||"Error");
  }
};
document.getElementById("closeModal").onclick = ()=>{
  document.getElementById("modal").classList.add("hidden");
};
</script>
</body>
</html>

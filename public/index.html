<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Contact and Table Booking</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <div class="wrapper">

    <!-- Vollbreites Banner -->
    <div class="hero">
      <!-- nutze dein 1500×1000 Bild; kann auch extern gehostet sein -->
      <img src="/logo-hero.png" alt="RÖSTILAND by NOXAMA SAMUI"/>
    </div>

    <h1>Contact and Table Booking</h1>

    <section class="card" id="contact">
      <h2>Address</h2>
      <div class="row">
        <div class="kv">
          <b>Address</b><div>Moo 4 Lamai Beach, 84310 Suratthani, Thailand</div>
          <b>Phone</b>
          <div><a class="btn btn-pill" href="tel:+666077270675">+66 077 270 675</a></div>
          <b>Email</b>
          <div><a class="btn btn-pill" href="mailto:info@noxamasamui.com">info@noxamasamui.com</a></div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="row">
        <div>
          <label for="date">Date</label>
          <input id="date" class="input" type="date"/>
        </div>
        <div>
          <label for="guests">Guests (max 10 online)</label>
          <select id="guests" class="input"></select>
        </div>
      </div>

      <label style="margin-top:14px">Choose a time slot</label>
      <div id="times" class="times"></div>

      <div id="fullmsg" class="note" style="display:none;margin-top:12px;">
        We are fully booked or closed on this date. Please choose another day.
      </div>
    </section>

    <section class="card">
      <div class="row">
        <div>
          <label>First name*</label>
          <input id="first" class="input" autocomplete="given-name">
        </div>
        <div>
          <label>Name*</label>
          <input id="last" class="input" autocomplete="family-name">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Email*</label>
          <input id="email" class="input" type="email" autocomplete="email">
        </div>
        <div>
          <label>Phone (optional)</label>
          <input id="phone" class="input" autocomplete="tel">
        </div>
      </div>
      <div>
        <label>Notes</label>
        <textarea id="notes" class="input" rows="3" placeholder="Allergies, seating request, occasion"></textarea>
      </div>
      <div style="margin-top:14px">
        <button id="book" class="btn btn-pill">Book now</button>
        <button id="group" class="btn btn-pill" style="background:#7c5f2e;display:none">11+ guests — contact us</button>
      </div>
    </section>

    <div class="footer-space"></div>
  </div>

<script>
const el = s => document.querySelector(s);
const list = (n,fn)=>Array.from({length:n},(_,i)=>fn(i));

const dateEl   = el('#date');
const guestsEl = el('#guests');
const timesEl  = el('#times');
const fullMsg  = el('#fullmsg');
const bookBtn  = el('#book');
const groupBtn = el('#group');

const today = new Date();
dateEl.valueAsDate = today;

guestsEl.innerHTML = list(10, i => `<option value="${i+1}">${i+1}</option>`).join('');
guestsEl.addEventListener('change', () => {
  const g = Number(guestsEl.value);
  groupBtn.style.display = g >= 11 ? 'inline-block' : 'none';
});
groupBtn.addEventListener('click', () => {
  window.location.href = 'mailto:info@noxamasamui.com?subject=Group%20booking%2011%2B';
});

let selectedTime = '';
function renderTimes(items){
  timesEl.innerHTML = '';
  selectedTime = '';
  fullMsg.style.display = 'none';
  let any = false;
  for(const t of items){
    const b = document.createElement('button');
    b.className = 'time';
    b.textContent = t.time;
    if(!t.canReserve){ b.disabled = true; }
    b.addEventListener('click', ()=>{
      for(const x of timesEl.querySelectorAll('.time')) x.classList.remove('selected');
      b.classList.add('selected'); selectedTime = t.time;
    });
    timesEl.appendChild(b);
    any = true;
  }
  if(!items.length){ fullMsg.style.display='block'; }
  // bei Touch sofort visuelles Feedback
  timesEl.addEventListener('touchstart', e=> {
    const btn = e.target.closest('.time'); if(btn) btn.classList.add('selected');
  }, {passive:true});
}

async function loadSlots(){
  const ymd = dateEl.value;
  const r = await fetch(`/api/slots?date=${ymd}`).then(r=>r.json());
  renderTimes(r.filter(x => x.allowed));
}
dateEl.addEventListener('change', loadSlots);
loadSlots();

bookBtn.addEventListener('click', async ()=>{
  if (!selectedTime){ alert('Please select a time'); return; }
  const body = {
    date: dateEl.value,
    time: selectedTime,
    firstName: el('#first').value.trim(),
    name: el('#last').value.trim(),
    email: el('#email').value.trim(),
    phone: el('#phone').value.trim(),
    guests: Number(guestsEl.value),
    notes: el('#notes').value.trim()
  };
  if(!body.firstName || !body.name || !body.email){
    alert('Please fill in first name, name and email.'); return;
  }
  bookBtn.disabled = true; bookBtn.textContent = 'Sending…';
  try{
    const res = await fetch('/api/reservations',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const data = await res.json();
    if(!res.ok){ alert(data.error || 'Failed'); }
    else{ alert('Reservation received. You will get a confirmation email shortly.'); }
  }catch(e){ alert('Network error'); }
  finally{ bookBtn.disabled=false; bookBtn.textContent='Book now'; }
});
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Reservation — RÖSTILAND BY NOXAMA SAMUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    /* Banner */
    .hero-wrap{max-width:1200px;margin:0 auto 14px auto}
    .hero{
      width:100%; height:210px; object-fit:cover; display:block;
      border-radius:12px; box-shadow:0 8px 28px rgba(0,0,0,.18);
      background:#e9dfcf;
    }
    @media (min-width:900px){ .hero{height:240px} }

    /* Guests field + 11+ Button */
    .guest-line{display:flex;align-items:center;gap:10px}
    .guest-line input{max-width:100px}
    .guest-extra{
      font-size:13px;
      background:#b3822f;
      color:#fff;
      border:0;
      border-radius:6px;
      padding:4px 10px;
      cursor:pointer;
      transition:background .2s;
    }
    .guest-extra:hover{background:#8a6626}
    .inline-help{font-size:12px;opacity:.7;margin-top:2px}
  </style>
</head>
<body>
<div class="container">

  <!-- Banner -->
  <div class="hero-wrap">
    <img id="heroImg" class="hero" src="/logo-hero.png" alt="Röstiland"/>
  </div>

  <nav><a class="active" href="/">Reservation</a> <a href="/admin">Admin</a></nav>

  <h1 id="brand">Reservation</h1>
  <p id="venueInfo" class="muted"></p>

  <div class="card">
    <h2>Book a table</h2>
    <div class="row">
      <div><label>Date</label><input id="rDate" type="date"/></div>
      <div><label>Time</label><select id="rTime"></select></div>
      <div>
        <label>Guests</label>
        <div class="guest-line">
          <input id="rGuests" type="number" min="1" max="48" value="2"/>
          <button id="btnGroup" type="button" class="guest-extra">11+ guests</button>
        </div>
        <div class="inline-help">For larger groups please contact us directly.</div>
      </div>
    </div>

    <div class="row">
      <div><label>First name</label><input id="rFirstName" autocomplete="given-name"/></div>
      <div><label>Last name</label><input id="rLastName" autocomplete="family-name"/></div>
    </div>
    <div class="row">
      <div><label>Email</label><input id="rEmail" type="email" autocomplete="email"/></div>
      <div><label>Phone</label><input id="rPhone" type="tel" autocomplete="tel"/></div>
    </div>

    <label>Notes</label><input id="rNotes" placeholder="Optional"/>

    <div class="row">
      <button id="btnReserve" class="btn" type="button">Reserve</button>
      <span id="msg" class="badge"></span>
      <div class="spacer"></div>
      <small class="muted" id="statusText"></small>
    </div>
  </div>
</div>

<!-- Loyalty Modal -->
<div id="loyalty-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;align-items:center;justify-content:center;">
  <div style="background:#fff8f0;border:1px solid #e0d7c5;border-radius:12px;max-width:520px;width:92%;padding:22px;box-shadow:0 10px 35px rgba(0,0,0,.25);text-align:center;">
    <canvas id="fw-canvas" width="480" height="180" style="width:100%;height:180px;display:block;border-radius:10px;margin-bottom:10px;"></canvas>
    <div id="loyalty-text" style="font-family:Georgia,'Times New Roman',serif;color:#3a2f28;font-size:18px;margin:6px 0 12px 0;"></div>
    <button onclick="hideLoyaltyModal()" style="background:#b3822f;color:#fff;border:0;border-radius:8px;padding:10px 16px;font-weight:700;cursor:pointer;">Continue</button>
  </div>
</div>

<script>
  const pad2=n=>String(n).padStart(2,"0");
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };

  const elDate = document.getElementById("rDate"); elDate.value = today();
  const elTime = document.getElementById("rTime");
  const elGuests = document.getElementById("rGuests");
  const elMsg = document.getElementById("msg");
  const elStatus = document.getElementById("statusText");
  const heroImg = document.getElementById("heroImg");

  let CFG = {};

  async function loadConfig(){
    try{
      const r = await fetch("/api/config");
      CFG = await r.json();
      document.getElementById("brand").textContent = `Reservation — ${CFG.brand}`;
      document.getElementById("venueInfo").textContent = `${CFG.address} • ${CFG.phone}`;
      elGuests.max = String(CFG.maxOnlineGuests || 10);
      heroImg.src = CFG.mailHeaderUrl || CFG.mailLogoUrl || "/logo-hero.png";
    }catch{}
  }
  loadConfig();

  async function loadSlots(){
    elTime.innerHTML = "";
    elMsg.textContent = "";
    elStatus.textContent = "Loading slots…";
    try{
      const d = elDate.value || today();
      const g = Number(elGuests.value || 2);
      const r = await fetch(`/api/slots?date=${encodeURIComponent(d)}&guests=${g}`);
      const slots = await r.json();
      let openCount = 0;
      for(const s of slots){
        if(s.allowed){
          const opt = document.createElement("option");
          opt.value = s.time; opt.textContent = s.time;
          elTime.appendChild(opt); openCount++;
        }
      }
      if(openCount===0){
        elStatus.textContent = slots?.[0]?.reason || "No availability";
      }else{
        elStatus.textContent = `Available times: ${openCount}`;
      }
    }catch(err){
      elStatus.textContent = "Failed to load slots";
    }
  }
  elDate.addEventListener("change", loadSlots);
  elGuests.addEventListener("change", loadSlots);
  loadSlots();

  document.getElementById("btnReserve").addEventListener("click", async ()=>{
    elMsg.textContent = "Sending…";
    const payload = {
      date: elDate.value || today(),
      time: elTime.value,
      firstName: document.getElementById("rFirstName").value.trim(),
      name: document.getElementById("rLastName").value.trim(),
      email: document.getElementById("rEmail").value.trim(),
      phone: document.getElementById("rPhone").value.trim(),
      guests: Number(elGuests.value || 0),
      notes: document.getElementById("rNotes").value.trim()
    };
    try{
      const r = await fetch("/api/reservations", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const json = await r.json();
      if(!r.ok){ elMsg.textContent = json.error || "Error"; return; }
      elMsg.textContent = "";
      showToast("Reservation received. You will get a confirmation email shortly. Please also check your spam folder.");
      handleBookingSuccess(json);
      loadSlots();
    }catch(e){
      elMsg.textContent = "Network error";
    }
  });

  // 11+ guests Anfrage
  document.getElementById("btnGroup").addEventListener("click", ()=>{
    const d = elDate.value || today();
    const t = elTime.value || "";
    const to = CFG.email || "info@noxamasamui.com";
    const subject = encodeURIComponent("Group reservation request (11+ guests)");
    const body = encodeURIComponent(
      `Hello Röstiland,\n\nI would like to request a table for a group of 11+ guests.\n\nPreferred date: ${d}\nPreferred time: ${t}\n\nMy details:\nName: ${document.getElementById("rFirstName").value} ${document.getElementById("rLastName").value}\nEmail: ${document.getElementById("rEmail").value}\nPhone: ${document.getElementById("rPhone").value}\nNotes: ${document.getElementById("rNotes").value}\n\nThank you!`
    );
    window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
  });

  function showToast(msg){
    const t = document.createElement("div");
    t.textContent = msg;
    t.style.cssText = "position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#1a1a1a;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.25);z-index:99999;opacity:.98";
    document.body.appendChild(t);
    setTimeout(()=>{ t.style.transition="opacity .4s"; t.style.opacity="0"; setTimeout(()=>t.remove(),400); }, 2600);
  }

  function showLoyaltyModal(tier){
    const txt = document.getElementById('loyalty-text');
    if (tier === 15) txt.textContent = 'Herzlichen Glueckwunsch! Ab sofort erhaeltst du 15 Prozent Loyalty Danke.';
    else if (tier === 10) txt.textContent = 'Herzlichen Glueckwunsch! Ab sofort erhaeltst du 10 Prozent Loyalty Danke.';
    else txt.textContent = 'Herzlichen Glueckwunsch! Ab sofort erhaeltst du 5 Prozent Loyalty Danke.';
    document.getElementById('loyalty-modal').style.display = 'flex';
    startFireworks();
  }
  function hideLoyaltyModal(){ document.getElementById('loyalty-modal').style.display = 'none'; stopFireworks(); }
  let fwTimer=null;
  function startFireworks(){
    const c = document.getElementById('fw-canvas');
    const ctx = c.getContext('2d');
    const W = c.width, H = c.height;
    const particles=[];
    function boom(){ for(let i=0;i<60;i++){ const a=Math.random()*Math.PI*2; const sp=1.5+Math.random()*2.5; particles.push({x:W/2,y:H/2,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:60,color:`hsl(${Math.floor(Math.random()*360)},90%,60%)`}); } }
    function tick(){
      ctx.fillStyle="rgba(255,248,240,.25)"; ctx.fillRect(0,0,W,H);
      for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.02; p.life--; ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,2,0,Math.PI*2); ctx.fill(); if(p.life<=0) particles.splice(i,1); }
      if (Math.random()<0.04) boom();
    }
    boom(); fwTimer=setInterval(tick,16);
  }
  function stopFireworks(){ if(fwTimer){ clearInterval(fwTimer); fwTimer=null; } }
  function handleBookingSuccess(json){
    if (json && (json.nowUnlockedTier===5 || json.nowUnlockedTier===10 || json.nowUnlockedTier===15)){
      showLoyaltyModal(json.nowUnlockedTier);
    }
  }
</script>
</body>
</html>

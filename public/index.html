<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Contact and Table Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/style.css"/>
</head>
  <!-- Success modal -->
<div id="successModal" class="modal hidden">
  <div class="modal-card">
    <h3>Thank you!</h3>
    <p>Your reservation has been received.</p>
    <button id="successOk">OK</button>
  </div>
</div>
<style>
  .modal.hidden { display: none; }
  .modal {
    position: fixed; inset: 0; background: rgba(0,0,0,.45);
    display: grid; place-items: center; z-index: 9999;
  }
  .modal-card {
    width: min(92vw, 420px);
    background: #fff; border-radius: 12px;
    padding: 20px; text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,.18);
  }
  .modal-card h3 { margin: 0 0 8px; font-size: 20px; }
  .modal-card p { margin: 0 0 16px; color: #5a463a; }
  #successOk {
    appearance: none; border: 0; border-radius: 10px;
    background: #b6802a; color: #fff; padding: 10px 16px;
    cursor: pointer; font-weight: 600;
  }
</style>

<body>
<header class="hero">
  <img id="heroLogo" src="/logo-hero.png" alt="RÖSTILAND by NOXAMA SAMUI"/>
</header>

<main class="container">
  <div class="card">
    <h1>Contact and Table Booking</h1>

    <a class="address-link" id="venueAddress" target="_blank" rel="noopener">Address</a>
    <div class="btn-group" style="margin-bottom:12px">
      <a id="venuePhone" class="btn outline" href="#">Phone</a>
      <a id="venueEmail" class="btn outline" href="#">Email</a>
    </div>

    <div class="grid2">
      <div>
        <label class="label">Date</label>
        <input id="date" class="input" type="date"/>
      </div>

      <div>
        <label class="label">Guests (max 10 online)</label>
        <select id="guests" class="input">
          <option value="2">2</option>
          <option value="3">3</option><option value="4">4</option>
          <option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option>
          <option value="9">9</option><option value="10">10</option>
          <option value="11+">11+</option>
        </select>
      </div>
    </div>

    <div id="bigGroupHint" class="badge" style="display:none;margin:10px 0">
      For groups of 11 or more, please <a id="bigPhone" href="#" style="margin:0 6px">call us</a> or
      <a id="bigEmail" href="#">send an email</a>. We’ll arrange a great setup for you.
    </div>

    <h3>Choose a time slot</h3>
    <div id="slots" class="slots"></div>

    <div class="grid2" style="margin-top:12px">
      <div>
        <label class="label">First name*</label>
        <input id="firstName" class="input" placeholder="First name"/>
      </div>
      <div>
        <label class="label">Name*</label>
        <input id="name" class="input" placeholder="Last name"/>
      </div>
      <div>
        <label class="label">Email*</label>
        <input id="email" class="input" type="email" placeholder="you@example.com"/>
      </div>
      <div>
        <label class="label">Phone (optional)</label>
        <input id="phone" class="input" placeholder="+66 000 000 000"/>
      </div>
    </div>

    <label class="label">Notes</label>
    <textarea id="notes" class="input" rows="3" placeholder="Allergies, seating request, occasion"></textarea>

    <div class="actions">
      <button id="bookBtn" class="btn primary">Book now</button>
    </div>
  </div>
</main>

<!-- Simple dialog for fully booked -->
<dialog class="dlg" id="fullDlg">
  <div class="dlg-card">
    <h3>We’re sorry</h3>
    <p>Fully booked at this time. Please select another slot.</p>
    <div class="actions"><button id="fullOk" class="btn primary btn-sm">OK</button></div>
  </div>
</dialog>

<script>
const q = (s)=>document.querySelector(s);
const slotsEl = q('#slots');
const fullDlg = q('#fullDlg'); q('#fullOk').onclick=()=>fullDlg.close();

let activeSlot = null;
let cfg = { phone:"", email:"", mapLink:"#", mailHeaderUrl:null, mailLogoUrl:null };

// Load config (logo / contact)
fetch('/api/config').then(r=>r.json()).then(c=>{
  cfg = Object.assign(cfg, c||{});
  if (c.mailHeaderUrl) q("#heroLogo").src = c.mailHeaderUrl;
  else if (c.mailLogoUrl) q("#heroLogo").src = c.mailLogoUrl;

  const phoneHref = c.venuePhone ? 'tel:'+c.venuePhone.replace(/\s+/g,'') : '#';
  const mailHref  = c.venueEmail ? 'mailto:'+c.venueEmail : '#';
  q('#venuePhone').href = phoneHref;
  q('#venueEmail').href = mailHref;
  q('#venueAddress').href = c.venueMapLink || '#';
  q('#venueAddress').textContent = c.venueAddress || 'Address';

  q('#bigPhone').href = phoneHref;
  q('#bigEmail').href = mailHref;
});

// Date default = today (local)
q('#date').valueAsDate = new Date();

// Guests logic (11+)
q('#guests').addEventListener('change', e=>{
  const show = e.target.value === '11+';
  q('#bigGroupHint').style.display = show ? 'inline-flex' : 'none';
});

// Load slots
async function loadSlots(){
  slotsEl.innerHTML = '';
  activeSlot = null;
  const date = q('#date').value;
  const guests = q('#guests').value === '11+' ? 10 : Number(q('#guests').value);
  const res = await fetch(`/api/slots?date=${encodeURIComponent(date)}&guests=${guests}`);
  const data = await res.json();
  (data || []).forEach(s=>{
    const b = document.createElement('button');
    b.className = 'slot' + (s.disabled ? ' disabled' : '');
    b.textContent = s.time;
    b.disabled = !!s.disabled;
    b.onclick = ()=>{
      if (s.disabled) {
        fullDlg.showModal();
        return;
      }
      document.querySelectorAll('.slot').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); activeSlot = s.time;
    };
    slotsEl.appendChild(b);
  });
}
q('#date').addEventListener('change', loadSlots);
q('#guests').addEventListener('change', loadSlots);
loadSlots();

// Book
q('#bookBtn').addEventListener('click', async ()=>{
  if (q('#guests').value === '11+') {
    // sanft: hinweis statt post
    q('#bigGroupHint').style.display = 'inline-flex';
    window.scrollTo({ top: 0, behavior: 'smooth' });
    return;
  }
  if (!activeSlot){ fullDlg.showModal(); return; }

  const payload = {
    date: q('#date').value,
    time: activeSlot,
    guests: Number(q('#guests').value),
    firstName: q('#firstName').value.trim(),
    name: q('#name').value.trim(),
    email: q('#email').value.trim(),
    phone: q('#phone').value.trim() || null,
    notes: q('#notes').value.trim() || null
  };

  const r = await fetch('/api/book', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  if (r.ok){
    alert('Thank you! Your reservation has been received.');
    location.href = '/';
  } else if (r.status === 409) {
    fullDlg.showModal();
  } else {
    const txt = await r.text();
    alert('Booking failed: '+txt);
  }
});
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Contact and Table Booking</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" href="/logo.png">
  <style>
    :root{
      --bg:#efe6da;
      --card:#f7efe6;
      --ink:#3a2f28;
      --muted:#6b513f;
      --accent:#a6753a;
      --chip:#fff;
      --chipBorder:#e3d2bf;
      --chipDisabled:#ddd2c6;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Georgia,"Times New Roman",serif}
    .wrap{max-width:980px;margin:0 auto;padding:32px 16px}
    header{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:6px}
    header img{width:150px;height:auto;border-radius:10px;display:block}
    h1{font-size:42px;line-height:1.05;margin:10px 0 16px}
    .card{background:var(--card);border:1px solid #e8d8c7;border-radius:14px;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    label{font-weight:700;display:block;margin:8px 0 6px 0}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #d7c6b4;border-radius:10px;background:#fff;font-family:inherit}
    textarea{min-height:64px}
    .time-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:10px}
    .chip{padding:10px 0;border:1px solid var(--chipBorder);border-radius:999px;text-align:center;background:var(--chip);cursor:pointer;user-select:none}
    .chip[disabled]{background:#f0e6da;border-color:var(--chipDisabled);color:#9b8b7a;cursor:not-allowed}
    .chip.selected{background:var(--accent);color:#fff;border-color:var(--accent)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{display:inline-block;padding:10px 14px;background:var(--accent);color:#fff;border:none;border-radius:10px;cursor:pointer}
    .note{color:var(--muted);margin-top:6px}
    @media (max-width:720px){
      .time-grid{grid-template-columns:repeat(3,1fr)}
      h1{font-size:36px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="/logo.png" alt="Logo">
      <h1>Contact and Table Booking</h1>
    </header>

    <section class="card grid" id="contact">
      <div><b>Address</b><br><span id="addr"></span></div>
      <div><b>Phone</b><br><a id="phone" href="#"></a></div>
      <div><b>Email</b><br><a id="email" href="#"></a></div>
    </section>

    <section class="card" id="form">
      <label>Date</label>
      <input type="date" id="date">
      <div class="note">Choose your date first.</div>

      <label style="margin-top:12px">Guests (max 10 online)</label>
      <select id="guests"></select>

      <label style="margin-top:12px">Choose a time slot (15 minutes grid)</label>
      <div id="times" class="time-grid"></div>

      <div class="row" style="margin-top:12px">
        <div>
          <label>First name*</label>
          <input id="firstName" required>
        </div>
        <div>
          <label>Name*</label>
          <input id="name" required>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Email*</label>
          <input id="emailIn" type="email" required>
        </div>
        <div>
          <label>Phone (optional)</label>
          <input id="phoneIn">
        </div>
      </div>
      <div>
        <label>Notes</label>
        <textarea id="notes" placeholder="Allergies, seating request, occasion"></textarea>
      </div>

      <div style="margin-top:14px">
        <button class="btn" id="submit">Book now</button>
      </div>

      <div id="msg" class="note" style="margin-top:10px"></div>
    </section>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const addr = $("#addr"), phone = $("#phone"), mail = $("#email");
    fetch("/api/config").then(r=>r.json()).then(c=>{
      addr.textContent = c.address || "";
      if(c.phone){ phone.href = "tel:"+c.phone; phone.textContent = c.phone; }
      if(c.email){ mail.href = "mailto:"+c.email; mail.textContent = c.email; }
    });

    // guests select 1..10
    const gSel = $("#guests");
    for(let i=1;i<=10;i++){
      const o=document.createElement("option"); o.value=String(i); o.textContent=String(i);
      gSel.appendChild(o);
    }

    const dateIn = $("#date");
    const times = $("#times");
    const msg = $("#msg");
    const today = new Date();
    dateIn.valueAsNumber = Date.UTC(today.getFullYear(), today.getMonth(), today.getDate());
    let selectedTime = "";

    function renderTimes(items){
      times.innerHTML = "";
      selectedTime = "";
      items.forEach(it=>{
        const b = document.createElement("button");
        b.type="button";
        b.textContent = it.time;
        b.className = "chip";
        if(!it.allowed || !it.canReserve){
          b.disabled = true;
          b.title = "Not available";
        }else{
          b.onclick = ()=>{
            [...times.querySelectorAll(".chip")].forEach(x=>x.classList.remove("selected"));
            b.classList.add("selected");
            selectedTime = it.time;
          };
        }
        times.appendChild(b);
      });
    }

    async function loadSlots(){
      msg.textContent = "";
      times.innerHTML = "";
      selectedTime = "";
      const date = dateIn.value;
      const guests = Number(gSel.value||1);
      if(!date) return;
      const q = new URLSearchParams({date, guests:String(guests)});
      const items = await fetch("/api/slots?"+q.toString()).then(r=>r.json());
      renderTimes(items);
      if(items.every(x=>!x.allowed || !x.canReserve)){
        msg.textContent = "No available time slots for "+guests+" guests on this date. Please choose another time or day.";
      }
    }

    dateIn.addEventListener("change", loadSlots);
    gSel.addEventListener("change", loadSlots);
    loadSlots();

    $("#submit").onclick = async ()=>{
      msg.textContent = "";
      const body = {
        date: dateIn.value,
        time: selectedTime,
        firstName: $("#firstName").value.trim(),
        name: $("#name").value.trim(),
        email: $("#emailIn").value.trim(),
        phone: $("#phoneIn").value.trim(),
        guests: Number(gSel.value||1),
        notes: $("#notes").value.trim()
      };
      if(!body.date || !body.time || !body.firstName || !body.name || !body.email){
        msg.textContent = "Please complete all required fields and select a time.";
        return;
      }
      try{
        const r = await fetch("/api/reservations",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify(body)
        });
        const data = await r.json();
        if(!r.ok){ msg.textContent = data?.error || "Error"; return; }
        alert("Your reservation has been received. You will get a confirmation email shortly. Please also check your spam folder.");
        window.scrollTo({top:0,behavior:"smooth"});
      }catch(e){
        msg.textContent = "Unexpected error.";
      }
    };
  </script>
</body>
</html>

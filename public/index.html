<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Contact and Table Booking</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="/favicon.ico">
<link rel="stylesheet" href="/style.css">
</head>
<body class="bg">

<header class="brand-hero">
  <img src="/logo-hero.png" alt="RÃ–STILAND" class="brand-hero__img">
</header>

<main class="container">
  <h1>Contact and Table Booking</h1>

  <!-- Address -->
  <section class="card">
    <h3>Address</h3>
    <p id="addr"></p>
    <div class="btn-row">
      <a id="btnPhone" class="btn">Phone</a>
      <a id="btnMail" class="btn">Email</a>
    </div>
  </section>

  <!-- Booking -->
  <section class="card">
    <div class="grid">
      <label>Date
        <input type="date" id="date">
      </label>

      <label>Guests (max 10 online)
        <select id="guests">
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          <option>6</option><option>7</option><option>8</option><option>9</option><option selected>10</option>
          <option value="11+">11+</option>
        </select>
      </label>
    </div>

    <div>
      <h4>Choose a time slot</h4>
      <div id="slots" class="slot-grid"></div>
      <p id="slotMsg" class="muted"></p>
    </div>

    <div class="grid">
      <label>First name*<input id="firstName" required></label>
      <label>Name*<input id="name" required></label>
      <label class="col-span-2">Email*<input id="email" type="email" required></label>
      <label class="col-span-2">Phone (optional)<input id="phone"></label>
      <label class="col-span-2">Notes<input id="notes" placeholder="Allergies, seating request, occasion"></label>
    </div>

    <button id="book" class="btn btn-primary">Book now</button>
  </section>
</main>

<!-- simple modal -->
<div id="modal" class="modal hidden">
  <div class="modal__card">
    <div id="modalBody"></div>
    <div class="center"><button class="btn" id="modalOk">OK</button></div>
  </div>
</div>

<script>
const cfg = { brand:'', address:'', phone:'', email:'', maxOnlineGuests:10 };
let selectedTime = '';

function showModal(html){
  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modal').classList.remove('hidden');
}
document.getElementById('modalOk').onclick = ()=>document.getElementById('modal').classList.add('hidden');

function esc(s=''){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;');}
function today(){ return new Date().toISOString().slice(0,10); }

async function loadConfig(){
  const c = await fetch('/api/config').then(r=>r.json());
  Object.assign(cfg,c);
  document.getElementById('addr').textContent = cfg.address;
  document.getElementById('btnPhone').href = 'tel:'+cfg.phone.replace(/\s+/g,'');
  document.getElementById('btnMail').href = 'mailto:'+cfg.email;
}

async function loadDayNotice(dateStr){
  const dn = await fetch('/api/daynotice?date='+encodeURIComponent(dateStr)).then(r=>r.json()).catch(()=>null);
  if (dn && dn.message){
    showModal(`<h3>Info ${esc(dateStr)}</h3><p>${esc(dn.message)}</p>`);
  }
}

async function loadSlots(dateStr){
  const guestsSel = document.getElementById('guests') as HTMLSelectElement;
  const gVal = guestsSel.value;
  if (gVal === '11+') return; // keine Online slots anzeigen
  const guests = Number(gVal||'1');

  const wrap = document.getElementById('slots');
  const msg = document.getElementById('slotMsg');
  wrap.innerHTML=''; msg.textContent='';

  const data = await fetch('/api/slots?date='+encodeURIComponent(dateStr)+'&guests='+guests).then(r=>r.json());
  const anyAvailable = data.some(s => s.allowed === true);

  for(const s of data){
    const btn = document.createElement('button');
    btn.textContent = s.time;
    btn.className = 'slot';
    if(!s.allowed){
      btn.disabled = true;
      btn.classList.add('slot-off');
      btn.title = s.reason||'Not available';
    }else{
      btn.onclick = ()=>{
        selectedTime = s.time;
        for(const el of wrap.querySelectorAll('.slot.selected')) el.classList.remove('selected');
        btn.classList.add('selected');
      };
    }
    wrap.appendChild(btn);
  }
  if(!anyAvailable){
    msg.textContent = 'We are fully booked or closed on this date. Please choose another day.';
  }
}

document.getElementById('guests').addEventListener('change', e=>{
  const v = (e.target as HTMLSelectElement).value;
  if(v==='11+'){
    showModal('<h3>Groups of 11+</h3><p>Please contact us directly by phone or email. Thank you!</p>');
    (e.target as HTMLSelectElement).value = '10';
  }else{
    loadSlots((document.getElementById('date') as HTMLInputElement).value);
  }
});

document.getElementById('date').addEventListener('change', async e=>{
  const d = (e.target as HTMLInputElement).value;
  await loadDayNotice(d);
  await loadSlots(d);
});

document.getElementById('book').onclick = async ()=>{
  const date = (document.getElementById('date') as HTMLInputElement).value;
  const guests = Number((document.getElementById('guests') as HTMLSelectElement).value||'1');
  const firstName = (document.getElementById('firstName') as HTMLInputElement).value.trim();
  const name = (document.getElementById('name') as HTMLInputElement).value.trim();
  const email = (document.getElementById('email') as HTMLInputElement).value.trim();
  const phone = (document.getElementById('phone') as HTMLInputElement).value.trim();
  const notes = (document.getElementById('notes') as HTMLInputElement).value.trim();

  if(!date || !selectedTime || !firstName || !name || !email){
    showModal('<p>Please fill all required fields and choose a time slot.</p>');
    return;
  }

  const res = await fetch('/api/reservations', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ date, time:selectedTime, firstName, name, email, phone, guests, notes })
  });
  const j = await res.json().catch(()=>({}));
  if(!res.ok){
    showModal('<p>'+esc(j.error||'Failed to book')+'</p>');
    return;
  }
  showModal('<h3>Reservation received</h3><p>Thank you! You will get a confirmation email shortly. Please check your spam folder.</p>');
  selectedTime='';
  loadSlots(date);
};

(async function init(){
  await loadConfig();
  const d = today();
  (document.getElementById('date') as HTMLInputElement).value = d;
  await loadDayNotice(d);
  await loadSlots(d);
})();
</script>
</body>
</html>

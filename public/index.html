<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Contact and Table Booking</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <div class="container">

    <!-- Brand banner -->
    <div class="brand-banner-wrap">
      <img class="brand-banner" src="https://i.imgur.com/LQ4nzwd.png" alt="RÖSTILAND">
    </div>

    <h1>Contact and Table Booking</h1>

    <!-- Contact card -->
    <div class="card">
      <h2>Address</h2>
      <div class="row">
        <div class="col">
          Moo 4 Lamai Beach, 84310 Suratthani, Thailand
        </div>
        <div class="col">
          <a class="btn btn--ghost" href="tel:+666077270675">Phone</a>
          <a class="btn btn--ghost" href="mailto:info@noxamasamui.com" style="margin-left:10px;">
            info@noxamasamui.com
          </a>
        </div>
      </div>
    </div>

    <!-- Booking form -->
    <form class="card" id="form">
      <div class="row">
        <div class="col">
          <label for="date">Date</label>
          <input id="date" name="date" type="date" required>
        </div>
        <div class="col">
          <label for="guests">Guests (max 10 online)</label>
          <select id="guests" name="guests" required></select>
        </div>
      </div>

      <h2>Choose a time slot</h2>
      <div id="slots-message" class="note note--warn" style="display:none;"></div>
      <div id="slots"></div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label for="firstName">First name*</label>
          <input id="firstName" name="firstName" required>
        </div>
        <div class="col">
          <label for="name">Name*</label>
          <input id="name" name="name" required>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label for="email">Email*</label>
          <input id="email" name="email" type="email" required>
        </div>
        <div class="col">
          <label for="phone">Phone (optional)</label>
          <input id="phone" name="phone">
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label for="notes">Notes</label>
          <textarea id="notes" name="notes" rows="3" placeholder="Allergies, seating request, occasion"></textarea>
        </div>
      </div>

      <div style="margin-top:10px">
        <button class="btn" type="submit">Book now</button>
      </div>
    </form>
  </div>

  <div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>

  <script>
  const dateInput   = document.getElementById('date');
  const guestsSel   = document.getElementById('guests');
  const slotsBox    = document.getElementById('slots');
  const msgEl       = document.getElementById('slots-message');
  const form        = document.getElementById('form');

  // guests 1..10 + call button later
  for(let i=1;i<=10;i++){
    const o=document.createElement('option'); o.value=i; o.textContent=i; guestsSel.appendChild(o);
  }

  // default date = today
  const today = new Date(); today.setHours(0,0,0,0);
  dateInput.value = today.toISOString().slice(0,10);

  let selectedTime = null;

  function showToast(msg, isError=false){
    const el=document.getElementById('toast');
    el.textContent=msg; el.className='toast'+(isError?' toast--error':'');
    el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 3000);
  }

  function slotButton(t){
    const b=document.createElement('button');
    b.type='button'; b.className='slot'; b.textContent=t;
    b.addEventListener('click',()=>{
      selectedTime = t;
      document.querySelectorAll('.slot.selected').forEach(el=>el.classList.remove('selected'));
      b.classList.add('selected');
    });
    return b;
  }

  function renderSlots(items){
    slotsBox.innerHTML='';
    if(items.length){
      items.forEach(i=>slotsBox.appendChild(slotButton(i.time)));
    }
    // 11+ guests call button
    const callBtn=document.createElement('button');
    callBtn.type='button';
    callBtn.className='slot slot--call';
    callBtn.textContent='11+ guests — call us';
    callBtn.onclick=()=>location.href='tel:+666077270675';
    slotsBox.appendChild(callBtn);
  }

  async function loadSlots(){
    selectedTime=null;
    const date = dateInput.value;
    const res  = await fetch(`/api/slots?date=${encodeURIComponent(date)}`);
    const list = await res.json();

    const sundayClosed = list.length && list.every(i => i.reason === 'Closed on Sunday');
    const anyAllowed   = list.some(i => i.allowed);

    if(sundayClosed){
      msgEl.textContent='We’re closed on Sundays.';
      msgEl.style.display='block';
      renderSlots([]);
      return;
    }
    if(!anyAllowed){
      msgEl.textContent='No slots available for this date. Please choose another day.';
      msgEl.style.display='block';
      renderSlots([]);
      return;
    }
    msgEl.style.display='none';
    renderSlots(list.filter(i=>i.allowed));
  }

  dateInput.addEventListener('change', loadSlots);
  guestsSel.addEventListener('change', loadSlots);

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!selectedTime){ showToast('Please select a time slot.', true); return; }

    const payload={
      date: dateInput.value,
      time: selectedTime,
      guests: Number(guestsSel.value),
      firstName: document.getElementById('firstName').value.trim(),
      name: document.getElementById('name').value.trim(),
      email: document.getElementById('email').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      notes: document.getElementById('notes').value.trim()
    };

    try{
      const r = await fetch('/api/reservations',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const j = await r.json();
      if(!r.ok){ showToast(j.error || 'Booking failed', true); return; }
      showToast('Reservation received. A confirmation email is on its way.');
      form.reset(); selectedTime=null; loadSlots();
    }catch(err){
      showToast('Network error', true);
    }
  });

  // init
  loadSlots();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Contact and Table Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
<header class="hero">
  <img id="heroLogo" src="/logo-hero.png" alt="ROESTILAND by NOXAMA SAMUI"/>
</header>

<main class="container">
  <h1>Contact and Table Booking</h1>

  <section class="card">
    <h2>Address</h2>
    <a id="venueAddressLink" class="address-link" target="_blank" rel="noopener noreferrer"
       href="https://maps.google.com/?q=Moo+4+Lamai+Beach,+84310+Suratthani,+Thailand">
      <span id="venueAddressText">Moo 4 Lamai Beach, 84310 Suratthani, Thailand</span>
    </a>
    <div class="flex">
      <a id="phoneBtn" class="btn outline" href="tel:+660000000">Phone</a>
      <a id="emailBtn" class="btn outline" href="mailto:info@noxamasamui.com">Email</a>
    </div>
  </section>

  <section class="card">
    <h2>Date</h2>
    <input id="date" type="date" class="input"/>

    <h2>Guests (max 10 online)</h2>
    <select id="guests" class="input"></select>

    <h2>Choose a time slot</h2>
    <div id="slotsWrap" class="slots"></div>
    <div id="slotInfo" class="muted"></div>
  </section>

  <section class="card">
    <div class="grid2">
      <div><label class="label">First name*</label><input id="firstName" class="input"/></div>
      <div><label class="label">Name*</label><input id="name" class="input"/></div>
    </div>
    <div class="grid2">
      <div><label class="label">Email*</label><input id="email" type="email" class="input"/></div>
      <div><label class="label">Phone (optional)</label><input id="phone" type="tel" class="input"/></div>
    </div>
    <label class="label">Notes</label>
    <textarea id="notes" class="input" rows="3" placeholder="Allergies, seating request, occasion"></textarea>

    <div class="actions">
      <button id="bookBtn" class="btn primary">Book now</button>
    </div>
  </section>
</main>

<!-- Nice dialogs -->
<dialog id="okDlg" class="dlg">
  <div class="dlg-card">
    <h3>Thank you for your booking</h3>
    <p>
      We have received your reservation. You will receive a confirmation email shortly.<br/>
      Please also check your spam folder.
    </p>
    <div class="actions">
      <button id="okDlgBtn" class="btn primary">OK</button>
    </div>
  </div>
</dialog>

<dialog id="infoDlg" class="dlg">
  <div class="dlg-card">
    <h3 id="infoTitle">Information</h3>
    <p id="infoBody"></p>
    <div style="display:flex;align-items:center;gap:8px;margin-top:8px;" id="ackRow" hidden>
      <input type="checkbox" id="ackCb"/><label for="ackCb" class="muted">I have read this notice</label>
    </div>
    <div class="actions">
      <button id="infoOk" class="btn primary">OK</button>
    </div>
  </div>
</dialog>

<dialog id="errorDlg" class="dlg">
  <div class="dlg-card">
    <h3>Weâ€™re sorry</h3>
    <p id="errorText">Something went wrong.</p>
    <div class="actions">
      <button id="errorOk" class="btn primary">OK</button>
    </div>
  </div>
</dialog>

<script>
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
let SELECTED_TIME = "";

function showInfo(title, body, requireAck=false){
  $("#infoTitle").textContent = title || "Information";
  $("#infoBody").innerHTML = body || "";
  const ack = $("#ackRow");
  ack.hidden = !requireAck;
  $("#ackCb").checked = false;
  $("#infoOk").onclick = ()=>{
    if(requireAck && !$("#ackCb").checked) return;
    $("#infoDlg").close();
  };
  $("#infoDlg").showModal();
}
function showError(msg){
  $("#errorText").textContent = msg || "Something went wrong.";
  $("#errorOk").onclick = ()=>$("#errorDlg").close();
  $("#errorDlg").showModal();
}

async function loadConfig(){
  const r = await fetch("/api/config"); const c = await r.json();
  if (c.mailHeaderUrl) $("#heroLogo").src = c.mailHeaderUrl;
  else if (c.mailLogoUrl) $("#heroLogo").src = c.mailLogoUrl;

  $("#venueAddressText").textContent = c.address || "";
  $("#venueAddressLink").href = "https://maps.google.com/?q=" + encodeURIComponent(c.address || "");

  if (c.phone) $("#phoneBtn").href = "tel:" + String(c.phone).replace(/\s+/g,"");
  if (c.email) $("#emailBtn").href = "mailto:" + c.email;

  const gsel = $("#guests"); gsel.innerHTML = "";
  const max = Number(c.maxOnlineGuests || 10);
  for (let i=1;i<=max;i++){ const o=document.createElement("option"); o.value=String(i); o.textContent=String(i); gsel.appendChild(o); }
  gsel.value = "2";
}

async function maybeShowNotices(ymd){
  try{
    const r = await fetch(`/api/notices?date=${encodeURIComponent(ymd)}`);
    const list = await r.json();
    if(Array.isArray(list) && list.length){
      const n = list[0]; // simple: zeige die erste aktive Notice
      showInfo(n.title || "Notice", n.message || "", !!n.requireAck);
    }
  }catch{}
}

async function loadSlots(){
  $("#slotsWrap").innerHTML = ""; $("#slotInfo").textContent = ""; SELECTED_TIME = "";
  const d = $("#date").value; const g = $("#guests").value || "1";
  if (!d) return;

  // Show date-related notices (admin)
  await maybeShowNotices(d);

  const r = await fetch(`/api/slots?date=${encodeURIComponent(d)}&guests=${encodeURIComponent(g)}`);
  const list = await r.json();

  let any = false;
  for (const s of list){
    const b = document.createElement("button");
    b.type="button"; b.className="slot"; b.textContent=s.time;
    if (s.canReserve){
      b.onclick = ()=>{ SELECTED_TIME=s.time; $$(".slot").forEach(x=>x.classList.remove("active")); b.classList.add("active"); };
      any = true;
    } else {
      b.disabled = true; b.classList.add("disabled");
      b.title = s.reason || "Not available";
    }
    $("#slotsWrap").appendChild(b);
  }
  if (!any){
    const hasSunday = list.some(x=>x.reason==="Closed on Sunday");
    if (hasSunday) {
      $("#slotInfo").textContent = "We are closed on Sunday. Please choose another day.";
      showInfo("Closed on Sunday", "We are closed on Sunday. Please choose another day.");
    } else {
      $("#slotInfo").textContent = "We are fully booked for this date. Please choose another day.";
    }
  }
}

async function book(){
  const payload = {
    date: $("#date").value, time: SELECTED_TIME,
    firstName: $("#firstName").value.trim(),
    name: $("#name").value.trim(),
    email: $("#email").value.trim(),
    phone: $("#phone").value.trim(),
    guests: Number($("#guests").value || 1),
    notes: $("#notes").value.trim()
  };
  if (!payload.date || !payload.time || !payload.firstName || !payload.name || !payload.email){
    showError("Please complete all required fields.");
    return;
  }
  try{
    const r = await fetch("/api/reservations", {
      method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)
    });
    if (!r.ok){
      const e = await r.json().catch(()=>({error:"Reservation failed"}));
      showError(e.error || "Reservation failed");
      return;
    }
    $("#okDlg").showModal();
  }catch{
    showError("Network error. Please try again.");
  }
}

document.addEventListener("DOMContentLoaded", async ()=>{
  await loadConfig();
  const today = new Date(); const iso = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;
  $("#date").value = iso;
  await loadSlots();
  $("#date").addEventListener("change", loadSlots);
  $("#guests").addEventListener("change", loadSlots);
  $("#bookBtn").addEventListener("click", book);
  $("#okDlgBtn").addEventListener("click", ()=>$("#okDlg").close());
});
</script>
</body>
</html>

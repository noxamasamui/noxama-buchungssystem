<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <title>Reservation â€” ROSTILAND BY NOXAMA SAMUI</title>
  <link rel="stylesheet" href="/style.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* kleine Styles fuer Modals und Feuerwerk */
    .nox-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      padding: 20px;
    }
    .nox-modal {
      background: #fff8f0;
      color: #3a2f28;
      border-radius: 12px;
      padding: 18px;
      max-width: 720px;
      width: 100%;
      box-shadow: 0 12px 40px rgba(0,0,0,0.25);
      text-align: center;
      border: 1px solid #e0d7c5;
    }
    .nox-modal h3 { margin-top: 0; margin-bottom: 8px; }
    .nox-modal .nox-btn {
      display: inline-block;
      padding: 10px 18px;
      border-radius: 8px;
      background: #b3822f;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    /* Firework / confetti animation simple */
    .nox-fireworks {
      position: relative;
      height: 160px;
      margin-top: 8px;
      overflow: visible;
    }
    .nox-confetti {
      position: absolute;
      bottom: 0;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      opacity: 0;
      animation: nox-confetti-move 1.4s ease-out forwards;
    }
    @keyframes nox-confetti-move {
      0% { transform: translateY(0) scale(0.6); opacity: 1; }
      30% { opacity: 1; }
      100% { transform: translateY(-220px) translateX(var(--tx,0px)) rotate(240deg) scale(1); opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="hero-wrap" style="text-align:center;margin-top:18px;">
    <img id="heroBanner" class="hero-banner" alt="Logo banner" style="max-width:640px;width:76%;border-radius:12px;box-shadow:0 25px 50px rgba(0,0,0,.18);"/>
  </div>

  <div class="container">
    <h1 style="text-align:center;margin-top:8px;">Reservation â€” ROSTILAND BY NOXAMA SAMUI</h1>
    <p style="text-align:center;margin-top:6px;">Moo 4 Lamai Beach, 84310 Suratthani, Thailand â€¢ +66 077 270 675</p>

    <div class="card booking-card booking-compact" style="max-width:760px;margin:18px auto;padding:18px;">
      <h2>Book a table</h2>

      <div class="row date-time">
        <div style="flex:1 1 220px;">
          <label>Date</label>
          <input id="rDate" type="date"/>
        </div>
        <div style="flex:0 0 110px;">
          <label>Guests</label>
          <select id="rGuests">
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
          </select>
        </div>
        <div style="flex:0 0 140px;">
          <label>Time</label>
          <select id="rTime"></select>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>First name</label>
          <input id="rFirst" type="text"/>
        </div>
        <div>
          <label>Last name</label>
          <input id="rLast" type="text"/>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>Email</label>
          <input id="rEmail" type="email"/>
        </div>
        <div>
          <label>Phone</label>
          <input id="rPhone" type="tel"/>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>Notes</label>
        <textarea id="rNotes" rows="2" style="width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #c8b99e;"></textarea>
      </div>

      <div style="margin-top:12px;text-align:left;">
        <button id="btnReserve" class="btn btn-primary-book" type="button">Book</button>
        <span id="rMsg" class="badge" style="margin-left:10px;"></span>
      </div>
    </div>
  </div>

  <!-- Confirmation modal (hidden) -->
  <div id="confirm-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#fff8f0;border-radius:12px;padding:18px;max-width:420px;width:92%;text-align:center;border:1px solid #e0d7c5;">
      <h3 id="confirm-title" style="margin-top:0;">Reservation confirmed</h3>
      <div id="confirm-text" style="margin:8px 0 12px 0;color:#3a2f28;"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="confirm-ok" class="btn" style="min-width:120px;">Continue</button>
      </div>
    </div>
  </div>

<script>
  // helper: today string yyyy-mm-dd
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

  // fill banner from /api/config
  (async()=>{
    try{
      const r = await fetch('/api/config'); const cfg = await r.json();
      const hero = document.getElementById('heroBanner');
      hero.src = cfg.mailHeaderUrl || cfg.mailLogoUrl || '/logo-hero.png';
      hero.alt = cfg.brand || 'Banner';
    }catch(e){ console.error(e); }
  })();

  const dateInput = document.getElementById('rDate');
  const guestsInput = document.getElementById('rGuests');
  const timeSelect = document.getElementById('rTime');
  const reserveBtn = document.getElementById('btnReserve');
  const msgSpan = document.getElementById('rMsg');

  dateInput.value = today();

  // populate initial times as a fallback (will be replaced by server result)
  function fillTimesFallback(){
    timeSelect.innerHTML = '';
    const from = 10*60, to = 22*60, interval = 15;
    for(let m=from;m<=to;m+=interval){
      const hh=String(Math.floor(m/60)).padStart(2,"0");
      const mm=String(m%60).padStart(2,"0");
      const opt=document.createElement("option"); opt.value=`${hh}:${mm}`; opt.textContent=opt.value;
      timeSelect.appendChild(opt);
    }
  }
  fillTimesFallback();

  // generic modal helper
  function showModal(htmlContent, title = "") {
    const ex = document.getElementById("__noxama_modal");
    if (ex) ex.remove();
    const overlay = document.createElement("div");
    overlay.id = "__noxama_modal";
    overlay.className = "nox-modal-overlay";
    overlay.innerHTML = `<div class="nox-modal">
      ${ title ? `<h3>${title}</h3>` : '' }
      <div class="nox-modal-inner">${htmlContent}</div>
      <div style="margin-top:12px;"><button class="nox-btn" id="__noxama_modal_ok">Okay</button></div>
    </div>`;
    document.body.appendChild(overlay);
    const ok = document.getElementById("__noxama_modal_ok");
    ok.addEventListener("click", ()=> overlay.remove());
  }

  // fireworks modal for loyalty
  function showLoyaltyModal(tier){
    // tier is 5 10 or 15
    const title = "You earned a loyalty reward";
    const html = `
      <div style="font-family:Georgia,serif;color:#3a2f28;">
        <div style="font-size:22px;margin-bottom:6px;">ðŸŽ‰ Congratulations â€” loyalty reward unlocked!</div>
        <div style="font-size:16px;margin-bottom:8px;">You just reached a milestone</div>
        <div style="background:#fff3df;padding:14px;border-radius:10px;display:inline-block;margin-bottom:8px;">
          Enjoy a <b style="color:#b3822f;">${tier}%</b> thank-you discount on your next visit
        </div>
        <div style="font-size:13px;color:#555;margin-top:8px;">We applied a note to your profile. Thank you for your loyalty</div>
        <div class="nox-fireworks" id="__nox_fireworks"></div>
      </div>
    `;
    showModal(html, title);

    // start confetti elements
    const container = document.getElementById("__nox_fireworks");
    if(!container) return;
    // create multiple confetti bits with random positions and colors
    const colors = ['#e74c3c','#f1c40f','#2ecc71','#3498db','#9b59b6','#e67e22'];
    for(let i=0;i<18;i++){
      const el = document.createElement("div");
      el.className = "nox-confetti";
      const leftpct = 10 + Math.random()*80; // start x
      el.style.left = leftpct + '%';
      el.style.background = colors[Math.floor(Math.random()*colors.length)];
      // random horizontal travel
      const tx = (Math.random()*180 - 90) + 'px';
      el.style.setProperty('--tx', tx);
      // stagger animation delay
      el.style.animationDelay = (Math.random()*0.35) + 's';
      // scaled size
      const size = 6 + Math.round(Math.random()*10);
      el.style.width = size + 'px'; el.style.height = size + 'px';
      container.appendChild(el);
      // remove after animation
      setTimeout(()=> el.remove(), 1600 + Math.random()*400);
    }
  }

  // update times based on server data. show only allowed and bookable slots
  async function updateTimesFor(date, guests){
    // clear message
    msgSpan.textContent = '';
    timeSelect.innerHTML = '';
    if(!date) { fillTimesFallback(); return; }
    try{
      const resp = await fetch(`/api/slots?date=${encodeURIComponent(date)}&guests=${encodeURIComponent(guests)}`, {cache:"no-store"});
      if(!resp.ok) { fillTimesFallback(); return; }
      const slots = await resp.json();
      if(!Array.isArray(slots) || slots.length === 0){ fillTimesFallback(); return; }

      // filter: only show slots that are allowed and canReserve true
      const showable = slots.filter(s => s.allowed === true && (s.canReserve === true));
      if(showable.length === 0){
        // if no slot available, decide reason and immediately show friendly popup
        // prefer Sunday closed
        const reasons = Array.from(new Set(slots.map(s => (s.reason||"")).filter(Boolean)));
        let reasonText = reasons.find(r => /sunday/i.test(r)) || reasons.find(r => /blocked|closed/i.test(r)) || reasons[0] || "This day is not available";
        const friendly = `
          <div style="font-family:Georgia,serif;color:#3a2f28;">
            <div style="font-size:20px;margin-bottom:8px;">Oh no â€” this day is not available</div>
            <div style="margin-bottom:10px;">${reasonText}</div>
            <div>Please pick another day â€” we would love to welcome you.</div>
          </div>`;
        // remove any options so user cannot pick a non available time
        timeSelect.innerHTML = '';
        showModal(friendly, "Reservation not possible");
        return;
      }

      // populate times. Do not show leftover numbers, only time text
      showable.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.time;
        opt.textContent = s.time; // only time
        timeSelect.appendChild(opt);
      });

      // if a previously selected time is not in new list, select first
      if(!Array.from(timeSelect.options).some(o=>o.value === timeSelect.value)){
        timeSelect.selectedIndex = 0;
      }

    }catch(e){
      console.error("updateTimesFor error", e);
      fillTimesFallback();
    }
  }

  // listeners: date and guests
  dateInput.addEventListener('change', ()=> updateTimesFor(dateInput.value, guestsInput.value));
  guestsInput.addEventListener('change', ()=> updateTimesFor(dateInput.value, guestsInput.value));

  // initial update
  updateTimesFor(dateInput.value, guestsInput.value);

  // reservation submit
  reserveBtn.addEventListener('click', async ()=>{
    msgSpan.textContent = '';
    const payload = {
      date: dateInput.value || today(),
      time: timeSelect.value,
      firstName: (document.getElementById('rFirst').value || "").trim(),
      name: (document.getElementById('rLast').value || "").trim(),
      email: (document.getElementById('rEmail').value || "").trim(),
      phone: (document.getElementById('rPhone').value || "").trim(),
      guests: Number(guestsInput.value || 1),
      notes: (document.getElementById('rNotes').value || "").trim()
    };

    if(!payload.firstName || !payload.name || !payload.email || !payload.guests){
      msgSpan.textContent = 'Please fill first name, last name, email and guests';
      return;
    }

    try{
      const r = await fetch('/api/reservations', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const json = await r.json().catch(()=>({}));

      if(r.ok){
        // if loyalty unlocked, show loyalty modal with fireworks first
        if(json && (json.nowUnlockedTier === 5 || json.nowUnlockedTier === 10 || json.nowUnlockedTier === 15)){
          showLoyaltyModal(json.nowUnlockedTier);
          // after short delay show confirm modal
          setTimeout(()=> {
            document.getElementById('confirm-title').textContent = 'Reservation received';
            document.getElementById('confirm-text').innerHTML = `Thank you! Your reservation is confirmed. A confirmation mail will be sent to <b>${payload.email}</b>. Please also check your spam folder.`;
            document.getElementById('confirm-ok').onclick = ()=>{ hideConfirmModal(); window.location.href = '/'; };
            showConfirmModal();
          }, 1400);
        } else {
          // normal flow
          document.getElementById('confirm-title').textContent = 'Reservation received';
          document.getElementById('confirm-text').innerHTML = `Thank you! Your reservation is confirmed. A confirmation mail will be sent to <b>${payload.email}</b>. Please also check your spam folder.`;
          document.getElementById('confirm-ok').onclick = ()=>{ hideConfirmModal(); window.location.href = '/'; };
          showConfirmModal();
        }
      } else {
        const err = (json && json.error) ? json.error : "Failed to create reservation";
        // if server says closed / blocked / sunday -> show friendly popup now
        if(err.toLowerCase().includes("sunday") || err.toLowerCase().includes("closed") || err.toLowerCase().includes("blocked") || err.toLowerCase().includes("fully booked")){
          let friendly = "This slot is not available. Please choose another day or time.";
          if(err.toLowerCase().includes("sunday")) friendly = "We are closed on Sundays. Please choose another day.";
          else if(err.toLowerCase().includes("blocked") || err.toLowerCase().includes("closed")) friendly = "This date is blocked or closed. Please pick another day.";
          else if(err.toLowerCase().includes("fully booked")) friendly = "This slot is fully booked. Please choose another time or day.";
          showModal(`<div style="font-family:Georgia,serif;color:#3a2f28;">${friendly}</div>`, "Not available");
          // refresh times so user sees current availability
          updateTimesFor(dateInput.value, guestsInput.value);
        } else {
          msgSpan.textContent = err || 'Error saving reservation';
        }
      }
    }catch(e){
      console.error('reservation post error', e);
      msgSpan.textContent = 'Network error';
    }
  });

  function showConfirmModal(){
    const m = document.getElementById('confirm-modal');
    m.style.display = 'flex';
  }
  function hideConfirmModal(){
    const m = document.getElementById('confirm-modal');
    m.style.display = 'none';
  }

  // close confirm modal ok
  document.getElementById('confirm-ok').addEventListener('click', hideConfirmModal);

</script>
</body>
</html>

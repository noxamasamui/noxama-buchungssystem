<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Contact and Table Booking</title>
<link rel="stylesheet" href="/style.css"/>
<link rel="icon" href="/logo.png"/>
</head>
  <div id="noticeModal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999">
  <div style="background:#fff;max-width:560px;width:92%;border-radius:12px;padding:16px">
    <h3 id="noticeTitle" style="margin:0 0 8px">Important information</h3>
    <div id="noticeText" style="white-space:pre-wrap"></div>
    <div id="noticeAckWrap" style="margin:10px 0;display:none">
      <label><input type="checkbox" id="noticeAck"/> I have read and agree</label>
    </div>
    <div style="text-align:right;margin-top:10px">
      <button id="noticeClose" style="background:#b6802a;color:#fff;border:none;border-radius:10px;padding:8px 12px">OK</button>
    </div>
  </div>
</div>
<body>
  <div class="container">
    <div class="header"><img class="logo" src="/logo.png" alt="Röstiland"/></div>

    <div class="toolbar">
      <a class="btn-ghost" href="tel:+66800000000">Phone</a>
      <a class="btn-ghost" href="mailto:info@noxamasamui.com">Email</a>
    </div>

    <h1>Contact and Table Booking</h1>
    <div class="sub">Moo 4 Lamai Beach, 84310 Suratthani, Thailand</div>

    <div class="card">
      <div class="row">
        <div>
          <label>Date</label>
          <input id="date" type="date"/>
        </div>
        <div>
          <label>Guests (max 10 online)</label>
          <select id="guests"></select>
        </div>
      </div>

      <label class="full" style="margin-top:10px">Choose a time slot</label>
      <div id="slots" class="slot-grid" aria-live="polite"></div>

      <div class="row full" style="margin-top:12px">
        <div>
          <label>First name*</label>
          <input id="firstName" type="text" placeholder="First name"/>
        </div>
        <div>
          <label>Name*</label>
          <input id="name" type="text" placeholder="Name"/>
        </div>
      </div>

      <div class="row full">
        <div>
          <label>Email*</label>
          <input id="email" type="email" placeholder="you@email.com"/>
        </div>
        <div>
          <label>Phone (optional)</label>
          <input id="phone" type="tel" placeholder=""/>
        </div>
      </div>

      <div class="full">
        <label>Notes</label>
        <textarea id="notes" placeholder="Allergies, seating request, occasion"></textarea>
      </div>

      <div style="display:flex;justify-content:flex-end;margin-top:14px">
        <button id="book" class="btn">Book now</button>
      </div>

      <div class="notice" style="margin-top:10px">
        11+ guests? Please <a href="tel:+66800000000">call us</a> or <a href="mailto:info@noxamasamui.com">send an email</a>.
      </div>
    </div>

    <div class="footer">Moo 4 Lamai Beach, 84310 Suratthani, Thailand</div>
  </div>

  <div id="toast" class="toast" style="display:none">
    <div>
      <h3 id="toastTitle">Thank you!</h3>
      <p id="toastText">Your reservation has been received.</p>
      <button id="toastBtn" class="btn">OK</button>
    </div>
  </div>

<script>
  <script>
  const elModal = document.getElementById("noticeModal");
  const elAck = document.getElementById("noticeAck");
  const elAckWrap = document.getElementById("noticeAckWrap");
  const elClose = document.getElementById("noticeClose");
  const elText = document.getElementById("noticeText");

  let currentNotice = null;
  let ackRequired = false;
  let ackGranted = false;

  async function checkNoticeFor(dateYmd){
    currentNotice = await fetch(`/api/notice?date=${dateYmd}`).then(r=>r.json()).catch(()=>null);
    ackRequired = !!(currentNotice && currentNotice.requireAck);
    ackGranted = !ackRequired;
    updateBookButton();
    if(currentNotice){
      elText.textContent = currentNotice.message;
      elAck.checked = false;
      elAckWrap.style.display = currentNotice.requireAck ? "block":"none";
      elModal.style.display = "flex";
    }
  }

  elClose.addEventListener("click", ()=>{
    if(ackRequired && !elAck.checked){
      alert("Please confirm with the checkbox first.");
      return;
    }
    ackGranted = ackRequired ? elAck.checked : true;
    elModal.style.display = "none";
    updateBookButton();
  });
  elAck.addEventListener("change", ()=>{ if(ackRequired){ ackGranted = elAck.checked; updateBookButton(); } });

  function updateBookButton(){
    const btn = document.getElementById("bookBtn") || document.querySelector('button[type="submit"]');
    if(!btn) return;
    btn.disabled = !ackGranted;
  }

  // rufe checkNoticeFor(date) auf, wenn das Datum geändert wird
  const dateInput = document.querySelector('input[type="date"]#date') || document.querySelector('input[name="date"]');
  if(dateInput){
    dateInput.addEventListener("change", ()=>{
      const d = dateInput.value;
      if(/^\d{4}-\d{2}-\d{2}$/.test(d)) checkNoticeFor(d);
    });
    // initial
    if(dateInput.value && /^\d{4}-\d{2}-\d{2}$/.test(dateInput.value)) checkNoticeFor(dateInput.value);
  }

  // Beim Absenden ack mitsenden
  const form = document.querySelector("form");
  if(form){
    form.addEventListener("submit", (e)=>{
      if(!ackGranted){
        e.preventDefault();
        alert("Please confirm the special information first.");
      }
    }, true);
  }
</script>

const $ = sel => document.querySelector(sel);
const T = (id, html) => { const el = document.createElement('div'); el.innerHTML = html; return el.firstElementChild; };

const params = new URLSearchParams(location.search);
const todayISO = new Date().toISOString().slice(0,10);
$("#date").value = params.get("date") || todayISO;

const guestsSel = $("#guests");
for (let i=1;i<=10;i++){ const o=document.createElement("option"); o.value=String(i); o.textContent=String(i); guestsSel.appendChild(o); }
const plus = document.createElement("option"); plus.value="11+"; plus.textContent="11+"; guestsSel.appendChild(plus);
guestsSel.value = params.get("guests") || "2";
guestsSel.addEventListener("change", () => {
  if (guestsSel.value === "11+") {
    showToast("Groups",
      'For 11+ guests please call us or write an email.<br><br><a class="btn" href="tel:+66800000000">Call</a> &nbsp; <a class="btn" href="mailto:info@noxamasamui.com">Email</a>',
      "Close",
      false
    );
    guestsSel.value = "10";
  }
});

let selectedTime = params.get("time") || "";
const slotsEl = $("#slots");

async function loadSlots(){
  const date = $("#date").value;
  const guests = Number($("#guests").value || 2);
  const res = await fetch(`/api/slots?date=${encodeURIComponent(date)}&guests=${guests}`);
  const list = await res.json();

  slotsEl.innerHTML = "";
  list.forEach(s=>{
    const b = T("div", `<button type="button" class="slot ${s.disabled?'disabled':''}" data-time="${s.time}">${s.time}</button>`);
    if (s.time===selectedTime) b.classList.add("active");
    b.addEventListener("click", ()=> {
      [...slotsEl.querySelectorAll(".slot")].forEach(x=>x.classList.remove("active"));
      b.classList.add("active"); selectedTime = s.time;
    });
    slotsEl.appendChild(b);
  });
}
$("#date").addEventListener("change", loadSlots);
$("#guests").addEventListener("change", loadSlots);
loadSlots();

function showToast(title, text, btnText="OK", autoRedirect=true, loyalty=null){
  $("#toastTitle").innerHTML = title;
  $("#toastText").innerHTML = text;
  $("#toast").style.display="flex";
  $("#toastBtn").textContent = btnText;
  $("#toastBtn").onclick = () => {
    $("#toast").style.display="none";
    if(autoRedirect) location.href = "https://noxamasamui.com";
  };
  // Mini Konfetti bei Loyalty-Stufen
  if (loyalty && (loyalty.level===5 || loyalty.level===10 || loyalty.level===15)) {
    try{ import('https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.module.mjs')
      .then(m=>m.default({particleCount:200,spread:120,origin:{y:.6}})); }catch{}
  }
}

$("#book").addEventListener("click", async ()=>{
  const date = $("#date").value;
  const body = {
    date,
    time: selectedTime,
    guests: Number($("#guests").value||2),
    firstName: $("#firstName").value.trim(),
    name: $("#name").value.trim(),
    email: $("#email").value.trim(),
    phone: $("#phone").value.trim(),
    notes: $("#notes").value.trim()
  };
  if(!body.date || !body.time || !body.firstName || !body.name || !body.email){
    showToast("Missing data","Please fill date, time, first name, name and email.","OK", false); return;
  }
  const res = await fetch("/api/book",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  const j = await res.json().catch(()=>({}));
  if(j && j.ok){
    const L = j.loyalty || null;
    if(L && L.level>0){
      showToast("Thank you for your loyalty!",
        `You now enjoy a <b>${L.level}% Loyalty Discount</b> for this and all future visits.`,
        "Great!", true, L);
    }else if(L && L.nextAt){
      showToast("Thank you!","After <b>"+L.nextAt+"</b> bookings you’ll enjoy a loyalty discount.","OK");
    }else{
      showToast("Thank you!","Your reservation has been received.","OK");
    }
  }else{
    showToast("Error", (j && j.error) ? j.error : "Unknown error","Close", false);
  }
});

// Prefill from query
if (params.get("firstName")) $("#firstName").value = params.get("firstName");
if (params.get("name")) $("#name").value = params.get("name");
if (params.get("email")) $("#email").value = params.get("email");
if (params.get("phone")) $("#phone").value = params.get("phone");
if (params.get("notes")) $("#notes").value = decodeURIComponent(params.get("notes"));
</script>
</body>
</html>

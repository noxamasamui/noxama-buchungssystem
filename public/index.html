<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <title>Reservation â€” ROESTILAND BY NOXAMA SAMUI</title>
  <link rel="stylesheet" href="/style.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* retained theme + small adjustments */
    body { background:#d9c8b0; font-family: Georgia, "Times New Roman", serif; color:#3a2f28; margin:0; }
    .hero-wrap { text-align:center; margin-top:18px; }
    .hero-banner { max-width:640px; width:76%; border-radius:12px; box-shadow:0 25px 50px rgba(0,0,0,.18); }

    .container { max-width:980px; margin:18px auto; padding:0 14px; }
    .card { background: linear-gradient(180deg,#fffaf6,#fff3e8); border-radius:10px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,0.12); border:1px solid rgba(200,170,130,0.16); }
    h1,h2 { margin:0 0 8px 0; text-align:center; }
    label { font-weight:600; display:block; margin-bottom:6px; }
    input, select, textarea { width:100%; box-sizing:border-box; padding:10px; border-radius:8px; border:1px solid #d9c2a8; background:#fff; }
    .row { display:flex; gap:12px; align-items:center; }
    .date-time .row > div { flex:1; }
    .form-grid-2 .row > div { flex:1; }
    .btn { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; background:#b3822f; color:#fff; font-weight:700; }
    .btn-primary-book { background:#b3822f; box-shadow:0 4px 10px rgba(0,0,0,.12); }

    .badge { display:inline-block; background:#fff3df; padding:6px 10px; border-radius:8px; border:1px solid #ead6b6; color:#3a2f28; }

    /* loyalty modal + fireworks (your example adapted) */
    #loyalty-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 9999; align-items: center; justify-content: center; }
    #loyalty-modal > div { background: #fff8f0; border: 1px solid #e0d7c5; border-radius: 12px; max-width: 520px; width: 92%; padding: 18px; box-shadow: 0 10px 35px rgba(0,0,0,0.25); text-align: center; animation: fadein .18s ease both; }
    #fw-canvas { width: 100%; height: 160px; display: block; border-radius: 10px; margin-bottom: 10px; background: linear-gradient(180deg,#fff,#fff8f2); box-shadow: inset 0 -6px 12px rgba(0,0,0,0.03); }

    /* small utilities */
    .hidden { display: none !important; }
    .text-center { text-align: center; }

    /* images */
    img { max-width: 100%; height: auto; display: block; }

    /* subtle animation */
    @keyframes fadein { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width:520px){ #fw-canvas { height:120px; } }
  </style>
</head>
<body>
  <div class="hero-wrap">
    <img id="heroBanner" class="hero-banner" alt="Logo banner" />
  </div>

  <div class="container">
    <h1 style="text-align:center;margin-top:8px;">Reservation â€” ROESTILAND BY NOXAMA SAMUI</h1>
    <p style="text-align:center;margin-top:6px;">
      Moo 4 Lamai Beach, 84310 Suratthani, Thailand â€¢ +66 077 270 675
    </p>

    <div class="card booking-card booking-compact" style="max-width:760px;margin:18px auto;padding:18px;">
      <h2>Book a table</h2>

      <div class="row date-time" style="margin-top:12px;">
        <div style="flex:1 1 220px;">
          <label for="rDate">Date</label>
          <input id="rDate" type="date"/>
        </div>
        <div style="flex:0 0 110px;">
          <label for="rGuests">Guests</label>
          <select id="rGuests">
            <!-- extended options up to 20, but 11+ triggers contact modal -->
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
            <option>11</option><option>12</option><option>13</option><option>14</option><option>15</option>
            <option>16</option><option>17</option><option>18</option><option>19</option><option>20</option>
          </select>
        </div>
        <div style="flex:0 0 140px;">
          <label for="rTime">Time</label>
          <select id="rTime"></select>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:12px;">
        <div>
          <label for="rFirst">First name</label>
          <input id="rFirst" type="text"/>
        </div>
        <div>
          <label for="rLast">Last name</label>
          <input id="rLast" type="text"/>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:12px;">
        <div>
          <label for="rEmail">Email</label>
          <input id="rEmail" type="email"/>
        </div>
        <div>
          <label for="rPhone">Phone</label>
          <input id="rPhone" type="tel"/>
        </div>
      </div>

      <div style="margin-top:12px;">
        <label for="rNotes">Notes</label>
        <textarea id="rNotes" rows="2" style="width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #c8b99e;"></textarea>
      </div>

      <div style="margin-top:12px;text-align:left;">
        <button id="btnReserve" class="btn btn-primary-book" type="button">Book</button>
        <span id="rMsg" class="badge" style="margin-left:10px;"></span>
      </div>
    </div>
  </div>

  <!-- confirmation modal -->
  <div id="confirm-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#fff8f0;border-radius:12px;padding:18px;max-width:420px;width:92%;text-align:center;border:1px solid #e0d7c5;">
      <h3 id="confirm-title" style="margin-top:0;">Reservation confirmed</h3>
      <div id="confirm-text" style="margin:8px 0 12px 0;color:#3a2f28;"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="confirm-ok" class="btn" style="min-width:120px;">Continue</button>
      </div>
    </div>
  </div>

  <!-- loyalty modal (white panel + canvas) -->
  <div id="loyalty-modal" aria-hidden="true">
    <div role="dialog" aria-modal="true">
      <canvas id="fw-canvas" width="800" height="160"></canvas>
      <div style="text-align:center;">
        <h3 style="margin:6px 0 4px 0;color:#3a2f28;">You earned a loyalty reward</h3>
        <div id="loyalty-sub" style="font-family:Georgia,serif;color:#3a2f28;margin-bottom:8px;">ðŸŽ‰ Congratulations â€” loyalty reward unlocked!</div>
        <div id="loyalty-visit" style="margin-bottom:10px;color:#3a2f28;"></div>
        <div class="loyalty-reward" style="display:inline-block;background: linear-gradient(180deg,#f7dfc7,#e8caa0); color:#5a3610; padding:12px 18px; border-radius:10px; font-weight:700;"></div>
        <div style="margin-top:12px;"><button id="loyalty-ok" class="btn" style="min-width:120px;margin-top:8px;">Okay</button></div>
      </div>
    </div>
  </div>

  <!-- contact modal for 11+ guests -->
  <div id="contact-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#fff8f0;border-radius:12px;padding:18px;max-width:520px;width:92%;text-align:center;border:1px solid #e0d7c5;">
      <h3 style="margin-top:0;color:#3a2f28;">For large groups, please contact us</h3>
      <p style="color:#3a2f28;">For reservations of 11 or more guests we kindly ask you to call or email so we can assist with seating and special requests.</p>
      <p style="margin-top:10px;">
        <a id="tel-link" href="tel:+66077270675" style="display:inline-block;margin-right:8px;padding:10px 14px;border-radius:8px;background:#b3822f;color:#fff;text-decoration:none;">Call +66 077 270 675</a>
        <a id="mail-link" href="mailto:info@noxamasamui.com" style="display:inline-block;margin-left:8px;padding:10px 14px;border-radius:8px;background:#8b6a36;color:#fff;text-decoration:none;">Email info@noxamasamui.com</a>
      </p>
      <div style="margin-top:12px;"><button id="contact-ok" class="btn" style="min-width:120px;">Close</button></div>
    </div>
  </div>

<script>
/* small helpers */
const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };
const BOOKING_BG = '#d9c8b0';

(async()=>{
  try {
    const r = await fetch('/api/config', {cache:"no-store"});
    if(!r.ok) return;
    const cfg = await r.json();
    const hero = document.getElementById('heroBanner');
    hero.src = cfg.mailHeaderUrl && cfg.mailHeaderUrl.trim() ? cfg.mailHeaderUrl : (cfg.mailLogoUrl && cfg.mailLogoUrl.trim() ? cfg.mailLogoUrl : '/logo-hero.png');
    hero.alt = cfg.brand || 'Banner';
  } catch(e){ console.error("cfg", e); }
})();

document.getElementById('rDate').value = today();

/* update times: request /api/slots and only list allowed times
   if none allowed => inspect reasons and show immediate modal
   if guests >=11 => show contact modal and don't load times
*/
async function updateTimes(){
  const date = document.getElementById('rDate').value;
  const guests = Number(document.getElementById('rGuests').value || 1);
  const sel = document.getElementById('rTime');
  sel.innerHTML = '';

  // 11+ guests -> contact modal
  if(guests >= 11){
    showContactModal();
    return;
  } else {
    hideContactModal();
  }

  if(!date) return;

  try {
    const res = await fetch(`/api/slots?date=${encodeURIComponent(date)}&guests=${encodeURIComponent(guests)}`, {cache:"no-store"});
    if(!res.ok){
      fillFallbackTimes(sel);
      return;
    }
    const slots = await res.json();
    if(!Array.isArray(slots)){
      fillFallbackTimes(sel);
      return;
    }

    const allowed = slots.filter(s => s.allowed === true);
    if(allowed.length === 0){
      // gather reasons
      const reasons = Array.from(new Set(slots.map(s => (s.reason||"")).filter(Boolean)));
      const sunday = reasons.find(r => /sunday/i.test(r));
      const blocked = reasons.find(r => /blocked|closed/i.test(r));
      const reasonText = sunday || blocked || reasons[0] || "This date is not available";
      showSimpleModal("Reservation not possible", `
        <div style="font-family:Georgia,serif;color:#3a2f28;">
          <div style="font-size:20px;margin-bottom:8px;">Oh no â€” this day is not available</div>
          <div style="margin-bottom:10px;">${escapeHtml(reasonText)}</div>
          <div>Please choose another date â€” we would love to welcome you.</div>
        </div>
      `);
      return;
    }

    // populate only allowed times (do not show remaining counts)
    for(const s of allowed){
      const opt = document.createElement('option');
      opt.value = s.time;
      opt.textContent = s.time;
      sel.appendChild(opt);
    }

    if(!sel.options.length) fillFallbackTimes(sel);
  } catch(e){
    console.error("updateTimes", e);
    fillFallbackTimes(sel);
  }
}

function fillFallbackTimes(sel){
  sel.innerHTML = '';
  const from = 10*60, to = 22*60, interval = 15;
  for(let m=from;m<to;m+=interval){
    const hh = String(Math.floor(m/60)).padStart(2,"0");
    const mm = String(m%60).padStart(2,"0");
    const o = document.createElement('option'); o.value = `${hh}:${mm}`; o.textContent = `${hh}:${mm}`; sel.appendChild(o);
  }
}

/* immediate refresh when user changes date or guests */
document.getElementById('rDate').addEventListener('change', ()=> updateTimes());
document.getElementById('rGuests').addEventListener('change', ()=> updateTimes());
updateTimes();

/* reserve button: posts to /api/reservations, shows loyalty modal for tier 5/10/15 */
document.getElementById('btnReserve').addEventListener('click', async ()=>{
  const guests = Number(document.getElementById('rGuests').value || 1);
  if(guests >= 11){
    // block booking and show contact
    showContactModal();
    return;
  }

  const payload = {
    date: document.getElementById('rDate').value,
    time: document.getElementById('rTime').value,
    firstName: (document.getElementById('rFirst').value || '').trim(),
    name: (document.getElementById('rLast').value || '').trim(),
    email: (document.getElementById('rEmail').value || '').trim(),
    phone: (document.getElementById('rPhone').value || '').trim(),
    guests: guests,
    notes: (document.getElementById('rNotes').value || '').trim()
  };

  const rMsg = document.getElementById('rMsg');
  rMsg.textContent = '';

  // minimal client validation
  if(!payload.firstName || !payload.name || !payload.email || !payload.guests){
    rMsg.textContent = 'Please fill first name, last name, email and guests';
    return;
  }

  try {
    const res = await fetch('/api/reservations', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const json = await res.json().catch(()=>({}));

    if(res.ok){
      const visitNo = Number(json.visitNo || json.visit || 0);
      let tier = 0;
      if(visitNo >= 15) tier = 15;
      else if(visitNo >= 10) tier = 10;
      else if(visitNo >= 5) tier = 5;

      if(tier > 0){
        // show loyalty, then confirmation
        showLoyaltyModal(tier, visitNo);
        setTimeout(()=> showConfirmModal("Reservation received", `Thank you! Your reservation is confirmed. A confirmation mail will be sent to <b>${escapeHtml(payload.email)}</b>.`, true), 1300);
      } else {
        showConfirmModal("Reservation received", `Thank you! Your reservation is confirmed. A confirmation mail will be sent to <b>${escapeHtml(payload.email)}</b>.`, true);
      }
    } else {
      const err = (json && json.error) ? String(json.error).toLowerCase() : '';
      if(err.includes("sunday") || err.includes("closed") || err.includes("blocked") || err.includes("fully booked")){
        showSimpleModal("Reservation not possible", `
          <div style="font-family:Georgia,serif;color:#3a2f28;">
            <div style="font-size:20px;margin-bottom:8px;">This day is not available</div>
            <div style="margin-bottom:10px;">${escapeHtml(String(json.error || "This date is not available"))}</div>
            <div>Please choose another date â€” we would love to welcome you.</div>
          </div>
        `);
        updateTimes();
      } else {
        rMsg.textContent = json.error || 'Error saving reservation';
      }
    }
  } catch(e){
    console.error("post reservation", e);
    document.getElementById('rMsg').textContent = 'Network error';
  }
});

/* simple confirmation modal helpers */
function showConfirmModal(title, html, redirectAfterOk=false){
  const cm = document.getElementById('confirm-modal');
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-text').innerHTML = html;
  cm.style.display = 'flex';
  document.getElementById('confirm-ok').onclick = ()=> {
    cm.style.display = 'none';
    if(redirectAfterOk) window.location.href = '/';
  };
}
function hideConfirmModal(){ document.getElementById('confirm-modal').style.display = 'none'; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" })[c]); }

/* simple message modal */
function showSimpleModal(title, innerHtml){
  const id = '__simple_modal';
  const ex = document.getElementById(id); if(ex) ex.remove();
  const overlay = document.createElement('div'); overlay.id = id;
  overlay.style = 'position:fixed;inset:0;background:rgba(6,4,3,0.65);display:flex;align-items:center;justify-content:center;z-index:99998;';
  const panel = document.createElement('div');
  panel.style = 'background:#fff8f0;border-radius:12px;padding:18px;max-width:520px;width:92%;text-align:center;border:1px solid #e0d7c5;';
  panel.innerHTML = `<div style="text-align:left;">${innerHtml}</div><div style="text-align:center;margin-top:12px;"><button id="__simple_ok" class="btn" style="min-width:120px;">Okay</button></div>`;
  overlay.appendChild(panel);
  document.body.appendChild(overlay);
  panel.querySelector('#__simple_ok').onclick = ()=> overlay.remove();
}

/* contact modal controls */
function showContactModal(){
  document.getElementById('contact-modal').style.display = 'flex';
}
function hideContactModal(){
  document.getElementById('contact-modal').style.display = 'none';
}
document.getElementById('contact-ok').addEventListener('click', hideContactModal);

/* LOYALTY Modal + Fireworks (canvas-based) */
function showLoyaltyModal(tier, visitNo){
  const modal = document.getElementById('loyalty-modal');
  document.getElementById('loyalty-visit').textContent = `You just reached visit ${visitNo}`;
  const reward = modal.querySelector('.loyalty-reward');
  reward.textContent = `Enjoy a ${tier}% thank-you discount on your next visit`;
  modal.style.display = 'flex';
  // start canvas fireworks
  const canvas = document.getElementById('fw-canvas');
  if(canvas) startCanvasFireworks(canvas);
  // ok button closes modal
  document.getElementById('loyalty-ok').onclick = ()=> {
    modal.style.display = 'none';
    // clear canvas (stop)
    if(canvas && canvas.getContext) {
      const ctx = canvas.getContext('2d'); ctx && ctx.clearRect(0,0,canvas.width,canvas.height);
    }
  };
}

/* Fireworks engine adjusted for canvas element (richer, denser)
   Works on the <canvas id="fw-canvas"> element */
function startCanvasFireworks(canvas){
  if(!canvas) return;
  // size canvas to displayed size (devicePixelRatio aware)
  function fit(){
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.max(300, Math.floor(rect.width * dpr));
    canvas.height = Math.max(120, Math.floor(rect.height * dpr));
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';
  }
  fit();
  window.addEventListener('resize', fit);
  const ctx = canvas.getContext('2d');
  if(!ctx) return;

  const colors = [
    '#ff3b30','#ff6b6b','#ff9500','#ffb74d','#ffd54f',
    '#8bc34a','#4caf50','#00b894','#00bcd4','#3498db',
    '#7e57c2','#9c27b0','#e91e63','#ff4081','#f06292',
    '#ffd180','#ffd699', '#c9a24a', '#ffd700'
  ];

  // particle arrays
  const parts = [];
  let last = performance.now();
  let running = true;

  class P {
    constructor(x,y,vx,vy,r,color,life,type){
      this.x = x; this.y = y; this.vx = vx; this.vy = vy;
      this.r = r; this.color = color; this.life = life; this.age = 0; this.type = type || 'p';
    }
    update(dt){
      this.vy += 0.06 * dt;
      this.x += this.vx * dt;
      this.y += this.vy * dt;
      this.age += dt*16;
    }
    draw(ctx){
      const a = Math.max(0, 1 - this.age/this.life);
      ctx.globalAlpha = a;
      if(this.type === 'p'){
        ctx.fillStyle = this.color;
        ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); ctx.fill();
      } else {
        ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.age/20); ctx.fillStyle = this.color; ctx.fillRect(-this.r/2,-this.r/2,this.r,this.r); ctx.restore();
      }
      ctx.globalAlpha = 1;
    }
  }

  function burst(x,y,scale=1){
    const n = Math.floor(80*scale) + Math.floor(Math.random()*120*scale);
    for(let i=0;i<n;i++){
      const a = Math.random()*Math.PI*2;
      const s = (2 + Math.random()*8) * (0.6 + Math.random()*0.8) * scale;
      const vx = Math.cos(a) * s * (0.6 + Math.random()*0.8);
      const vy = Math.sin(a) * s * (0.6 + Math.random()*0.8) - (2+Math.random()*2);
      const r = 1 + Math.random()*4;
      const color = colors[Math.floor(Math.random()*colors.length)];
      const life = 700 + Math.random()*1600;
      parts.push(new P(x,y,vx,vy,r,color,life,'p'));
    }
    // confetti
    for(let i=0;i<40;i++){
      const vx = (Math.random()-0.5)*6;
      const vy = -2 - Math.random()*6;
      const r = 5 + Math.random()*8;
      const color = colors[Math.floor(Math.random()*colors.length)];
      parts.push(new P(x,y,vx,vy,r,color,1200,'c'));
    }
  }

  function frame(now){
    const dt = Math.min(60, now-last)/16; last = now;
    // fade background with slight tint to keep canvas soft
    ctx.fillStyle = 'rgba(255,250,246,0.18)';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    for(let i=parts.length-1;i>=0;i--){
      const p = parts[i];
      p.update(dt);
      p.draw(ctx);
      if(p.age > p.life || p.y > canvas.height + 40) parts.splice(i,1);
    }

    // auto bursts
    if(running && (parts.length < 900) && Math.random() < 0.14) {
      burst(Math.random()*(canvas.width-120)+60, Math.random()*(canvas.height*0.45)+30, 0.9 + Math.random()*1.6);
    }
    requestAnimationFrame(frame);
  }

  // choreograph: big central bursts + random stream
  burst(canvas.width*0.5, canvas.height*0.28, 2.6);
  setTimeout(()=> burst(canvas.width*0.35, canvas.height*0.22, 1.4), 160);
  setTimeout(()=> burst(canvas.width*0.65, canvas.height*0.26, 1.4), 260);
  let i=0; const iv = setInterval(()=>{ burst(60 + Math.random()*(canvas.width-120), 40 + Math.random()*canvas.height*0.45, 0.8+Math.random()*1.0); i++; if(i>26) clearInterval(iv); }, 80);

  requestAnimationFrame(frame);
  // stop after 10.5s and clear
  setTimeout(()=>{ running=false; setTimeout(()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); }, 900); }, 10500);
}

/* contact modal buttons (tel/mail links adjusted) */
document.getElementById('tel-link').addEventListener('click', ()=> { /* nothing needed, native call */ });
document.getElementById('mail-link').addEventListener('click', ()=> { /* opens mail client */ });

/* close contact modal */
document.getElementById('contact-ok').addEventListener('click', ()=> { hideContactModal(); });

/* ensure times refreshed on page load */
window.addEventListener('load', ()=> updateTimes());
</script>
</body>
</html>

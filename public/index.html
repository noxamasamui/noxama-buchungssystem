<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Contact and Table Booking</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="preconnect" href="https://i.imgur.com">
  <meta name="color-scheme" content="light only">
</head>
<body>

  <!-- Banner-Logo bis an den Boxrand -->
  <header class="hero">
    <img
      id="brandBanner"
      src="https://i.imgur.com/LQ4nzwd.png"
      alt="R√ñSTILAND"
      onerror="this.src='/logo-hero.png'">
  </header>

  <main class="container">
    <h1 class="page-title">Contact and Table Booking</h1>

    <!-- Address card -->
    <section class="card">
      <h2 class="card-title">Address</h2>

      <address class="address">
        <a class="address-line"
           href="https://maps.apple.com/?q=Moo%204%20Lamai%20Beach,%2084310%20Suratthani,%20Thailand"
           target="_blank" rel="noopener">
          Moo 4 Lamai Beach, 84310 Suratthani, Thailand
        </a>
      </address>

      <div class="btn-row">
        <a class="btn" href="tel:+666077270675" aria-label="Call phone">
          <span class="btn-icon" aria-hidden="true">üìû</span>
          <span>Phone</span>
        </a>

        <a class="btn" href="mailto:info@noxamasamui.com" aria-label="Send email">
          <span class="btn-icon" aria-hidden="true">‚úâÔ∏è</span>
          <span>Email</span>
        </a>

        <a class="btn" target="_blank" rel="noopener"
           href="https://maps.google.com/?q=Moo+4+Lamai+Beach,+84310+Suratthani,+Thailand"
           aria-label="Open in maps">
          <span class="btn-icon" aria-hidden="true">üó∫Ô∏è</span>
          <span>Open in Maps</span>
        </a>
      </div>
    </section>

    <!-- Booking form -->
    <form id="bookingForm" class="card" autocomplete="off">
      <h2 class="card-title">Date</h2>
      <div class="field">
        <input type="text" id="date" class="input" readonly>
        <button type="button" id="datePick" class="icon-btn" aria-label="Pick date">üìÖ</button>
      </div>

      <h2 class="card-title">Guests (max 10 online)</h2>
      <div class="field">
        <select id="guests" class="input">
          <!-- 1..10 -->
        </select>
      </div>

      <h2 class="card-title">Choose a time slot</h2>
      <div id="slotWrap" class="pill-grid" aria-live="polite"></div>
      <div id="slotMsg" class="hint" hidden></div>

      <h2 class="card-title">First name*</h2>
      <input id="firstName" class="input" required placeholder="First name">

      <h2 class="card-title">Name*</h2>
      <input id="name" class="input" required placeholder="Last name">

      <h2 class="card-title">Email*</h2>
      <input id="email" class="input" type="email" required placeholder="name@example.com">

      <h2 class="card-title">Phone (optional)</h2>
      <input id="phone" class="input" inputmode="tel" placeholder="">

      <h2 class="card-title">Notes</h2>
      <textarea id="notes" class="input" rows="3" placeholder="Allergies, seating request, occasion"></textarea>

      <div class="actions">
        <button class="btn-primary" type="submit" id="bookBtn">Book now</button>
      </div>
    </form>
  </main>

  <!-- Best√§tigungs-Modal -->
  <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-title">Reservation received</div>
      <p id="modalText">
        Thank you for your booking. You will receive a confirmation email shortly.
        Please also check your spam folder.
      </p>
      <button class="btn-primary" id="modalOk">OK</button>
    </div>
  </div>

  <script>
    /* ---------- tiny helpers ---------- */
    const $ = sel => document.querySelector(sel);
    const slotWrap = $("#slotWrap");
    const slotMsg  = $("#slotMsg");
    let selectedTime = "";

    // Fill guest select
    (function fillGuests(){
      const g = $("#guests");
      for (let i=1;i<=10;i++){
        const o = document.createElement("option");
        o.value = String(i);
        o.textContent = String(i);
        g.appendChild(o);
      }
    })();

    // Date management
    function ymd(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd= String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }
    function ddmmyyyy(d){
      const dt = new Date(d);
      return `${String(dt.getDate()).padStart(2,"0")}.${String(dt.getMonth()+1).padStart(2,"0")}.${dt.getFullYear()}`;
    }
    const today = new Date();
    let currentYmd = ymd(today);
    $("#date").value = ddmmyyyy(today);

    // very light date picker: +/‚àí one day with the icon, long tap shows native
    $("#datePick").addEventListener("click", () => {
      const cur = new Date(currentYmd);
      cur.setDate(cur.getDate()+1);
      currentYmd = ymd(cur);
      $("#date").value = ddmmyyyy(cur);
      selectedTime = "";
      renderSlots();
    });
    $("#date").addEventListener("click", () => {
      // try native picker via prompt fallback (mobile-safe)
      const v = prompt("Enter date (YYYY-MM-DD):", currentYmd);
      if (!v) return;
      const d = new Date(v);
      if (!isNaN(d.getTime())) {
        currentYmd = ymd(d);
        $("#date").value = ddmmyyyy(d);
        selectedTime = "";
        renderSlots();
      }
    });

    // fetch slots and render
    async function renderSlots(){
      slotWrap.innerHTML = "";
      slotMsg.hidden = true;

      const guests = Number($("#guests").value || 1);
      const res = await fetch(`/api/slots?date=${encodeURIComponent(currentYmd)}`);
      const data = await res.json(); // [{time, canReserve, allowed, reason, left, ...}]
      const anyAvail = data.some(s => s.canReserve);

      if (!anyAvail) {
        slotMsg.textContent = "We are fully booked or closed on this date. Please choose another day.";
        slotMsg.hidden = false;
      }

      data.forEach(s => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "pill";
        b.textContent = s.time;

        if (!s.canReserve) {
          b.classList.add("disabled");
          b.disabled = true;
          b.setAttribute("aria-disabled","true");
        }

        b.addEventListener("click", () => {
          if (b.disabled) return;
          [...slotWrap.querySelectorAll(".pill.selected")].forEach(x => x.classList.remove("selected"));
          b.classList.add("selected");
          selectedTime = s.time;
        }, {passive:true});

        slotWrap.appendChild(b);
      });
    }
    renderSlots();

    // re-render when guest count changes (kann Kapazit√§ten beeinflussen)
    $("#guests").addEventListener("change", () => {
      selectedTime = "";
      renderSlots();
    });

    // submit booking
    $("#bookingForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = $("#bookBtn");
      if (!selectedTime) {
        alert("Please select a time slot.");
        return;
      }
      btn.disabled = true;

      const payload = {
        date: currentYmd,
        time: selectedTime,
        firstName: $("#firstName").value.trim(),
        name: $("#name").value.trim(),
        email: $("#email").value.trim(),
        phone: $("#phone").value.trim(),
        guests: Number($("#guests").value || 1),
        notes: $("#notes").value.trim()
      };

      try {
        const r = await fetch("/api/reservations", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const j = await r.json();

        if (!r.ok) {
          // Soft-Error im Form, keine JS-Alert-H√∂lle
          showModal(
            j?.error || "Reservation could not be completed. Please choose another time."
          );
          // falls slots inzwischen weg sind: neu laden
          await renderSlots();
          btn.disabled = false;
          return;
        }

        // success: Best√§tigungsmodal
        showModal(
          "Thank you for your booking. You will receive a confirmation email shortly. Please also check your spam folder."
        );
        // Form zur√ºcksetzen
        selectedTime = "";
        $("#bookingForm").reset();
        $("#date").value = ddmmyyyy(new Date(currentYmd)); // Datum belassen
        await renderSlots();
      } catch (err) {
        console.error(err);
        showModal("Network error. Please try again.");
      } finally {
        btn.disabled = false;
      }
    });

    function showModal(text){
      $("#modalText").textContent = text;
      const m = $("#modal");
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
    }
    $("#modalOk").addEventListener("click", () => {
      const m = $("#modal");
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
    }, {passive:true});
  </script>
</body>
</html>

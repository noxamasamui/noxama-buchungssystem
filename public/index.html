<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Reservation — ROESTILAND BY NOXAMA SAMUI</title>
  <link rel="stylesheet" href="/style.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* --- Ergänzende Styles (nur das Nötigste, rest bleibt in style.css) --- */

    .hero-wrap { text-align:center; margin-top:18px; }
    .hero-banner { max-width:640px; width:76%; border-radius:12px; box-shadow:0 25px 50px rgba(0,0,0,.18); display:inline-block; }

    /* Loyalty modal + fireworks styling */
    #loyalty-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:99999; align-items:center; justify-content:center; }
    #loyalty-modal > .card {
      background:#d6c7b2;
      border:1px solid rgba(0,0,0,0.06);
      border-radius:12px;
      max-width:520px;
      width:92%;
      padding:14px;
      box-shadow:0 10px 35px rgba(0,0,0,0.25);
      text-align:center;
      position:relative;
      overflow:visible;
    }
    #fw-canvas { width:100%; height:200px; display:block; border-radius:10px; margin-bottom:12px; background:linear-gradient(180deg,#fff,#fff8f2); box-shadow: inset 0 -6px 12px rgba(0,0,0,0.03); }

    #loyalty-modal h2 { margin:8px 0 4px; font-size:22px; color:#3a2f28; }
    #loyalty-modal p { margin:6px 0; color:#3a2f28; }

    #loyalty-modal .btn { margin-top:10px; background:#b3822f; color:#fff; border-radius:8px; padding:8px 14px; border:0; cursor:pointer; font-weight:700; }

    /* 11+ large party modal */
    #largeparty-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:99998; align-items:center; justify-content:center; }
    #largeparty-modal > .box {
      background:#fff8f0; border:1px solid #e0d7c5; border-radius:12px; max-width:520px; width:92%; padding:18px; box-shadow:0 10px 35px rgba(0,0,0,0.25); text-align:center;
    }
    #largeparty-modal .contact-row { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:12px; }
    #largeparty-modal .contact-row a { background:#b3822f; color:#fff; padding:10px 14px; border-radius:8px; text-decoration:none; font-weight:700; display:inline-block; min-width:120px; text-align:center; }

    /* NOTICE modal */
    #notice-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:99997; align-items:center; justify-content:center; }
    #notice-modal > .notice-box {
      background:#fff8f0; border:1px solid #e0d7c5; border-radius:12px; max-width:520px; width:92%; padding:18px; box-shadow:0 10px 35px rgba(0,0,0,0.25); text-align:left; color:#3a2f28;
    }
    #notice-modal h3 { margin-top:0; text-align:center; }
    #notice-modal p { white-space:pre-wrap; }

    @media (max-width:520px) {
      #largeparty-modal .contact-row a { min-width:120px; flex:1 1 100%; }
      #loyalty-modal > .card { padding:12px; }
      #fw-canvas { height:140px; }
    }

    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div class="hero-wrap">
    <img id="heroBanner" class="hero-banner" alt="Logo banner" src="/logo-hero.png"/>
  </div>

  <div class="container">
    <h1 style="text-align:center;margin-top:8px;">Reservation — ROESTILAND BY NOXAMA SAMUI</h1>
    <p style="text-align:center;margin-top:6px;">Moo 4 Lamai Beach, 84310 Suratthani, Thailand • +66 077 270 675</p>

    <div class="card booking-card booking-compact" style="max-width:760px;margin:18px auto;padding:18px;">
      <h2>Book a table</h2>

      <div class="row date-time">
        <div style="flex:1 1 220px;">
          <label>Date</label>
          <input id="rDate" type="date"/>
        </div>
        <div style="flex:0 0 110px;">
          <label>Guests</label>
          <select id="rGuests">
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
            <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
            <option value="11plus">11+</option>
          </select>
        </div>
        <div style="flex:0 0 140px;">
          <label>Time</label>
          <select id="rTime"></select>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>First name</label>
          <input id="rFirst" type="text"/>
        </div>
        <div>
          <label>Last name</label>
          <input id="rLast" type="text"/>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>Email</label>
          <input id="rEmail" type="email"/>
        </div>
        <div>
          <label>Phone</label>
          <input id="rPhone" type="tel"/>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>Notes</label>
        <textarea id="rNotes" rows="2" style="width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #c8b99e;"></textarea>
      </div>

      <div style="margin-top:12px;text-align:left;">
        <button id="btnReserve" class="btn btn-primary-book" type="button">Book</button>
        <span id="rMsg" class="badge" style="margin-left:10px;"></span>
      </div>
    </div>
  </div>

  <!-- confirmation modal -->
  <div id="confirm-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#fff8f0;border-radius:12px;padding:18px;max-width:420px;width:92%;text-align:center;border:1px solid #e0d7c5;">
      <h3 id="confirm-title" style="margin-top:0;">Reservation confirmed</h3>
      <div id="confirm-text" style="margin:8px 0 12px 0;color:#3a2f28;"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="confirm-ok" class="btn" style="min-width:120px;">Continue</button>
      </div>
    </div>
  </div>

  <!-- loyalty modal (with fireworks canvas) -->
  <div id="loyalty-modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="loyalty-title">
      <canvas id="fw-canvas"></canvas>
      <h2 id="loyalty-title">You earned a loyalty reward</h2>
      <p id="loyalty-sub">Congratulations — loyalty reward unlocked!</p>
      <p id="loyalty-msg"></p>
      <button id="loyalty-ok" class="btn">Okay</button>
    </div>
  </div>

  <!-- large party modal -->
  <div id="largeparty-modal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" aria-labelledby="lp-title">
      <h2 id="lp-title">Large party request</h2>
      <p>For parties of 11 or more please contact us directly so we can arrange a suitable table and confirm availability.</p>
      <div class="contact-row" style="margin-top:12px;">
        <a href="tel:+66077270675" id="lp-call">Call +66 077 270 675</a>
        <a href="mailto:info@noxamasamui.com" id="lp-email">Email info@noxamasamui.com</a>
      </div>
      <div style="margin-top:12px;">
        <button id="lp-ok" class="btn">OK</button>
      </div>
    </div>
  </div>

  <!-- notice modal (date-specific admin notices) -->
  <div id="notice-modal" aria-hidden="true">
    <div class="notice-box" role="dialog" aria-modal="true" aria-labelledby="notice-title">
      <h3 id="notice-title">Information</h3>
      <div id="notice-body" style="margin-top:8px;color:#3a2f28"></div>
      <div style="text-align:center;margin-top:14px;">
        <button id="notice-ok" class="btn">Okay</button>
      </div>
    </div>
  </div>

<script>
  // ---------- Helpers ----------
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

  // load banner from /api/config
  (async()=>{
    try{
      const r = await fetch('/api/config', {cache:"no-store"});
      if(!r.ok) return;
      const cfg = await r.json();
      const hero = document.getElementById('heroBanner');
      hero.src = cfg.mailHeaderUrl && cfg.mailHeaderUrl.trim() ? cfg.mailHeaderUrl : (cfg.mailLogoUrl && cfg.mailLogoUrl.trim() ? cfg.mailLogoUrl : '/logo-hero.png');
      hero.alt = cfg.brand || 'Banner';
    }catch(e){ console.error("cfg",e); }
  })();

  document.getElementById('rDate').value = today();

  // fill time slots by asking /api/slots (only allowed shown)
  async function updateTimes(){
    const date = document.getElementById('rDate').value;
    const guestsSel = document.getElementById('rGuests');
    const guestsVal = guestsSel.value === '11plus' ? 1 : Number(guestsSel.value || 1);
    const sel = document.getElementById('rTime');
    sel.innerHTML = '';

    if(!date) return;

    try{
      const resp = await fetch(`/api/slots?date=${encodeURIComponent(date)}&guests=${encodeURIComponent(guestsVal)}`, {cache:"no-store"});
      if(!resp.ok) return;
      const slots = await resp.json();
      if(!Array.isArray(slots)) return;

      const anyAllowed = slots.some(s => s.allowed === true);
      if(!anyAllowed){
        const reasons = Array.from(new Set(slots.map(s => s.reason || '').filter(Boolean)));
        let reason = reasons.find(r => r.toLowerCase().includes('sunday')) || reasons[0] || 'This date is not available';
        showLargeAlert("Reservation not possible", reason + ". Please choose another date.");
        return;
      }

      slots.filter(s => s.allowed).forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.time;
        opt.textContent = s.time;
        sel.appendChild(opt);
      });

    }catch(e){ console.error("updateTimes error", e); }
  }

  // initial
  updateTimes();

  // when date changes: check for closures/notices & refresh times
  document.getElementById('rDate').addEventListener('change', async (e)=>{
    const date = e.target.value;
    // check admin-configured notice for the date (non-blocking)
    checkNoticeForDate(date);
    // update times (this already checks blocked/closed)
    updateTimes();
  });

  // guests change
  document.getElementById('rGuests').addEventListener('change', async function(){
    const v = this.value;
    if(v === '11plus'){
      showLargePartyModal();
      setTimeout(()=>{ this.value='1'; updateTimes(); }, 10);
      return;
    }
    updateTimes();
  });

  // ---------- Check for admin notices (new) ----------
  async function checkNoticeForDate(date){
    if(!date) return;
    try{
      const r = await fetch(`/api/notice?date=${encodeURIComponent(date)}`, {cache:"no-store"});
      if(!r.ok) return;
      const obj = await r.json();
      if(obj && obj.id){
        // show a friendly popup with the content
        const title = obj.title || "Important information";
        const body = obj.message || "";
        showNoticeModal(title, body);
      }
    }catch(e){
      console.error("checkNotice", e);
    }
  }

  function showNoticeModal(title, body){
    const m = document.getElementById('notice-modal');
    document.getElementById('notice-title').textContent = title;
    document.getElementById('notice-body').textContent = body;
    document.getElementById('notice-ok').onclick = ()=>{ m.style.display = 'none'; };
    m.style.display = 'flex';
  }

  // ---------- Booking submit unchanged (kept minimal) ----------
  document.getElementById('btnReserve').addEventListener('click', async ()=>{
    const payload = {
      date: document.getElementById('rDate').value,
      time: document.getElementById('rTime').value,
      firstName: document.getElementById('rFirst').value.trim(),
      name: document.getElementById('rLast').value.trim(),
      email: document.getElementById('rEmail').value.trim(),
      phone: document.getElementById('rPhone').value.trim(),
      guests: Number(document.getElementById('rGuests').value),
      notes: document.getElementById('rNotes').value.trim()
    };
    const msg = document.getElementById('rMsg');
    msg.textContent = '';

    if(!payload.firstName || !payload.name || !payload.email || !payload.guests){
      msg.textContent = 'Please fill first name, last name, email and guests';
      return;
    }

    try{
      const r = await fetch('/api/reservations', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });

      const json = await r.json().catch(()=>({}));
      if(r.ok){
        if(json && (json.nowUnlockedTier === 5 || json.nowUnlockedTier === 10 || json.nowUnlockedTier === 15)){
          showLoyaltyModal(json.nowUnlockedTier, json.visitNo || null);
          document.getElementById('loyalty-ok').onclick = ()=>{
            hideLoyaltyModal();
            showConfirm("Reservation received", `Thank you. A confirmation mail was sent to <b>${payload.email}</b>.`);
          };
        } else {
          showConfirm("Reservation received", `Thank you. A confirmation mail was sent to <b>${payload.email}</b>.`);
        }
      } else {
        const err = json.error?.toLowerCase() || "";
        if(err.includes("closed") || err.includes("blocked") || err.includes("sunday") || err.includes("fully booked")){
          showLargeAlert("Reservation not possible", json.error || "Please choose another date or time.");
        } else {
          msg.textContent = json.error || 'Error saving reservation';
        }
      }
    }catch(e){
      console.error('reservation post error', e);
      msg.textContent = 'Network error';
    }
  });

  function showConfirm(title, html){
    const m = document.getElementById('confirm-modal');
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-text').innerHTML = html;
    document.getElementById('confirm-ok').onclick = ()=>{ hideConfirm(); window.location.href = '/'; };
    m.style.display = 'flex';
  }
  function hideConfirm(){ document.getElementById('confirm-modal').style.display = 'none'; }

  // large party modal (11+)
  function showLargePartyModal(){
    const m = document.getElementById('largeparty-modal'); m.style.display='flex';
    document.getElementById('lp-ok').onclick = ()=>{ m.style.display='none'; };
  }
  function showLargeAlert(title, text){
    const m = document.getElementById('largeparty-modal');
    const box = m.querySelector('.box');
    box.querySelector('h2').textContent = title;
    box.querySelector('p').textContent = text;
    const cr = box.querySelector('.contact-row'); cr.style.display='none';
    m.style.display='flex';
    document.getElementById('lp-ok').onclick = ()=>{
      cr.style.display=''; box.querySelector('h2').textContent='Large party request';
      box.querySelector('p').textContent='For parties of 11 or more please contact us directly so we can arrange a suitable table and confirm availability.';
      m.style.display='none';
    };
  }
  // call after date changed (inside your existing change handler)
async function checkDateNotices(date) {
  try {
    if (!date) return;
    const resp = await fetch(`/api/admin/notices`);
    if (!resp.ok) return;
    const list = await resp.json();
    if (!Array.isArray(list) || list.length === 0) return;
    const match = list.find(n => n.date === date);
    if (match) {
      // show a friendly modal (reuse showModal if available)
      const content = `<div style="font-family:Georgia,serif;color:#3a2f28;">
        <div style="font-size:18px;font-weight:700;margin-bottom:8px;">Note for ${date}</div>
        <div style="font-size:15px">${match.msg}</div>
      </div>`;
      if (typeof showModal === "function") {
        showModal(content, "Important information");
      } else {
        alert(match.msg);
      }
    }
  } catch (e) { console.error("checkDateNotices", e); }
}


  /* ----------------- loyalty fireworks (unchanged) ------------------ */
  // (The fireworks code is identical to what worked; omitted here for brevity in commentary)
  // Include the same startFireworks / stopFireworks / showLoyaltyModal / hideLoyaltyModal functions
  // for brevity in this block I've omitted the copy — in your deployment use the fireworks functions
  // from your working file (they are unchanged).

  // For completeness the actual file should contain the same fireworks functions present earlier
  // (startFireworks, stopFireworks, showLoyaltyModal, hideLoyaltyModal). They must be included.
  // ---------- End fireworks block placeholder ----------

  // Accessibility: close modals on Escape
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ document.getElementById('largeparty-modal').style.display='none'; hideConfirm(); hideLoyaltyModal(); document.getElementById('notice-modal').style.display='none'; } });

  // Keep times fresh
  window.addEventListener('focus', ()=> updateTimes());

  // call check once initially for today's date (optional)
  checkNoticeForDate(document.getElementById('rDate').value);

</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Contact and Table Booking</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <div class="wrap">
    <img class="logo" src="/logo-hero.png" alt="RÖSTILAND">
    <h1>Contact and Table Booking</h1>

    <div class="card">
      <p><strong>Address</strong><br>
        Moo 4 Lamai Beach, 84310 Suratthani, Thailand</p>
      <p><strong>Phone</strong> <a href="tel:+666077270675">+66 077 270 675</a><br>
         <strong>Email</strong> <a href="mailto:info@noxamasamui.com">info@noxamasamui.com</a></p>
    </div>

    <div class="card">
      <label for="date">Date</label>
      <input id="date" type="date"/>

      <label for="guests" style="margin-top:12px">Guests (max 10 online)</label>
      <select id="guests">
        <option value="">Select guests…</option>
        <script>
          for(let i=1;i<=10;i++){
            document.write(`<option value="${i}">${i}</option>`);
          }
        </script>
        <option value="group">Group 11+</option>
      </select>
      <div id="groupNote" class="notice" style="display:none;margin-top:10px">
        For groups of 11 or more, please contact us via
        <a href="mailto:info@noxamasamui.com">email</a> or
        <a href="tel:+666077270675">phone</a>.
      </div>

      <div id="closedNote" class="notice error" style="display:none;margin-top:14px">
        We are fully booked or closed on this date. Please choose another day.
      </div>

      <div id="slotsWrap" style="margin-top:14px;display:none">
        <label>Choose a time slot (15 minutes grid)</label>
        <div id="slots" class="grid"></div>
      </div>
    </div>

    <form id="form" class="card" style="display:none">
      <div class="row">
        <div>
          <label for="first">First name*</label>
          <input id="first" type="text" required>
        </div>
        <div>
          <label for="name">Name*</label>
          <input id="name" type="text" required>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="email">Email*</label>
          <input id="email" type="email" required>
        </div>
        <div>
          <label for="phone">Phone (optional)</label>
          <input id="phone" type="tel" placeholder="">
        </div>
      </div>
      <div>
        <label for="notes">Notes</label>
        <textarea id="notes" placeholder="Allergies, seating request, occasion"></textarea>
      </div>

      <div class="center" style="margin-top:14px">
        <button class="btn" type="submit">Book now</button>
      </div>

      <div id="msg" class="notice success" style="display:none;margin-top:12px"></div>
    </form>

  </div>

<script>
const logoUrl = '/logo-hero.png'; // zentral, falls du später umstellst

const dateEl   = document.getElementById('date');
const guestsEl = document.getElementById('guests');
const groupNote= document.getElementById('groupNote');
const slotsWrap= document.getElementById('slotsWrap');
const slotsEl  = document.getElementById('slots');
const closedNote= document.getElementById('closedNote');
const formEl   = document.getElementById('form');
const msgEl    = document.getElementById('msg');

let pickedSlot = null;

function ymdToday(){
  const t = new Date();
  const y=t.getFullYear(), m = String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

dateEl.value = ymdToday();

guestsEl.addEventListener('change', ()=>{
  if(guestsEl.value==='group'){
    slotsWrap.style.display='none';
    formEl.style.display='none';
    groupNote.style.display='block';
    return;
  }
  groupNote.style.display='none';
  if(dateEl.value && guestsEl.value) loadSlots();
});
dateEl.addEventListener('change', ()=>{
  if(guestsEl.value && guestsEl.value!=='group') loadSlots();
});

async function loadSlots(){
  pickedSlot=null;
  formEl.style.display='none';
  slotsEl.innerHTML='';
  closedNote.style.display='none';
  slotsWrap.style.display='none';

  const r = await fetch(`/api/slots?date=${encodeURIComponent(dateEl.value)}&guests=${encodeURIComponent(guestsEl.value)}`);
  if(!r.ok){ closedNote.style.display='block'; return }
  const data = await r.json(); // { open:true, slots:[{t:"10:00",free:true},...] }

  if(!data.open || !data.slots?.length){
    closedNote.style.display='block';
    return;
  }
  slotsWrap.style.display='block';
  for(const s of data.slots){
    const b = document.createElement('button');
    b.type='button';
    b.className='slot';
    b.textContent=s.t;
    if(!s.free) b.setAttribute('disabled','');
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.slot.active').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      pickedSlot = s.t;
      formEl.style.display='block';
      msgEl.style.display='none';
    });
    slotsEl.appendChild(b);
  }
}

document.getElementById('form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!pickedSlot) return;

  const payload = {
    date: dateEl.value,
    time: pickedSlot,
    guests: Number(guestsEl.value),
    firstName: document.getElementById('first').value.trim(),
    name: document.getElementById('name').value.trim(),
    email: document.getElementById('email').value.trim(),
    phone: document.getElementById('phone').value.trim() || null,
    notes: document.getElementById('notes').value.trim() || null
  };

  const r = await fetch('/api/reservations', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const res = await r.json();

  if(!r.ok){
    msgEl.className='notice error';
    msgEl.textContent = res?.error || 'Booking failed.';
    msgEl.style.display='block';
    return;
  }

  msgEl.className='notice success';
  msgEl.innerHTML = 'Thank you! Your reservation has been received. A confirmation email will arrive shortly. Please also check your spam folder.';
  msgEl.style.display='block';

  // Button-UI zurücksetzen
  document.querySelectorAll('.slot.active').forEach(x=>x.classList.remove('active'));
  formEl.reset();
  formEl.style.display='none';
});
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Contact and Table Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    /* Nur Zusatz fuer das Feuerwerk-Modal */
    .modal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,.45); z-index: 999; }
    .hidden { display: none; }
    .modal-body { background: #fff; max-width: 520px; width: calc(100% - 32px); border-radius: 12px; padding: 20px; text-align: center; }
    .confetti { position: absolute; pointer-events: none; inset: 0; overflow: hidden; }
    .logo { max-width: 260px; height: auto; display: block; margin: 0 auto 8px auto; }
    .slot-grid .slot { transition: transform .06s ease; }
    .slot-grid .slot.active { transform: scale(0.98); outline: 2px solid #b3822f; }
  </style>
</head>
<body style="background:#d6c7b2;">
<div class="container">
  <img class="logo" src="/logo-hero.png" alt="Logo"/>

  <h1>Contact and Table Booking</h1>

  <div class="card">
    <div id="contactBox" class="contact">
      <p><b>Address</b><br/><a id="venueAddressLink" href="#" target="_blank" rel="noopener"><span id="venueAddress"></span></a></p>
      <p><b>Phone</b> <a id="venuePhoneLink" href="#" ><span id="venuePhone"></span></a><br/><b>Email</b> <a id="venueEmailLink" href="#"><span id="venueEmail"></span></a></p>
    </div>
  </div>

  <div class="card">
    <label>Date</label>
    <div class="row">
      <input id="date" type="date"/>
      <button id="reload" class="btn" type="button">â†»</button>
    </div>

    <div id="dayInfo" class="banner hidden"></div>

    <label style="margin-top:10px;">Choose a time slot (15 minutes grid)</label>
    <div id="slots" class="slot-grid"></div>

    <div class="grid2">
      <div>
        <label>First name*</label>
        <input id="firstName" required />
      </div>
      <div>
        <label>Name*</label>
        <input id="name" required />
      </div>
    </div>

    <label>Email*</label>
    <input id="email" type="email" required />

    <label>Phone (optional)</label>
    <input id="phone" />

    <label>Guests*</label>
    <select id="guests"></select>

    <label>Notes</label>
    <textarea id="notes" rows="3" placeholder="Allergies, seating request, occasion"></textarea>

    <div class="actions">
      <button id="book" class="btn" type="button">Book now</button>
      <span id="msg" class="badge"></span>
    </div>
  </div>
</div>

<!-- Thank-you modal -->
<div id="modal" class="modal hidden">
  <div class="modal-body">
    <h3>Thank you!</h3>
    <p>Your reservation has been received. You will get a confirmation email shortly. Please also check your spam folder.</p>
    <button id="closeModal" class="btn">OK</button>
  </div>
</div>

<!-- Loyalty unlock modal with simple confetti -->
<div id="loyaltyModal" class="modal hidden">
  <div class="confetti" id="confetti"></div>
  <div class="modal-body">
    <h3 id="loyaltyTitle">ðŸŽ‰ Loyalty unlocked!</h3>
    <p id="loyaltyText">You now enjoy a loyalty thank-you.</p>
    <button id="closeLoyalty" class="btn">Nice!</button>
  </div>
</div>

<script>
const todayISO = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

function setLinks(cfg){
  const addr = cfg.address || "";
  const phone = cfg.phone || "";
  const email = cfg.email || "";
  document.getElementById("venueAddress").textContent = addr;
  document.getElementById("venuePhone").textContent   = phone;
  document.getElementById("venueEmail").textContent   = email;
  document.getElementById("venueAddressLink").href = "https://maps.google.com/?q=" + encodeURIComponent(addr);
  document.getElementById("venuePhoneLink").href = "tel:" + phone.replace(/\s+/g,"");
  document.getElementById("venueEmailLink").href = "mailto:" + email;
}

// Kontaktangaben laden
fetch("/api/config").then(r=>r.json()).then(c=>{ setLinks(c); });

document.getElementById("date").value = todayISO();
for(let i=1;i<=11;i++){ const o=document.createElement("option"); o.value=o.textContent=String(i<=10?i:"11+"); document.getElementById("guests").appendChild(o); }

let selectedTime = null;

async function loadSlots(){
  selectedTime = null;
  const d = document.getElementById("date").value;
  const gSel = document.getElementById("guests").value;
  const guests = (gSel === "11+") ? 10 : Number(gSel); // online nur bis 10
  const r = await fetch(`/api/slots?date=${encodeURIComponent(d)}&guests=${guests}`);
  const data = await r.json();
  const box = document.getElementById("slots");
  const banner = document.getElementById("dayInfo");
  box.innerHTML = "";

  // Nur Slots anzeigen, die wirklich buchbar sind
  const available = data.filter(s => s.allowed && s.canReserve);
  if (available.length === 0) {
    // freundliche Tagesmeldung
    const hasSunday = data.some(s => s.reason === "Closed on Sunday");
    if (hasSunday) {
      banner.textContent = "We are closed on Sundays. Please choose another day.";
    } else {
      banner.textContent = "This date is fully booked. Please choose another day.";
    }
    banner.classList.remove("hidden");
  } else {
    banner.classList.add("hidden");
    banner.textContent = "";
  }

  available.forEach(s=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "slot";
    b.textContent = s.time;
    b.onclick = ()=>{ document.querySelectorAll(".slot.active").forEach(x=>x.classList.remove("active")); b.classList.add("active"); selectedTime = s.time; };
    box.appendChild(b);
  });
}
document.getElementById("reload").onclick = loadSlots;
document.getElementById("date").addEventListener("change", loadSlots);
document.getElementById("guests").addEventListener("change", (e)=>{
  if (e.target.value === "11+") {
    alert("For groups of 11 or more, please contact us directly by phone or email. We will be happy to assist.");
  }
  loadSlots();
});
loadSlots();

function friendlyError(e){
  if(!e) return "Something went wrong.";
  const s = e.toLowerCase();
  if(s.includes("sunday")) return "We are closed on Sundays. Please choose another day.";
  if(s.includes("blocked") || s.includes("fully")) return "This date is fully booked. Please choose another day.";
  if(s.includes("opening") || s.includes("before") || s.includes("closing")) return "This time is outside our opening hours.";
  return e;
}

/* Minimal Konfetti (ohne Lib) */
function burstConfetti() {
  const box = document.getElementById("confetti");
  box.innerHTML = "";
  const N = 120;
  for(let i=0;i<N;i++){
    const s = document.createElement("span");
    s.textContent = ["ðŸŽŠ","ðŸŽ‰","âœ¨","ðŸ’«"][Math.floor(Math.random()*4)];
    s.style.position = "absolute";
    s.style.left = Math.random()*100 + "%";
    s.style.top = "-10%";
    s.style.fontSize = (14 + Math.random()*14) + "px";
    s.style.animation = `fall ${3 + Math.random()*2}s linear ${Math.random()}s forwards`;
    box.appendChild(s);
  }
}
const style = document.createElement("style");
style.textContent = `
@keyframes fall {
  to { transform: translateY(120vh) rotate(360deg); opacity: 0.9; }
}`;
document.head.appendChild(style);

document.getElementById("book").onclick = async ()=>{
  const d = document.getElementById("date").value;
  const firstName = document.getElementById("firstName").value.trim();
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const guestsVal = document.getElementById("guests").value;
  const guests = guestsVal === "11+" ? 10 : Number(guestsVal);
  const notes = document.getElementById("notes").value.trim();
  const m = document.getElementById("msg");

  if(!selectedTime){ m.textContent="Please select a time slot"; return; }
  if(!firstName || !name || !email){ m.textContent="Please fill in all required fields"; return; }

  m.textContent = "";
  const payload = { date:d, time:selectedTime, firstName, name, email, phone, guests, notes };
  const r = await fetch("/api/reservations", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  if(r.ok){
    const json = await r.json();

    // Loyalty Unlock Popup bei 5/10/15
    if (json && json.nowUnlockedTier && Number(json.nowUnlockedTier) > 0) {
      const tier = Number(json.nowUnlockedTier);
      document.getElementById("loyaltyTitle").textContent = `ðŸŽ‰ Loyalty unlocked â€” ${tier}% ðŸŽ‰`;
      document.getElementById("loyaltyText").innerHTML = `From now on you enjoy a <b>${tier}%</b> loyalty thank-you.`;
      document.getElementById("loyaltyModal").classList.remove("hidden");
      burstConfetti();
    }

    // Standard-OK Modal
    document.getElementById("modal").classList.remove("hidden");
  }else{
    const e = await r.json().catch(()=>({error:"Error"}));
    m.textContent = friendlyError(e.error||"Error");
  }
};
document.getElementById("closeModal").onclick = ()=>document.getElementById("modal").classList.add("hidden");
document.getElementById("closeLoyalty").onclick = ()=>document.getElementById("loyaltyModal").classList.add("hidden");
</script>
</body>
</html>

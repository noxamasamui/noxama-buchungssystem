<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Contact and Table Booking</title>
  <link rel="stylesheet" href="/style.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* kleine Extras damit das Popup auch ohne weitere CSS-Datei gut aussieht */
    .modal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,.35); }
    .modal.hidden { display: none; }
    .modal-body { background: #fff; color:#3a2f28; padding: 20px; border-radius: 10px; width: min(560px, 92vw); box-shadow: 0 10px 30px rgba(0,0,0,.2); }
    .modal-body h3 { margin-top: 0; }
    .btn-ghost { background: #eee3d5; border: 1px solid #d8c6b2; color:#3a2f28; border-radius:8px; padding:10px 14px; cursor:pointer; }
  </style>
</head>
<body>
<div class="container">
  <img class="logo" src="/logo.png" alt="Logo"/>

  <h1>Contact and Table Booking</h1>

  <div class="card">
    <div id="contactBox" class="contact">
      <p><b>Address</b><br/><span id="venueAddress"></span></p>
      <p><b>Phone</b> <span id="venuePhone"></span><br/><b>Email</b> <span id="venueEmail"></span></p>
    </div>
  </div>

  <div class="card">
    <label>Date</label>
    <div class="row">
      <input id="date" type="date"/>
      <button id="reload" class="btn" type="button">↻</button>
    </div>

    <div id="dayInfo" class="banner hidden"></div>

    <label style="margin-top:10px;">Choose a time slot (15 minutes grid)</label>
    <div id="slots" class="slot-grid"></div>

    <div class="grid2">
      <div>
        <label>First name*</label>
        <input id="firstName" required />
      </div>
      <div>
        <label>Name*</label>
        <input id="name" required />
      </div>
    </div>

    <label>Email*</label>
    <input id="email" type="email" required />

    <label>Phone (optional)</label>
    <input id="phone" />

    <label>Guests*</label>
    <select id="guests"></select>

    <label>Notes</label>
    <textarea id="notes" rows="3" placeholder="Allergies, seating request, occasion"></textarea>

    <div class="actions">
      <button id="book" class="btn" type="button">Book now</button>
      <span id="msg" class="badge"></span>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal hidden" aria-modal="true" role="dialog">
  <div class="modal-body">
    <h3 id="modalTitle">Thank you!</h3>
    <p id="modalText">Your reservation has been received. You will get a confirmation email shortly.</p>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="closeModal" class="btn">OK</button>
    </div>
  </div>
</div>

<script>
const todayISO = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

// contact
fetch("/api/config").then(r=>r.json()).then(c=>{
  document.getElementById("venueAddress").textContent = c.address || "";
  document.getElementById("venuePhone").textContent   = c.phone || "";
  document.getElementById("venueEmail").textContent   = c.email || "";
});

document.getElementById("date").value = todayISO();
for(let i=1;i<=48;i++){ const o=document.createElement("option"); o.value=o.textContent=String(i); document.getElementById("guests").appendChild(o); }

let selectedTime = null;

// unified modal helpers
function showModal(title, text){
  document.getElementById("modalTitle").textContent = title || "Info";
  document.getElementById("modalText").textContent = text || "";
  document.getElementById("modal").classList.remove("hidden");
}
document.getElementById("closeModal").onclick = ()=>document.getElementById("modal").classList.add("hidden");

// translate any backend reason (de/en) to clean English for the UI
function toEnglishReason(reason){
  const r = String(reason||"").toLowerCase();

  if(r.includes("sonntag") || r.includes("sunday"))
    return "We are closed on Sundays.";

  if(r.includes("fully") || r.includes("ausgebucht") || r.includes("voll"))
    return "This time is fully booked. Please choose another time or a different day.";

  if(r.includes("blockiert") || r.includes("temporarily") || r.includes("blocked"))
    return "This date is blocked for a private event. Please choose another day.";

  if(r.includes("opening") || r.includes("öffnun") || r.includes("closing"))
    return "This time is outside our opening hours.";

  return reason || "Not available.";
}

async function loadSlots(){
  selectedTime = null;
  const d = document.getElementById("date").value;
  const r = await fetch(`/api/slots?date=${encodeURIComponent(d)}`);
  const data = await r.json();
  const box = document.getElementById("slots");
  const banner = document.getElementById("dayInfo");
  const btnBook = document.getElementById("book");
  box.innerHTML = "";
  btnBook.disabled = true;

  // Banner bei komplett nicht buchbarem Tag
  if (data.length && data.every(s => !s.allowed || !s.canReserve)) {
    const reasons = Array.from(new Set(data.map(s => toEnglishReason(s.reason))));
    const main = reasons.length === 1 ? reasons[0] : "No available time slots for this day. Please choose another day.";
    banner.textContent = main;
    banner.classList.remove("hidden");
  } else {
    banner.classList.add("hidden");
    banner.textContent = "";
  }

  data.forEach(s=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "slot " + (s.allowed && s.canReserve ? "" : "disabled");
    b.textContent = s.time;

    if (s.allowed && s.canReserve) {
      b.onclick = ()=>{
        document.querySelectorAll(".slot.active").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        selectedTime = s.time;
        btnBook.disabled = false;
      };
    } else {
      const reason = toEnglishReason(s.reason);
      b.title = reason;

      // Wichtig: auch bei disabled Slot zeigen wir ein Popup
      b.onclick = ()=>showModal("Not available", reason);
    }
    box.appendChild(b);
  });
}
document.getElementById("reload").onclick = loadSlots;
document.getElementById("date").addEventListener("change", loadSlots);
loadSlots();

// friendly error popup
function friendlyError(e){
  if(!e) return "Something went wrong.";
  const t = String(e).toLowerCase();
  if(t.includes("sunday") || t.includes("sonntag")) return "We are closed on Sundays.";
  if(t.includes("fully") || t.includes("ausgebucht") || t.includes("voll")) return "This time is fully booked. Please choose another time or a different day.";
  if(t.includes("block") || t.includes("blockiert")) return "This date is blocked for a private event. Please choose another day.";
  if(t.includes("opening") || t.includes("closing") || t.includes("öffnun")) return "This time is outside our opening hours.";
  return e;
}

document.getElementById("book").onclick = async ()=>{
  const d = document.getElementById("date").value;
  const firstName = document.getElementById("firstName").value.trim();
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const guests = Number(document.getElementById("guests").value);
  const notes = document.getElementById("notes").value.trim();

  if(!selectedTime){ return showModal("Select a time", "Please choose a time slot before booking."); }
  if(!firstName || !name || !email){ return showModal("Missing information", "Please fill in first name, name and email."); }

  try {
    const payload = { date:d, time:selectedTime, firstName, name, email, phone, guests, notes };
    const resp = await fetch("/api/reservations", {
      method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)
    });

    if(resp.ok){
      showModal("Reservation confirmed", "Thank you! We have received your reservation and sent a confirmation email.");
      loadSlots();
    } else {
      // zeige server text, aber englisch-aufbereitet
      const raw = await resp.text();
      let errMsg = "";
      try { errMsg = (JSON.parse(raw).error) || raw; } catch { errMsg = raw || "Error"; }
      showModal("Not available", friendlyError(errMsg));
    }
  } catch {
    showModal("Network error", "Please try again in a moment.");
  }
};
</script>
</body>
</html>

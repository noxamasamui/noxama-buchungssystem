<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Reservation — ROESTILAND BY NOXAMA SAMUI</title>
  <link rel="stylesheet" href="/style.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* only minimal additions for notice modal look (keeps rest of your style.css intact) */
    .notice-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:99999;align-items:center;justify-content:center;}
    .notice-modal { background:#fff8f0;border:1px solid #e0d7c5;border-radius:12px;max-width:520px;width:92%;padding:18px;box-shadow:0 10px 35px rgba(0,0,0,0.25);text-align:center;}
    .notice-modal h3{margin:8px 0 10px;font-size:20px;color:#3a2f28}
    .notice-modal p{color:#3a2f28;margin:8px 0;}
    .notice-modal .ok{margin-top:12px;background:#b3822f;color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:700}
  </style>
</head>
<body>
  <div class="hero-wrap" style="text-align:center;margin-top:18px;">
    <img id="heroBanner" class="hero-banner" alt="Logo banner" style="max-width:640px;width:76%;border-radius:12px;box-shadow:0 25px 50px rgba(0,0,0,.18);"/>
  </div>

  <div class="container">
    <h1 style="text-align:center;margin-top:8px;">Reservation — RÖSTILAND BY NOXAMA SAMUI</h1>
    <p style="text-align:center;margin-top:6px;">Moo 4 Lamai Beach, 84310 Suratthani, Thailand • +66 077 270 675</p>

    <div class="card booking-card booking-compact" style="max-width:760px;margin:18px auto;padding:18px;">
      <h2>Book a table</h2>

      <div class="row date-time">
        <div style="flex:1 1 220px;">
          <label>Date</label>
          <input id="rDate" type="date"/>
        </div>
        <div style="flex:0 0 110px;">
          <label>Guests</label>
          <select id="rGuests">
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
            <option value="11plus">11+</option>
          </select>
        </div>
        <div style="flex:0 0 140px;">
          <label>Time</label>
          <select id="rTime"></select>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>First name</label>
          <input id="rFirst" type="text"/>
        </div>
        <div>
          <label>Last name</label>
          <input id="rLast" type="text"/>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>Email</label>
          <input id="rEmail" type="email"/>
        </div>
        <div>
          <label>Phone</label>
          <input id="rPhone" type="tel"/>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>Notes</label>
        <textarea id="rNotes" rows="2" style="width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #c8b99e;"></textarea>
      </div>

      <div style="margin-top:12px;text-align:left;">
        <button id="btnReserve" class="btn btn-primary-book" type="button">Book</button>
        <span id="rMsg" class="badge" style="margin-left:10px;"></span>
      </div>
    </div>
  </div>

  <!-- confirmation modal (unchanged minimal) -->
  <div id="confirm-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#fff8f0;border-radius:12px;padding:18px;max-width:420px;width:92%;text-align:center;border:1px solid #e0d7c5;">
      <h3 id="confirm-title" style="margin-top:0;">Reservation confirmed</h3>
      <div id="confirm-text" style="margin:8px 0 12px 0;color:#3a2f28;"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="confirm-ok" class="btn" style="min-width:120px;">Continue</button>
      </div>
    </div>
  </div>

  <!-- Notice modal (for admin-set notices like Christmas menu) -->
  <div id="notice-modal" class="notice-modal-overlay" aria-hidden="true">
    <div class="notice-modal" role="dialog" aria-modal="true">
      <h3 id="notice-title">Important information</h3>
      <div id="notice-body"></div>
      <button id="notice-ok" class="ok">Okay</button>
    </div>
  </div>

<script>
  // helper: today string yyyy-mm-dd
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

  // load config (banner)
  (async()=>{ try{ const r = await fetch('/api/config'); if(!r.ok) return; const cfg = await r.json(); const hero = document.getElementById('heroBanner'); hero.src = cfg.mailHeaderUrl || cfg.mailLogoUrl || '/logo-hero.png'; hero.alt = cfg.brand || 'Banner'; }catch(e){console.error(e);} })();

  document.getElementById('rDate').value = today();

  // fill times select (keeps same as server)
  function fillTimes(){
    const sel = document.getElementById('rTime');
    sel.innerHTML = '';
    const from = 10*60, to = 22*60, interval = 15;
    for(let m=from;m<to;m+=interval){
      const hh=String(Math.floor(m/60)).padStart(2,"0");
      const mm=String(m%60).padStart(2,"0");
      const opt=document.createElement("option"); opt.value=`${hh}:${mm}`; opt.textContent=opt.value;
      sel.appendChild(opt);
    }
  }
  fillTimes();

  // helper: show notice modal
  function showNotice(message, title="Important information"){
    const overlay = document.getElementById('notice-modal');
    document.getElementById('notice-title').textContent = title;
    document.getElementById('notice-body').innerHTML = message;
    overlay.style.display = 'flex';
    document.getElementById('notice-ok').onclick = ()=> overlay.style.display = 'none';
  }

  // When date changes: check slots AND check admin notices immediately
  async function onDateOrGuestsChanged(){
    const date = document.getElementById('rDate').value || today();
    const guestsRaw = document.getElementById('rGuests').value;
    // if user chose 11+ show large-party modal (reuse existing confirm modal appearance)
    if(guestsRaw === '11plus'){
      showNotice(`<div style="font-family:Georgia,serif;color:#3a2f28">
        <div style="font-size:20px;font-weight:700;margin-bottom:8px;">Large party request</div>
        <div>For parties of 11 or more please contact us directly so we can arrange a suitable table and confirm availability.</div>
        <div style="margin-top:12px"><a href="tel:+66077270675" style="display:inline-block;padding:10px 14px;background:#b3822f;color:#fff;border-radius:8px;text-decoration:none;margin-right:8px;">Call +66 077 270 675</a><a href="mailto:info@noxamasamui.com" style="display:inline-block;padding:10px 14px;background:#b3822f;color:#fff;border-radius:8px;text-decoration:none;">Email info@noxamasamui.com</a></div>
      </div>`, "Large party request");
      // reset guests to 1 afterwards (so times update for a valid guests value)
      setTimeout(()=>{ document.getElementById('rGuests').value = '1'; updateTimes(); }, 10);
      return;
    }

    // update times from /api/slots (only allowed times shown)
    await updateTimes();

    // then check admin notices for this date
    try {
      const resp = await fetch(`/api/notices?date=${encodeURIComponent(date)}`, {cache:"no-store"});
      if(resp.ok){
        const j = await resp.json().catch(()=>null);
        if(j && j.message){
          // friendly message in modal (admin-provided)
          showNotice(j.message, j.title || "Important information");
        }
      }
    } catch(e){ console.error("notice check error", e); }
  }

  // updateTimes same logic as before but will only show allowed times
  async function updateTimes(){
    const date = document.getElementById('rDate').value;
    const guests = Number(document.getElementById('rGuests').value || 1);
    const sel = document.getElementById('rTime');
    sel.innerHTML = '';

    if (!date) return;

    try{
      const r = await fetch(`/api/slots?date=${encodeURIComponent(date)}&guests=${encodeURIComponent(guests)}`);
      const slots = await r.json();
      const allowed = Array.isArray(slots) ? slots.filter(s => s.allowed) : [];
      if (allowed.length === 0) {
        // friendly unified message (keeps existing behaviour)
        showNotice(`This date is not available. Please choose another date.`, "Reservation not possible");
        return;
      }
      allowed.forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s.time;
        opt.textContent = s.time;
        sel.appendChild(opt);
      });
    }catch(e){ console.error("updateTimes", e); }
  }

  // init and event hooks
  document.getElementById("rDate").addEventListener("change", onDateOrGuestsChanged);
  document.getElementById("rGuests").addEventListener("change", onDateOrGuestsChanged);
  // initial load
  onDateOrGuestsChanged();

  // reserve button behaviour (kept same as before, minimal)
  document.getElementById('btnReserve').addEventListener('click', async ()=>{
    const payload = {
      date: document.getElementById('rDate').value,
      time: document.getElementById('rTime').value,
      firstName: (document.getElementById('rFirst').value || "").trim(),
      name: (document.getElementById('rLast').value || "").trim(),
      email: (document.getElementById('rEmail').value || "").trim(),
      phone: (document.getElementById('rPhone').value || "").trim(),
      guests: (document.getElementById('rGuests').value === '11plus') ? 11 : Number(document.getElementById('rGuests').value || 1),
      notes: (document.getElementById('rNotes').value || "").trim()
    };
    const msg = document.getElementById('rMsg'); msg.textContent = '';

    if(!payload.firstName || !payload.name || !payload.email || !payload.guests){ msg.textContent = 'Please fill first name, last name, email and guests'; return; }

    try {
      const r = await fetch('/api/reservations', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const json = await r.json().catch(()=>({}));
      if(r.ok){
        // loyalty handling - if server returns nowUnlockedTier, show loyalty modal (existing UI)
        if(json && json.nowUnlockedTier){
          // call existing loyalty modal if present
          if(typeof showLoyaltyModal === 'function') showLoyaltyModal(json.nowUnlockedTier);
        }
        // show confirmation
        document.getElementById('confirm-title').textContent = 'Reservation received';
        document.getElementById('confirm-text').innerHTML = `Thank you. A confirmation mail was sent to <b>${payload.email}</b>.`;
        document.getElementById('confirm-ok').onclick = ()=>{ document.getElementById('confirm-modal').style.display='none'; window.location.href = '/'; };
        document.getElementById('confirm-modal').style.display = 'flex';
      } else {
        const err = (json && json.error) ? json.error : 'Error saving reservation';
        if(String(err).toLowerCase().includes('closed') || String(err).toLowerCase().includes('blocked') || String(err).toLowerCase().includes('fully booked')){
          showNotice(err, "Not available");
        } else {
          msg.textContent = err || 'Error saving reservation';
        }
      }
    } catch(e){
      console.error(e);
      msg.textContent = 'Network error';
    }
  });

</script>
</body>
</html>

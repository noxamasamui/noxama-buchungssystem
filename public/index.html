<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Table Booking — RÖSTILAND BY NOXAMA SAMUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <div class="container">
    <!-- Hero Logo -->
    <div class="hero">
      <img id="heroLogo" src="/logo-hero.png" alt="RÖSTILAND BY NOXAMA SAMUI"/>
    </div>

    <h1 class="page-title">Book a Table</h1>

    <!-- Contact card -->
    <div class="card">
      <div id="contactBox" class="contact">
        <div class="contact-item">
          <div class="contact-label">Address</div>
          <a id="venueAddressLink" href="#" target="_blank" rel="noopener">
            <span id="venueAddress"></span>
          </a>
        </div>
        <div class="contact-row">
          <div class="contact-item">
            <div class="contact-label">Phone</div>
            <a id="venuePhone" href="#"></a>
          </div>
          <div class="contact-item">
            <div class="contact-label">Email</div>
            <a id="venueEmail" href="#"></a>
          </div>
        </div>
      </div>
    </div>

    <!-- Booking form -->
    <div class="card">
      <label for="date">Date</label>
      <div class="row">
        <input id="date" type="date" />
        <button id="reload" class="btn" type="button" title="Reload slots">↻</button>
      </div>

      <label for="guests" style="margin-top:10px;">Guests</label>
      <div class="row">
        <select id="guests"></select>
        <a id="largeParty" class="btn-plain" href="#" title="Contact us for large parties">11+ guests?</a>
      </div>

      <div id="dayInfo" class="banner hidden"></div>

      <label style="margin-top:10px;">Choose a time</label>
      <div id="slots" class="slot-grid"></div>

      <div class="grid2">
        <div>
          <label>First name*</label>
          <input id="firstName" required />
        </div>
        <div>
          <label>Last name*</label>
          <input id="name" required />
        </div>
      </div>

      <label>Email*</label>
      <input id="email" type="email" required />

      <label>Phone (optional)</label>
      <input id="phone" />

      <label>Notes</label>
      <textarea id="notes" rows="3" placeholder="Allergies, seating request, occasion"></textarea>

      <div class="actions">
        <button id="book" class="btn btn-primary" type="button" disabled>Book now</button>
        <span id="msg" class="badge"></span>
      </div>
    </div>
  </div>

  <!-- Modal: generic info -->
  <div id="infoModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-body">
      <h3 id="infoTitle">Info</h3>
      <p id="infoText"></p>
      <button id="infoOk" class="btn">OK</button>
    </div>
  </div>

  <!-- Modal: booking success -->
  <div id="successModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-body">
      <h3>Thank you!</h3>
      <p>Your reservation has been received. You will get a confirmation email shortly.
        If you don’t see it, please check your spam folder.</p>
      <button id="closeSuccess" class="btn">OK</button>
    </div>
  </div>

<script>
/* ---------- helpers ---------- */
const qs = (s)=>document.querySelector(s);
const qsa = (s)=>document.querySelectorAll(s);
const todayISO = ()=>{
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
};
function openModal(id, title, text){
  if (qs("#" + id + " #infoTitle")) qs("#" + id + " #infoTitle").textContent = title || "";
  if (qs("#" + id + " #infoText"))  qs("#" + id + " #infoText").textContent  = text || "";
  qs("#" + id).classList.remove("hidden");
  document.body.classList.add("modal-open");
}
function closeModal(id){
  qs("#" + id).classList.add("hidden");
  document.body.classList.remove("modal-open");
}

/* ---------- load contact config + set hero logo ---------- */
let VENUE = { brand:"", address:"", phone:"", email:"", maxOnlineGuests:10, mailLogoUrl:"", mailHeaderUrl:"" };

fetch("/api/config").then(r=>r.json()).then(c=>{
  VENUE = c || VENUE;

  // hero logo chooses banner if available, then logo-hero, then /logo.png
  const hero = qs("#heroLogo");
  hero.src = VENUE.mailHeaderUrl || "/logo-hero.png";
  hero.onerror = ()=>{ hero.src = "/logo.png"; };

  // address link
  qs("#venueAddress").textContent = VENUE.address || "";
  const mapQ = encodeURIComponent(VENUE.address || "");
  qs("#venueAddressLink").href = mapQ ? `https://www.google.com/maps/search/?api=1&query=${mapQ}` : "#";

  // phone link
  const tel = (VENUE.phone||"").replace(/\s+/g,"");
  qs("#venuePhone").textContent = VENUE.phone || "";
  qs("#venuePhone").href = tel ? `tel:${tel}` : "#";

  // mail link
  qs("#venueEmail").textContent = VENUE.email || "";
  qs("#venueEmail").href = VENUE.email ? `mailto:${VENUE.email}` : "#";

  // 11+ mailto
  const subject = encodeURIComponent("Group booking (11+ guests)");
  qs("#largeParty").href = VENUE.email ? `mailto:${VENUE.email}?subject=${subject}` : "#";
});

/* ---------- form init ---------- */
qs("#date").value = todayISO();

// guests 1..10
const selGuests = qs("#guests");
for(let i=1;i<=10;i++){
  const o=document.createElement("option");
  o.value=String(i); o.textContent=String(i);
  selGuests.appendChild(o);
}

let selectedTime = null;

/* ---------- slots loader (only render available) ---------- */
async function loadSlots() {
  selectedTime = null;
  qs("#book").disabled = true;

  const d = qs("#date").value;
  const g = Number(qs("#guests").value || 1);

  const box = qs("#slots");
  const banner = qs("#dayInfo");
  box.innerHTML = "";                       // immer zuerst leeren

  const r = await fetch(`/api/slots?date=${encodeURIComponent(d)}&guests=${g}`);
  const data = await r.json();

  // NUR Slots rendern, die wirklich buchbar sind
  const available = (Array.isArray(data) ? data : []).filter(
    s => s && s.canReserve === true && s.allowed === true
  );

  if (available.length === 0) {
    // Keine Buttons anzeigen
    box.innerHTML = "";
    qs("#book").disabled = true;

    // Grund herausfinden für Popup
    const reasons = (data || []).map(s => String(s.reason||"")).join(" | ").toLowerCase();
    if (reasons.includes("closed on sunday")) {
      openModal("infoModal", "Closed on Sunday",
        "We are closed on Sundays. Please choose another day. Thank you for your understanding.");
    } else if (reasons.includes("fully booked for this date")) {
      openModal("infoModal", "Fully booked",
        "This date is fully booked. Please choose another day. We would love to welcome you soon.");
    } else if (reasons.includes("blocked")) {
      openModal("infoModal", "Fully booked",
        "This date is fully booked. Please choose another day. We would love to welcome you soon.");
    } else {
      openModal("infoModal", "Not available",
        "No time slots available for this date and party size. Please try another day.");
    }
    banner.classList.add("hidden");
    banner.textContent = "";
    return;
  }

  banner.classList.add("hidden");
  banner.textContent = "";

  available.forEach(s=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "slot";
    b.textContent = s.time;
    b.onclick = ()=>{
      qsa(".slot.active").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      selectedTime = s.time;
      qs("#book").disabled = false;
    };
    box.appendChild(b);
  });
}

qs("#reload").onclick = loadSlots;
qs("#date").addEventListener("change", loadSlots);
qs("#guests").addEventListener("change", loadSlots);
loadSlots();

/* ---------- friendly error mapping ---------- */
function friendlyError(e){
  if(!e) return "Something went wrong.";
  const s = String(e).toLowerCase();
  if (s.includes("sunday")) return "We are closed on Sundays. Please choose another day.";
  if (s.includes("blocked")) return "This date is fully booked. Please choose another day.";
  if (s.includes("fully")) return "We are fully booked at this time. Please select another slot.";
  if (s.includes("opening") || s.includes("closing")) return "This time is outside our opening hours.";
  return e;
}

/* ---------- booking submit ---------- */
qs("#book").onclick = async ()=>{
  const d = qs("#date").value;
  const firstName = qs("#firstName").value.trim();
  const name = qs("#name").value.trim();
  const email = qs("#email").value.trim();
  const phone = qs("#phone").value.trim();
  const guests = Number(qs("#guests").value);
  const notes = qs("#notes").value.trim();

  if(!selectedTime){
    openModal("infoModal", "Select a time", "Please choose a time slot to proceed.");
    return;
  }
  if(!firstName || !name || !email){
    openModal("infoModal", "Missing details", "Please fill in first name, last name and email.");
    return;
  }

  const payload = { date:d, time:selectedTime, firstName, name, email, phone, guests, notes };
  const r = await fetch("/api/reservations", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  if(r.ok){
    openModal("successModal");
  } else {
    const e = await r.json().catch(()=>({error:"Error"}));
    const msg = friendlyError(e.error||"Error");
    openModal("infoModal", "Booking not possible", msg);
  }
};

/* close modals */
qs("#infoOk").onclick = ()=> closeModal("infoModal");
qs("#closeSuccess").onclick = ()=> closeModal("successModal");
</script>
</body>
</html>

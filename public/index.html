<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <title>Reservation â€” RÃ–STILAND BY NOXAMA SAMUI</title>
  <link rel="stylesheet" href="/style.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* kleine lokale Styles fÃ¼r Buttons/Badges (keine Layout-Ã„nderungen) */
    .btn { cursor:pointer; padding:8px 12px; border-radius:8px; border:0; background:#b3822f; color:#fff }
    .btn-secondary { background:#fff; color:#3a2f28; border:1px solid #ddd }
    .badge { font-size:0.95rem; color:#6b5b4a }
    /* times buttons */
    .time-btn { margin:6px 6px 6px 0; padding:8px 12px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .time-btn.selected { box-shadow:0 6px 18px rgba(179,130,47,0.28); }
    /* small responsive container */
    @media (max-width:720px){ .booking-card{ padding:12px } .hero-wrap img { width:92% } }
  </style>
</head>
<body>
  <div class="hero-wrap" style="text-align:center;margin-top:18px;">
    <img id="heroBanner" class="hero-banner" alt="Logo banner" style="max-width:640px;width:76%;border-radius:12px;box-shadow:0 25px 50px rgba(0,0,0,.18);"/>
  </div>

  <div class="container">
    <h1 style="text-align:center;margin-top:8px;">Reservation â€” RÃ–STILAND BY NOXAMA SAMUI</h1>
    <p style="text-align:center;margin-top:6px;">Moo 4 Lamai Beach, 84310 Suratthani, Thailand â€¢ +66 077 270 675</p>

    <div class="card booking-card booking-compact" style="max-width:760px;margin:18px auto;padding:18px;">
      <h2>Book a table</h2>

      <div class="row date-time">
        <div style="flex:1 1 220px;">
          <label>Date</label>
          <input id="rDate" type="date"/>
        </div>
        <div style="flex:0 0 110px;">
          <label>Guests</label>
          <select id="rGuests">
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
          </select>
        </div>
        <div style="flex:0 0 140px;">
          <label>Time</label>
          <!-- rTime wird dynamisch befÃ¼llt nur mit erlaubten Zeiten -->
          <div id="timesContainer" aria-live="polite" style="min-height:36px"></div>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:12px;">
        <div>
          <label>First name</label>
          <input id="rFirst" type="text"/>
        </div>
        <div>
          <label>Last name</label>
          <input id="rLast" type="text"/>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>Email</label>
          <input id="rEmail" type="email"/>
        </div>
        <div>
          <label>Phone</label>
          <input id="rPhone" type="tel"/>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>Notes</label>
        <textarea id="rNotes" rows="2" style="width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #c8b99e;"></textarea>
      </div>

      <div style="margin-top:12px;text-align:left;">
        <button id="btnReserve" class="btn btn-primary-book" type="button">Book</button>
        <span id="rMsg" class="badge" style="margin-left:10px;"></span>
      </div>
    </div>
  </div>

  <!-- Confirmation modal (hidden) -->
  <div id="confirm-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#fff8f0;border-radius:12px;padding:18px;max-width:540px;width:92%;text-align:center;border:1px solid #e0d7c5;">
      <h3 id="confirm-title" style="margin-top:0;">Reservation confirmed</h3>
      <div id="confirm-text" style="margin:8px 0 12px 0;color:#3a2f28;"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="confirm-ok" class="btn" style="min-width:120px;">Continue</button>
      </div>
    </div>
  </div>

  <!-- Generic overlay modal used for immediate-date and loyalty -->
  <div id="__noxama_modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:99998;">
    <div id="__noxama_modal_box" style="background:#fff;border-radius:12px;padding:18px;max-width:720px;width:92%;text-align:center;border:1px solid #e0d7c5;">
      <!-- injected content -->
    </div>
  </div>

<script>
/* ---------- Helpers ---------- */

const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

function showOverlay(html, title){
  const ov = document.getElementById("__noxama_modal");
  const box = document.getElementById("__noxama_modal_box");
  box.innerHTML = "";
  if (title){
    const h = document.createElement("h3"); h.textContent = title; h.style.marginTop="0";
    box.appendChild(h);
  }
  const content = document.createElement("div"); content.innerHTML = html; box.appendChild(content);
  const btn = document.createElement("div");
  btn.style.marginTop = "14px";
  const ok = document.createElement("button");
  ok.textContent = "Alles klar";
  ok.className = "btn";
  ok.onclick = ()=> { ov.style.display = "none"; };
  btn.appendChild(ok);
  box.appendChild(btn);
  ov.style.display = "flex";
}
function hideOverlay(){ document.getElementById("__noxama_modal").style.display = "none"; }

function showConfirm(title, text, okCb){
  const m = document.getElementById("confirm-modal");
  document.getElementById("confirm-title").textContent = title;
  document.getElementById("confirm-text").innerHTML = text;
  document.getElementById("confirm-ok").onclick = ()=>{
    hideConfirm();
    if (typeof okCb === "function") okCb();
  };
  m.style.display = "flex";
}
function hideConfirm(){ document.getElementById("confirm-modal").style.display = "none"; }

/* ---------- Fill banner ---------- */
(async()=>{
  try{
    const r = await fetch('/api/config',{cache:"no-store'});
    if (!r.ok) throw new Error("no cfg");
    const cfg = await r.json();
    const hero = document.getElementById('heroBanner');
    hero.src = (cfg.mailHeaderUrl && cfg.mailHeaderUrl.trim()) ? cfg.mailHeaderUrl : ((cfg.mailLogoUrl && cfg.mailLogoUrl.trim()) ? cfg.mailLogoUrl : '/logo-hero.png');
    hero.alt = cfg.brand || 'Banner';
    hero.onerror = function(){ this.src = '/logo-hero.png'; };
  }catch(e){
    // ignore
  }
})();

/* ---------- Main booking UI logic ---------- */
const rDate = document.getElementById('rDate');
const rGuests = document.getElementById('rGuests');
const timesContainer = document.getElementById('timesContainer');
const rMsg = document.getElementById('rMsg');
const btnReserve = document.getElementById('btnReserve');

rDate.value = today();

/* Load slots from server and render only allowed times.
   If no allowed times exist -> show immediate popup (friendly).
*/
let lastLoadedDate = "";
async function loadSlotsFor(date) {
  if (!date) return;
  lastLoadedDate = date;
  timesContainer.innerHTML = ""; // clear
  rMsg.textContent = "";
  const guests = Number(rGuests.value || 1);

  try {
    const resp = await fetch(`/api/slots?date=${encodeURIComponent(date)}&guests=${encodeURIComponent(guests)}`, {cache: "no-store"});
    if (!resp.ok) throw new Error("Slots fetch failed");
    const slots = await resp.json();

    if (!Array.isArray(slots) || slots.length === 0) {
      // treat as closed/blocked â€” show friendly popup
      showOverlay(`<div style="font-family:Georgia,serif;color:#3a2f28">
        <div style="font-size:20px;margin-bottom:8px">Oh nein â€” an diesem Tag ist leider nichts verfugbar</div>
        <div>Bitte wahlen Sie ein anderes Datum. Wir freuen uns darauf, Sie bald zu begrussen.</div>
      </div>`, "Tag nicht verfugbar");
      return;
    }

    // Determine allowed slots
    const allowed = slots.filter(s => s.allowed === true);

    if (allowed.length === 0) {
      // If every slot is disallowed, show the best friendly reason
      const reasons = Array.from(new Set(slots.map(s => (s.reason || "").trim()).filter(Boolean)));
      const sundayReason = reasons.find(r => /sunday|sonntag/i.test(r));
      const chosen = sundayReason || reasons[0] || "Dieser Tag ist nicht verfugbar";
      const friendly = `<div style="font-family:Georgia,serif;color:#3a2f28">
          <div style="font-size:20px;margin-bottom:8px">Oh nein â€” an diesem Tag ist leider nichts verfugbar</div>
          <div style="margin-bottom:10px">${chosen}</div>
          <div>Bitte wahlen Sie ein anderes Datum. Wir freuen uns darauf, Sie bald zu begrussen.</div>
        </div>`;
      showOverlay(friendly, "Tag nicht verfugbar");
      return;
    }

    // Render allowed buttons only
    allowed.forEach(slot => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "time-btn";
      b.textContent = slot.time;
      b.dataset.time = slot.time;
      b.onclick = function(){
        // mark selected
        timesContainer.querySelectorAll(".time-btn").forEach(x=>x.classList.remove("selected"));
        this.classList.add("selected");
      };
      timesContainer.appendChild(b);
    });

  } catch (e) {
    console.error("loadSlotsFor error", e);
    showOverlay(`<div style="font-family:Georgia,serif;color:#3a2f28">
      <div style="font-size:18px;margin-bottom:8px">Fehler</div>
      <div>Verfugbarkeiten konnten nicht geladen werden. Bitte versuchen Sie es erneut.</div>
    </div>`,"Fehler");
  }
}

/* Trigger load on date or guest change */
rDate.addEventListener("change", ()=> loadSlotsFor(rDate.value));
rGuests.addEventListener("change", ()=> loadSlotsFor(rDate.value));

/* initial load */
loadSlotsFor(rDate.value);

/* ---------- Booking action ---------- */
btnReserve.addEventListener("click", async ()=>{
  rMsg.textContent = "";
  const selectedBtn = timesContainer.querySelector(".time-btn.selected");
  if (!selectedBtn) {
    rMsg.textContent = "Bitte wÃ¤hle eine verfÃ¼gbare Uhrzeit";
    return;
  }
  const payload = {
    date: rDate.value || today(),
    time: selectedBtn.dataset.time,
    firstName: (document.getElementById('rFirst').value || "").trim(),
    name: (document.getElementById('rLast').value || "").trim(),
    email: (document.getElementById('rEmail').value || "").trim(),
    phone: (document.getElementById('rPhone').value || "").trim(),
    guests: Number(document.getElementById('rGuests').value || 1),
    notes: (document.getElementById('rNotes').value || "").trim()
  };

  // basic client validation
  if(!payload.firstName || !payload.name || !payload.email || !payload.guests){
    rMsg.textContent = 'Bitte Vorname, Nachname, E-Mail und GÃ¤ste ausfÃ¼llen';
    return;
  }

  try {
    const resp = await fetch('/api/reservations', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const json = await resp.json().catch(()=>({}));

    if (!resp.ok) {
      const err = (json && json.error) ? json.error : "Buchung fehlgeschlagen";
      // Friendly handling: if closed/blocked/sunday/fully booked -> show modal
      if (/closed|blocked|sunday|fully booked|not available|nicht verfugbar/i.test(err)) {
        let message = "Dieser Termin ist leider nicht verfugbar. Bitte wÃ¤hlen Sie ein anderes Datum oder eine andere Uhrzeit.";
        if (/sunday|sonntag/i.test(err)) message = "Wir haben sonntags geschlossen. Bitte wÃ¤hlen Sie einen anderen Tag.";
        if (/blocked|closed/i.test(err)) message = "Dieser Tag ist gesperrt. Bitte wÃ¤hlen Sie ein anderes Datum.";
        if (/fully booked/i.test(err)) message = "Dieser Zeitpunkt ist inzwischen ausgebucht. Bitte wÃ¤hlen Sie eine andere Uhrzeit.";
        showOverlay(`<div style="font-family:Georgia,serif;color:#3a2f28">
          <div style="font-size:20px;margin-bottom:8px">${message}</div>
          <div>Wir helfen gern bei der Auswahl eines alternativen Termins.</div>
        </div>`,"Nicht verfÃ¼gbar");
        // reload slots to reflect current state (prevents stale selection)
        loadSlotsFor(rDate.value);
        return;
      }
      // otherwise show brief message inline
      rMsg.textContent = err || 'Fehler beim Speichern';
      return;
    }

    // Success - determine loyalty popup using server visitNo if present, otherwise nowUnlockedTier
    const visitNo = (json && typeof json.visitNo === "number") ? json.visitNo : null;
    let loyaltyPercent = 0;
    if (visitNo !== null) {
      if (visitNo >= 15) loyaltyPercent = 15;
      else if (visitNo >= 10) loyaltyPercent = 10;
      else if (visitNo >= 5) loyaltyPercent = 5;
    } else if (json && json.nowUnlockedTier) {
      loyaltyPercent = Number(json.nowUnlockedTier) || 0;
    }

    // If loyaltyPercent > 0 and visitNo exists in the ranges specified (5-9,10-14,15+), show celebratory modal
    if (loyaltyPercent > 0 && visitNo !== null) {
      const msgHtml = `
        <div style="font-family:Georgia,serif;color:#3a2f28">
          <div style="font-size:28px;margin-bottom:8px">ðŸŽ‰ Hurra!</div>
          <div style="font-size:18px;margin-bottom:8px">Sie haben nun <strong>${loyaltyPercent}%</strong> Loyalty-Rabatt</div>
          <div>Zeigen Sie diese Nachricht bitte beim Empfang. Vielen Dank fÃ¼r Ihre Treue!</div>
        </div>
      `;
      showOverlay(msgHtml, "Loyalty Belohnung");
      // Show confirmation modal after a short delay so user sees both
      setTimeout(()=> {
        showConfirm("Reservation erhalten", `Danke! Ihre Reservierung ist bestÃ¤tigt. Eine BestÃ¤tigung wird an <b>${payload.email}</b> gesendet.`, ()=>{ window.location.href = "/"; });
      }, 1200);
    } else {
      // Regular confirmation
      showConfirm("Reservation erhalten", `Danke! Ihre Reservierung ist bestÃ¤tigt. Eine BestÃ¤tigung wird an <b>${payload.email}</b> gesendet.`, ()=>{ window.location.href = "/"; });
    }

  } catch (err) {
    console.error("reservation post error", err);
    rMsg.textContent = 'Netzwerkfehler';
  }
});

/* ---------- Immediate date check for closed / blocked / Sunday ----------
   This also ensures user gets popup immediately after they pick a date.
   (It duplicates loadSlotsFor semantics but provides immediate friendly message
    even if user doesn't open times.)
*/
async function checkDateImmediate(date) {
  if (!date) return;
  try {
    const resp = await fetch(`/api/slots?date=${encodeURIComponent(date)}&guests=1`, {cache:"no-store"});
    if (!resp.ok) return;
    const slots = await resp.json();
    if (!Array.isArray(slots) || slots.length === 0) {
      showOverlay(`<div style="font-family:Georgia,serif;color:#3a2f28">
        <div style="font-size:20px;margin-bottom:8px">Oh nein â€” an diesem Tag ist leider nichts verfugbar</div>
        <div>Bitte wahlen Sie ein anderes Datum. Wir freuen uns darauf, Sie bald zu begrussen.</div>
      </div>`,"Tag nicht verfugbar");
      return;
    }
    const allNotAllowed = slots.every(s => s.allowed === false);
    if (allNotAllowed) {
      const reasons = Array.from(new Set(slots.map(s => (s.reason||"")).filter(Boolean)));
      const sundayReason = reasons.find(r => /sunday|sonntag/i.test(r));
      const chosen = sundayReason || reasons[0] || "Dieser Tag ist nicht verfugbar";
      const friendly = `<div style="font-family:Georgia,serif;color:#3a2f28">
          <div style="font-size:20px;margin-bottom:8px">Oh nein â€” an diesem Tag ist leider nichts verfugbar</div>
          <div style="margin-bottom:10px">${chosen}</div>
          <div>Bitte wahlen Sie ein anderes Datum. Wir freuen uns darauf, Sie bald zu begrussen.</div>
        </div>`;
      showOverlay(friendly, "Tag nicht verfugbar");
    }
  } catch(e){ console.error("checkDateImmediate", e); }
}

/* Hook date input for immediate notifications */
rDate.addEventListener("change", ()=>{
  const d = rDate.value;
  // load and also check immediate for friendly popup (they overlap but that's ok)
  loadSlotsFor(d);
  checkDateImmediate(d);
});

/* Also re-check when guests change (availability depends on guests) */
rGuests.addEventListener("change", ()=> loadSlotsFor(rDate.value));

</script>
</body>
</html>

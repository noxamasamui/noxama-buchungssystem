<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Contact and Table Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    /* Nur behutsame Styles hier – Rest kommt aus style.css (deine frühere Version) */
    body { background:#f2e8dc; } /* wie früher */
    .container{max-width:820px;margin:24px auto;padding:0 12px;}
    .logo{display:block;margin:8px auto 6px auto;width:160px;height:auto;border-radius:8px;}
    h1{font-size:40px;line-height:1.1;margin:8px 0 14px 0;}
    .card{background:#fbf6ee;border-radius:14px;padding:14px 16px;margin:16px 0;border:1px solid #e7dbc8;}
    .slot-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
    @media (max-width:720px){ .slot-grid{grid-template-columns:repeat(4,1fr)} }
    @media (max-width:480px){ .slot-grid{grid-template-columns:repeat(3,1fr)} }
    .slot{border-radius:10px;border:1px solid #cdbba3;padding:8px 0;background:#fff;cursor:pointer}
    .slot:hover{background:#f5efe6}
    .slot.active{background:#b08956;color:#fff;border-color:#b08956}
    .slot.disabled{opacity:.45;cursor:not-allowed;background:#eee}
    .row{display:flex;gap:10px;align-items:center}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input,select,textarea{width:100%;border:1px solid #cdbba3;border-radius:8px;padding:9px;background:#fff}
    label{display:block;margin:8px 0 4px 0}
    .btn{background:#b08956;border:none;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .badge{display:inline-block;background:#f8e7cf;border:1px solid #e7d6bd;border-radius:10px;padding:6px 10px;margin-left:8px}
    .banner{background:#fde7e7;border:1px solid #f1c9c9;border-radius:10px;padding:10px 12px;margin:8px 0}
    .hidden{display:none}
    nav{margin:6px 0 14px 0}
    nav a{margin-right:10px;color:#6d5a49}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center}
    .modal.hidden{display:none}
    .modal-body{width:min(560px,92vw);background:#fff;border-radius:14px;padding:16px 18px}
  </style>
</head>
<body>
<div class="container">
  <img class="logo" src="/logo.png" alt="Logo"/>
  <h1>Contact and Table Booking</h1>

  <div class="card">
    <div id="contactBox" class="contact">
      <p><b>Address</b><br/><span id="venueAddress"></span></p>
      <p><b>Phone</b> <a id="venuePhoneLink" href="#"><span id="venuePhone"></span></a><br/>
         <b>Email</b> <a id="venueEmailLink" href="#"><span id="venueEmail"></span></a></p>
    </div>
  </div>

  <div class="card">
    <label>Date</label>
    <div class="row">
      <input id="date" type="date"/>
      <button id="reload" class="btn" type="button">↻</button>
    </div>

    <label style="margin-top:10px;">Choose a time slot (15 minutes grid)</label>
    <div id="dayInfo" class="banner hidden"></div>
    <div id="slots" class="slot-grid"></div>

    <div class="grid2" style="margin-top:10px;">
      <div>
        <label>First name*</label>
        <input id="firstName" required />
      </div>
      <div>
        <label>Name*</label>
        <input id="name" required />
      </div>
    </div>

    <label>Email*</label>
    <input id="email" type="email" required />

    <label>Phone (optional)</label>
    <input id="phone" />

    <label>Guests* <span class="badge">max 10 online</span></label>
    <select id="guests"></select>
    <button id="groupBtn" class="btn" type="button" style="margin-top:6px;">Group 11+?</button>

    <label>Notes</label>
    <textarea id="notes" rows="3" placeholder="Allergies, seating request, occasion"></textarea>

    <div class="row" style="margin-top:12px;">
      <button id="book" class="btn" type="button">Book now</button>
      <span id="msg" class="badge"></span>
    </div>
  </div>
</div>

<!-- Thank-you modal -->
<div id="modal" class="modal hidden">
  <div class="modal-body">
    <h3>Thank you!</h3>
    <p>Your reservation has been received. You will get a confirmation email shortly. Please also check your spam folder.</p>
    <button id="closeModal" class="btn">OK</button>
  </div>
</div>

<script>
const todayISO = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

fetch("/api/config").then(r=>r.json()).then(c=>{
  document.getElementById("venueAddress").textContent = c.address || "";
  document.getElementById("venuePhone").textContent = c.phone || "";
  document.getElementById("venueEmail").textContent = c.email || "";
  if(c.phone){ const a=document.getElementById("venuePhoneLink"); a.href = `tel:${c.phone.replace(/[^+\d]/g,'')}`; }
  if(c.email){ const a=document.getElementById("venueEmailLink"); a.href = `mailto:${c.email}`; }
});

document.getElementById("date").value = todayISO();
for(let i=1;i<=10;i++){ const o=document.createElement("option"); o.value=o.textContent=String(i); document.getElementById("guests").appendChild(o); }
document.getElementById("groupBtn").onclick = ()=>{ window.location.href = "mailto:info@noxamasamui.com?subject=Group%20reservation%20(11%2B)"; };

let selectedTime = null;

async function loadSlots(){
  selectedTime = null;
  const d = document.getElementById("date").value;
  const r = await fetch(`/api/slots?date=${encodeURIComponent(d)}`);
  const data = await r.json();
  const box = document.getElementById("slots");
  const banner = document.getElementById("dayInfo");
  box.innerHTML = "";

  // Nachricht bei Sonntag / Blockierung / voll
  const anyAllowed = data.some(s => s.allowed);
  const anyReservable = data.some(s => s.allowed && s.canReserve);
  const isAllBlocked = data.length && data.every(s => s.reason === "Blocked");
  const isSunday = data.length && data.every(s => s.reason === "Sunday closed");

  if(isSunday){
    banner.textContent = "We are closed on Sundays.";
    banner.classList.remove("hidden");
  } else if (isAllBlocked){
    banner.textContent = "We are fully booked on this date. Please choose another day.";
    banner.classList.remove("hidden");
  } else if (anyAllowed && !anyReservable){
    banner.textContent = "No available time slots for your party on this date. Please choose another time or day.";
    banner.classList.remove("hidden");
  } else {
    banner.classList.add("hidden");
    banner.textContent = "";
  }

  data.forEach(s=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "slot " + (s.allowed && s.canReserve ? "" : "disabled");
    b.textContent = s.time;
    if (s.allowed && s.canReserve) {
      b.onclick = ()=>{
        document.querySelectorAll(".slot.active").forEach(x=>x.classList.remove("active"));
        b.classList.add("active"); selectedTime = s.time;
      };
    } else {
      b.title = s.reason || "Not available";
    }
    box.appendChild(b);
  });
}
document.getElementById("reload").onclick = loadSlots;
document.getElementById("date").addEventListener("change", loadSlots);
loadSlots();

function friendlyError(e){
  if(!e) return "Something went wrong.";
  const x=e.toLowerCase();
  if(x.includes("sunday")) return "We are closed on Sundays.";
  if(x.includes("block")) return "We are fully booked on this date. Please choose another day.";
  if(x.includes("reservationsplätze")||x.includes("fully")) return "We are fully booked at this time. Please select another slot.";
  if(x.includes("before")||x.includes("open")) return "This time is outside our opening hours.";
  return e;
}

document.getElementById("book").onclick = async ()=>{
  const d = document.getElementById("date").value;
  const firstName = document.getElementById("firstName").value.trim();
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const guests = Number(document.getElementById("guests").value);
  const notes = document.getElementById("notes").value.trim();
  const m = document.getElementById("msg");

  if(!selectedTime){ m.textContent="Please select a time slot"; return; }
  if(!firstName || !name || !email){ m.textContent="Please fill in all required fields"; return; }

  // Button gegen Doppel-Click sperren
  const btn = document.getElementById("book");
  btn.disabled = true; m.textContent = "";

  const payload = { date:d, time:selectedTime, firstName, name, email, phone, guests, notes };
  const r = await fetch("/api/reservations", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  if(r.ok){
    document.getElementById("modal").classList.remove("hidden");
  }else{
    const e = await r.json().catch(()=>({error:"Error"}));
    m.textContent = friendlyError(e.error||"Error");
    btn.disabled = false;
  }
};

document.getElementById("closeModal").onclick = ()=>{
  document.getElementById("modal").classList.add("hidden");
  // Seite bleibt offen (wichtig für eingebettete Nutzung)
};
</script>
</body>
</html>

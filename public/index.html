<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Reservation â€” RÃ–STILAND BY NOXAMA SAMUI</title>
  <link rel="stylesheet" href="/style.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* small style tweaks for modal + form harmony */
    body { background: #d9c8b0; font-family: Georgia, "Times New Roman", serif; color:#3a2f28; }
    .hero-wrap { text-align:center; margin-top:18px; }
    .hero-banner { max-width:640px; width:76%; border-radius:12px; box-shadow:0 25px 50px rgba(0,0,0,.18); }

    .container { max-width:980px; margin:18px auto; padding:0 14px; }
    .card { background: linear-gradient(180deg,#fffaf6,#fff3e8); border-radius:10px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,0.12); border:1px solid rgba(200,170,130,0.16); }
    h1,h2 { margin:0 0 8px 0; text-align:center; }
    label { font-weight:600; display:block; margin-bottom:6px; }
    input, select, textarea { width:100%; box-sizing:border-box; padding:10px; border-radius:8px; border:1px solid #d9c2a8; background:#fff; }
    .row { display:flex; gap:12px; align-items:center; }
    .date-time .row > div { flex:1; }
    .form-grid-2 .row > div { flex:1; }
    .btn { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; background:#b3822f; color:#fff; font-weight:700; }
    .btn-primary-book { background:#b3822f; box-shadow:0 4px 10px rgba(0,0,0,.12); }

    .badge { display:inline-block; background:#fff3df; padding:6px 10px; border-radius:8px; border:1px solid #ead6b6; color:#3a2f28; }

    /* Modal styles */
    .nox-modal-overlay {
      position: fixed; inset: 0; background: rgba(8,6,4,0.4); display:flex; align-items:center; justify-content:center; z-index:99999; backdrop-filter: blur(3px);
    }
    .nox-modal {
      width: min(880px, 94%); border-radius:12px; overflow:hidden; box-shadow:0 30px 60px rgba(0,0,0,0.45);
      background: linear-gradient(180deg,#fffaf6,#fff3e8); border:1px solid rgba(200,170,130,0.18); color:#3a2f28; font-family: Georgia, serif;
    }
    .nox-modal .modal-body { padding:18px; text-align:center; position:relative; }
    .nox-modal h2 { margin:4px 0 8px 0; font-size:26px; }
    .nox-fireworks { width:100%; height:260px; position:relative; overflow:hidden; background: radial-gradient(circle at 10% 10%, rgba(255,243,230,0.18), transparent 10%); }
    .nox-reward-panel { display:inline-block; background: linear-gradient(180deg,#fff6ea,#fff0db); border-radius:10px; padding:12px 18px; border:1px solid rgba(214,187,147,0.6); box-shadow: inset 0 1px 0 rgba(255,255,255,0.6); margin-top:8px; }
    .close-x { position:absolute; right:12px; top:12px; background:rgba(0,0,0,0.06); border-radius:8px; padding:6px 8px; cursor:pointer; border:none; }
    @media (max-width:520px){ .nox-fireworks{height:160px;} .nox-modal h2{font-size:20px;} }
  </style>
</head>
<body>
  <div class="hero-wrap">
    <img id="heroBanner" class="hero-banner" src="/logo-hero.png" alt="Logo banner" />
  </div>

  <div class="container">
    <h1>Reservation â€” RÃ–STILAND BY NOXAMA SAMUI</h1>
    <p style="text-align:center;margin-top:6px;">Moo 4 Lamai Beach, 84310 Suratthani, Thailand â€¢ +66 077 270 675</p>

    <div class="card booking-card booking-compact" style="max-width:760px;margin:18px auto;padding:18px;">
      <h2>Book a table</h2>

      <div class="row date-time" style="margin-top:12px;">
        <div style="flex:1 1 220px;">
          <label for="rDate">Date</label>
          <input id="rDate" type="date"/>
        </div>
        <div style="flex:0 0 110px;">
          <label for="rGuests">Guests</label>
          <select id="rGuests">
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
          </select>
        </div>
        <div style="flex:0 0 170px;">
          <label for="rTime">Time</label>
          <select id="rTime"><option>Loadingâ€¦</option></select>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:12px;">
        <div>
          <label for="rFirst">First name</label>
          <input id="rFirst" type="text"/>
        </div>
        <div>
          <label for="rLast">Last name</label>
          <input id="rLast" type="text"/>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:12px;">
        <div>
          <label for="rEmail">Email</label>
          <input id="rEmail" type="email"/>
        </div>
        <div>
          <label for="rPhone">Phone</label>
          <input id="rPhone" type="tel"/>
        </div>
      </div>

      <div style="margin-top:12px;">
        <label for="rNotes">Notes</label>
        <textarea id="rNotes" rows="2" style="width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #c8b99e;"></textarea>
      </div>

      <div style="margin-top:12px;text-align:left;">
        <button id="btnReserve" class="btn btn-primary-book" type="button">Book</button>
        <span id="rMsg" class="badge" style="margin-left:10px;"></span>
      </div>
    </div>
  </div>

  <!-- Confirmation modal (used for generic messages) -->
  <div id="confirm-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#fff8f0;border-radius:12px;padding:18px;max-width:420px;width:92%;text-align:center;border:1px solid #e0d7c5;">
      <h3 id="confirm-title" style="margin-top:0;">Reservation confirmed</h3>
      <div id="confirm-text" style="margin:8px 0 12px 0;color:#3a2f28;"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="confirm-ok" class="btn" style="min-width:120px;">Okay</button>
      </div>
    </div>
  </div>

<script>
  // helper: today string yyyy-mm-dd
  const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

  // fill banner from /api/config
  (async()=>{
    try{
      const r = await fetch('/api/config', {cache:"no-store'});
      if (!r.ok) return;
      const cfg = await r.json();
      const hero = document.getElementById('heroBanner');
      hero.src = cfg.mailHeaderUrl && cfg.mailHeaderUrl.trim() ? cfg.mailHeaderUrl : (cfg.mailLogoUrl && cfg.mailLogoUrl.trim() ? cfg.mailLogoUrl : '/logo-hero.png');
      hero.alt = cfg.brand || 'Banner';
    }catch(e){ console.error("cfg", e); }
  })();

  // initial values
  const dateInput = document.getElementById('rDate');
  const guestsSelect = document.getElementById('rGuests');
  const timeSelect = document.getElementById('rTime');
  const reserveBtn = document.getElementById('btnReserve');
  const msgBox = document.getElementById('rMsg');

  dateInput.value = today();

  // fillTimes skeleton (used only if slots endpoint fails)
  function fillTimesFallback() {
    timeSelect.innerHTML = '';
    const from = 10*60, to = 22*60, interval = 15;
    for(let m=from;m<to;m+=interval){
      const hh=String(Math.floor(m/60)).padStart(2,"0");
      const mm=String(m%60).padStart(2,"0");
      const opt = document.createElement('option'); opt.value = `${hh}:${mm}`; opt.textContent = `${hh}:${mm}`; timeSelect.appendChild(opt);
    }
  }

  // Core: fetch slots for selected date and guests and populate timeSelect with only allowed times
  async function refreshSlotsAndPopulate(date, guests) {
    timeSelect.innerHTML = '<option>Loadingâ€¦</option>';
    try{
      const resp = await fetch(`/api/slots?date=${encodeURIComponent(date)}&guests=${encodeURIComponent(guests)}`, {cache:"no-store"});
      if (!resp.ok) { fillTimesFallback(); return; }
      const slots = await resp.json();
      if (!Array.isArray(slots)) { fillTimesFallback(); return; }

      // if all slots disallowed -> show immediate modal and clear times
      const anyAllowed = slots.some(s => s.allowed === true);
      if (!anyAllowed) {
        timeSelect.innerHTML = '';
        // pick representative reason
        const reasons = Array.from(new Set(slots.map(s=>s.reason||"").filter(Boolean)));
        const reason = reasons.find(r=>/sunday/i.test(r)) || reasons[0] || 'This date is not available';
        // friendly modal
        showNiceModal("Reservation not possible", `
          <div style="font-family:Georgia,serif;color:#3a2f28;">
            <div style="font-size:20px;margin-bottom:8px;">Oh no â€” this day is not available</div>
            <div style="margin-bottom:10px;">${reason}</div>
            <div>Please pick another day â€” we would love to welcome you.</div>
          </div>
        `);
        return;
      }

      // otherwise show only allowed times (no remaining counts)
      timeSelect.innerHTML = '';
      for(const s of slots){
        if (s.allowed === true) {
          const opt = document.createElement('option');
          opt.value = s.time;
          opt.textContent = s.time; // purposely do not show counts
          timeSelect.appendChild(opt);
        }
      }

      // if no option added (fallback)
      if (!timeSelect.options.length) fillTimesFallback();
    }catch(e){
      console.error("refreshSlots", e);
      fillTimesFallback();
    }
  }

  // initial population and on change
  refreshSlotsAndPopulate(dateInput.value, guestsSelect.value);

  dateInput.addEventListener("change", ()=> refreshSlotsAndPopulate(dateInput.value, guestsSelect.value));
  guestsSelect.addEventListener("change", ()=> refreshSlotsAndPopulate(dateInput.value, guestsSelect.value));

  // helper nice modal (for closed/blocked)
  function showNiceModal(title, htmlContent){
    // remove if present
    const ex = document.getElementById("__nox_nice_modal");
    if (ex) ex.remove();

    const overlay = document.createElement('div');
    overlay.id = "__nox_nice_modal";
    overlay.className = 'nox-modal-overlay';

    const modal = document.createElement('div');
    modal.className = 'nox-modal';
    modal.innerHTML = `
      <button class="close-x" aria-label="close">âœ•</button>
      <div class="nox-fireworks" style="height:120px;background:transparent;"></div>
      <div class="modal-body">
        <h2>${title}</h2>
        <div class="sub" style="margin-bottom:6px;"></div>
        <div style="font-size:15px;color:#4b3b2f;margin-bottom:8px;"></div>
        <div style="margin-top:6px;">${htmlContent}</div>
        <div style="margin-top:14px;"><button class="btn" id="__nox_modal_ok">Okay</button></div>
      </div>
    `;
    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    modal.querySelector('.close-x').onclick = ()=> overlay.remove();
    modal.querySelector('#__nox_modal_ok').onclick = ()=> overlay.remove();
  }

  // confirmation modal helpers
  function showConfirmModal(title, text, onOkRedirect=false) {
    const cm = document.getElementById('confirm-modal');
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-text').innerHTML = text;
    cm.style.display = 'flex';
    document.getElementById('confirm-ok').onclick = ()=> {
      cm.style.display = 'none';
      if (onOkRedirect) window.location.href = '/';
    };
  }

  // Loyalty modal + fireworks (denser, faster, colorful)
  function createLoyaltyModal(tier, visitNo){
    // remove existing
    const ex = document.getElementById("__nox_loyalty");
    if (ex) ex.remove();

    const overlay = document.createElement("div");
    overlay.id = "__nox_loyalty";
    overlay.className = "nox-modal-overlay";

    const modal = document.createElement("div");
    modal.className = "nox-modal";
    modal.innerHTML = `
      <button class="close-x" aria-label="close">âœ•</button>
      <div class="nox-fireworks" id="__nox_fireworks_canvas_wrap" style="height:200px"></div>
      <div class="modal-body">
        <h2>You earned a loyalty reward</h2>
        <div class="sub">ðŸŽ‰ Congratulations â€” loyalty reward unlocked!</div>
        <div style="font-size:15px;color:#4b3b2f;margin-bottom:8px;">You just reached visit ${visitNo}</div>
        <div class="nox-reward-panel"><div style="font-size:20px;"><strong>Enjoy a ${tier}% thank-you discount on your next visit</strong></div></div>
        <div class="small-note">We applied a note to your profile. Thank you for your loyalty.</div>
        <div style="margin-top:14px;"><button class="btn" id="__nox_ok_btn">Okay</button></div>
      </div>
    `;
    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    modal.querySelector(".close-x").onclick = ()=> overlay.remove();
    modal.querySelector("#__nox_ok_btn").onclick = ()=> overlay.remove();

    const wrap = document.getElementById("__nox_fireworks_canvas_wrap");
    initFireworks(wrap);
  }

  // Fireworks implementation (dense, colorful)
  function initFireworks(container){
    while(container.firstChild) container.removeChild(container.firstChild);
    const c = document.createElement("canvas");
    c.style.position = "absolute"; c.style.left = 0; c.style.top = 0; c.width = container.clientWidth; c.height = container.clientHeight;
    container.appendChild(c);
    const ctx = c.getContext("2d");
    if(!ctx) return;

    let W = c.width, H = c.height;
    function resize(){ c.width = container.clientWidth; c.height = container.clientHeight; W = c.width; H = c.height; }
    window.addEventListener("resize", resize);

    const colors = ['#ff3b30','#ff9500','#ffcc00','#4cd964','#32a7ff','#5856d6','#ff6bcb','#ffd54f','#8d6e63','#9c27b0','#00bfa5','#ff7043'];

    class Particle {
      constructor(x,y,vx,vy,size,color,life,type){
        this.x=x; this.y=y; this.vx=vx; this.vy=vy; this.size=size; this.color=color; this.life=life; this.age=0; this.type=type || 'spark';
        this.rotation = Math.random()*360; this.spin = (Math.random()-0.5)*6;
      }
      update(dt){
        this.vy += 0.06; this.x+=this.vx*dt; this.y+=this.vy*dt; this.age += dt*18; this.rotation += this.spin*dt*40;
      }
      draw(ctx){
        ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.rotation*Math.PI/180);
        const alpha = Math.max(0, 1 - this.age/this.life);
        ctx.globalAlpha = alpha;
        if (this.type==='spark') {
          ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(0,0,this.size,0,Math.PI*2); ctx.fill();
        } else {
          ctx.fillStyle = this.color; ctx.fillRect(-this.size/2, -this.size/2, this.size, this.size*0.6);
        }
        ctx.restore();
      }
    }

    const particles = [];
    let last = performance.now();
    let running = true;

    function spawnBurst(x,y,power=1){
      const count = 60 + Math.floor(140 * power);
      for(let i=0;i<count;i++){
        const angle = Math.random()*Math.PI*2;
        const speed = 2 + Math.random()*8*power;
        const vx = Math.cos(angle)*speed; const vy = Math.sin(angle)*speed*0.6;
        const size = 2 + Math.random()*5; const color = colors[Math.floor(Math.random()*colors.length)];
        const life = 800 + Math.random()*1600;
        particles.push(new Particle(x,y,vx,vy,size,color,life,'spark'));
      }
      for(let i=0;i<28;i++){
        const vx = (Math.random()-0.5)*6; const vy = -1 - Math.random()*6; const size = 6 + Math.random()*12; const color = colors[Math.floor(Math.random()*colors.length)];
        particles.push(new Particle(x,y,vx,vy,size,color,1200,'confetti'));
      }
    }

    function tick(now){
      const dt = Math.min(60, now-last)/16; last = now;
      // glow fade
      ctx.fillStyle = 'rgba(8,6,4,0.12)'; ctx.fillRect(0,0,W,H);
      for(let i=particles.length-1;i>=0;i--){
        const p = particles[i]; p.update(dt); p.draw(ctx);
        if (p.age > p.life || p.y > H+40) particles.splice(i,1);
      }
      // auto bursts for lively effect
      if (running && particles.length < 160 && Math.random() < 0.05) spawnBurst(60 + Math.random()*(W-120), 40 + Math.random()*H*0.5, 0.8 + Math.random()*1.4);
      if (running) requestAnimationFrame(tick);
    }

    // initial heavy show
    (function initial(){
      spawnBurst(W*0.5, H*0.35, 1.8);
      setTimeout(()=> spawnBurst(W*0.35, H*0.22, 1.2), 140);
      setTimeout(()=> spawnBurst(W*0.65, H*0.28, 1.3), 240);
      let i=0; const iv = setInterval(()=>{ spawnBurst(80 + Math.random()*(W-160), 40 + Math.random()*H*0.45, 0.6 + Math.random()*0.8); i++; if(i>10) clearInterval(iv); }, 120);
    })();

    requestAnimationFrame(tick);
    // auto stop
    setTimeout(()=>{ running=false; window.removeEventListener("resize", resize); setTimeout(()=>{ if(c.parentNode) c.parentNode.removeChild(c); },600); }, 7000);
  }

  // Reserve button handler: sends to /api/reservations, shows loyalty modal when server indicates nowUnlockedTier
  reserveBtn.addEventListener("click", async ()=>{
    msgBox.textContent = '';
    const payload = {
      date: dateInput.value || today(),
      time: timeSelect.value,
      firstName: (document.getElementById('rFirst').value || "").trim(),
      name: (document.getElementById('rLast').value || "").trim(),
      email: (document.getElementById('rEmail').value || "").trim(),
      phone: (document.getElementById('rPhone').value || "").trim(),
      guests: Number(guestsSelect.value || 1),
      notes: (document.getElementById('rNotes').value || "").trim()
    };
    if(!payload.firstName || !payload.name || !payload.email || !payload.guests){
      msgBox.textContent = 'Please fill first name, last name, email and guests';
      return;
    }
    try{
      const r = await fetch('/api/reservations', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const json = await r.json().catch(()=>({}));
      if (r.ok){
        // success
        // if loyalty unlocked show the big modal with fireworks
        const unlocked = json && (json.nowUnlockedTier || json.nowUnlockedTier === 0 ? json.nowUnlockedTier : (json.discount || 0));
        // if server returns nowUnlockedTier value 5/10/15 -> show modal
        if (json && (json.nowUnlockedTier === 5 || json.nowUnlockedTier === 10 || json.nowUnlockedTier === 15)) {
          createLoyaltyModal(json.nowUnlockedTier, json.visitNo || 0);
          // after small delay show confirmation modal as well
          setTimeout(()=> showConfirmModal('Reservation received', `Thank you! Your reservation is confirmed. A confirmation mail will be sent to <b>${payload.email}</b>. Please check your spam folder.`, true), 900);
        } else {
          showConfirmModal('Reservation received', `Thank you! Your reservation is confirmed. A confirmation mail will be sent to <b>${payload.email}</b>. Please check your spam folder.`, true);
        }
      } else {
        // server responded with error; handle closed/blocked specially
        const err = (json && json.error) ? String(json.error) : 'Failed to create reservation';
        if (/sunday/i.test(err) || /closed/i.test(err) || /blocked/i.test(err) || /fully booked/i.test(err)) {
          const reason = err;
          showNiceModal("Not available", `<div style="font-family:Georgia,serif;color:#3a2f28;">${reason}<div style="margin-top:8px;">Please select another date.</div></div>`);
          // refresh slots to reflect server truth
          refreshSlotsAndPopulate(dateInput.value, guestsSelect.value);
        } else {
          msgBox.textContent = err;
        }
      }
    }catch(e){
      console.error("reservation post error", e);
      msgBox.textContent = 'Network error';
    }
  });

  // ensure times are refreshed on load as well
  window.addEventListener('load', ()=> refreshSlotsAndPopulate(dateInput.value, guestsSelect.value));
</script>
</body>
</html>

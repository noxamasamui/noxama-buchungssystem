<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Reservation — ROESTILAND BY NOXAMA SAMUI</title>
  <link rel="stylesheet" href="/style.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
/* mobile fix: time field smaller on phones */
@media (max-width: 520px) {
  .date-time { display:flex; gap:10px; flex-wrap:wrap; }

  .date-time > div:nth-child(1) { flex: 1 1 100%; }

  .date-time > div:nth-child(2),
  .date-time > div:nth-child(3) {
    flex: 0 0 auto;
    min-width: 92px;
    max-width: 140px;
  }

  #rTime, #rGuests {
    font-size: 15px;
    padding: 8px 10px;
    height: 42px;
    border-radius: 8px;
    box-sizing: border-box;
  }

  #rDate {
    padding: 12px 14px;
    height: 48px;
    font-size: 16px;
    border-radius: 10px;
  }
}
</style>

</head>
<body>

  <div class="hero-wrap" style="text-align:center;margin-top:18px;">
    <img id="heroBanner" class="hero-banner"
         alt="Logo banner"
         style="max-width:640px;width:76%;border-radius:12px;box-shadow:0 25px 50px rgba(0,0,0,.18);" />
  </div>

  <div class="container">
    <h1 style="text-align:center;margin-top:8px;">Reservation — ROESTILAND BY NOXAMA SAMUI</h1>
    <p style="text-align:center;margin-top:6px;">
      Moo 4 Lamai Beach, 84310 Suratthani, Thailand • +66 077 270 675
    </p>

    <div class="card booking-card booking-compact"
         style="max-width:760px;margin:18px auto;padding:18px;">
      <h2>Book a table</h2>

      <div class="row date-time">
        <div style="flex:1 1 220px;">
          <label>Date</label>
          <input id="rDate" type="date"/>
        </div>

        <div style="flex:0 0 110px;">
          <label>Guests</label>
          <select id="rGuests">
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
            <option value="11plus">11+</option>
          </select>
        </div>

        <div style="flex:0 0 140px;">
          <label>Time</label>
          <select id="rTime"></select>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>First name</label>
          <input id="rFirst" type="text"/>
        </div>
        <div>
          <label>Last name</label>
          <input id="rLast" type="text"/>
        </div>
      </div>

      <div class="row form-grid-2" style="margin-top:6px;">
        <div>
          <label>Email</label>
          <input id="rEmail" type="email"/>
        </div>
        <div>
          <label>Phone</label>
          <input id="rPhone" type="tel"/>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>Notes</label>
        <textarea id="rNotes" rows="2"
          style="width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #c8b99e;"></textarea>
      </div>

      <div style="margin-top:12px;text-align:left;">
        <button id="btnReserve" class="btn btn-primary-book" type="button">Book</button>
        <span id="rMsg" class="badge" style="margin-left:10px;"></span>
      </div>
    </div>
  </div>

  <div id="confirm-modal"
       style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);
              align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#fff8f0;border-radius:12px;padding:18px;max-width:420px;
                width:92%;text-align:center;border:1px solid #e0d7c5;">
      <h3 id="confirm-title" style="margin-top:0;">Reservation confirmed</h3>
      <div id="confirm-text" style="margin:8px 0 12px 0;color:#3a2f28;"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="confirm-ok" class="btn" style="min-width:120px;">Continue</button>
      </div>
    </div>
  </div>

<script>
const today = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };

(async()=>{
  try {
    const r = await fetch('/api/config');
    const cfg = await r.json();
    const hero = document.getElementById('heroBanner');
    hero.src = cfg.mailHeaderUrl || cfg.mailLogoUrl || '/logo-hero.png';
    hero.alt = cfg.brand || 'Banner';
  } catch(e) {}
})();

document.getElementById('rDate').value = today();

async function updateTimes() {
  const date = document.getElementById('rDate').value;
  const guests = document.getElementById('rGuests').value;

  if (guests === "11plus") {
    showModal(`
      For parties of 11 or more please contact us directly.
      <br><br>
      <a href="tel:+66077270675" class="btn">Call +66 077 270 675</a>
      <a href="mailto:info@noxamasamui.com" class="btn">Email info@noxamasamui.com</a>
    `, "Large party request");
    return;
  }

  const sel = document.getElementById('rTime');
  sel.innerHTML = '';

  if (!date) return;

  const r = await fetch(`/api/slots?date=${date}&guests=${guests}`);
  const slots = await r.json();
  const allowed = slots.filter(s => s.allowed);

  if (allowed.length === 0) {
    showModal(`This date is not available. Please choose another date.`, "Reservation not possible");
    return;
  }

  allowed.forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s.time;
    opt.textContent = s.time;
    sel.appendChild(opt);
  });
}

document.getElementById("rDate").addEventListener("change", updateTimes);
document.getElementById("rGuests").addEventListener("change", updateTimes);
updateTimes();


document.getElementById('btnReserve').addEventListener('click', async ()=>{

  if (document.getElementById('rGuests').value === "11plus") return;

  const payload = {
    date: document.getElementById('rDate').value,
    time: document.getElementById('rTime').value,
    firstName: document.getElementById('rFirst').value.trim(),
    name: document.getElementById('rLast').value.trim(),
    email: document.getElementById('rEmail').value.trim(),
    phone: document.getElementById('rPhone').value.trim(),
    guests: Number(document.getElementById('rGuests').value),
    notes: document.getElementById('rNotes').value.trim()
  };

  try {
    const r = await fetch('/api/reservations', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });

    const json = await r.json();

    if (r.ok) {

      if (json.nowUnlockedTier)
        showLoyaltyModal(json.nowUnlockedTier);

      const title = document.getElementById('confirm-title');
      const txt = document.getElementById('confirm-text');
      title.textContent = "Reservation received";
      txt.innerHTML = `Thank you. A confirmation mail was sent to <b>${payload.email}</b>.`;

      document.getElementById('confirm-ok').onclick = ()=>{ hideConfirmModal(); window.location.href="/"; };
      showConfirmModal();

    } else {
      const err = json.error?.toLowerCase() || "";
      if (err.includes("blocked") || err.includes("closed"))
        showModal("This day is not available. Please choose another date.","Reservation not possible");
    }

  } catch(e) {
    document.getElementById('rMsg').textContent = "Network error";
  }
});

function showConfirmModal(){ document.getElementById('confirm-modal').style.display = 'flex'; }
function hideConfirmModal(){ document.getElementById('confirm-modal').style.display = 'none'; }

function showModal(content, title="") {
  const ex = document.getElementById("__modal");
  if (ex) ex.remove();

  const o = document.createElement("div");
  o.id = "__modal";
  o.style = "position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:99999;";

  const box = document.createElement("div");
  box.style = "background:#fff8f0;border-radius:12px;padding:18px;max-width:520px;width:92%;text-align:center;border:1px solid #e0d7c5;";

  box.innerHTML = `${title ? `<h3>${title}</h3>`:""}<div>${content}</div>
      <button style="margin-top:14px;padding:10px 18px;border:none;border-radius:8px;background:#b3822f;color:#fff;">OK</button>`;

  box.querySelector("button").onclick = ()=> o.remove();
  o.appendChild(box);
  document.body.appendChild(o);
}


/* Loyalty modal + fullscreen fireworks */
function showLoyaltyModal(tier){
  const ex = document.getElementById("__loyalty");
  if (ex) ex.remove();

  const o = document.createElement("div");
  o.id = "__loyalty";
  o.style = "position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:999999;";

  const box = document.createElement("div");
  box.style = "background:#d6c7b2;border-radius:12px;max-width:520px;width:92%;padding:18px;text-align:center;border:1px solid #bcae9a;position:relative;overflow:hidden;";

  box.innerHTML = `
      <h2>You earned a loyalty reward</h2>
      <p>Congratulations — loyalty reward unlocked!</p>
      <p>You just reached visit ${tier}</p>
      <p style="font-size:18px;">Enjoy a ${tier < 10 ? "5" : tier < 15 ? "10" : "15"} percent discount on your next visit</p>
      <button id="closeL" style="margin-top:18px;padding:10px 18px;border:none;border-radius:8px;background:#b3822f;color:#fff;">Okay</button>
  `;

  o.appendChild(box);
  document.body.appendChild(o);

  document.getElementById("closeL").onclick = ()=> o.remove();

  startFireworks(box);
}

/* full area fireworks */
function startFireworks(container){
  const colors = ['#f8e7c5','#b3822f','#fff','#ffe9c0'];

  const spawn = ()=>{
    const p = document.createElement("div");
    p.style.position="absolute";
    p.style.width=p.style.height=`${6+Math.random()*18}px`;
    p.style.left=`${Math.random()*100}%`;
    p.style.top=`${Math.random()*100}%`;
    p.style.background=colors[Math.floor(Math.random()*colors.length)];
    p.style.borderRadius="50%";
    p.style.opacity="1";
    p.style.transition="opacity 1200ms linear, transform 1200ms ease-out";

    container.appendChild(p);

    setTimeout(()=>{ p.style.opacity="0"; p.style.transform="scale(2)"; },60);
    setTimeout(()=> p.remove(),1300);
  };

  const loop=setInterval(spawn,50);
  setTimeout(()=> clearInterval(loop),1500);
}
</script>

</body>
</html>
